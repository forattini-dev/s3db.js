#!/bin/sh

# Pre-commit hook: Build before committing
# This ensures dist/ files are always in sync with source code
echo "üî® Running build before commit..."

# Check if we're in the right directory
if [ ! -f "package.json" ]; then
  echo "‚ö†Ô∏è  Warning: package.json not found, skipping build"
  exit 0
fi

# Run rollup directly to avoid pnpm workspace issues during git hooks
if [ -f "node_modules/.bin/rollup" ]; then
  echo "üì¶ Running rollup directly (bypassing package manager)"
  node_modules/.bin/rollup -c 2>&1
elif [ -x "$(command -v npx)" ]; then
  echo "üì¶ Using npx rollup"
  npx rollup -c 2>&1
else
  echo "‚ùå Rollup not found in node_modules or npx not available"
  exit 1
fi

BUILD_EXIT_CODE=$?

if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "‚ùå Build failed with exit code $BUILD_EXIT_CODE"
  echo "üí° To commit without running build, use: git commit --no-verify"
  exit 1
fi

# Stage the built files
git add dist/

echo "‚úÖ Build successful, dist/ files staged"
exit 0
