name: CI/CD Pipeline

on:
  push:
    branches: ['main']
    tags: ['v*']
  pull_request:
    branches: ['main']

jobs:
  # ============================================
  # Stage 1: Build & Lint (runs once per Node version)
  # ============================================
  build:
    name: Build (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22, 23]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: |
          if npm run | grep -q "lint"; then pnpm run lint; fi

      - name: Build
        run: pnpm run build

      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            dist
          key: build-${{ github.sha }}-node${{ matrix.node-version }}

  # ============================================
  # Stage 2: Parallel Test Suites (matrix: suite Ã— node)
  # ============================================
  test:
    name: Test ${{ matrix.suite.name }} (Node ${{ matrix.node-version }})
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22, 23]
        suite:
          - name: core
            path: tests/core/
            timeout: 10
            flags: ''
          - name: scheduler
            path: tests/plugins/scheduler/
            timeout: 5
            flags: ''
          - name: api
            path: tests/plugins/api/
            timeout: 3
            flags: ''
          - name: ttl
            path: tests/plugins/ttl/
            timeout: 3
            flags: ''
          - name: state-machine
            path: tests/plugins/state-machine/
            timeout: 3
            flags: ''
          - name: s3-queue
            path: tests/plugins/s3-queue/
            timeout: 3
            flags: ''
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            dist
          key: build-${{ github.sha }}-node${{ matrix.node-version }}

      - name: Run ${{ matrix.suite.name }} Tests
        run: pnpm vitest run ${{ matrix.suite.path }} --reporter=verbose ${{ matrix.suite.flags }}
        timeout-minutes: ${{ matrix.suite.timeout }}

  # ============================================
  # Stage 3: Quality Gate (waits for all tests)
  # ============================================
  quality:
    name: Quality Gate
    needs: [build, test]
    runs-on: ubuntu-latest
    steps:
      - name: All tests passed
        run: echo "All test suites passed on Node 20, 22, and 23!"

  release-next:
    name: Release Next
    needs: quality
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Check if version bump commit
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping: commit message '$COMMIT_MSG' is a version bump"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        if: steps.check.outputs.skip != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js (NPM Registry)
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install Dependencies
        if: steps.check.outputs.skip != 'true'
        run: pnpm install --frozen-lockfile

      - name: Bump Version (Next)
        if: steps.check.outputs.skip != 'true'
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          SHA=$(git rev-parse --short HEAD)
          BASE_VERSION=$(echo $CURRENT_VERSION | cut -d'-' -f1)
          NEW_VERSION="$BASE_VERSION-next.$SHA"

          echo "New version: $NEW_VERSION"
          npm version $NEW_VERSION --no-git-tag-version
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Build
        if: steps.check.outputs.skip != 'true'
        run: pnpm run build

      - name: Publish to NPM (Next)
        if: steps.check.outputs.skip != 'true'
        run: pnpm publish --tag next --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node.js (GitHub Packages)
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@forattini-dev'

      - name: Publish to GitHub Packages (Next)
        if: steps.check.outputs.skip != 'true'
        run: |
          node -e "
            const pkg = require('./package.json');
            pkg.name = '@forattini-dev/s3db.js';
            pkg.publishConfig = { registry: 'https://npm.pkg.github.com' };
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          pnpm publish --tag next --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Job Summary
        if: steps.check.outputs.skip != 'true'
        run: |
          echo "## ðŸš€ Next Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`next\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# NPM" >> $GITHUB_STEP_SUMMARY
          echo "npm install s3db.js@next" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# PNPM" >> $GITHUB_STEP_SUMMARY
          echo "pnpm add s3db.js@next" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Specific version" >> $GITHUB_STEP_SUMMARY
          echo "npm install s3db.js@${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [NPM Package](https://www.npmjs.com/package/s3db.js?activeTab=versions)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Packages](https://github.com/${{ github.repository }}/pkgs/npm/s3db.js)" >> $GITHUB_STEP_SUMMARY

      - name: Skip Summary
        if: steps.check.outputs.skip == 'true'
        run: |
          echo "## â­ï¸ Release Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version bump commit detected. Skipping @next release." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The stable release will be published via the tag workflow." >> $GITHUB_STEP_SUMMARY

  release-stable:
    name: Release Stable
    needs: quality
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js (NPM Registry)
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Embeddings (MCP)
        run: pnpm run build:embeddings

      - name: Build
        run: pnpm run build

      - name: Publish to NPM (Stable)
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node.js (GitHub Packages)
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@forattini-dev'

      - name: Publish to GitHub Packages (Stable)
        run: |
          node -e "
            const pkg = require('./package.json');
            pkg.name = '@forattini-dev/s3db.js';
            pkg.publishConfig = { registry: 'https://npm.pkg.github.com' };
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}

          echo "## What's Changed" > CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md

          if [ -n "$PREV_TAG" ]; then
            echo "Changes since $PREV_TAG:" >> CHANGELOG_BODY.md
            echo "" >> CHANGELOG_BODY.md

            FEATURES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^feat" 2>/dev/null || true)
            if [ -n "$FEATURES" ]; then
              echo "### ðŸš€ Features" >> CHANGELOG_BODY.md
              echo "$FEATURES" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            FIXES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^fix" 2>/dev/null || true)
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes" >> CHANGELOG_BODY.md
              echo "$FIXES" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            DOCS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^docs" 2>/dev/null || true)
            if [ -n "$DOCS" ]; then
              echo "### ðŸ“š Documentation" >> CHANGELOG_BODY.md
              echo "$DOCS" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            TESTS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^test" 2>/dev/null || true)
            if [ -n "$TESTS" ]; then
              echo "### âœ… Tests" >> CHANGELOG_BODY.md
              echo "$TESTS" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            CHORE=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^ci\|^chore" 2>/dev/null || true)
            if [ -n "$CHORE" ]; then
              echo "### ðŸ”§ Maintenance" >> CHANGELOG_BODY.md
              echo "$CHORE" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            echo "### ðŸ‘¥ Contributors" >> CHANGELOG_BODY.md
            CONTRIBUTORS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/compare/$PREV_TAG...$CURRENT_TAG" \
              | jq -r '.commits[].author.login // empty' | sort -u | grep -v '^$' || true)
            if [ -n "$CONTRIBUTORS" ]; then
              echo "$CONTRIBUTORS" | while read -r user; do
                if [[ ! "$user" =~ \  ]]; then
                  echo "- @$user" >> CHANGELOG_BODY.md
                else
                  echo "- $user" >> CHANGELOG_BODY.md
                fi
              done
            else
              git log $PREV_TAG..HEAD --pretty=format:"- %an" | sort -u >> CHANGELOG_BODY.md
            fi
            echo "" >> CHANGELOG_BODY.md
          else
            echo "Initial release! ðŸŽ‰" >> CHANGELOG_BODY.md
          fi

          echo "" >> CHANGELOG_BODY.md
          echo "---" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$CURRENT_TAG" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "## ðŸ“¦ Installation" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "\`\`\`bash" >> CHANGELOG_BODY.md
          echo "# NPM" >> CHANGELOG_BODY.md
          echo "npm install s3db.js@$CURRENT_TAG" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "# PNPM" >> CHANGELOG_BODY.md
          echo "pnpm add s3db.js@$CURRENT_TAG" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "# GitHub Packages" >> CHANGELOG_BODY.md
          echo "npm install @forattini-dev/s3db.js@$CURRENT_TAG --registry=https://npm.pkg.github.com" >> CHANGELOG_BODY.md
          echo "\`\`\`" >> CHANGELOG_BODY.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG_BODY.md
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            mcp/data/embeddings-core.json
            mcp/data/embeddings-plugins.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Job Summary
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "## ðŸŽ‰ Stable Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Git Tag** | [\`v$VERSION\`](${{ github.server_url }}/${{ github.repository }}/releases/tag/v$VERSION) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# NPM (latest)" >> $GITHUB_STEP_SUMMARY
          echo "npm install s3db.js" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# PNPM" >> $GITHUB_STEP_SUMMARY
          echo "pnpm add s3db.js" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Specific version" >> $GITHUB_STEP_SUMMARY
          echo "npm install s3db.js@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [NPM Package](https://www.npmjs.com/package/s3db.js)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Packages](https://github.com/${{ github.repository }}/pkgs/npm/s3db.js)" >> $GITHUB_STEP_SUMMARY

  deploy-docs:
    name: Deploy Documentation
    needs: release-stable
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4