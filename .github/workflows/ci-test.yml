name: CI - Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test-memory:
    name: Tests (Memory) - Node ${{ matrix.node }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        node: [22, 24, 25]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Run Tests (Memory Client Only)
        run: pnpm test
        env:
          # Force MemoryClient (default when no S3 credentials)
          TEST_MODE: memory
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Test Summary
        if: always()
        run: |
          echo "## Memory Tests - Node ${{ matrix.node }}" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ All tests run using MemoryClient (100-1000x faster)" >> $GITHUB_STEP_SUMMARY

  test-minio:
    name: Tests (MinIO) - Node ${{ matrix.node }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        node: [22, 24, 25]

    services:
      minio:
        image: minio/minio:latest
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin123
        ports:
          - 9000:9000
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        volumes:
          - /tmp/minio-data:/data

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Wait for MinIO
        run: |
          timeout 30s bash -c 'until curl -sf http://localhost:9000/minio/health/live; do
            echo "Waiting for MinIO..."
            sleep 1
          done'
          echo "‚úÖ MinIO is ready"

      - name: Create S3 Bucket
        run: |
          docker run --rm --network="host" \
            -e AWS_ACCESS_KEY_ID=minioadmin \
            -e AWS_SECRET_ACCESS_KEY=minioadmin123 \
            amazon/aws-cli \
            --endpoint-url http://localhost:9000 \
            s3 mb s3://s3db 2>/dev/null || echo "Bucket already exists"

      - name: Build
        run: pnpm run build

      - name: Run Tests (MinIO S3-Compatible)
        run: pnpm test
        env:
          # MinIO credentials
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin123
          AWS_ENDPOINT: http://localhost:9000
          AWS_REGION: us-east-1
          AWS_BUCKET: s3db
          AWS_FORCE_PATH_STYLE: "true"
          BUCKET_CONNECTION_STRING: s3://minioadmin:minioadmin123@s3db?endpoint=http://localhost:9000&region=us-east-1&forcePathStyle=true
          TEST_MODE: s3
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Test Summary
        if: always()
        run: |
          echo "## MinIO Tests - Node ${{ matrix.node }}" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ All tests run against MinIO S3-compatible storage" >> $GITHUB_STEP_SUMMARY
          echo "üîß Connection: http://localhost:9000" >> $GITHUB_STEP_SUMMARY

  coverage:
    name: Coverage Report (MinIO)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [test-memory, test-minio]

    services:
      minio:
        image: minio/minio:latest
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin123
        ports:
          - 9000:9000
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Wait for MinIO
        run: |
          timeout 30s bash -c 'until curl -sf http://localhost:9000/minio/health/live; do
            echo "Waiting for MinIO..."
            sleep 1
          done'

      - name: Create S3 Bucket
        run: |
          docker run --rm --network="host" \
            -e AWS_ACCESS_KEY_ID=minioadmin \
            -e AWS_SECRET_ACCESS_KEY=minioadmin123 \
            amazon/aws-cli \
            --endpoint-url http://localhost:9000 \
            s3 mb s3://s3db 2>/dev/null || echo "Bucket already exists"

      - name: Build
        run: pnpm run build

      - name: Run Tests with Coverage
        run: pnpm run test:coverage
        env:
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin123
          AWS_ENDPOINT: http://localhost:9000
          AWS_REGION: us-east-1
          AWS_BUCKET: s3db
          AWS_FORCE_PATH_STYLE: "true"
          BUCKET_CONNECTION_STRING: s3://minioadmin:minioadmin123@s3db?endpoint=http://localhost:9000&region=us-east-1&forcePathStyle=true
          TEST_MODE: s3
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

      - name: Coverage Summary
        if: always()
        run: |
          echo "## üìä Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage/coverage-summary.json ]; then
            STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
            LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)

            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Lines | ${LINES}% |" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Coverage data not available" >> $GITHUB_STEP_SUMMARY
          fi

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test-memory, test-minio, coverage]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## üöÄ CI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Test Matrix Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Memory Tests | ${{ needs.test-memory.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MinIO Tests | ${{ needs.test-minio.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **MemoryClient**: In-memory S3-compatible storage (100-1000x faster)" >> $GITHUB_STEP_SUMMARY
          echo "- **MinIO**: Real S3-compatible server (production-like)" >> $GITHUB_STEP_SUMMARY

      - name: Check Status
        if: needs.test-memory.result != 'success' || needs.test-minio.result != 'success'
        run: |
          echo "‚ùå CI Failed - Check test results above"
          exit 1
