import{customAlphabet as e,urlAlphabet as t}from"nanoid";import{PromisePool as r}from"@supercharge/promise-pool";import{ReadableStream as n}from"node:stream/web";import{chunk as i,merge as o,isString as s,isEmpty as a,invert as c,uniq as u,cloneDeep as l,get as h,set as f,isObject as d,isFunction as p,isPlainObject as g}from"lodash-es";import{createHash as m}from"crypto";import{S3Client as y,PutObjectCommand as w,GetObjectCommand as b,HeadObjectCommand as v,CopyObjectCommand as E,DeleteObjectCommand as I,DeleteObjectsCommand as _,ListObjectsV2Command as A}from"@aws-sdk/client-s3";import{flatten as k,unflatten as B}from"flat";import x from"fastest-validator";function S(e){"string"!=typeof e&&(e=String(e));let t=0;for(let r=0;r<e.length;r++){const n=e.codePointAt(r);n<=127?t+=1:n<=2047?t+=2:n<=65535?t+=3:n<=1114111&&(t+=4,n>65535&&r++)}return t}function O(e){let t=0;for(const r of Object.keys(e))t+=S(r);return t}function U(e){return null==e?"":"boolean"==typeof e?e?"1":"0":"number"==typeof e?String(e):"string"==typeof e?e:Array.isArray(e)?0===e.length?"[]":e.map(e=>String(e)).join("|"):"object"==typeof e?JSON.stringify(e):String(e)}function C(e){const t={};for(const[r,n]of Object.entries(e)){const e=S(U(n));t[r]=e}return t}function N(e){const t=C(e);return Object.values(t).reduce((e,t)=>e+t,0)+O(e)}function R(e){const t=C(e),r=O(e),n=Object.values(t).reduce((e,t)=>e+t,0),i=n+r,o=Object.entries(t).sort(([,e],[,t])=>t-e).map(([e,t])=>({attribute:e,size:t,percentage:(t/i*100).toFixed(2)+"%"}));return{total:i,valueSizes:t,namesSize:r,valueTotal:n,breakdown:o,detailedBreakdown:{values:n,names:r,total:i}}}function T(e={}){const{version:t="1",timestamps:r=!1,id:n=""}=e,i={_v:String(t)};r&&(i.createdAt="2024-01-01T00:00:00.000Z",i.updatedAt="2024-01-01T00:00:00.000Z"),n&&(i.id=n);const o={};for(const[e,t]of Object.entries(i))o[e]=t;return N(o)}function L(e={}){const{s3Limit:t=2048,systemConfig:r={}}=e;return t-T(r)}const D=2047;var j=Object.freeze({__proto__:null,S3_METADATA_LIMIT_BYTES:D,handleGet:async function({resource:e,metadata:t,body:r}){return{metadata:t,body:r}},handleInsert:async function({resource:e,data:t,mappedData:r,originalData:n}){const i=N(r),o=L({s3Limit:D,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t.id}});if(i>o)throw new Error(`S3 metadata size exceeds 2KB limit. Current size: ${i} bytes, effective limit: ${o} bytes, absolute limit: 2047 bytes`);return{mappedData:r,body:JSON.stringify(r)}},handleUpdate:async function({resource:e,id:t,data:r,mappedData:n,originalData:i}){const o=N(n),s=L({s3Limit:D,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t}});if(o>s)throw new Error(`S3 metadata size exceeds 2KB limit. Current size: ${o} bytes, effective limit: ${s} bytes, absolute limit: 2047 bytes`);return{mappedData:n,body:JSON.stringify(n)}},handleUpsert:async function({resource:e,id:t,data:r,mappedData:n}){const i=N(n),o=L({s3Limit:D,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t}});if(i>o)throw new Error(`S3 metadata size exceeds 2KB limit. Current size: ${i} bytes, effective limit: ${o} bytes, absolute limit: 2047 bytes`);return{mappedData:n,body:""}}});var M=Object.freeze({__proto__:null,handleGet:async function({resource:e,metadata:t,body:r}){return{metadata:t,body:r}},handleInsert:async function({resource:e,data:t,mappedData:r,originalData:n}){const i=N(r);return i>L({s3Limit:D,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t.id}})&&e.emit("exceedsLimit",{operation:"insert",totalSize:i,limit:2047,excess:i-2047,data:n||t}),{mappedData:r,body:JSON.stringify(t)}},handleUpdate:async function({resource:e,id:t,data:r,mappedData:n,originalData:i}){const o=N(n);return o>L({s3Limit:D,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t}})&&e.emit("exceedsLimit",{operation:"update",id:t,totalSize:o,limit:2047,excess:o-2047,data:i||r}),{mappedData:n,body:JSON.stringify(r)}},handleUpsert:async function({resource:e,id:t,data:r,mappedData:n,originalData:i}){const o=N(n);return o>L({s3Limit:D,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t}})&&e.emit("exceedsLimit",{operation:"upsert",id:t,totalSize:o,limit:2047,excess:o-2047,data:i||r}),{mappedData:n,body:JSON.stringify(r)}}});const P="$truncated",F="true",q=S(P)+S(F);async function Q({resource:e,data:t,mappedData:r,originalData:n}){const i=L({s3Limit:D,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t.id}}),o=C(r),s=Object.entries(o).sort(([,e],[,t])=>e-t),a={};let c=0,u=!1;r._v&&(a._v=r._v,c+=o._v);for(const[e,t]of s){if("_v"===e)continue;const n=r[e];if(!(c+(t+(u?0:q))<=i)){const t=i-c-(u?0:q);if(t>0){const r=z(n,t);a[e]=r,u=!0,c+=S(r)}else a[e]="",u=!0;break}a[e]=n,c+=t}let l=N(a)+(u?q:0);for(;l>i;){const e=Object.keys(a).filter(e=>"_v"!==e&&"$truncated"!==e);if(0===e.length)break;a[e[e.length-1]]="",l=N(a)+q,u=!0}return u&&(a[P]=F),{mappedData:a,body:JSON.stringify(r)}}function z(e,t){if("string"==typeof e)return $(e,t);if("object"==typeof e&&null!==e){return $(JSON.stringify(e),t)}return $(String(e),t)}function $(e,t){const r=new TextEncoder;let n=r.encode(e);if(n.length<=t)return e;let i=e.length;for(;i>0;){const o=e.substring(0,i);if(n=r.encode(o),n.length<=t)return o;i--}return""}var H=Object.freeze({__proto__:null,handleGet:async function({resource:e,metadata:t,body:r}){return{metadata:t,body:r}},handleInsert:Q,handleUpdate:async function({resource:e,id:t,data:r,mappedData:n,originalData:i}){return Q({resource:e,data:r,mappedData:n,originalData:i})},handleUpsert:async function({resource:e,id:t,data:r,mappedData:n}){return Q({resource:e,data:r,mappedData:n})}});function V(e){if(null==e){const e=new Error("fnOrPromise cannot be null or undefined");return e.stack=(new Error).stack,[!1,e,void 0]}if("function"==typeof e)try{const t=e();return null==t?[!0,null,t]:"function"==typeof t.then?t.then(e=>[!0,null,e]).catch(e=>{if(e instanceof Error&&Object.isExtensible(e)){const t=Object.getOwnPropertyDescriptor(e,"stack");if(t&&t.writable&&t.configurable&&e.hasOwnProperty("stack"))try{e.stack=(new Error).stack}catch(e){}}return[!1,e,void 0]}):[!0,null,t]}catch(e){if(e instanceof Error&&Object.isExtensible(e)){const t=Object.getOwnPropertyDescriptor(e,"stack");if(t&&t.writable&&t.configurable&&e.hasOwnProperty("stack"))try{e.stack=(new Error).stack}catch(e){}}return[!1,e,void 0]}return"function"==typeof e.then?Promise.resolve(e).then(e=>[!0,null,e]).catch(e=>{if(e instanceof Error&&Object.isExtensible(e)){const t=Object.getOwnPropertyDescriptor(e,"stack");if(t&&t.writable&&t.configurable&&e.hasOwnProperty("stack"))try{e.stack=(new Error).stack}catch(e){}}return[!1,e,void 0]}):[!0,null,e]}function G(e){try{return[!0,null,e()]}catch(e){return[!1,e,null]}}const K="$overflow",W="true",J=S(K)+S(W);async function Z({resource:e,data:t,mappedData:r,originalData:n}){const i=L({s3Limit:D,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t.id}}),o=C(r),s=Object.entries(o).sort(([,e],[,t])=>e-t),a={},c={};let u=0,l=!1;r._v&&(a._v=r._v,u+=o._v);let h=i;for(const[e,t]of s)"_v"!==e&&(!l&&u+t>i&&(h-=J,l=!0),!l&&u+t<=h?(a[e]=r[e],u+=t):(c[e]=r[e],l=!0));l&&(a[K]=W);const f=Object.keys(c).length>0;let d=f?JSON.stringify(c):"";return f||(d="{}"),{mappedData:a,body:d}}var Y=Object.freeze({__proto__:null,handleGet:async function({resource:e,metadata:t,body:r}){let n={};if(r&&""!==r.trim()){const[e,t,i]=G(()=>JSON.parse(r));n=e?i:{}}const i={...n,...t};return delete i.$overflow,{metadata:i,body:r}},handleInsert:Z,handleUpdate:async function({resource:e,id:t,data:r,mappedData:n,originalData:i}){return Z({resource:e,data:r,mappedData:n,originalData:i})},handleUpsert:async function({resource:e,id:t,data:r,mappedData:n}){return Z({resource:e,data:r,mappedData:n})}});async function X({resource:e,data:t,mappedData:r}){const n={_v:r._v||String(e.version)};n._map=JSON.stringify(e.schema.map);return{mappedData:n,body:JSON.stringify(r)}}var ee=Object.freeze({__proto__:null,handleGet:async function({resource:e,metadata:t,body:r}){let n={};if(r&&""!==r.trim()){const[e,t,i]=G(()=>JSON.parse(r));n=e?i:{}}return{metadata:{...n,...t},body:r}},handleInsert:X,handleUpdate:async function({resource:e,id:t,data:r,mappedData:n}){const i={_v:n._v||String(e.version)};return i._map=JSON.stringify(e.schema.map),{mappedData:i,body:JSON.stringify(n)}},handleUpsert:async function({resource:e,id:t,data:r,mappedData:n}){return X({resource:e,data:r,mappedData:n})}});const te={"user-managed":M,"enforce-limits":j,"truncate-data":H,"body-overflow":Y,"body-only":ee};function re(e){const t=te[e];if(!t)throw new Error(`Unknown behavior: ${e}. Available behaviors: ${Object.keys(te).join(", ")}`);return t}const ne=Object.keys(te),ie="user-managed",oe="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",se=Object.fromEntries([...oe].map((e,t)=>[e,t])),ae=e=>{if("number"!=typeof e||isNaN(e))return"undefined";if(!isFinite(e))return"undefined";if(0===e)return oe[0];if(e<0)return"-"+ae(-Math.floor(e));e=Math.floor(e);let t="";for(;e;)t=oe[e%62]+t,e=Math.floor(e/62);return t},ce=e=>{if("string"!=typeof e)return NaN;if(""===e)return 0;let t=!1;"-"===e[0]&&(t=!0,e=e.slice(1));let r=0;for(let t=0;t<e.length;t++){const n=se[e[t]];if(void 0===n)return NaN;r=62*r+n}return t?-r:r},ue=e=>{if("number"!=typeof e||isNaN(e))return"undefined";if(!isFinite(e))return"undefined";const t=e<0;e=Math.abs(e);const[r,n]=e.toString().split("."),i=ae(Number(r));return n?(t?"-":"")+i+"."+n:(t?"-":"")+i},le=e=>{if("string"!=typeof e)return NaN;let t=!1;"-"===e[0]&&(t=!0,e=e.slice(1));const[r,n]=e.split("."),i=ce(r);if(isNaN(i))return NaN;const o=n?Number(i+"."+n):i;return t?-o:o};class he extends Error{constructor({verbose:e,bucket:t,key:r,message:n,code:i,statusCode:o,requestId:s,awsMessage:a,original:c,commandName:u,commandInput:l,metadata:h,suggestion:f,...d}){e&&(n+=`\n\nVerbose:\n\n${JSON.stringify(d,null,2)}`),super(n),"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error(n).stack,super.name=this.constructor.name,this.name=this.constructor.name,this.bucket=t,this.key=r,this.thrownAt=new Date,this.code=i,this.statusCode=o,this.requestId=s,this.awsMessage=a,this.original=c,this.commandName=u,this.commandInput=l,this.metadata=h,this.suggestion=f,this.data={bucket:t,key:r,...d,verbose:e,message:n}}toJson(){return{name:this.name,message:this.message,code:this.code,statusCode:this.statusCode,requestId:this.requestId,awsMessage:this.awsMessage,bucket:this.bucket,key:this.key,thrownAt:this.thrownAt,commandName:this.commandName,commandInput:this.commandInput,metadata:this.metadata,suggestion:this.suggestion,data:this.data,original:this.original,stack:this.stack}}toString(){return`${this.name} | ${this.message}`}}class fe extends he{constructor(e,t={}){let r,n,i,o,s,a;t.original&&(s=t.original,r=s.code||s.Code||s.name,n=s.statusCode||s.$metadata&&s.$metadata.httpStatusCode,i=s.requestId||s.$metadata&&s.$metadata.requestId,o=s.message,a=s.$metadata?{...s.$metadata}:void 0),super({message:e,...t,code:r,statusCode:n,requestId:i,awsMessage:o,original:s,metadata:a})}}class de extends fe{constructor(e,t={}){super(e,t),Object.assign(this,t)}}class pe extends fe{constructor(e,t={}){super(e,t),Object.assign(this,t)}}class ge extends fe{constructor(e,t={}){super(e,t),Object.assign(this,t)}}class me extends fe{constructor(e,t={}){super(e,t),Object.assign(this,t)}}class ye extends fe{constructor(e,t={}){super(e,t),Object.assign(this,t)}}class we extends fe{constructor({bucket:e,resourceName:t,id:r,original:n,...i}){if("string"!=typeof r)throw new Error("id must be a string");if("string"!=typeof e)throw new Error("bucket must be a string");if("string"!=typeof t)throw new Error("resourceName must be a string");super(`Resource not found: ${t}/${r} [bucket:${e}]`,{bucket:e,resourceName:t,id:r,original:n,...i})}}class be extends fe{constructor({bucket:e,original:t,...r}){if("string"!=typeof e)throw new Error("bucket must be a string");super(`Bucket does not exists [bucket:${e}]`,{bucket:e,original:t,...r})}}class ve extends fe{constructor({bucket:e,key:t,resourceName:r,id:n,original:i,...o}){if("string"!=typeof t)throw new Error("key must be a string");if("string"!=typeof e)throw new Error("bucket must be a string");if(void 0!==n&&"string"!=typeof n)throw new Error("id must be a string");super(`No such key: ${t} [bucket:${e}]`,{bucket:e,key:t,resourceName:r,id:n,original:i,...o}),this.resourceName=r,this.id=n}}class Ee extends fe{constructor({bucket:e,key:t,resourceName:r,id:n,original:i,...o}){if("string"!=typeof t)throw new Error("key must be a string");if("string"!=typeof e)throw new Error("bucket must be a string");super(`Not found: ${t} [bucket:${e}]`,{bucket:e,key:t,resourceName:r,id:n,original:i,...o}),this.resourceName=r,this.id=n}}class Ie extends fe{constructor({bucket:e,original:t,...r}){if("string"!=typeof e)throw new Error("bucket must be a string");super(`Missing metadata for bucket [bucket:${e}]`,{bucket:e,original:t,...r})}}class _e extends fe{constructor({bucket:e,resourceName:t,attributes:r,validation:n,message:i,original:o,...s}){if("string"!=typeof e)throw new Error("bucket must be a string");if("string"!=typeof t)throw new Error("resourceName must be a string");super(i||`Validation error: This item is not valid. Resource=${t} [bucket:${e}].\n${JSON.stringify(n,null,2)}`,{bucket:e,resourceName:t,attributes:r,validation:n,original:o,...s})}}class Ae extends fe{}const ke={NotFound:Ee,NoSuchKey:ve,UnknownError:Ae,NoSuchBucket:be,MissingMetadata:Ie,InvalidResourceItem:_e};function Be(e,t={}){const r=e.code||e.Code||e.name,n=e.$metadata?{...e.$metadata}:void 0,i=t.commandName,o=t.commandInput;let s;return"NoSuchKey"===r||"NotFound"===r?(s="Check if the key exists in the specified bucket and if your credentials have permission.",new ve({...t,original:e,metadata:n,commandName:i,commandInput:o,suggestion:s})):"NoSuchBucket"===r?(s="Check if the bucket exists and if your credentials have permission.",new be({...t,original:e,metadata:n,commandName:i,commandInput:o,suggestion:s})):"AccessDenied"===r||403===e.statusCode||"Forbidden"===r?(s="Check your credentials and bucket policy.",new me("Access denied",{...t,original:e,metadata:n,commandName:i,commandInput:o,suggestion:s})):"ValidationError"===r||400===e.statusCode?(s="Check the request parameters and payload.",new pe("Validation error",{...t,original:e,metadata:n,commandName:i,commandInput:o,suggestion:s})):"MissingMetadata"===r?(s="Check if the object metadata is present and valid.",new Ie({...t,original:e,metadata:n,commandName:i,commandInput:o,suggestion:s})):(s="Check the error details and AWS documentation.",new Ae("Unknown error",{...t,original:e,metadata:n,commandName:i,commandInput:o,suggestion:s}))}class xe extends fe{constructor(e,t={}){super(e,{...t,suggestion:"Check the connection string format and credentials."})}}class Se extends fe{constructor(e,t={}){super(e,{...t,suggestion:"Check if the crypto library is available and input is valid."})}}class Oe extends fe{constructor(e,t={}){super(e,{...t,suggestion:"Check schema definition and input data."})}}class Ue extends fe{constructor(e,t={}){super(e,{...t,suggestion:t.suggestion||"Check resource configuration, attributes, and operation context."}),Object.assign(this,t)}}class Ce extends fe{constructor(e,t={}){super(e,{...t,suggestion:t.suggestion||"Check partition definition, fields, and input values."})}}async function Ne(){let e;if("undefined"!=typeof process){const[t,r,n]=await V(async()=>{const{webcrypto:e}=await import("crypto");return e});if(!t)throw new Se("Crypto API not available",{original:r,context:"dynamicCrypto"});e=n}else"undefined"!=typeof window&&(e=window.crypto);if(!e)throw new Se("Could not load any crypto library",{context:"dynamicCrypto"});return e}async function Re(e){const[t,r,n]=await V(Ne);if(!t)throw new Se("Crypto API not available",{original:r});const i=(new TextEncoder).encode(e),[o,s,a]=await V(()=>n.subtle.digest("SHA-256",i));if(!o)throw new Se("SHA-256 digest failed",{original:s,input:e});return Array.from(new Uint8Array(a)).map(e=>e.toString(16).padStart(2,"0")).join("")}async function Te(e,t){const[r,n,i]=await V(Ne);if(!r)throw new Se("Crypto API not available",{original:n});const o=i.getRandomValues(new Uint8Array(16)),[s,a,c]=await V(()=>De(t,o));if(!s)throw new Se("Key derivation failed",{original:a,passphrase:t,salt:o});const u=i.getRandomValues(new Uint8Array(12)),l=(new TextEncoder).encode(e),[h,f,d]=await V(()=>i.subtle.encrypt({name:"AES-GCM",iv:u},c,l));if(!h)throw new Se("Encryption failed",{original:f,content:e});const p=new Uint8Array(o.length+u.length+d.byteLength);return p.set(o),p.set(u,o.length),p.set(new Uint8Array(d),o.length+u.length),function(e){if("undefined"!=typeof process)return Buffer.from(e).toString("base64");{const[t,r,n]=G(()=>String.fromCharCode.apply(null,new Uint8Array(e)));if(!t)throw new Se("Failed to convert ArrayBuffer to base64 (browser)",{original:r});return window.btoa(n)}}(p)}async function Le(e,t){const[r,n,i]=await V(Ne);if(!r)throw new Se("Crypto API not available",{original:n});const o=function(e){if("undefined"!=typeof process)return new Uint8Array(Buffer.from(e,"base64"));{const[t,r,n]=G(()=>window.atob(e));if(!t)throw new Se("Failed to decode base64 (browser)",{original:r});const i=n.length,o=new Uint8Array(i);for(let e=0;e<i;e++)o[e]=n.charCodeAt(e);return o}}(e),s=o.slice(0,16),a=o.slice(16,28),c=o.slice(28),[u,l,h]=await V(()=>De(t,s));if(!u)throw new Se("Key derivation failed (decrypt)",{original:l,passphrase:t,salt:s});const[f,d,p]=await V(()=>i.subtle.decrypt({name:"AES-GCM",iv:a},h,c));if(!f)throw new Se("Decryption failed",{original:d,encryptedBase64:e});return(new TextDecoder).decode(p)}async function De(e,t){const[r,n,i]=await V(Ne);if(!r)throw new Se("Crypto API not available",{original:n});const o=(new TextEncoder).encode(e),[s,a,c]=await V(()=>i.subtle.importKey("raw",o,{name:"PBKDF2"},!1,["deriveKey"]));if(!s)throw new Se("importKey failed",{original:a,passphrase:e});const[u,l,h]=await V(()=>i.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},c,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]));if(!u)throw new Se("deriveKey failed",{original:l,passphrase:e,salt:t});return h}const je=e(t,22),Me=e("ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789",16);var Pe;function Fe(){}function qe(){qe.init.call(this)}function Qe(e){return void 0===e._maxListeners?qe.defaultMaxListeners:e._maxListeners}function ze(e,t,r,n){var i,o,s,a;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((o=e._events)?(o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),s=o[t]):(o=e._events=new Fe,e._eventsCount=0),s){if("function"==typeof s?s=o[t]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),!s.warned&&(i=Qe(e))&&i>0&&s.length>i){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,a=c,"function"==typeof console.warn?console.warn(a):console.log(a)}}else s=o[t]=r,++e._eventsCount;return e}function $e(e,t,r){var n=!1;function i(){e.removeListener(t,i),n||(n=!0,r.apply(e,arguments))}return i.listener=r,i}function He(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function Ve(e,t){for(var r=new Array(t);t--;)r[t]=e[t];return r}Fe.prototype=Object.create(null),qe.EventEmitter=qe,qe.usingDomains=!1,qe.prototype.domain=void 0,qe.prototype._events=void 0,qe.prototype._maxListeners=void 0,qe.defaultMaxListeners=10,qe.init=function(){this.domain=null,qe.usingDomains&&(!Pe.active||this instanceof Pe.Domain||(this.domain=Pe.active)),this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new Fe,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},qe.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},qe.prototype.getMaxListeners=function(){return Qe(this)},qe.prototype.emit=function(e){var t,r,n,i,o,s,a,c="error"===e;if(s=this._events)c=c&&null==s.error;else if(!c)return!1;if(a=this.domain,c){if(t=arguments[1],!a){if(t instanceof Error)throw t;var u=new Error('Uncaught, unspecified "error" event. ('+t+")");throw u.context=t,u}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=a,t.domainThrown=!1,a.emit("error",t),!1}if(!(r=s[e]))return!1;var l="function"==typeof r;switch(n=arguments.length){case 1:!function(e,t,r){if(t)e.call(r);else for(var n=e.length,i=Ve(e,n),o=0;o<n;++o)i[o].call(r)}(r,l,this);break;case 2:!function(e,t,r,n){if(t)e.call(r,n);else for(var i=e.length,o=Ve(e,i),s=0;s<i;++s)o[s].call(r,n)}(r,l,this,arguments[1]);break;case 3:!function(e,t,r,n,i){if(t)e.call(r,n,i);else for(var o=e.length,s=Ve(e,o),a=0;a<o;++a)s[a].call(r,n,i)}(r,l,this,arguments[1],arguments[2]);break;case 4:!function(e,t,r,n,i,o){if(t)e.call(r,n,i,o);else for(var s=e.length,a=Ve(e,s),c=0;c<s;++c)a[c].call(r,n,i,o)}(r,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(n-1),o=1;o<n;o++)i[o-1]=arguments[o];!function(e,t,r,n){if(t)e.apply(r,n);else for(var i=e.length,o=Ve(e,i),s=0;s<i;++s)o[s].apply(r,n)}(r,l,this,i)}return!0},qe.prototype.addListener=function(e,t){return ze(this,e,t,!1)},qe.prototype.on=qe.prototype.addListener,qe.prototype.prependListener=function(e,t){return ze(this,e,t,!0)},qe.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,$e(this,e,t)),this},qe.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,$e(this,e,t)),this},qe.prototype.removeListener=function(e,t){var r,n,i,o,s;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(n=this._events))return this;if(!(r=n[e]))return this;if(r===t||r.listener&&r.listener===t)0===--this._eventsCount?this._events=new Fe:(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,o=r.length;o-- >0;)if(r[o]===t||r[o].listener&&r[o].listener===t){s=r[o].listener,i=o;break}if(i<0)return this;if(1===r.length){if(r[0]=void 0,0===--this._eventsCount)return this._events=new Fe,this;delete n[e]}else!function(e,t){for(var r=t,n=r+1,i=e.length;n<i;r+=1,n+=1)e[r]=e[n];e.pop()}(r,i);n.removeListener&&this.emit("removeListener",e,s||t)}return this},qe.prototype.off=function(e,t){return this.removeListener(e,t)},qe.prototype.removeAllListeners=function(e){var t,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new Fe,this._eventsCount=0):r[e]&&(0===--this._eventsCount?this._events=new Fe:delete r[e]),this;if(0===arguments.length){for(var n,i=Object.keys(r),o=0;o<i.length;++o)"removeListener"!==(n=i[o])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=new Fe,this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},qe.prototype.listeners=function(e){var t,r=this._events;return r&&(t=r[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(t):[]},qe.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):He.call(e,t)},qe.prototype.listenerCount=He,qe.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var Ge=Object.freeze({__proto__:null,EventEmitter:qe,default:qe});class Ke extends qe{constructor(e={}){super(),this.name=this.constructor.name,this.options=e,this.hooks=new Map}async setup(e){this.database=e,this.beforeSetup(),await this.onSetup(),this.afterSetup()}async start(){this.beforeStart(),await this.onStart(),this.afterStart()}async stop(){this.beforeStop(),await this.onStop(),this.afterStop()}async onSetup(){}async onStart(){}async onStop(){}addHook(e,t,r){this.hooks.has(e)||this.hooks.set(e,new Map);const n=this.hooks.get(e);n.has(t)||n.set(t,[]),n.get(t).push(r)}removeHook(e,t,r){const n=this.hooks.get(e);if(n&&n.has(t)){const e=n.get(t),i=e.indexOf(r);i>-1&&e.splice(i,1)}}wrapResourceMethod(e,t,r){const n=e[t];if(e._pluginWrappers||(e._pluginWrappers=new Map),e._pluginWrappers.has(t)||e._pluginWrappers.set(t,[]),e._pluginWrappers.get(t).push(r),!e[`_wrapped_${t}`]){e[`_wrapped_${t}`]=n;const r=n&&n._isMockFunction;e[t]=async function(...r){let n=await e[`_wrapped_${t}`](...r);for(const i of e._pluginWrappers.get(t))n=await i.call(this,n,r,t);return n},r&&(Object.setPrototypeOf(e[t],Object.getPrototypeOf(n)),Object.assign(e[t],n))}}addMiddleware(e,t,r){if(e._pluginMiddlewares||(e._pluginMiddlewares={}),!e._pluginMiddlewares[t]){e._pluginMiddlewares[t]=[];const r=e[t].bind(e);e[t]=async function(...n){let i=-1;const o=async(...n)=>(i++,i<e._pluginMiddlewares[t].length?await e._pluginMiddlewares[t][i].call(this,o,...n):await r(...n));return await o(...n)}}e._pluginMiddlewares[t].push(r)}getPartitionValues(e,t){if(!t.config?.partitions)return{};const r={};for(const[n,i]of Object.entries(t.config.partitions))if(i.fields){r[n]={};for(const[o,s]of Object.entries(i.fields)){const i=this.getNestedFieldValue(e,o);null!=i&&(r[n][o]=t.applyPartitionRule(i,s))}}else r[n]={};return r}getNestedFieldValue(e,t){if(!t.includes("."))return e[t]??null;const r=t.split(".");let n=e;for(const e of r){if(!n||"object"!=typeof n||!(e in n))return null;n=n[e]}return n??null}beforeSetup(){this.emit("plugin.beforeSetup",new Date)}afterSetup(){this.emit("plugin.afterSetup",new Date)}beforeStart(){this.emit("plugin.beforeStart",new Date)}afterStart(){this.emit("plugin.afterStart",new Date)}beforeStop(){this.emit("plugin.beforeStop",new Date)}afterStop(){this.emit("plugin.afterStop",new Date)}}const We={setup(e){},start(){},stop(){}};class Je extends Ke{constructor(e={}){super(e),this.auditResource=null,this.config={includeData:!1!==e.includeData,includePartitions:!1!==e.includePartitions,maxDataSize:e.maxDataSize||1e4,...e}}async onSetup(){const[e,t,r]=await V(()=>this.database.createResource({name:"audits",attributes:{id:"string|required",resourceName:"string|required",operation:"string|required",recordId:"string|required",userId:"string|optional",timestamp:"string|required",oldData:"string|optional",newData:"string|optional",partition:"string|optional",partitionValues:"string|optional",metadata:"string|optional"},behavior:"body-overflow"}));this.auditResource=e?r:this.database.resources.audits||null,(e||this.auditResource)&&(this.installDatabaseProxy(),this.installEventListeners())}async onStart(){}async onStop(){}installDatabaseProxy(){if(this.database._auditProxyInstalled)return;const e=this.installEventListenersForResource.bind(this);this.database._originalCreateResource=this.database.createResource,this.database.createResource=async function(...t){const r=await this._originalCreateResource(...t);return"audits"!==r.name&&e(r),r},this.database._auditProxyInstalled=!0}installEventListeners(){for(const e of Object.values(this.database.resources))"audits"!==e.name&&this.installEventListenersForResource(e)}installEventListenersForResource(e){e.on("insert",async t=>{const r=t.id||"auto-generated",n=this.config.includePartitions?this.getPartitionValues(t,e):null,i={id:`audit-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,resourceName:e.name,operation:"insert",recordId:r,userId:this.getCurrentUserId?.()||"system",timestamp:(new Date).toISOString(),oldData:null,newData:!1===this.config.includeData?null:JSON.stringify(this.truncateData(t)),partition:this.config.includePartitions?this.getPrimaryPartition(n):null,partitionValues:this.config.includePartitions&&n&&Object.keys(n).length>0?JSON.stringify(n):null,metadata:JSON.stringify({source:"audit-plugin",version:"2.0"})};this.logAudit(i).catch(console.error)}),e.on("update",async t=>{const r=t.id;let n=t.$before;if(this.config.includeData&&!n){const[t,i,o]=await V(()=>e.get(r));t&&(n=o)}const i=this.config.includePartitions?this.getPartitionValues(t,e):null,o={id:`audit-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,resourceName:e.name,operation:"update",recordId:r,userId:this.getCurrentUserId?.()||"system",timestamp:(new Date).toISOString(),oldData:n&&!1===this.config.includeData?null:n?JSON.stringify(this.truncateData(n)):null,newData:!1===this.config.includeData?null:JSON.stringify(this.truncateData(t)),partition:this.config.includePartitions?this.getPrimaryPartition(i):null,partitionValues:this.config.includePartitions&&i&&Object.keys(i).length>0?JSON.stringify(i):null,metadata:JSON.stringify({source:"audit-plugin",version:"2.0"})};this.logAudit(o).catch(console.error)}),e.on("delete",async t=>{const r=t.id;let n=t;if(this.config.includeData&&!n){const[t,i,o]=await V(()=>e.get(r));t&&(n=o)}const i=n&&this.config.includePartitions?this.getPartitionValues(n,e):null,o={id:`audit-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,resourceName:e.name,operation:"delete",recordId:r,userId:this.getCurrentUserId?.()||"system",timestamp:(new Date).toISOString(),oldData:n&&!1===this.config.includeData?null:n?JSON.stringify(this.truncateData(n)):null,newData:null,partition:this.config.includePartitions?this.getPrimaryPartition(i):null,partitionValues:this.config.includePartitions&&i&&Object.keys(i).length>0?JSON.stringify(i):null,metadata:JSON.stringify({source:"audit-plugin",version:"2.0"})};this.logAudit(o).catch(console.error)}),e.useMiddleware("deleteMany",async(t,r)=>{const n=t.args[0],i={};if(this.config.includeData)for(const t of n){const[r,n,o]=await V(()=>e.get(t));i[t]=r?o:null}const o=await r();if(o&&o.length>0&&this.config.includeData)for(const t of n){const r=i[t],n=r&&this.config.includePartitions?this.getPartitionValues(r,e):null,o={id:`audit-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,resourceName:e.name,operation:"delete",recordId:t,userId:this.getCurrentUserId?.()||"system",timestamp:(new Date).toISOString(),oldData:!1===this.config.includeData?null:JSON.stringify(this.truncateData(r)),newData:null,partition:this.config.includePartitions?this.getPrimaryPartition(n):null,partitionValues:this.config.includePartitions&&n&&Object.keys(n).length>0?JSON.stringify(n):null,metadata:JSON.stringify({source:"audit-plugin",version:"2.0",batchOperation:!0})};this.logAudit(o).catch(console.error)}return o})}getPartitionValues(e,t){if(!e)return null;const r=t.config?.partitions||{},n={};for(const[t,i]of Object.entries(r))if(i.fields){const r={};for(const[t,n]of Object.entries(i.fields)){const n=this.getNestedFieldValue(e,t);null!=n&&(r[t]=n)}Object.keys(r).length>0&&(n[t]=r)}return n}getNestedFieldValue(e,t){if(!t.includes("."))return e[t];const r=t.split(".");let n=e;for(const e of r){if(!n||"object"!=typeof n||!(e in n))return;n=n[e]}return n}getPrimaryPartition(e){if(!e)return null;const t=Object.keys(e);return t.length>0?t[0]:null}async logAudit(e){e.id||(e.id=`audit-${Date.now()}-${Math.random().toString(36).slice(2,8)}`);return await this.auditResource.insert(e)}truncateData(e){if(!e)return e;const t={};for(const[r,n]of Object.entries(e))r.startsWith("_")||"$overflow"===r||(t[r]=n);const r=JSON.stringify(t);if(r.length<=this.config.maxDataSize)return t;let n={...t},i=JSON.stringify(n).length;const o=JSON.stringify({_truncated:!0,_originalSize:r.length,_truncatedAt:(new Date).toISOString()}).length,s=this.config.maxDataSize-o;for(const[e,t]of Object.entries(n))if("string"==typeof t&&i>s){const r=i-s,o=Math.max(0,t.length-r-3);o<t.length&&(n[e]=t.substring(0,o)+"...",i=JSON.stringify(n).length)}return{...n,_truncated:!0,_originalSize:r.length,_truncatedAt:(new Date).toISOString()}}async getAuditLogs(e={}){if(!this.auditResource)return[];const[t,r,n]=await V(async()=>{const{resourceName:t,operation:r,recordId:n,userId:i,partition:o,startDate:s,endDate:a,limit:c=100,offset:u=0}=e;let l=(await this.auditResource.getAll()).filter(e=>(!t||e.resourceName===t)&&((!r||e.operation===r)&&((!n||e.recordId===n)&&((!i||e.userId===i)&&((!o||e.partition===o)&&(!(s&&new Date(e.timestamp)<new Date(s))&&!(a&&new Date(e.timestamp)>new Date(a))))))));l.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp));return l.slice(u,u+c).map(e=>{const[t,,r]="string"==typeof e.oldData?G(()=>JSON.parse(e.oldData)):[!0,null,e.oldData],[n,,i]="string"==typeof e.newData?G(()=>JSON.parse(e.newData)):[!0,null,e.newData],[o,,s]=e.partitionValues&&"string"==typeof e.partitionValues?G(()=>JSON.parse(e.partitionValues)):[!0,null,e.partitionValues],[a,,c]=e.metadata&&"string"==typeof e.metadata?G(()=>JSON.parse(e.metadata)):[!0,null,e.metadata];return{...e,oldData:null===e.oldData||void 0===e.oldData||"null"===e.oldData?null:t?r:null,newData:null===e.newData||void 0===e.newData||"null"===e.newData?null:n?i:null,partitionValues:o?s:e.partitionValues,metadata:a?c:e.metadata}})});return t?n:[]}async getRecordHistory(e,t){return this.getAuditLogs({resourceName:e,recordId:t,limit:1e3})}async getPartitionHistory(e,t,r){return this.getAuditLogs({resourceName:e,partition:t,limit:1e3})}async getAuditStats(e={}){const{resourceName:t,startDate:r,endDate:n}=e,i=await this.getAuditLogs({resourceName:t,startDate:r,endDate:n,limit:1e4}),o={total:i.length,byOperation:{},byResource:{},byPartition:{},byUser:{},timeline:{}};for(const e of i)if(o.byOperation[e.operation]=(o.byOperation[e.operation]||0)+1,o.byResource[e.resourceName]=(o.byResource[e.resourceName]||0)+1,e.partition&&(o.byPartition[e.partition]=(o.byPartition[e.partition]||0)+1),o.byUser[e.userId]=(o.byUser[e.userId]||0)+1,e.timestamp){const t=e.timestamp.split("T")[0];o.timeline[t]=(o.timeline[t]||0)+1}return o}}function Ze(e,t){for(var r=0,n=e.length-1;n>=0;n--){var i=e[n];"."===i?e.splice(n,1):".."===i?(e.splice(n,1),r++):r&&(e.splice(n,1),r--)}if(t)for(;r--;r)e.unshift("..");return e}var Ye=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,Xe=function(e){return Ye.exec(e).slice(1)};function et(){for(var e="",t=!1,r=arguments.length-1;r>=-1&&!t;r--){var n=r>=0?arguments[r]:"/";if("string"!=typeof n)throw new TypeError("Arguments to path.resolve must be strings");n&&(e=n+"/"+e,t="/"===n.charAt(0))}return(t?"/":"")+(e=Ze(ot(e.split("/"),function(e){return!!e}),!t).join("/"))||"."}function tt(e){var t=rt(e),r="/"===st(e,-1);return(e=Ze(ot(e.split("/"),function(e){return!!e}),!t).join("/"))||t||(e="."),e&&r&&(e+="/"),(t?"/":"")+e}function rt(e){return"/"===e.charAt(0)}function nt(){return tt(ot(Array.prototype.slice.call(arguments,0),function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e}).join("/"))}var it={extname:function(e){return Xe(e)[3]},basename:function(e,t){var r=Xe(e)[2];return t&&r.substr(-1*t.length)===t&&(r=r.substr(0,r.length-t.length)),r},dirname:function(e){var t=Xe(e),r=t[0],n=t[1];return r||n?(n&&(n=n.substr(0,n.length-1)),r+n):"."},sep:"/",delimiter:":",relative:function(e,t){function r(e){for(var t=0;t<e.length&&""===e[t];t++);for(var r=e.length-1;r>=0&&""===e[r];r--);return t>r?[]:e.slice(t,r-t+1)}e=et(e).substr(1),t=et(t).substr(1);for(var n=r(e.split("/")),i=r(t.split("/")),o=Math.min(n.length,i.length),s=o,a=0;a<o;a++)if(n[a]!==i[a]){s=a;break}var c=[];for(a=s;a<n.length;a++)c.push("..");return(c=c.concat(i.slice(s))).join("/")},join:nt,isAbsolute:rt,normalize:tt,resolve:et};function ot(e,t){if(e.filter)return e.filter(t);for(var r=[],n=0;n<e.length;n++)t(e[n],n,e)&&r.push(e[n]);return r}var st="b"==="ab".substr(-1)?function(e,t,r){return e.substr(t,r)}:function(e,t,r){return t<0&&(t=e.length+t),e.substr(t,r)},at="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},ct=[],ut=[],lt="undefined"!=typeof Uint8Array?Uint8Array:Array,ht=!1;function ft(){ht=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)ct[t]=e[t],ut[e.charCodeAt(t)]=t;ut["-".charCodeAt(0)]=62,ut["_".charCodeAt(0)]=63}function dt(e){return ct[e>>18&63]+ct[e>>12&63]+ct[e>>6&63]+ct[63&e]}function pt(e,t,r){for(var n,i=[],o=t;o<r;o+=3)n=(e[o]<<16)+(e[o+1]<<8)+e[o+2],i.push(dt(n));return i.join("")}function gt(e){var t;ht||ft();for(var r=e.length,n=r%3,i="",o=[],s=16383,a=0,c=r-n;a<c;a+=s)o.push(pt(e,a,a+s>c?c:a+s));return 1===n?(t=e[r-1],i+=ct[t>>2],i+=ct[t<<4&63],i+="=="):2===n&&(t=(e[r-2]<<8)+e[r-1],i+=ct[t>>10],i+=ct[t>>4&63],i+=ct[t<<2&63],i+="="),o.push(i),o.join("")}function mt(e,t,r,n,i){var o,s,a=8*i-n-1,c=(1<<a)-1,u=c>>1,l=-7,h=r?i-1:0,f=r?-1:1,d=e[t+h];for(h+=f,o=d&(1<<-l)-1,d>>=-l,l+=a;l>0;o=256*o+e[t+h],h+=f,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=n;l>0;s=256*s+e[t+h],h+=f,l-=8);if(0===o)o=1-u;else{if(o===c)return s?NaN:1/0*(d?-1:1);s+=Math.pow(2,n),o-=u}return(d?-1:1)*s*Math.pow(2,o-n)}function yt(e,t,r,n,i,o){var s,a,c,u=8*o-i-1,l=(1<<u)-1,h=l>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:o-1,p=n?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+h>=1?f/c:f*Math.pow(2,1-h))*c>=2&&(s++,c/=2),s+h>=l?(a=0,s=l):s+h>=1?(a=(t*c-1)*Math.pow(2,i),s+=h):(a=t*Math.pow(2,h-1)*Math.pow(2,i),s=0));i>=8;e[r+d]=255&a,d+=p,a/=256,i-=8);for(s=s<<i|a,u+=i;u>0;e[r+d]=255&s,d+=p,s/=256,u-=8);e[r+d-p]|=128*g}var wt={}.toString,bt=Array.isArray||function(e){return"[object Array]"==wt.call(e)};function vt(){return It.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function Et(e,t){if(vt()<t)throw new RangeError("Invalid typed array length");return It.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=It.prototype:(null===e&&(e=new It(t)),e.length=t),e}function It(e,t,r){if(!(It.TYPED_ARRAY_SUPPORT||this instanceof It))return new It(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return kt(this,e)}return _t(this,e,t,r)}function _t(e,t,r,n){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,r,n){if(t.byteLength,r<0||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(n||0))throw new RangeError("'length' is out of bounds");t=void 0===r&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,r):new Uint8Array(t,r,n);It.TYPED_ARRAY_SUPPORT?(e=t).__proto__=It.prototype:e=Bt(e,t);return e}(e,t,r,n):"string"==typeof t?function(e,t,r){"string"==typeof r&&""!==r||(r="utf8");if(!It.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var n=0|Ot(t,r);e=Et(e,n);var i=e.write(t,r);i!==n&&(e=e.slice(0,i));return e}(e,t,r):function(e,t){if(St(t)){var r=0|xt(t.length);return 0===(e=Et(e,r)).length||t.copy(e,0,0,r),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(n=t.length)!=n?Et(e,0):Bt(e,t);if("Buffer"===t.type&&bt(t.data))return Bt(e,t.data)}var n;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function At(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function kt(e,t){if(At(t),e=Et(e,t<0?0:0|xt(t)),!It.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function Bt(e,t){var r=t.length<0?0:0|xt(t.length);e=Et(e,r);for(var n=0;n<r;n+=1)e[n]=255&t[n];return e}function xt(e){if(e>=vt())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+vt().toString(16)+" bytes");return 0|e}function St(e){return!(null==e||!e._isBuffer)}function Ot(e,t){if(St(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return rr(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return nr(e).length;default:if(n)return rr(e).length;t=(""+t).toLowerCase(),n=!0}}function Ut(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return Ht(this,t,r);case"utf8":case"utf-8":return qt(this,t,r);case"ascii":return zt(this,t,r);case"latin1":case"binary":return $t(this,t,r);case"base64":return Ft(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Vt(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function Ct(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function Nt(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=It.from(t,n)),St(t))return 0===t.length?-1:Rt(e,t,r,n,i);if("number"==typeof t)return t&=255,It.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):Rt(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function Rt(e,t,r,n,i){var o,s=1,a=e.length,c=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,r/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var l=-1;for(o=r;o<a;o++)if(u(e,o)===u(t,-1===l?0:o-l)){if(-1===l&&(l=o),o-l+1===c)return l*s}else-1!==l&&(o-=o-l),l=-1}else for(r+c>a&&(r=a-c),o=r;o>=0;o--){for(var h=!0,f=0;f<c;f++)if(u(e,o+f)!==u(t,f)){h=!1;break}if(h)return o}return-1}function Tt(e,t,r,n){r=Number(r)||0;var i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");n>o/2&&(n=o/2);for(var s=0;s<n;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[r+s]=a}return s}function Lt(e,t,r,n){return ir(rr(t,e.length-r),e,r,n)}function Dt(e,t,r,n){return ir(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function jt(e,t,r,n){return Dt(e,t,r,n)}function Mt(e,t,r,n){return ir(nr(t),e,r,n)}function Pt(e,t,r,n){return ir(function(e,t){for(var r,n,i,o=[],s=0;s<e.length&&!((t-=2)<0);++s)n=(r=e.charCodeAt(s))>>8,i=r%256,o.push(i),o.push(n);return o}(t,e.length-r),e,r,n)}function Ft(e,t,r){return 0===t&&r===e.length?gt(e):gt(e.slice(t,r))}function qt(e,t,r){r=Math.min(e.length,r);for(var n=[],i=t;i<r;){var o,s,a,c,u=e[i],l=null,h=u>239?4:u>223?3:u>191?2:1;if(i+h<=r)switch(h){case 1:u<128&&(l=u);break;case 2:128==(192&(o=e[i+1]))&&(c=(31&u)<<6|63&o)>127&&(l=c);break;case 3:o=e[i+1],s=e[i+2],128==(192&o)&&128==(192&s)&&(c=(15&u)<<12|(63&o)<<6|63&s)>2047&&(c<55296||c>57343)&&(l=c);break;case 4:o=e[i+1],s=e[i+2],a=e[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(l=c)}null===l?(l=65533,h=1):l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|1023&l),n.push(l),i+=h}return function(e){var t=e.length;if(t<=Qt)return String.fromCharCode.apply(String,e);var r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=Qt));return r}(n)}It.TYPED_ARRAY_SUPPORT=void 0===at.TYPED_ARRAY_SUPPORT||at.TYPED_ARRAY_SUPPORT,vt(),It.poolSize=8192,It._augment=function(e){return e.__proto__=It.prototype,e},It.from=function(e,t,r){return _t(null,e,t,r)},It.TYPED_ARRAY_SUPPORT&&(It.prototype.__proto__=Uint8Array.prototype,It.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&It[Symbol.species]),It.alloc=function(e,t,r){return function(e,t,r,n){return At(t),t<=0?Et(e,t):void 0!==r?"string"==typeof n?Et(e,t).fill(r,n):Et(e,t).fill(r):Et(e,t)}(null,e,t,r)},It.allocUnsafe=function(e){return kt(null,e)},It.allocUnsafeSlow=function(e){return kt(null,e)},It.isBuffer=or,It.compare=function(e,t){if(!St(e)||!St(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,n=t.length,i=0,o=Math.min(r,n);i<o;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},It.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},It.concat=function(e,t){if(!bt(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return It.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var n=It.allocUnsafe(t),i=0;for(r=0;r<e.length;++r){var o=e[r];if(!St(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(n,i),i+=o.length}return n},It.byteLength=Ot,It.prototype._isBuffer=!0,It.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)Ct(this,t,t+1);return this},It.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)Ct(this,t,t+3),Ct(this,t+1,t+2);return this},It.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)Ct(this,t,t+7),Ct(this,t+1,t+6),Ct(this,t+2,t+5),Ct(this,t+3,t+4);return this},It.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?qt(this,0,e):Ut.apply(this,arguments)},It.prototype.equals=function(e){if(!St(e))throw new TypeError("Argument must be a Buffer");return this===e||0===It.compare(this,e)},It.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},It.prototype.compare=function(e,t,r,n,i){if(!St(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;for(var o=(i>>>=0)-(n>>>=0),s=(r>>>=0)-(t>>>=0),a=Math.min(o,s),c=this.slice(n,i),u=e.slice(t,r),l=0;l<a;++l)if(c[l]!==u[l]){o=c[l],s=u[l];break}return o<s?-1:s<o?1:0},It.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},It.prototype.indexOf=function(e,t,r){return Nt(this,e,t,r,!0)},It.prototype.lastIndexOf=function(e,t,r){return Nt(this,e,t,r,!1)},It.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return Tt(this,e,t,r);case"utf8":case"utf-8":return Lt(this,e,t,r);case"ascii":return Dt(this,e,t,r);case"latin1":case"binary":return jt(this,e,t,r);case"base64":return Mt(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Pt(this,e,t,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},It.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Qt=4096;function zt(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function $t(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function Ht(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var i="",o=t;o<r;++o)i+=tr(e[o]);return i}function Vt(e,t,r){for(var n=e.slice(t,r),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function Gt(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function Kt(e,t,r,n,i,o){if(!St(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function Wt(e,t,r,n){t<0&&(t=65535+t+1);for(var i=0,o=Math.min(e.length-r,2);i<o;++i)e[r+i]=(t&255<<8*(n?i:1-i))>>>8*(n?i:1-i)}function Jt(e,t,r,n){t<0&&(t=4294967295+t+1);for(var i=0,o=Math.min(e.length-r,4);i<o;++i)e[r+i]=t>>>8*(n?i:3-i)&255}function Zt(e,t,r,n,i,o){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function Yt(e,t,r,n,i){return i||Zt(e,0,r,4),yt(e,t,r,n,23,4),r+4}function Xt(e,t,r,n,i){return i||Zt(e,0,r,8),yt(e,t,r,n,52,8),r+8}It.prototype.slice=function(e,t){var r,n=this.length;if((e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e),It.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=It.prototype;else{var i=t-e;r=new It(i,void 0);for(var o=0;o<i;++o)r[o]=this[o+e]}return r},It.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||Gt(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n},It.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||Gt(e,t,this.length);for(var n=this[e+--t],i=1;t>0&&(i*=256);)n+=this[e+--t]*i;return n},It.prototype.readUInt8=function(e,t){return t||Gt(e,1,this.length),this[e]},It.prototype.readUInt16LE=function(e,t){return t||Gt(e,2,this.length),this[e]|this[e+1]<<8},It.prototype.readUInt16BE=function(e,t){return t||Gt(e,2,this.length),this[e]<<8|this[e+1]},It.prototype.readUInt32LE=function(e,t){return t||Gt(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},It.prototype.readUInt32BE=function(e,t){return t||Gt(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},It.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||Gt(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*t)),n},It.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||Gt(e,t,this.length);for(var n=t,i=1,o=this[e+--n];n>0&&(i*=256);)o+=this[e+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},It.prototype.readInt8=function(e,t){return t||Gt(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},It.prototype.readInt16LE=function(e,t){t||Gt(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},It.prototype.readInt16BE=function(e,t){t||Gt(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},It.prototype.readInt32LE=function(e,t){return t||Gt(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},It.prototype.readInt32BE=function(e,t){return t||Gt(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},It.prototype.readFloatLE=function(e,t){return t||Gt(e,4,this.length),mt(this,e,!0,23,4)},It.prototype.readFloatBE=function(e,t){return t||Gt(e,4,this.length),mt(this,e,!1,23,4)},It.prototype.readDoubleLE=function(e,t){return t||Gt(e,8,this.length),mt(this,e,!0,52,8)},It.prototype.readDoubleBE=function(e,t){return t||Gt(e,8,this.length),mt(this,e,!1,52,8)},It.prototype.writeUIntLE=function(e,t,r,n){(e=+e,t|=0,r|=0,n)||Kt(this,e,t,r,Math.pow(2,8*r)-1,0);var i=1,o=0;for(this[t]=255&e;++o<r&&(i*=256);)this[t+o]=e/i&255;return t+r},It.prototype.writeUIntBE=function(e,t,r,n){(e=+e,t|=0,r|=0,n)||Kt(this,e,t,r,Math.pow(2,8*r)-1,0);var i=r-1,o=1;for(this[t+i]=255&e;--i>=0&&(o*=256);)this[t+i]=e/o&255;return t+r},It.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,1,255,0),It.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},It.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,2,65535,0),It.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Wt(this,e,t,!0),t+2},It.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,2,65535,0),It.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Wt(this,e,t,!1),t+2},It.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,4,4294967295,0),It.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):Jt(this,e,t,!0),t+4},It.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,4,4294967295,0),It.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Jt(this,e,t,!1),t+4},It.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t|=0,!n){var i=Math.pow(2,8*r-1);Kt(this,e,t,r,i-1,-i)}var o=0,s=1,a=0;for(this[t]=255&e;++o<r&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s|0)-a&255;return t+r},It.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t|=0,!n){var i=Math.pow(2,8*r-1);Kt(this,e,t,r,i-1,-i)}var o=r-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s|0)-a&255;return t+r},It.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,1,127,-128),It.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},It.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,2,32767,-32768),It.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Wt(this,e,t,!0),t+2},It.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,2,32767,-32768),It.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Wt(this,e,t,!1),t+2},It.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,4,2147483647,-2147483648),It.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):Jt(this,e,t,!0),t+4},It.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||Kt(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),It.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Jt(this,e,t,!1),t+4},It.prototype.writeFloatLE=function(e,t,r){return Yt(this,e,t,!0,r)},It.prototype.writeFloatBE=function(e,t,r){return Yt(this,e,t,!1,r)},It.prototype.writeDoubleLE=function(e,t,r){return Xt(this,e,t,!0,r)},It.prototype.writeDoubleBE=function(e,t,r){return Xt(this,e,t,!1,r)},It.prototype.copy=function(e,t,r,n){if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var i,o=n-r;if(this===e&&r<t&&t<n)for(i=o-1;i>=0;--i)e[i+t]=this[i+r];else if(o<1e3||!It.TYPED_ARRAY_SUPPORT)for(i=0;i<o;++i)e[i+t]=this[i+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+o),t);return o},It.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!It.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var o;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(o=t;o<r;++o)this[o]=e;else{var s=St(e)?e:rr(new It(e,n).toString()),a=s.length;for(o=0;o<r-t;++o)this[o+t]=s[o%a]}return this};var er=/[^+\/0-9A-Za-z-_]/g;function tr(e){return e<16?"0"+e.toString(16):e.toString(16)}function rr(e,t){var r;t=t||1/0;for(var n=e.length,i=null,o=[],s=0;s<n;++s){if((r=e.charCodeAt(s))>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&o.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&o.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;o.push(r)}else if(r<2048){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function nr(e){return function(e){var t,r,n,i,o,s;ht||ft();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");o="="===e[a-2]?2:"="===e[a-1]?1:0,s=new lt(3*a/4-o),n=o>0?a-4:a;var c=0;for(t=0,r=0;t<n;t+=4,r+=3)i=ut[e.charCodeAt(t)]<<18|ut[e.charCodeAt(t+1)]<<12|ut[e.charCodeAt(t+2)]<<6|ut[e.charCodeAt(t+3)],s[c++]=i>>16&255,s[c++]=i>>8&255,s[c++]=255&i;return 2===o?(i=ut[e.charCodeAt(t)]<<2|ut[e.charCodeAt(t+1)]>>4,s[c++]=255&i):1===o&&(i=ut[e.charCodeAt(t)]<<10|ut[e.charCodeAt(t+1)]<<4|ut[e.charCodeAt(t+2)]>>2,s[c++]=i>>8&255,s[c++]=255&i),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(er,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function ir(e,t,r,n){for(var i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function or(e){return null!=e&&(!!e._isBuffer||sr(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&sr(e.slice(0,0))}(e))}function sr(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function ar(){throw new Error("setTimeout has not been defined")}function cr(){throw new Error("clearTimeout has not been defined")}var ur=ar,lr=cr;function hr(e){if(ur===setTimeout)return setTimeout(e,0);if((ur===ar||!ur)&&setTimeout)return ur=setTimeout,setTimeout(e,0);try{return ur(e,0)}catch(t){try{return ur.call(null,e,0)}catch(t){return ur.call(this,e,0)}}}"function"==typeof at.setTimeout&&(ur=setTimeout),"function"==typeof at.clearTimeout&&(lr=clearTimeout);var fr,dr=[],pr=!1,gr=-1;function mr(){pr&&fr&&(pr=!1,fr.length?dr=fr.concat(dr):gr=-1,dr.length&&yr())}function yr(){if(!pr){var e=hr(mr);pr=!0;for(var t=dr.length;t;){for(fr=dr,dr=[];++gr<t;)fr&&fr[gr].run();gr=-1,t=dr.length}fr=null,pr=!1,function(e){if(lr===clearTimeout)return clearTimeout(e);if((lr===cr||!lr)&&clearTimeout)return lr=clearTimeout,clearTimeout(e);try{return lr(e)}catch(t){try{return lr.call(null,e)}catch(t){return lr.call(this,e)}}}(e)}}function wr(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];dr.push(new br(e,t)),1!==dr.length||pr||hr(yr)}function br(e,t){this.fun=e,this.array=t}br.prototype.run=function(){this.fun.apply(null,this.array)};function vr(){}var Er=vr,Ir=vr,_r=vr,Ar=vr,kr=vr,Br=vr,xr=vr;var Sr=at.performance||{},Or=Sr.now||Sr.mozNow||Sr.msNow||Sr.oNow||Sr.webkitNow||function(){return(new Date).getTime()};var Ur=new Date;var Cr,Nr={nextTick:wr,title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:Er,addListener:Ir,once:_r,off:Ar,removeListener:kr,removeAllListeners:Br,emit:xr,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*Or.call(Sr),r=Math.floor(t),n=Math.floor(t%1*1e9);return e&&(r-=e[0],(n-=e[1])<0&&(r--,n+=1e9)),[r,n]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-Ur)/1e3}};Cr="function"==typeof Object.create?function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:function(e,t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e};var Rr=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),r={},n=0;n<t.length;n++)r[t[n]]=Object.getOwnPropertyDescriptor(e,t[n]);return r},Tr=/%[sdj%]/g;function Lr(e){if(!Zr(e)){for(var t=[],r=0;r<arguments.length;r++)t.push(Fr(arguments[r]));return t.join(" ")}r=1;for(var n=arguments,i=n.length,o=String(e).replace(Tr,function(e){if("%%"===e)return"%";if(r>=i)return e;switch(e){case"%s":return String(n[r++]);case"%d":return Number(n[r++]);case"%j":try{return JSON.stringify(n[r++])}catch(e){return"[Circular]"}default:return e}}),s=n[r];r<i;s=n[++r])Kr(s)||!tn(s)?o+=" "+s:o+=" "+Fr(s);return o}function Dr(e,t){if(Xr(at.process))return function(){return Dr(e,t).apply(this,arguments)};if(!0===Nr.noDeprecation)return e;var r=!1;return function(){if(!r){if(Nr.throwDeprecation)throw new Error(t);Nr.traceDeprecation?console.trace(t):console.error(t),r=!0}return e.apply(this,arguments)}}var jr,Mr={};function Pr(e){if(Xr(jr)&&(jr=Nr.env.NODE_DEBUG||""),e=e.toUpperCase(),!Mr[e])if(new RegExp("\\b"+e+"\\b","i").test(jr)){Mr[e]=function(){var t=Lr.apply(null,arguments);console.error("%s %d: %s",e,0,t)}}else Mr[e]=function(){};return Mr[e]}function Fr(e,t){var r={seen:[],stylize:Qr};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),Gr(t)?r.showHidden=t:t&&fn(r,t),Xr(r.showHidden)&&(r.showHidden=!1),Xr(r.depth)&&(r.depth=2),Xr(r.colors)&&(r.colors=!1),Xr(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=qr),zr(r,e,r.depth)}function qr(e,t){var r=Fr.styles[t];return r?"["+Fr.colors[r][0]+"m"+e+"["+Fr.colors[r][1]+"m":e}function Qr(e,t){return e}function zr(e,t,r){if(e.customInspect&&t&&on(t.inspect)&&t.inspect!==Fr&&(!t.constructor||t.constructor.prototype!==t)){var n=t.inspect(r,e);return Zr(n)||(n=zr(e,n,r)),n}var i=function(e,t){if(Xr(t))return e.stylize("undefined","undefined");if(Zr(t)){var r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(r,"string")}if(Jr(t))return e.stylize(""+t,"number");if(Gr(t))return e.stylize(""+t,"boolean");if(Kr(t))return e.stylize("null","null")}(e,t);if(i)return i;var o=Object.keys(t),s=function(e){var t={};return e.forEach(function(e,r){t[e]=!0}),t}(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(t)),nn(t)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return $r(t);if(0===o.length){if(on(t)){var a=t.name?": "+t.name:"";return e.stylize("[Function"+a+"]","special")}if(en(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(rn(t))return e.stylize(Date.prototype.toString.call(t),"date");if(nn(t))return $r(t)}var c,u="",l=!1,h=["{","}"];(Vr(t)&&(l=!0,h=["[","]"]),on(t))&&(u=" [Function"+(t.name?": "+t.name:"")+"]");return en(t)&&(u=" "+RegExp.prototype.toString.call(t)),rn(t)&&(u=" "+Date.prototype.toUTCString.call(t)),nn(t)&&(u=" "+$r(t)),0!==o.length||l&&0!=t.length?r<0?en(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),c=l?function(e,t,r,n,i){for(var o=[],s=0,a=t.length;s<a;++s)dn(t,String(s))?o.push(Hr(e,t,r,n,String(s),!0)):o.push("");return i.forEach(function(i){i.match(/^\d+$/)||o.push(Hr(e,t,r,n,i,!0))}),o}(e,t,r,s,o):o.map(function(n){return Hr(e,t,r,s,n,l)}),e.seen.pop(),function(e,t,r){var n=e.reduce(function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(n>60)return r[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+r[1];return r[0]+t+" "+e.join(", ")+" "+r[1]}(c,u,h)):h[0]+u+h[1]}function $r(e){return"["+Error.prototype.toString.call(e)+"]"}function Hr(e,t,r,n,i,o){var s,a,c;if((c=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?a=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(a=e.stylize("[Setter]","special")),dn(n,i)||(s="["+i+"]"),a||(e.seen.indexOf(c.value)<0?(a=Kr(r)?zr(e,c.value,null):zr(e,c.value,r-1)).indexOf("\n")>-1&&(a=o?a.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+a.split("\n").map(function(e){return"   "+e}).join("\n")):a=e.stylize("[Circular]","special")),Xr(s)){if(o&&i.match(/^\d+$/))return a;(s=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+a}function Vr(e){return Array.isArray(e)}function Gr(e){return"boolean"==typeof e}function Kr(e){return null===e}function Wr(e){return null==e}function Jr(e){return"number"==typeof e}function Zr(e){return"string"==typeof e}function Yr(e){return"symbol"==typeof e}function Xr(e){return void 0===e}function en(e){return tn(e)&&"[object RegExp]"===cn(e)}function tn(e){return"object"==typeof e&&null!==e}function rn(e){return tn(e)&&"[object Date]"===cn(e)}function nn(e){return tn(e)&&("[object Error]"===cn(e)||e instanceof Error)}function on(e){return"function"==typeof e}function sn(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function an(e){return It.isBuffer(e)}function cn(e){return Object.prototype.toString.call(e)}function un(e){return e<10?"0"+e.toString(10):e.toString(10)}Fr.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},Fr.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};var ln=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function hn(){var e,t;console.log("%s - %s",(e=new Date,t=[un(e.getHours()),un(e.getMinutes()),un(e.getSeconds())].join(":"),[e.getDate(),ln[e.getMonth()],t].join(" ")),Lr.apply(null,arguments))}function fn(e,t){if(!t||!tn(t))return e;for(var r=Object.keys(t),n=r.length;n--;)e[r[n]]=t[r[n]];return e}function dn(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var pn="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function gn(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(pn&&e[pn]){var t;if("function"!=typeof(t=e[pn]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,pn,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,r,n=new Promise(function(e,n){t=e,r=n}),i=[],o=0;o<arguments.length;o++)i.push(arguments[o]);i.push(function(e,n){e?r(e):t(n)});try{e.apply(this,i)}catch(e){r(e)}return n}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),pn&&Object.defineProperty(t,pn,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,Rr(e))}function mn(e,t){if(!e){var r=new Error("Promise was rejected with a falsy value");r.reason=e,e=r}return t(e)}function yn(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');function t(){for(var t=[],r=0;r<arguments.length;r++)t.push(arguments[r]);var n=t.pop();if("function"!=typeof n)throw new TypeError("The last argument must be of type Function");var i=this,o=function(){return n.apply(i,arguments)};e.apply(this,t).then(function(e){Nr.nextTick(o.bind(null,null,e))},function(e){Nr.nextTick(mn.bind(null,e,o))})}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),Object.defineProperties(t,Rr(e)),t}gn.custom=pn;var wn={inherits:Cr,_extend:fn,log:hn,isBuffer:an,isPrimitive:sn,isFunction:on,isError:nn,isDate:rn,isObject:tn,isRegExp:en,isUndefined:Xr,isSymbol:Yr,isString:Zr,isNumber:Jr,isNullOrUndefined:Wr,isNull:Kr,isBoolean:Gr,isArray:Vr,inspect:Fr,deprecate:Dr,format:Lr,debuglog:Pr,promisify:gn,callbackify:yn},bn=Object.freeze({__proto__:null,_extend:fn,callbackify:yn,debuglog:Pr,default:wn,deprecate:Dr,format:Lr,inherits:Cr,inspect:Fr,isArray:Vr,isBoolean:Gr,isBuffer:an,isDate:rn,isError:nn,isFunction:on,isNull:Kr,isNullOrUndefined:Wr,isNumber:Jr,isObject:tn,isPrimitive:sn,isRegExp:en,isString:Zr,isSymbol:Yr,isUndefined:Xr,log:hn,promisify:gn});function vn(){this.head=null,this.tail=null,this.length=0}vn.prototype.push=function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length},vn.prototype.unshift=function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length},vn.prototype.shift=function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}},vn.prototype.clear=function(){this.head=this.tail=null,this.length=0},vn.prototype.join=function(e){if(0===this.length)return"";for(var t=this.head,r=""+t.data;t=t.next;)r+=e+t.data;return r},vn.prototype.concat=function(e){if(0===this.length)return It.alloc(0);if(1===this.length)return this.head.data;for(var t=It.allocUnsafe(e>>>0),r=this.head,n=0;r;)r.data.copy(t,n),n+=r.data.length,r=r.next;return t};var En=It.isEncoding||function(e){switch(e&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function In(e){switch(this.encoding=(e||"utf8").toLowerCase().replace(/[-_]/,""),function(e){if(e&&!En(e))throw new Error("Unknown encoding: "+e)}(e),this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2,this.detectIncompleteChar=An;break;case"base64":this.surrogateSize=3,this.detectIncompleteChar=kn;break;default:return void(this.write=_n)}this.charBuffer=new It(6),this.charReceived=0,this.charLength=0}function _n(e){return e.toString(this.encoding)}function An(e){this.charReceived=e.length%2,this.charLength=this.charReceived?2:0}function kn(e){this.charReceived=e.length%3,this.charLength=this.charReceived?3:0}In.prototype.write=function(e){for(var t="";this.charLength;){var r=e.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:e.length;if(e.copy(this.charBuffer,this.charReceived,0,r),this.charReceived+=r,this.charReceived<this.charLength)return"";if(e=e.slice(r,e.length),!((i=(t=this.charBuffer.slice(0,this.charLength).toString(this.encoding)).charCodeAt(t.length-1))>=55296&&i<=56319)){if(this.charReceived=this.charLength=0,0===e.length)return t;break}this.charLength+=this.surrogateSize,t=""}this.detectIncompleteChar(e);var n=e.length;this.charLength&&(e.copy(this.charBuffer,0,e.length-this.charReceived,n),n-=this.charReceived);var i;n=(t+=e.toString(this.encoding,0,n)).length-1;if((i=t.charCodeAt(n))>=55296&&i<=56319){var o=this.surrogateSize;return this.charLength+=o,this.charReceived+=o,this.charBuffer.copy(this.charBuffer,o,0,o),e.copy(this.charBuffer,0,0,o),t.substring(0,n)}return t},In.prototype.detectIncompleteChar=function(e){for(var t=e.length>=3?3:e.length;t>0;t--){var r=e[e.length-t];if(1==t&&r>>5==6){this.charLength=2;break}if(t<=2&&r>>4==14){this.charLength=3;break}if(t<=3&&r>>3==30){this.charLength=4;break}}this.charReceived=t},In.prototype.end=function(e){var t="";if(e&&e.length&&(t=this.write(e)),this.charReceived){var r=this.charReceived,n=this.charBuffer,i=this.encoding;t+=n.slice(0,r).toString(i)}return t},Sn.ReadableState=xn;var Bn=Pr("stream");function xn(e,t){e=e||{},this.objectMode=!!e.objectMode,t instanceof ri&&(this.objectMode=this.objectMode||!!e.readableObjectMode);var r=e.highWaterMark,n=this.objectMode?16:16384;this.highWaterMark=r||0===r?r:n,this.highWaterMark=~~this.highWaterMark,this.buffer=new vn,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(this.decoder=new In(e.encoding),this.encoding=e.encoding)}function Sn(e){if(!(this instanceof Sn))return new Sn(e);this._readableState=new xn(e,this),this.readable=!0,e&&"function"==typeof e.read&&(this._read=e.read),qe.call(this)}function On(e,t,r,n,i){var o=function(e,t){var r=null;It.isBuffer(t)||"string"==typeof t||null==t||e.objectMode||(r=new TypeError("Invalid non-string/buffer chunk"));return r}(t,r);if(o)e.emit("error",o);else if(null===r)t.reading=!1,function(e,t){if(t.ended)return;if(t.decoder){var r=t.decoder.end();r&&r.length&&(t.buffer.push(r),t.length+=t.objectMode?1:r.length)}t.ended=!0,Nn(e)}(e,t);else if(t.objectMode||r&&r.length>0)if(t.ended&&!i){var s=new Error("stream.push() after EOF");e.emit("error",s)}else if(t.endEmitted&&i){var a=new Error("stream.unshift() after end event");e.emit("error",a)}else{var c;!t.decoder||i||n||(r=t.decoder.write(r),c=!t.objectMode&&0===r.length),i||(t.reading=!1),c||(t.flowing&&0===t.length&&!t.sync?(e.emit("data",r),e.read(0)):(t.length+=t.objectMode?1:r.length,i?t.buffer.unshift(r):t.buffer.push(r),t.needReadable&&Nn(e))),function(e,t){t.readingMore||(t.readingMore=!0,wr(Tn,e,t))}(e,t)}else i||(t.reading=!1);return function(e){return!e.ended&&(e.needReadable||e.length<e.highWaterMark||0===e.length)}(t)}Cr(Sn,qe),Sn.prototype.push=function(e,t){var r=this._readableState;return r.objectMode||"string"!=typeof e||(t=t||r.defaultEncoding)!==r.encoding&&(e=It.from(e,t),t=""),On(this,r,e,t,!1)},Sn.prototype.unshift=function(e){return On(this,this._readableState,e,"",!0)},Sn.prototype.isPaused=function(){return!1===this._readableState.flowing},Sn.prototype.setEncoding=function(e){return this._readableState.decoder=new In(e),this._readableState.encoding=e,this};var Un=8388608;function Cn(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=function(e){return e>=Un?e=Un:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function Nn(e){var t=e._readableState;t.needReadable=!1,t.emittedReadable||(Bn("emitReadable",t.flowing),t.emittedReadable=!0,t.sync?wr(Rn,e):Rn(e))}function Rn(e){Bn("emit readable"),e.emit("readable"),jn(e)}function Tn(e,t){for(var r=t.length;!t.reading&&!t.flowing&&!t.ended&&t.length<t.highWaterMark&&(Bn("maybeReadMore read 0"),e.read(0),r!==t.length);)r=t.length;t.readingMore=!1}function Ln(e){Bn("readable nexttick read 0"),e.read(0)}function Dn(e,t){t.reading||(Bn("resume read 0"),e.read(0)),t.resumeScheduled=!1,t.awaitDrain=0,e.emit("resume"),jn(e),t.flowing&&!t.reading&&e.read(0)}function jn(e){var t=e._readableState;for(Bn("flow",t.flowing);t.flowing&&null!==e.read(););}function Mn(e,t){return 0===t.length?null:(t.objectMode?r=t.buffer.shift():!e||e>=t.length?(r=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.head.data:t.buffer.concat(t.length),t.buffer.clear()):r=function(e,t,r){var n;e<t.head.data.length?(n=t.head.data.slice(0,e),t.head.data=t.head.data.slice(e)):n=e===t.head.data.length?t.shift():r?function(e,t){var r=t.head,n=1,i=r.data;e-=i.length;for(;r=r.next;){var o=r.data,s=e>o.length?o.length:e;if(s===o.length?i+=o:i+=o.slice(0,e),0===(e-=s)){s===o.length?(++n,r.next?t.head=r.next:t.head=t.tail=null):(t.head=r,r.data=o.slice(s));break}++n}return t.length-=n,i}(e,t):function(e,t){var r=It.allocUnsafe(e),n=t.head,i=1;n.data.copy(r),e-=n.data.length;for(;n=n.next;){var o=n.data,s=e>o.length?o.length:e;if(o.copy(r,r.length-e,0,s),0===(e-=s)){s===o.length?(++i,n.next?t.head=n.next:t.head=t.tail=null):(t.head=n,n.data=o.slice(s));break}++i}return t.length-=i,r}(e,t);return n}(e,t.buffer,t.decoder),r);var r}function Pn(e){var t=e._readableState;if(t.length>0)throw new Error('"endReadable()" called on non-empty stream');t.endEmitted||(t.ended=!0,wr(Fn,t,e))}function Fn(e,t){e.endEmitted||0!==e.length||(e.endEmitted=!0,t.readable=!1,t.emit("end"))}function qn(e,t){for(var r=0,n=e.length;r<n;r++)if(e[r]===t)return r;return-1}function Qn(){}function zn(e,t,r){this.chunk=e,this.encoding=t,this.callback=r,this.next=null}function $n(e,t){Object.defineProperty(this,"buffer",{get:Dr(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.")}),e=e||{},this.objectMode=!!e.objectMode,t instanceof ri&&(this.objectMode=this.objectMode||!!e.writableObjectMode);var r=e.highWaterMark,n=this.objectMode?16:16384;this.highWaterMark=r||0===r?r:n,this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var i=!1===e.decodeStrings;this.decodeStrings=!i,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var r=e._writableState,n=r.sync,i=r.writecb;if(function(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}(r),t)!function(e,t,r,n,i){--t.pendingcb,r?wr(i,n):i(n);e._writableState.errorEmitted=!0,e.emit("error",n)}(e,r,n,t,i);else{var o=Wn(r);o||r.corked||r.bufferProcessing||!r.bufferedRequest||Kn(e,r),n?wr(Gn,e,r,o,i):Gn(e,r,o,i)}}(t,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new Yn(this)}function Hn(e){if(!(this instanceof Hn||this instanceof ri))return new Hn(e);this._writableState=new $n(e,this),this.writable=!0,e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev)),qe.call(this)}function Vn(e,t,r,n,i,o,s){t.writelen=n,t.writecb=s,t.writing=!0,t.sync=!0,r?e._writev(i,t.onwrite):e._write(i,o,t.onwrite),t.sync=!1}function Gn(e,t,r,n){r||function(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}(e,t),t.pendingcb--,n(),Zn(e,t)}function Kn(e,t){t.bufferProcessing=!0;var r=t.bufferedRequest;if(e._writev&&r&&r.next){var n=t.bufferedRequestCount,i=new Array(n),o=t.corkedRequestsFree;o.entry=r;for(var s=0;r;)i[s]=r,r=r.next,s+=1;Vn(e,t,!0,t.length,i,"",o.finish),t.pendingcb++,t.lastBufferedRequest=null,o.next?(t.corkedRequestsFree=o.next,o.next=null):t.corkedRequestsFree=new Yn(t)}else{for(;r;){var a=r.chunk,c=r.encoding,u=r.callback;if(Vn(e,t,!1,t.objectMode?1:a.length,a,c,u),r=r.next,t.writing)break}null===r&&(t.lastBufferedRequest=null)}t.bufferedRequestCount=0,t.bufferedRequest=r,t.bufferProcessing=!1}function Wn(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function Jn(e,t){t.prefinished||(t.prefinished=!0,e.emit("prefinish"))}function Zn(e,t){var r=Wn(t);return r&&(0===t.pendingcb?(Jn(e,t),t.finished=!0,e.emit("finish")):Jn(e,t)),r}function Yn(e){var t=this;this.next=null,this.entry=null,this.finish=function(r){var n=t.entry;for(t.entry=null;n;){var i=n.callback;e.pendingcb--,i(r),n=n.next}e.corkedRequestsFree?e.corkedRequestsFree.next=t:e.corkedRequestsFree=t}}Sn.prototype.read=function(e){Bn("read",e),e=parseInt(e,10);var t=this._readableState,r=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&(t.length>=t.highWaterMark||t.ended))return Bn("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?Pn(this):Nn(this),null;if(0===(e=Cn(e,t))&&t.ended)return 0===t.length&&Pn(this),null;var n,i=t.needReadable;return Bn("need readable",i),(0===t.length||t.length-e<t.highWaterMark)&&Bn("length less than watermark",i=!0),t.ended||t.reading?Bn("reading or ended",i=!1):i&&(Bn("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=Cn(r,t))),null===(n=e>0?Mn(e,t):null)?(t.needReadable=!0,e=0):t.length-=e,0===t.length&&(t.ended||(t.needReadable=!0),r!==e&&t.ended&&Pn(this)),null!==n&&this.emit("data",n),n},Sn.prototype._read=function(e){this.emit("error",new Error("not implemented"))},Sn.prototype.pipe=function(e,t){var r=this,n=this._readableState;switch(n.pipesCount){case 0:n.pipes=e;break;case 1:n.pipes=[n.pipes,e];break;default:n.pipes.push(e)}n.pipesCount+=1,Bn("pipe count=%d opts=%j",n.pipesCount,t);var i=!t||!1!==t.end?s:u;function o(e){Bn("onunpipe"),e===r&&u()}function s(){Bn("onend"),e.end()}n.endEmitted?wr(i):r.once("end",i),e.on("unpipe",o);var a=function(e){return function(){var t=e._readableState;Bn("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&e.listeners("data").length&&(t.flowing=!0,jn(e))}}(r);e.on("drain",a);var c=!1;function u(){Bn("cleanup"),e.removeListener("close",d),e.removeListener("finish",p),e.removeListener("drain",a),e.removeListener("error",f),e.removeListener("unpipe",o),r.removeListener("end",s),r.removeListener("end",u),r.removeListener("data",h),c=!0,!n.awaitDrain||e._writableState&&!e._writableState.needDrain||a()}var l=!1;function h(t){Bn("ondata"),l=!1,!1!==e.write(t)||l||((1===n.pipesCount&&n.pipes===e||n.pipesCount>1&&-1!==qn(n.pipes,e))&&!c&&(Bn("false write response, pause",r._readableState.awaitDrain),r._readableState.awaitDrain++,l=!0),r.pause())}function f(t){Bn("onerror",t),g(),e.removeListener("error",f),0===function(e,t){return e.listeners(t).length}(e,"error")&&e.emit("error",t)}function d(){e.removeListener("finish",p),g()}function p(){Bn("onfinish"),e.removeListener("close",d),g()}function g(){Bn("unpipe"),r.unpipe(e)}return r.on("data",h),function(e,t,r){if("function"==typeof e.prependListener)return e.prependListener(t,r);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(r):e._events[t]=[r,e._events[t]]:e.on(t,r)}(e,"error",f),e.once("close",d),e.once("finish",p),e.emit("pipe",r),n.flowing||(Bn("pipe resume"),r.resume()),e},Sn.prototype.unpipe=function(e){var t=this._readableState;if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this)),this;if(!e){var r=t.pipes,n=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var i=0;i<n;i++)r[i].emit("unpipe",this);return this}var o=qn(t.pipes,e);return-1===o||(t.pipes.splice(o,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this)),this},Sn.prototype.on=function(e,t){var r=qe.prototype.on.call(this,e,t);if("data"===e)!1!==this._readableState.flowing&&this.resume();else if("readable"===e){var n=this._readableState;n.endEmitted||n.readableListening||(n.readableListening=n.needReadable=!0,n.emittedReadable=!1,n.reading?n.length&&Nn(this):wr(Ln,this))}return r},Sn.prototype.addListener=Sn.prototype.on,Sn.prototype.resume=function(){var e=this._readableState;return e.flowing||(Bn("resume"),e.flowing=!0,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,wr(Dn,e,t))}(this,e)),this},Sn.prototype.pause=function(){return Bn("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(Bn("pause"),this._readableState.flowing=!1,this.emit("pause")),this},Sn.prototype.wrap=function(e){var t=this._readableState,r=!1,n=this;for(var i in e.on("end",function(){if(Bn("wrapped end"),t.decoder&&!t.ended){var e=t.decoder.end();e&&e.length&&n.push(e)}n.push(null)}),e.on("data",function(i){(Bn("wrapped data"),t.decoder&&(i=t.decoder.write(i)),t.objectMode&&null==i)||(t.objectMode||i&&i.length)&&(n.push(i)||(r=!0,e.pause()))}),e)void 0===this[i]&&"function"==typeof e[i]&&(this[i]=function(t){return function(){return e[t].apply(e,arguments)}}(i));return function(e,t){for(var r=0,n=e.length;r<n;r++)t(e[r],r)}(["error","close","destroy","pause","resume"],function(t){e.on(t,n.emit.bind(n,t))}),n._read=function(t){Bn("wrapped _read",t),r&&(r=!1,e.resume())},n},Sn._fromList=Mn,Hn.WritableState=$n,Cr(Hn,qe),$n.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},Hn.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))},Hn.prototype.write=function(e,t,r){var n=this._writableState,i=!1;return"function"==typeof t&&(r=t,t=null),It.isBuffer(e)?t="buffer":t||(t=n.defaultEncoding),"function"!=typeof r&&(r=Qn),n.ended?function(e,t){var r=new Error("write after end");e.emit("error",r),wr(t,r)}(this,r):function(e,t,r,n){var i=!0,o=!1;return null===r?o=new TypeError("May not write null values to stream"):It.isBuffer(r)||"string"==typeof r||void 0===r||t.objectMode||(o=new TypeError("Invalid non-string/buffer chunk")),o&&(e.emit("error",o),wr(n,o),i=!1),i}(this,n,e,r)&&(n.pendingcb++,i=function(e,t,r,n,i){r=function(e,t,r){e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=It.from(t,r));return t}(t,r,n),It.isBuffer(r)&&(n="buffer");var o=t.objectMode?1:r.length;t.length+=o;var s=t.length<t.highWaterMark;s||(t.needDrain=!0);if(t.writing||t.corked){var a=t.lastBufferedRequest;t.lastBufferedRequest=new zn(r,n,i),a?a.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else Vn(e,t,!1,o,r,n,i);return s}(this,n,e,t,r)),i},Hn.prototype.cork=function(){this._writableState.corked++},Hn.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.finished||e.bufferProcessing||!e.bufferedRequest||Kn(this,e))},Hn.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+e);return this._writableState.defaultEncoding=e,this},Hn.prototype._write=function(e,t,r){r(new Error("not implemented"))},Hn.prototype._writev=null,Hn.prototype.end=function(e,t,r){var n=this._writableState;"function"==typeof e?(r=e,e=null,t=null):"function"==typeof t&&(r=t,t=null),null!=e&&this.write(e,t),n.corked&&(n.corked=1,this.uncork()),n.ending||n.finished||function(e,t,r){t.ending=!0,Zn(e,t),r&&(t.finished?wr(r):e.once("finish",r));t.ended=!0,e.writable=!1}(this,n,r)},Cr(ri,Sn);for(var Xn=Object.keys(Hn.prototype),ei=0;ei<Xn.length;ei++){var ti=Xn[ei];ri.prototype[ti]||(ri.prototype[ti]=Hn.prototype[ti])}function ri(e){if(!(this instanceof ri))return new ri(e);Sn.call(this,e),Hn.call(this,e),e&&!1===e.readable&&(this.readable=!1),e&&!1===e.writable&&(this.writable=!1),this.allowHalfOpen=!0,e&&!1===e.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",ni)}function ni(){this.allowHalfOpen||this._writableState.ended||wr(ii,this)}function ii(e){e.end()}function oi(e){this.afterTransform=function(t,r){return function(e,t,r){var n=e._transformState;n.transforming=!1;var i=n.writecb;if(!i)return e.emit("error",new Error("no writecb in Transform class"));n.writechunk=null,n.writecb=null,null!=r&&e.push(r);i(t);var o=e._readableState;o.reading=!1,(o.needReadable||o.length<o.highWaterMark)&&e._read(o.highWaterMark)}(e,t,r)},this.needTransform=!1,this.transforming=!1,this.writecb=null,this.writechunk=null,this.writeencoding=null}function si(e){if(!(this instanceof si))return new si(e);ri.call(this,e),this._transformState=new oi(this);var t=this;this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.once("prefinish",function(){"function"==typeof this._flush?this._flush(function(e){ai(t,e)}):ai(t)})}function ai(e,t){if(t)return e.emit("error",t);var r=e._writableState,n=e._transformState;if(r.length)throw new Error("Calling transform done when ws.length != 0");if(n.transforming)throw new Error("Calling transform done when still transforming");return e.push(null)}function ci(e){if(!(this instanceof ci))return new ci(e);si.call(this,e)}function ui(){qe.call(this)}Cr(si,ri),si.prototype.push=function(e,t){return this._transformState.needTransform=!1,ri.prototype.push.call(this,e,t)},si.prototype._transform=function(e,t,r){throw new Error("Not implemented")},si.prototype._write=function(e,t,r){var n=this._transformState;if(n.writecb=r,n.writechunk=e,n.writeencoding=t,!n.transforming){var i=this._readableState;(n.needTransform||i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}},si.prototype._read=function(e){var t=this._transformState;null!==t.writechunk&&t.writecb&&!t.transforming?(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform)):t.needTransform=!0},Cr(ci,si),ci.prototype._transform=function(e,t,r){r(null,e)},Cr(ui,qe),ui.Readable=Sn,ui.Writable=Hn,ui.Duplex=ri,ui.Transform=si,ui.PassThrough=ci,ui.Stream=ui,ui.prototype.pipe=function(e,t){var r=this;function n(t){e.writable&&!1===e.write(t)&&r.pause&&r.pause()}function i(){r.readable&&r.resume&&r.resume()}r.on("data",n),e.on("drain",i),e._isStdio||t&&!1===t.end||(r.on("end",s),r.on("close",a));var o=!1;function s(){o||(o=!0,e.end())}function a(){o||(o=!0,"function"==typeof e.destroy&&e.destroy())}function c(e){if(u(),0===qe.listenerCount(this,"error"))throw e}function u(){r.removeListener("data",n),e.removeListener("drain",i),r.removeListener("end",s),r.removeListener("close",a),r.removeListener("error",c),e.removeListener("error",c),r.removeListener("end",u),r.removeListener("close",u),e.removeListener("close",u)}return r.on("error",c),e.on("error",c),r.on("end",u),r.on("close",u),e.on("close",u),e.emit("pipe",r),e};var li=Object.freeze({__proto__:null,Duplex:ri,PassThrough:ci,Readable:Sn,Stream:ui,Transform:si,Writable:Hn,default:ui}),hi={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};function fi(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function di(e,t,r,n,i){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+n),i);else for(var o=0;o<n;o++)e[i+o]=t[r+o]}var pi=Uint8Array,gi=Uint16Array,mi=Int32Array;function yi(e){for(var t=e.length;--t>=0;)e[t]=0}var wi=256,bi=286,vi=30,Ei=15,Ii=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],_i=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Ai=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],ki=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Bi=new Array(576);yi(Bi);var xi=new Array(60);yi(xi);var Si=new Array(512);yi(Si);var Oi=new Array(256);yi(Oi);var Ui=new Array(29);yi(Ui);var Ci,Ni,Ri,Ti=new Array(vi);function Li(e,t,r,n,i){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=n,this.max_length=i,this.has_stree=e&&e.length}function Di(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function ji(e){return e<256?Si[e]:Si[256+(e>>>7)]}function Mi(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function Pi(e,t,r){e.bi_valid>16-r?(e.bi_buf|=t<<e.bi_valid&65535,Mi(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=r-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)}function Fi(e,t,r){Pi(e,r[2*t],r[2*t+1])}function qi(e,t){var r=0;do{r|=1&e,e>>>=1,r<<=1}while(--t>0);return r>>>1}function Qi(e,t,r){var n,i,o=new Array(16),s=0;for(n=1;n<=Ei;n++)o[n]=s=s+r[n-1]<<1;for(i=0;i<=t;i++){var a=e[2*i+1];0!==a&&(e[2*i]=qi(o[a]++,a))}}function zi(e){var t;for(t=0;t<bi;t++)e.dyn_ltree[2*t]=0;for(t=0;t<vi;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function $i(e){e.bi_valid>8?Mi(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function Hi(e,t,r,n){var i=2*t,o=2*r;return e[i]<e[o]||e[i]===e[o]&&n[t]<=n[r]}function Vi(e,t,r){for(var n=e.heap[r],i=r<<1;i<=e.heap_len&&(i<e.heap_len&&Hi(t,e.heap[i+1],e.heap[i],e.depth)&&i++,!Hi(t,n,e.heap[i],e.depth));)e.heap[r]=e.heap[i],r=i,i<<=1;e.heap[r]=n}function Gi(e,t,r){var n,i,o,s,a=0;if(0!==e.last_lit)do{n=e.pending_buf[e.d_buf+2*a]<<8|e.pending_buf[e.d_buf+2*a+1],i=e.pending_buf[e.l_buf+a],a++,0===n?Fi(e,i,t):(Fi(e,(o=Oi[i])+wi+1,t),0!==(s=Ii[o])&&Pi(e,i-=Ui[o],s),Fi(e,o=ji(--n),r),0!==(s=_i[o])&&Pi(e,n-=Ti[o],s))}while(a<e.last_lit);Fi(e,256,t)}function Ki(e,t){var r,n,i,o=t.dyn_tree,s=t.stat_desc.static_tree,a=t.stat_desc.has_stree,c=t.stat_desc.elems,u=-1;for(e.heap_len=0,e.heap_max=573,r=0;r<c;r++)0!==o[2*r]?(e.heap[++e.heap_len]=u=r,e.depth[r]=0):o[2*r+1]=0;for(;e.heap_len<2;)o[2*(i=e.heap[++e.heap_len]=u<2?++u:0)]=1,e.depth[i]=0,e.opt_len--,a&&(e.static_len-=s[2*i+1]);for(t.max_code=u,r=e.heap_len>>1;r>=1;r--)Vi(e,o,r);i=c;do{r=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Vi(e,o,1),n=e.heap[1],e.heap[--e.heap_max]=r,e.heap[--e.heap_max]=n,o[2*i]=o[2*r]+o[2*n],e.depth[i]=(e.depth[r]>=e.depth[n]?e.depth[r]:e.depth[n])+1,o[2*r+1]=o[2*n+1]=i,e.heap[1]=i++,Vi(e,o,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var r,n,i,o,s,a,c=t.dyn_tree,u=t.max_code,l=t.stat_desc.static_tree,h=t.stat_desc.has_stree,f=t.stat_desc.extra_bits,d=t.stat_desc.extra_base,p=t.stat_desc.max_length,g=0;for(o=0;o<=Ei;o++)e.bl_count[o]=0;for(c[2*e.heap[e.heap_max]+1]=0,r=e.heap_max+1;r<573;r++)(o=c[2*c[2*(n=e.heap[r])+1]+1]+1)>p&&(o=p,g++),c[2*n+1]=o,n>u||(e.bl_count[o]++,s=0,n>=d&&(s=f[n-d]),a=c[2*n],e.opt_len+=a*(o+s),h&&(e.static_len+=a*(l[2*n+1]+s)));if(0!==g){do{for(o=p-1;0===e.bl_count[o];)o--;e.bl_count[o]--,e.bl_count[o+1]+=2,e.bl_count[p]--,g-=2}while(g>0);for(o=p;0!==o;o--)for(n=e.bl_count[o];0!==n;)(i=e.heap[--r])>u||(c[2*i+1]!==o&&(e.opt_len+=(o-c[2*i+1])*c[2*i],c[2*i+1]=o),n--)}}(e,t),Qi(o,u,e.bl_count)}function Wi(e,t,r){var n,i,o=-1,s=t[1],a=0,c=7,u=4;for(0===s&&(c=138,u=3),t[2*(r+1)+1]=65535,n=0;n<=r;n++)i=s,s=t[2*(n+1)+1],++a<c&&i===s||(a<u?e.bl_tree[2*i]+=a:0!==i?(i!==o&&e.bl_tree[2*i]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,o=i,0===s?(c=138,u=3):i===s?(c=6,u=3):(c=7,u=4))}function Ji(e,t,r){var n,i,o=-1,s=t[1],a=0,c=7,u=4;for(0===s&&(c=138,u=3),n=0;n<=r;n++)if(i=s,s=t[2*(n+1)+1],!(++a<c&&i===s)){if(a<u)do{Fi(e,i,e.bl_tree)}while(0!==--a);else 0!==i?(i!==o&&(Fi(e,i,e.bl_tree),a--),Fi(e,16,e.bl_tree),Pi(e,a-3,2)):a<=10?(Fi(e,17,e.bl_tree),Pi(e,a-3,3)):(Fi(e,18,e.bl_tree),Pi(e,a-11,7));a=0,o=i,0===s?(c=138,u=3):i===s?(c=6,u=3):(c=7,u=4)}}yi(Ti);var Zi=!1;function Yi(e){Zi||(!function(){var e,t,r,n,i,o=new Array(16);for(r=0,n=0;n<28;n++)for(Ui[n]=r,e=0;e<1<<Ii[n];e++)Oi[r++]=n;for(Oi[r-1]=n,i=0,n=0;n<16;n++)for(Ti[n]=i,e=0;e<1<<_i[n];e++)Si[i++]=n;for(i>>=7;n<vi;n++)for(Ti[n]=i<<7,e=0;e<1<<_i[n]-7;e++)Si[256+i++]=n;for(t=0;t<=Ei;t++)o[t]=0;for(e=0;e<=143;)Bi[2*e+1]=8,e++,o[8]++;for(;e<=255;)Bi[2*e+1]=9,e++,o[9]++;for(;e<=279;)Bi[2*e+1]=7,e++,o[7]++;for(;e<=287;)Bi[2*e+1]=8,e++,o[8]++;for(Qi(Bi,287,o),e=0;e<vi;e++)xi[2*e+1]=5,xi[2*e]=qi(e,5);Ci=new Li(Bi,Ii,257,bi,Ei),Ni=new Li(xi,_i,0,vi,Ei),Ri=new Li(new Array(0),Ai,0,19,7)}(),Zi=!0),e.l_desc=new Di(e.dyn_ltree,Ci),e.d_desc=new Di(e.dyn_dtree,Ni),e.bl_desc=new Di(e.bl_tree,Ri),e.bi_buf=0,e.bi_valid=0,zi(e)}function Xi(e,t,r,n){Pi(e,0+(n?1:0),3),function(e,t,r){$i(e),Mi(e,r),Mi(e,~r),di(e.pending_buf,e.window,t,r,e.pending),e.pending+=r}(e,t,r)}function eo(e){Pi(e,2,3),Fi(e,256,Bi),function(e){16===e.bi_valid?(Mi(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}function to(e,t,r,n){var i,o,s=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<wi;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),Ki(e,e.l_desc),Ki(e,e.d_desc),s=function(e){var t;for(Wi(e,e.dyn_ltree,e.l_desc.max_code),Wi(e,e.dyn_dtree,e.d_desc.max_code),Ki(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*ki[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),i=e.opt_len+3+7>>>3,(o=e.static_len+3+7>>>3)<=i&&(i=o)):i=o=r+5,r+4<=i&&-1!==t?Xi(e,t,r,n):4===e.strategy||o===i?(Pi(e,2+(n?1:0),3),Gi(e,Bi,xi)):(Pi(e,4+(n?1:0),3),function(e,t,r,n){var i;for(Pi(e,t-257,5),Pi(e,r-1,5),Pi(e,n-4,4),i=0;i<n;i++)Pi(e,e.bl_tree[2*ki[i]+1],3);Ji(e,e.dyn_ltree,t-1),Ji(e,e.dyn_dtree,r-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),Gi(e,e.dyn_ltree,e.dyn_dtree)),zi(e),n&&$i(e)}function ro(e,t,r){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&r,e.last_lit++,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(Oi[r]+wi+1)]++,e.dyn_dtree[2*ji(t)]++),e.last_lit===e.lit_bufsize-1}function no(e,t,r,n){for(var i=65535&e,o=e>>>16&65535,s=0;0!==r;){r-=s=r>2e3?2e3:r;do{o=o+(i=i+t[n++]|0)|0}while(--s);i%=65521,o%=65521}return i|o<<16}var io=function(){for(var e,t=[],r=0;r<256;r++){e=r;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();function oo(e,t,r,n){var i=io,o=n+r;e^=-1;for(var s=n;s<o;s++)e=e>>>8^i[255&(e^t[s])];return-1^e}var so,ao=-2,co=258,uo=262,lo=103,ho=113,fo=666;function po(e,t){return e.msg=hi[t],t}function go(e){return(e<<1)-(e>4?9:0)}function mo(e){for(var t=e.length;--t>=0;)e[t]=0}function yo(e){var t=e.state,r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(di(e.output,t.pending_buf,t.pending_out,r,e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))}function wo(e,t){to(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,yo(e.strm)}function bo(e,t){e.pending_buf[e.pending++]=t}function vo(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function Eo(e,t,r,n){var i=e.avail_in;return i>n&&(i=n),0===i?0:(e.avail_in-=i,di(t,e.input,e.next_in,i,r),1===e.state.wrap?e.adler=no(e.adler,t,i,r):2===e.state.wrap&&(e.adler=oo(e.adler,t,i,r)),e.next_in+=i,e.total_in+=i,i)}function Io(e,t){var r,n,i=e.max_chain_length,o=e.strstart,s=e.prev_length,a=e.nice_match,c=e.strstart>e.w_size-uo?e.strstart-(e.w_size-uo):0,u=e.window,l=e.w_mask,h=e.prev,f=e.strstart+co,d=u[o+s-1],p=u[o+s];e.prev_length>=e.good_match&&(i>>=2),a>e.lookahead&&(a=e.lookahead);do{if(u[(r=t)+s]===p&&u[r+s-1]===d&&u[r]===u[o]&&u[++r]===u[o+1]){o+=2,r++;do{}while(u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&o<f);if(n=co-(f-o),o=f-co,n>s){if(e.match_start=t,s=n,n>=a)break;d=u[o+s-1],p=u[o+s]}}}while((t=h[t&l])>c&&0!==--i);return s<=e.lookahead?s:e.lookahead}function _o(e){var t,r,n,i,o,s=e.w_size;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=s+(s-uo)){di(e.window,e.window,s,s,0),e.match_start-=s,e.strstart-=s,e.block_start-=s,t=r=e.hash_size;do{n=e.head[--t],e.head[t]=n>=s?n-s:0}while(--r);t=r=s;do{n=e.prev[--t],e.prev[t]=n>=s?n-s:0}while(--r);i+=s}if(0===e.strm.avail_in)break;if(r=Eo(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=r,e.lookahead+e.insert>=3)for(o=e.strstart-e.insert,e.ins_h=e.window[o],e.ins_h=(e.ins_h<<e.hash_shift^e.window[o+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[o+3-1])&e.hash_mask,e.prev[o&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=o,o++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<uo&&0!==e.strm.avail_in)}function Ao(e,t){for(var r,n;;){if(e.lookahead<uo){if(_o(e),e.lookahead<uo&&0===t)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-uo&&(e.match_length=Io(e,r)),e.match_length>=3)if(n=ro(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!==--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else n=ro(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(wo(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(wo(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(wo(e,!1),0===e.strm.avail_out)?1:2}function ko(e,t){for(var r,n,i;;){if(e.lookahead<uo){if(_o(e),e.lookahead<uo&&0===t)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-uo&&(e.match_length=Io(e,r),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){i=e.strstart+e.lookahead-3,n=ro(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=i&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!==--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,n&&(wo(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((n=ro(e,0,e.window[e.strstart-1]))&&wo(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=ro(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(wo(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(wo(e,!1),0===e.strm.avail_out)?1:2}function Bo(e,t,r,n,i){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=n,this.func=i}function xo(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new gi(1146),this.dyn_dtree=new gi(122),this.bl_tree=new gi(78),mo(this.dyn_ltree),mo(this.dyn_dtree),mo(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new gi(16),this.heap=new gi(573),mo(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new gi(573),mo(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function So(e){var t,r=function(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:ho,e.adler=2===t.wrap?0:1,t.last_flush=0,Yi(t),0):po(e,ao)}(e);return 0===r&&((t=e.state).window_size=2*t.w_size,mo(t.head),t.max_lazy_match=so[t.level].max_lazy,t.good_match=so[t.level].good_length,t.nice_match=so[t.level].nice_length,t.max_chain_length=so[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),r}function Oo(e,t){var r,n,i,o;if(!e||!e.state||t>5||t<0)return e?po(e,ao):ao;if(n=e.state,!e.output||!e.input&&0!==e.avail_in||n.status===fo&&4!==t)return po(e,0===e.avail_out?-5:ao);if(n.strm=e,r=n.last_flush,n.last_flush=t,42===n.status)if(2===n.wrap)e.adler=0,bo(n,31),bo(n,139),bo(n,8),n.gzhead?(bo(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),bo(n,255&n.gzhead.time),bo(n,n.gzhead.time>>8&255),bo(n,n.gzhead.time>>16&255),bo(n,n.gzhead.time>>24&255),bo(n,9===n.level?2:n.strategy>=2||n.level<2?4:0),bo(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(bo(n,255&n.gzhead.extra.length),bo(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=oo(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(bo(n,0),bo(n,0),bo(n,0),bo(n,0),bo(n,0),bo(n,9===n.level?2:n.strategy>=2||n.level<2?4:0),bo(n,3),n.status=ho);else{var s=8+(n.w_bits-8<<4)<<8;s|=(n.strategy>=2||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(s|=32),s+=31-s%31,n.status=ho,vo(n,s),0!==n.strstart&&(vo(n,e.adler>>>16),vo(n,65535&e.adler)),e.adler=1}if(69===n.status)if(n.gzhead.extra){for(i=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>i&&(e.adler=oo(e.adler,n.pending_buf,n.pending-i,i)),yo(e),i=n.pending,n.pending!==n.pending_buf_size));)bo(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>i&&(e.adler=oo(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){i=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>i&&(e.adler=oo(e.adler,n.pending_buf,n.pending-i,i)),yo(e),i=n.pending,n.pending===n.pending_buf_size)){o=1;break}o=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,bo(n,o)}while(0!==o);n.gzhead.hcrc&&n.pending>i&&(e.adler=oo(e.adler,n.pending_buf,n.pending-i,i)),0===o&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){i=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>i&&(e.adler=oo(e.adler,n.pending_buf,n.pending-i,i)),yo(e),i=n.pending,n.pending===n.pending_buf_size)){o=1;break}o=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,bo(n,o)}while(0!==o);n.gzhead.hcrc&&n.pending>i&&(e.adler=oo(e.adler,n.pending_buf,n.pending-i,i)),0===o&&(n.status=lo)}else n.status=lo;if(n.status===lo&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&yo(e),n.pending+2<=n.pending_buf_size&&(bo(n,255&e.adler),bo(n,e.adler>>8&255),e.adler=0,n.status=ho)):n.status=ho),0!==n.pending){if(yo(e),0===e.avail_out)return n.last_flush=-1,0}else if(0===e.avail_in&&go(t)<=go(r)&&4!==t)return po(e,-5);if(n.status===fo&&0!==e.avail_in)return po(e,-5);if(0!==e.avail_in||0!==n.lookahead||0!==t&&n.status!==fo){var a=2===n.strategy?function(e,t){for(var r;;){if(0===e.lookahead&&(_o(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,r=ro(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(wo(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(wo(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(wo(e,!1),0===e.strm.avail_out)?1:2}(n,t):3===n.strategy?function(e,t){for(var r,n,i,o,s=e.window;;){if(e.lookahead<=co){if(_o(e),e.lookahead<=co&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(n=s[i=e.strstart-1])===s[++i]&&n===s[++i]&&n===s[++i]){o=e.strstart+co;do{}while(n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&i<o);e.match_length=co-(o-i),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(r=ro(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=ro(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(wo(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(wo(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(wo(e,!1),0===e.strm.avail_out)?1:2}(n,t):so[n.level].func(n,t);if(3!==a&&4!==a||(n.status=fo),1===a||3===a)return 0===e.avail_out&&(n.last_flush=-1),0;if(2===a&&(1===t?eo(n):5!==t&&(Xi(n,0,0,!1),3===t&&(mo(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),yo(e),0===e.avail_out))return n.last_flush=-1,0}return 4!==t?0:n.wrap<=0?1:(2===n.wrap?(bo(n,255&e.adler),bo(n,e.adler>>8&255),bo(n,e.adler>>16&255),bo(n,e.adler>>24&255),bo(n,255&e.total_in),bo(n,e.total_in>>8&255),bo(n,e.total_in>>16&255),bo(n,e.total_in>>24&255)):(vo(n,e.adler>>>16),vo(n,65535&e.adler)),yo(e),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?0:1)}so=[new Bo(0,0,0,0,function(e,t){var r=65535;for(r>e.pending_buf_size-5&&(r=e.pending_buf_size-5);;){if(e.lookahead<=1){if(_o(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+r;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,wo(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-uo&&(wo(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(wo(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(wo(e,!1),e.strm.avail_out),1)}),new Bo(4,4,8,4,Ao),new Bo(4,5,16,8,Ao),new Bo(4,6,32,32,Ao),new Bo(4,4,16,16,ko),new Bo(8,16,32,32,ko),new Bo(8,16,128,128,ko),new Bo(8,32,128,256,ko),new Bo(32,128,258,1024,ko),new Bo(32,258,258,4096,ko)];function Uo(e,t){var r,n,i,o,s,a,c,u,l,h,f,d,p,g,m,y,w,b,v,E,I,_,A,k,B;r=e.state,n=e.next_in,k=e.input,i=n+(e.avail_in-5),o=e.next_out,B=e.output,s=o-(t-e.avail_out),a=o+(e.avail_out-257),c=r.dmax,u=r.wsize,l=r.whave,h=r.wnext,f=r.window,d=r.hold,p=r.bits,g=r.lencode,m=r.distcode,y=(1<<r.lenbits)-1,w=(1<<r.distbits)-1;e:do{p<15&&(d+=k[n++]<<p,p+=8,d+=k[n++]<<p,p+=8),b=g[d&y];t:for(;;){if(d>>>=v=b>>>24,p-=v,0===(v=b>>>16&255))B[o++]=65535&b;else{if(!(16&v)){if(64&v){if(32&v){r.mode=12;break e}e.msg="invalid literal/length code",r.mode=30;break e}b=g[(65535&b)+(d&(1<<v)-1)];continue t}for(E=65535&b,(v&=15)&&(p<v&&(d+=k[n++]<<p,p+=8),E+=d&(1<<v)-1,d>>>=v,p-=v),p<15&&(d+=k[n++]<<p,p+=8,d+=k[n++]<<p,p+=8),b=m[d&w];;){if(d>>>=v=b>>>24,p-=v,16&(v=b>>>16&255)){if(I=65535&b,p<(v&=15)&&(d+=k[n++]<<p,(p+=8)<v&&(d+=k[n++]<<p,p+=8)),(I+=d&(1<<v)-1)>c){e.msg="invalid distance too far back",r.mode=30;break e}if(d>>>=v,p-=v,I>(v=o-s)){if((v=I-v)>l&&r.sane){e.msg="invalid distance too far back",r.mode=30;break e}if(_=0,A=f,0===h){if(_+=u-v,v<E){E-=v;do{B[o++]=f[_++]}while(--v);_=o-I,A=B}}else if(h<v){if(_+=u+h-v,(v-=h)<E){E-=v;do{B[o++]=f[_++]}while(--v);if(_=0,h<E){E-=v=h;do{B[o++]=f[_++]}while(--v);_=o-I,A=B}}}else if(_+=h-v,v<E){E-=v;do{B[o++]=f[_++]}while(--v);_=o-I,A=B}for(;E>2;)B[o++]=A[_++],B[o++]=A[_++],B[o++]=A[_++],E-=3;E&&(B[o++]=A[_++],E>1&&(B[o++]=A[_++]))}else{_=o-I;do{B[o++]=B[_++],B[o++]=B[_++],B[o++]=B[_++],E-=3}while(E>2);E&&(B[o++]=B[_++],E>1&&(B[o++]=B[_++]))}break}if(64&v){e.msg="invalid distance code",r.mode=30;break e}b=m[(65535&b)+(d&(1<<v)-1)]}}break}}while(n<i&&o<a);n-=E=p>>3,d&=(1<<(p-=E<<3))-1,e.next_in=n,e.next_out=o,e.avail_in=n<i?i-n+5:5-(n-i),e.avail_out=o<a?a-o+257:257-(o-a),r.hold=d,r.bits=p}var Co=15,No=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],Ro=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],To=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],Lo=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function Do(e,t,r,n,i,o,s,a){var c,u,l,h,f,d,p,g,m,y=a.bits,w=0,b=0,v=0,E=0,I=0,_=0,A=0,k=0,B=0,x=0,S=null,O=0,U=new gi(16),C=new gi(16),N=null,R=0;for(w=0;w<=Co;w++)U[w]=0;for(b=0;b<n;b++)U[t[r+b]]++;for(I=y,E=Co;E>=1&&0===U[E];E--);if(I>E&&(I=E),0===E)return i[o++]=20971520,i[o++]=20971520,a.bits=1,0;for(v=1;v<E&&0===U[v];v++);for(I<v&&(I=v),k=1,w=1;w<=Co;w++)if(k<<=1,(k-=U[w])<0)return-1;if(k>0&&(0===e||1!==E))return-1;for(C[1]=0,w=1;w<Co;w++)C[w+1]=C[w]+U[w];for(b=0;b<n;b++)0!==t[r+b]&&(s[C[t[r+b]]++]=b);if(0===e?(S=N=s,d=19):1===e?(S=No,O-=257,N=Ro,R-=257,d=256):(S=To,N=Lo,d=-1),x=0,b=0,w=v,f=o,_=I,A=0,l=-1,h=(B=1<<I)-1,1===e&&B>852||2===e&&B>592)return 1;for(;;){p=w-A,s[b]<d?(g=0,m=s[b]):s[b]>d?(g=N[R+s[b]],m=S[O+s[b]]):(g=96,m=0),c=1<<w-A,v=u=1<<_;do{i[f+(x>>A)+(u-=c)]=p<<24|g<<16|m}while(0!==u);for(c=1<<w-1;x&c;)c>>=1;if(0!==c?(x&=c-1,x+=c):x=0,b++,0===--U[w]){if(w===E)break;w=t[r+s[b]]}if(w>I&&(x&h)!==l){for(0===A&&(A=I),f+=v,k=1<<(_=w-A);_+A<E&&!((k-=U[_+A])<=0);)_++,k<<=1;if(B+=1<<_,1===e&&B>852||2===e&&B>592)return 1;i[l=x&h]=I<<24|_<<16|f-o}}return 0!==x&&(i[f+x]=w-A<<24|64<<16),a.bits=I,0}var jo=-2,Mo=12,Po=30;function Fo(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function qo(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new gi(320),this.work=new gi(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function Qo(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,function(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new mi(852),t.distcode=t.distdyn=new mi(592),t.sane=1,t.back=-1,0):jo}(e)):jo}function zo(e,t){var r,n;return e?(n=new qo,e.state=n,n.window=null,r=function(e,t){var r,n;return e&&e.state?(n=e.state,t<0?(r=0,t=-t):(r=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?jo:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=r,n.wbits=t,Qo(e))):jo}(e,t),0!==r&&(e.state=null),r):jo}var $o,Ho,Vo=!0;function Go(e){if(Vo){var t;for($o=new mi(512),Ho=new mi(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Do(1,e.lens,0,288,$o,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Do(2,e.lens,0,32,Ho,0,e.work,{bits:5}),Vo=!1}e.lencode=$o,e.lenbits=9,e.distcode=Ho,e.distbits=5}function Ko(e,t){var r,n,i,o,s,a,c,u,l,h,f,d,p,g,m,y,w,b,v,E,I,_,A,k,B=0,x=new pi(4),S=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return jo;(r=e.state).mode===Mo&&(r.mode=13),s=e.next_out,i=e.output,c=e.avail_out,o=e.next_in,n=e.input,a=e.avail_in,u=r.hold,l=r.bits,h=a,f=c,_=0;e:for(;;)switch(r.mode){case 1:if(0===r.wrap){r.mode=13;break}for(;l<16;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if(2&r.wrap&&35615===u){r.check=0,x[0]=255&u,x[1]=u>>>8&255,r.check=oo(r.check,x,2,0),u=0,l=0,r.mode=2;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&u)<<8)+(u>>8))%31){e.msg="incorrect header check",r.mode=Po;break}if(8!=(15&u)){e.msg="unknown compression method",r.mode=Po;break}if(l-=4,I=8+(15&(u>>>=4)),0===r.wbits)r.wbits=I;else if(I>r.wbits){e.msg="invalid window size",r.mode=Po;break}r.dmax=1<<I,e.adler=r.check=1,r.mode=512&u?10:Mo,u=0,l=0;break;case 2:for(;l<16;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if(r.flags=u,8!=(255&r.flags)){e.msg="unknown compression method",r.mode=Po;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=Po;break}r.head&&(r.head.text=u>>8&1),512&r.flags&&(x[0]=255&u,x[1]=u>>>8&255,r.check=oo(r.check,x,2,0)),u=0,l=0,r.mode=3;case 3:for(;l<32;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}r.head&&(r.head.time=u),512&r.flags&&(x[0]=255&u,x[1]=u>>>8&255,x[2]=u>>>16&255,x[3]=u>>>24&255,r.check=oo(r.check,x,4,0)),u=0,l=0,r.mode=4;case 4:for(;l<16;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}r.head&&(r.head.xflags=255&u,r.head.os=u>>8),512&r.flags&&(x[0]=255&u,x[1]=u>>>8&255,r.check=oo(r.check,x,2,0)),u=0,l=0,r.mode=5;case 5:if(1024&r.flags){for(;l<16;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}r.length=u,r.head&&(r.head.extra_len=u),512&r.flags&&(x[0]=255&u,x[1]=u>>>8&255,r.check=oo(r.check,x,2,0)),u=0,l=0}else r.head&&(r.head.extra=null);r.mode=6;case 6:if(1024&r.flags&&((d=r.length)>a&&(d=a),d&&(r.head&&(I=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),di(r.head.extra,n,o,d,I)),512&r.flags&&(r.check=oo(r.check,n,d,o)),a-=d,o+=d,r.length-=d),r.length))break e;r.length=0,r.mode=7;case 7:if(2048&r.flags){if(0===a)break e;d=0;do{I=n[o+d++],r.head&&I&&r.length<65536&&(r.head.name+=String.fromCharCode(I))}while(I&&d<a);if(512&r.flags&&(r.check=oo(r.check,n,d,o)),a-=d,o+=d,I)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=8;case 8:if(4096&r.flags){if(0===a)break e;d=0;do{I=n[o+d++],r.head&&I&&r.length<65536&&(r.head.comment+=String.fromCharCode(I))}while(I&&d<a);if(512&r.flags&&(r.check=oo(r.check,n,d,o)),a-=d,o+=d,I)break e}else r.head&&(r.head.comment=null);r.mode=9;case 9:if(512&r.flags){for(;l<16;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if(u!==(65535&r.check)){e.msg="header crc mismatch",r.mode=Po;break}u=0,l=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=Mo;break;case 10:for(;l<32;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}e.adler=r.check=Fo(u),u=0,l=0,r.mode=11;case 11:if(0===r.havedict)return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,r.hold=u,r.bits=l,2;e.adler=r.check=1,r.mode=Mo;case Mo:if(5===t||6===t)break e;case 13:if(r.last){u>>>=7&l,l-=7&l,r.mode=27;break}for(;l<3;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}switch(r.last=1&u,l-=1,3&(u>>>=1)){case 0:r.mode=14;break;case 1:if(Go(r),r.mode=20,6===t){u>>>=2,l-=2;break e}break;case 2:r.mode=17;break;case 3:e.msg="invalid block type",r.mode=Po}u>>>=2,l-=2;break;case 14:for(u>>>=7&l,l-=7&l;l<32;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if((65535&u)!=(u>>>16^65535)){e.msg="invalid stored block lengths",r.mode=Po;break}if(r.length=65535&u,u=0,l=0,r.mode=15,6===t)break e;case 15:r.mode=16;case 16:if(d=r.length){if(d>a&&(d=a),d>c&&(d=c),0===d)break e;di(i,n,o,d,s),a-=d,o+=d,c-=d,s+=d,r.length-=d;break}r.mode=Mo;break;case 17:for(;l<14;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if(r.nlen=257+(31&u),u>>>=5,l-=5,r.ndist=1+(31&u),u>>>=5,l-=5,r.ncode=4+(15&u),u>>>=4,l-=4,r.nlen>286||r.ndist>30){e.msg="too many length or distance symbols",r.mode=Po;break}r.have=0,r.mode=18;case 18:for(;r.have<r.ncode;){for(;l<3;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}r.lens[S[r.have++]]=7&u,u>>>=3,l-=3}for(;r.have<19;)r.lens[S[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,A={bits:r.lenbits},_=Do(0,r.lens,0,19,r.lencode,0,r.work,A),r.lenbits=A.bits,_){e.msg="invalid code lengths set",r.mode=Po;break}r.have=0,r.mode=19;case 19:for(;r.have<r.nlen+r.ndist;){for(;y=(B=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,w=65535&B,!((m=B>>>24)<=l);){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if(w<16)u>>>=m,l-=m,r.lens[r.have++]=w;else{if(16===w){for(k=m+2;l<k;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if(u>>>=m,l-=m,0===r.have){e.msg="invalid bit length repeat",r.mode=Po;break}I=r.lens[r.have-1],d=3+(3&u),u>>>=2,l-=2}else if(17===w){for(k=m+3;l<k;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}l-=m,I=0,d=3+(7&(u>>>=m)),u>>>=3,l-=3}else{for(k=m+7;l<k;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}l-=m,I=0,d=11+(127&(u>>>=m)),u>>>=7,l-=7}if(r.have+d>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=Po;break}for(;d--;)r.lens[r.have++]=I}}if(r.mode===Po)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=Po;break}if(r.lenbits=9,A={bits:r.lenbits},_=Do(1,r.lens,0,r.nlen,r.lencode,0,r.work,A),r.lenbits=A.bits,_){e.msg="invalid literal/lengths set",r.mode=Po;break}if(r.distbits=6,r.distcode=r.distdyn,A={bits:r.distbits},_=Do(2,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,A),r.distbits=A.bits,_){e.msg="invalid distances set",r.mode=Po;break}if(r.mode=20,6===t)break e;case 20:r.mode=21;case 21:if(a>=6&&c>=258){e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,r.hold=u,r.bits=l,Uo(e,f),s=e.next_out,i=e.output,c=e.avail_out,o=e.next_in,n=e.input,a=e.avail_in,u=r.hold,l=r.bits,r.mode===Mo&&(r.back=-1);break}for(r.back=0;y=(B=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,w=65535&B,!((m=B>>>24)<=l);){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if(y&&!(240&y)){for(b=m,v=y,E=w;y=(B=r.lencode[E+((u&(1<<b+v)-1)>>b)])>>>16&255,w=65535&B,!(b+(m=B>>>24)<=l);){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}u>>>=b,l-=b,r.back+=b}if(u>>>=m,l-=m,r.back+=m,r.length=w,0===y){r.mode=26;break}if(32&y){r.back=-1,r.mode=Mo;break}if(64&y){e.msg="invalid literal/length code",r.mode=Po;break}r.extra=15&y,r.mode=22;case 22:if(r.extra){for(k=r.extra;l<k;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}r.length+=u&(1<<r.extra)-1,u>>>=r.extra,l-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=23;case 23:for(;y=(B=r.distcode[u&(1<<r.distbits)-1])>>>16&255,w=65535&B,!((m=B>>>24)<=l);){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if(!(240&y)){for(b=m,v=y,E=w;y=(B=r.distcode[E+((u&(1<<b+v)-1)>>b)])>>>16&255,w=65535&B,!(b+(m=B>>>24)<=l);){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}u>>>=b,l-=b,r.back+=b}if(u>>>=m,l-=m,r.back+=m,64&y){e.msg="invalid distance code",r.mode=Po;break}r.offset=w,r.extra=15&y,r.mode=24;case 24:if(r.extra){for(k=r.extra;l<k;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}r.offset+=u&(1<<r.extra)-1,u>>>=r.extra,l-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=Po;break}r.mode=25;case 25:if(0===c)break e;if(d=f-c,r.offset>d){if((d=r.offset-d)>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=Po;break}d>r.wnext?(d-=r.wnext,p=r.wsize-d):p=r.wnext-d,d>r.length&&(d=r.length),g=r.window}else g=i,p=s-r.offset,d=r.length;d>c&&(d=c),c-=d,r.length-=d;do{i[s++]=g[p++]}while(--d);0===r.length&&(r.mode=21);break;case 26:if(0===c)break e;i[s++]=r.length,c--,r.mode=21;break;case 27:if(r.wrap){for(;l<32;){if(0===a)break e;a--,u|=n[o++]<<l,l+=8}if(f-=c,e.total_out+=f,r.total+=f,f&&(e.adler=r.check=r.flags?oo(r.check,i,f,s-f):no(r.check,i,f,s-f)),f=c,(r.flags?u:Fo(u))!==r.check){e.msg="incorrect data check",r.mode=Po;break}u=0,l=0}r.mode=28;case 28:if(r.wrap&&r.flags){for(;l<32;){if(0===a)break e;a--,u+=n[o++]<<l,l+=8}if(u!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=Po;break}u=0,l=0}r.mode=29;case 29:_=1;break e;case Po:_=-3;break e;case 31:return-4;default:return jo}return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,r.hold=u,r.bits=l,(r.wsize||f!==e.avail_out&&r.mode<Po&&(r.mode<27||4!==t))&&function(e,t,r,n){var i,o=e.state;null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new pi(o.wsize)),n>=o.wsize?(di(o.window,t,r-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((i=o.wsize-o.wnext)>n&&(i=n),di(o.window,t,r-n,i,o.wnext),(n-=i)?(di(o.window,t,r-n,n,0),o.wnext=n,o.whave=o.wsize):(o.wnext+=i,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=i)))}(e,e.output,e.next_out,f-e.avail_out),h-=e.avail_in,f-=e.avail_out,e.total_in+=h,e.total_out+=f,r.total+=f,r.wrap&&f&&(e.adler=r.check=r.flags?oo(r.check,i,f,e.next_out-f):no(r.check,i,f,e.next_out-f)),e.data_type=r.bits+(r.last?64:0)+(r.mode===Mo?128:0)+(20===r.mode||15===r.mode?256:0),(0===h&&0===f||4===t)&&0===_&&(_=-5),_}var Wo;function Jo(e){if(e<1||e>7)throw new TypeError("Bad argument");this.mode=e,this.init_done=!1,this.write_in_progress=!1,this.pending_close=!1,this.windowBits=0,this.level=0,this.memLevel=0,this.strategy=0,this.dictionary=null}function Zo(e,t){for(var r=0;r<e.length;r++)this[t+r]=e[r]}Jo.prototype.init=function(e,t,r,n,i){var o;switch(this.windowBits=e,this.level=t,this.memLevel=r,this.strategy=n,3!==this.mode&&4!==this.mode||(this.windowBits+=16),7===this.mode&&(this.windowBits+=32),5!==this.mode&&6!==this.mode||(this.windowBits=-this.windowBits),this.strm=new fi,this.mode){case 1:case 3:case 5:o=function(e,t,r,n,i,o){if(!e)return ao;var s=1;if(-1===t&&(t=6),n<0?(s=0,n=-n):n>15&&(s=2,n-=16),i<1||i>9||8!==r||n<8||n>15||t<0||t>9||o<0||o>4)return po(e,ao);8===n&&(n=9);var a=new xo;return e.state=a,a.strm=e,a.wrap=s,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=i+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new pi(2*a.w_size),a.head=new gi(a.hash_size),a.prev=new gi(a.w_size),a.lit_bufsize=1<<i+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new pi(a.pending_buf_size),a.d_buf=1*a.lit_bufsize,a.l_buf=3*a.lit_bufsize,a.level=t,a.strategy=o,a.method=r,So(e)}(this.strm,this.level,8,this.windowBits,this.memLevel,this.strategy);break;case 2:case 4:case 6:case 7:o=zo(this.strm,this.windowBits);break;default:throw new Error("Unknown mode "+this.mode)}0===o?(this.write_in_progress=!1,this.init_done=!0):this._error(o)},Jo.prototype.params=function(){throw new Error("deflateParams Not supported")},Jo.prototype._writeCheck=function(){if(!this.init_done)throw new Error("write before init");if(0===this.mode)throw new Error("already finalized");if(this.write_in_progress)throw new Error("write already in progress");if(this.pending_close)throw new Error("close is pending")},Jo.prototype.write=function(e,t,r,n,i,o,s){this._writeCheck(),this.write_in_progress=!0;var a=this;return Nr.nextTick(function(){a.write_in_progress=!1;var c=a._write(e,t,r,n,i,o,s);a.callback(c[0],c[1]),a.pending_close&&a.close()}),this},Jo.prototype.writeSync=function(e,t,r,n,i,o,s){return this._writeCheck(),this._write(e,t,r,n,i,o,s)},Jo.prototype._write=function(e,t,r,n,i,o,s){if(this.write_in_progress=!0,0!==e&&1!==e&&2!==e&&3!==e&&4!==e&&5!==e)throw new Error("Invalid flush value");null==t&&(t=new It(0),n=0,r=0),i._set?i.set=i._set:i.set=Zo;var a,c=this.strm;switch(c.avail_in=n,c.input=t,c.next_in=r,c.avail_out=s,c.output=i,c.next_out=o,this.mode){case 1:case 3:case 5:a=Oo(c,e);break;case 7:case 2:case 4:case 6:a=Ko(c,e);break;default:throw new Error("Unknown mode "+this.mode)}return this._checkError(a,c,e)||this._error(a),this.write_in_progress=!1,[c.avail_in,c.avail_out]},Jo.prototype._checkError=function(e,t,r){switch(e){case 0:case-5:if(0!==t.avail_out&&4===r)return!1;break;case 1:break;default:return!1}return!0},Jo.prototype.close=function(){this.write_in_progress?this.pending_close=!0:(this.pending_close=!1,1===this.mode||3===this.mode||5===this.mode?function(e){var t;e&&e.state&&(42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&t!==lo&&t!==ho&&t!==fo?po(e,ao):(e.state=null,t===ho&&po(e,-3)))}(this.strm):function(e){if(!e||!e.state)return jo;var t=e.state;t.window&&(t.window=null),e.state=null}(this.strm),this.mode=0)},Jo.prototype.reset=function(){switch(this.mode){case 1:case 5:Wo=So(this.strm);break;case 2:case 6:Wo=Qo(this.strm)}0!==Wo&&this._error(Wo)},Jo.prototype._error=function(e){this.onerror(hi[e]+": "+this.strm.msg,e),this.write_in_progress=!1,this.pending_close&&this.close()};var Yo=Object.freeze({__proto__:null,DEFLATE:1,DEFLATERAW:5,GUNZIP:4,GZIP:3,INFLATE:2,INFLATERAW:6,NONE:0,UNZIP:7,Z_BEST_COMPRESSION:9,Z_BEST_SPEED:1,Z_BINARY:0,Z_BLOCK:5,Z_BUF_ERROR:-5,Z_DATA_ERROR:-3,Z_DEFAULT_COMPRESSION:-1,Z_DEFAULT_STRATEGY:0,Z_DEFLATED:8,Z_ERRNO:-1,Z_FILTERED:1,Z_FINISH:4,Z_FIXED:4,Z_FULL_FLUSH:3,Z_HUFFMAN_ONLY:2,Z_NEED_DICT:2,Z_NO_COMPRESSION:0,Z_NO_FLUSH:0,Z_OK:0,Z_PARTIAL_FLUSH:1,Z_RLE:3,Z_STREAM_END:1,Z_STREAM_ERROR:-2,Z_SYNC_FLUSH:2,Z_TEXT:1,Z_TREES:6,Z_UNKNOWN:2,Zlib:Jo});var Xo={};Object.keys(Yo).forEach(function(e){Xo[e]=Yo[e]}),Xo.Z_MIN_WINDOWBITS=8,Xo.Z_MAX_WINDOWBITS=15,Xo.Z_DEFAULT_WINDOWBITS=15,Xo.Z_MIN_CHUNK=64,Xo.Z_MAX_CHUNK=1/0,Xo.Z_DEFAULT_CHUNK=16384,Xo.Z_MIN_MEMLEVEL=1,Xo.Z_MAX_MEMLEVEL=9,Xo.Z_DEFAULT_MEMLEVEL=8,Xo.Z_MIN_LEVEL=-1,Xo.Z_MAX_LEVEL=9,Xo.Z_DEFAULT_LEVEL=Xo.Z_DEFAULT_COMPRESSION;var es={Z_OK:Xo.Z_OK,Z_STREAM_END:Xo.Z_STREAM_END,Z_NEED_DICT:Xo.Z_NEED_DICT,Z_ERRNO:Xo.Z_ERRNO,Z_STREAM_ERROR:Xo.Z_STREAM_ERROR,Z_DATA_ERROR:Xo.Z_DATA_ERROR,Z_MEM_ERROR:Xo.Z_MEM_ERROR,Z_BUF_ERROR:Xo.Z_BUF_ERROR,Z_VERSION_ERROR:Xo.Z_VERSION_ERROR};function ts(e,t,r){var n=[],i=0;function o(){for(var t;null!==(t=e.read());)n.push(t),i+=t.length;e.once("readable",o)}function s(){var t=It.concat(n,i);n=[],r(null,t),e.close()}e.on("error",function(t){e.removeListener("end",s),e.removeListener("readable",o),r(t)}),e.on("end",s),e.end(t),o()}function rs(e,t){if("string"==typeof t&&(t=new It(t)),!It.isBuffer(t))throw new TypeError("Not a string or buffer");var r=Xo.Z_FINISH;return e._processChunk(t,r)}function ns(e){if(!(this instanceof ns))return new ns(e);ls.call(this,e,Xo.DEFLATE)}function is(e){if(!(this instanceof is))return new is(e);ls.call(this,e,Xo.INFLATE)}function os(e){if(!(this instanceof os))return new os(e);ls.call(this,e,Xo.GZIP)}function ss(e){if(!(this instanceof ss))return new ss(e);ls.call(this,e,Xo.GUNZIP)}function as(e){if(!(this instanceof as))return new as(e);ls.call(this,e,Xo.DEFLATERAW)}function cs(e){if(!(this instanceof cs))return new cs(e);ls.call(this,e,Xo.INFLATERAW)}function us(e){if(!(this instanceof us))return new us(e);ls.call(this,e,Xo.UNZIP)}function ls(e,t){if(this._opts=e=e||{},this._chunkSize=e.chunkSize||Xo.Z_DEFAULT_CHUNK,si.call(this,e),e.flush&&e.flush!==Xo.Z_NO_FLUSH&&e.flush!==Xo.Z_PARTIAL_FLUSH&&e.flush!==Xo.Z_SYNC_FLUSH&&e.flush!==Xo.Z_FULL_FLUSH&&e.flush!==Xo.Z_FINISH&&e.flush!==Xo.Z_BLOCK)throw new Error("Invalid flush flag: "+e.flush);if(this._flushFlag=e.flush||Xo.Z_NO_FLUSH,e.chunkSize&&(e.chunkSize<Xo.Z_MIN_CHUNK||e.chunkSize>Xo.Z_MAX_CHUNK))throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits&&(e.windowBits<Xo.Z_MIN_WINDOWBITS||e.windowBits>Xo.Z_MAX_WINDOWBITS))throw new Error("Invalid windowBits: "+e.windowBits);if(e.level&&(e.level<Xo.Z_MIN_LEVEL||e.level>Xo.Z_MAX_LEVEL))throw new Error("Invalid compression level: "+e.level);if(e.memLevel&&(e.memLevel<Xo.Z_MIN_MEMLEVEL||e.memLevel>Xo.Z_MAX_MEMLEVEL))throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=Xo.Z_FILTERED&&e.strategy!=Xo.Z_HUFFMAN_ONLY&&e.strategy!=Xo.Z_RLE&&e.strategy!=Xo.Z_FIXED&&e.strategy!=Xo.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!It.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._binding=new Xo.Zlib(t);var r=this;this._hadError=!1,this._binding.onerror=function(e,t){r._binding=null,r._hadError=!0;var n=new Error(e);n.errno=t,n.code=es[t],r.emit("error",n)};var n=Xo.Z_DEFAULT_COMPRESSION;"number"==typeof e.level&&(n=e.level);var i=Xo.Z_DEFAULT_STRATEGY;"number"==typeof e.strategy&&(i=e.strategy),this._binding.init(e.windowBits||Xo.Z_DEFAULT_WINDOWBITS,n,e.memLevel||Xo.Z_DEFAULT_MEMLEVEL,i,e.dictionary),this._buffer=new It(this._chunkSize),this._offset=0,this._closed=!1,this._level=n,this._strategy=i,this.once("end",this.close)}Object.keys(es).forEach(function(e){es[es[e]]=e}),Cr(ls,si),ls.prototype.params=function(e,t,r){if(e<Xo.Z_MIN_LEVEL||e>Xo.Z_MAX_LEVEL)throw new RangeError("Invalid compression level: "+e);if(t!=Xo.Z_FILTERED&&t!=Xo.Z_HUFFMAN_ONLY&&t!=Xo.Z_RLE&&t!=Xo.Z_FIXED&&t!=Xo.Z_DEFAULT_STRATEGY)throw new TypeError("Invalid strategy: "+t);if(this._level!==e||this._strategy!==t){var n=this;this.flush(Xo.Z_SYNC_FLUSH,function(){n._binding.params(e,t),n._hadError||(n._level=e,n._strategy=t,r&&r())})}else Nr.nextTick(r)},ls.prototype.reset=function(){return this._binding.reset()},ls.prototype._flush=function(e){this._transform(new It(0),"",e)},ls.prototype.flush=function(e,t){var r=this._writableState;if(("function"==typeof e||void 0===e&&!t)&&(t=e,e=Xo.Z_FULL_FLUSH),r.ended)t&&Nr.nextTick(t);else if(r.ending)t&&this.once("end",t);else if(r.needDrain){var n=this;this.once("drain",function(){n.flush(t)})}else this._flushFlag=e,this.write(new It(0),"",t)},ls.prototype.close=function(e){if(e&&Nr.nextTick(e),!this._closed){this._closed=!0,this._binding.close();var t=this;Nr.nextTick(function(){t.emit("close")})}},ls.prototype._transform=function(e,t,r){var n,i=this._writableState,o=(i.ending||i.ended)&&(!e||i.length===e.length);if(null===!e&&!It.isBuffer(e))return r(new Error("invalid input"));o?n=Xo.Z_FINISH:(n=this._flushFlag,e.length>=i.length&&(this._flushFlag=this._opts.flush||Xo.Z_NO_FLUSH)),this._processChunk(e,n,r)},ls.prototype._processChunk=function(e,t,r){var n=e&&e.length,i=this._chunkSize-this._offset,o=0,s=this,a="function"==typeof r;if(!a){var c,u=[],l=0;this.on("error",function(e){c=e});do{var h=this._binding.writeSync(t,e,o,n,this._buffer,this._offset,i)}while(!this._hadError&&p(h[0],h[1]));if(this._hadError)throw c;var f=It.concat(u,l);return this.close(),f}var d=this._binding.write(t,e,o,n,this._buffer,this._offset,i);function p(c,h){if(!s._hadError){var f=i-h;if(function(e,t){if(!e)throw new Error(t)}(f>=0,"have should not go down"),f>0){var d=s._buffer.slice(s._offset,s._offset+f);s._offset+=f,a?s.push(d):(u.push(d),l+=d.length)}if((0===h||s._offset>=s._chunkSize)&&(i=s._chunkSize,s._offset=0,s._buffer=new It(s._chunkSize)),0===h){if(o+=n-c,n=c,!a)return!0;var g=s._binding.write(t,e,o,n,s._buffer,s._offset,s._chunkSize);return g.callback=p,void(g.buffer=e)}if(!a)return!1;r()}}d.buffer=e,d.callback=p},Cr(ns,ls),Cr(is,ls),Cr(os,ls),Cr(ss,ls),Cr(as,ls),Cr(cs,ls),Cr(us,ls);var hs={codes:es,createDeflate:function(e){return new ns(e)},createInflate:function(e){return new is(e)},createDeflateRaw:function(e){return new as(e)},createInflateRaw:function(e){return new cs(e)},createGzip:function(e){return new os(e)},createGunzip:function(e){return new ss(e)},createUnzip:function(e){return new us(e)},deflate:function(e,t,r){return"function"==typeof t&&(r=t,t={}),ts(new ns(t),e,r)},deflateSync:function(e,t){return rs(new ns(t),e)},gzip:function(e,t,r){return"function"==typeof t&&(r=t,t={}),ts(new os(t),e,r)},gzipSync:function(e,t){return rs(new os(t),e)},deflateRaw:function(e,t,r){return"function"==typeof t&&(r=t,t={}),ts(new as(t),e,r)},deflateRawSync:function(e,t){return rs(new as(t),e)},unzip:function(e,t,r){return"function"==typeof t&&(r=t,t={}),ts(new us(t),e,r)},unzipSync:function(e,t){return rs(new us(t),e)},inflate:function(e,t,r){return"function"==typeof t&&(r=t,t={}),ts(new is(t),e,r)},inflateSync:function(e,t){return rs(new is(t),e)},gunzip:function(e,t,r){return"function"==typeof t&&(r=t,t={}),ts(new ss(t),e,r)},gunzipSync:function(e,t){return rs(new ss(t),e)},inflateRaw:function(e,t,r){return"function"==typeof t&&(r=t,t={}),ts(new cs(t),e,r)},inflateRawSync:function(e,t){return rs(new cs(t),e)},Deflate:ns,Inflate:is,Gzip:os,Gunzip:ss,DeflateRaw:as,InflateRaw:cs,Unzip:us,Zlib:ls};class fs extends qe{constructor(e={}){super(),this.config=e}async _set(e,t){}async _get(e){}async _del(e){}async _clear(e){}validateKey(e){if(null==e||"string"!=typeof e||!e)throw new Error("Invalid key")}async set(e,t){return this.validateKey(e),await this._set(e,t),this.emit("set",t),t}async get(e){this.validateKey(e);const t=await this._get(e);return this.emit("get",t),t}async del(e){this.validateKey(e);const t=await this._del(e);return this.emit("delete",t),t}async delete(e){return this.del(e)}async clear(e){const t=await this._clear(e);return this.emit("clear",t),t}}class ds extends qe{constructor({resource:e}){super(),this.resource=e,this.client=e.client,this.stream=new n({highWaterMark:3*this.client.parallelism,start:this._start.bind(this),pull:this._pull.bind(this),cancel:this._cancel.bind(this)})}build(){return this.stream.getReader()}async _start(e){this.controller=e,this.continuationToken=null,this.closeNextIteration=!1}async _pull(e){if(this.closeNextIteration)return void e.close();const t=await this.client.listObjects({prefix:`resource=${this.resource.name}`,continuationToken:this.continuationToken}),r=t?.Contents.map(e=>e.Key).map(e=>e.replace(this.client.config.keyPrefix,"")).map(e=>e.startsWith("/")?e.replace("/",""):e).map(e=>e.replace(`resource=${this.resource.name}/id=`,""));this.continuationToken=t.NextContinuationToken,this.enqueue(r),t.IsTruncated||(this.closeNextIteration=!0)}enqueue(e){e.forEach(e=>{this.controller.enqueue(e),this.emit("id",e)})}_cancel(e){}}class ps extends ds{enqueue(e){this.controller.enqueue(e),this.emit("page",e)}}class gs extends qe{constructor({resource:e,batchSize:t=10,concurrency:r=5}){if(super(),!e)throw new Error("Resource is required for ResourceReader");this.resource=e,this.client=e.client,this.batchSize=t,this.concurrency=r,this.input=new ps({resource:this.resource}),this.transform=new si({objectMode:!0,transform:this._transform.bind(this)}),this.input.on("data",e=>{this.transform.write(e)}),this.input.on("end",()=>{this.transform.end()}),this.input.on("error",e=>{this.emit("error",e)}),this.transform.on("data",e=>{this.emit("data",e)}),this.transform.on("end",()=>{this.emit("end")}),this.transform.on("error",e=>{this.emit("error",e)})}build(){return this}async _transform(e,t,n){const[i,o]=await V(async()=>{await r.for(e).withConcurrency(this.concurrency).handleError(async(e,t)=>{this.emit("error",e,t)}).process(async e=>{const t=await this.resource.get(e);return this.push(t),t})});n(o)}resume(){this.input.resume()}}class ms extends qe{constructor({resource:e,batchSize:t=10,concurrency:r=5}){super(),this.resource=e,this.client=e.client,this.batchSize=t,this.concurrency=r,this.buffer=[],this.writing=!1,this.writable=new Hn({objectMode:!0,write:this._write.bind(this)}),this.writable.on("finish",()=>{this.emit("finish")}),this.writable.on("error",e=>{this.emit("error",e)})}build(){return this}write(e){return this.buffer.push(e),this._maybeWrite().catch(e=>{this.emit("error",e)}),!0}end(){this.ended=!0,this._maybeWrite().catch(e=>{this.emit("error",e)})}async _maybeWrite(){if(!this.writing&&(0!==this.buffer.length||this.ended)){for(this.writing=!0;this.buffer.length>0;){const e=this.buffer.splice(0,this.batchSize),[t,n]=await V(async()=>{await r.for(e).withConcurrency(this.concurrency).handleError(async(e,t)=>{this.emit("error",e,t)}).process(async e=>{const[t,r,n]=await V(async()=>await this.resource.insert(e));return t?n:(this.emit("error",r,e),null)})});t||this.emit("error",n)}this.writing=!1,this.ended&&this.writable.emit("finish")}}async _write(e,t,r){r()}}function ys(e){return new Promise((t,r)=>{if(!e)return r(new Error("streamToString: stream is undefined"));const n=[];e.on("data",e=>n.push(e)),e.on("error",r),e.on("end",()=>t(Buffer.concat(n).toString("utf-8")))})}class ws extends fs{constructor({client:e,keyPrefix:t="cache",ttl:r=0,prefix:n}){super({client:e,keyPrefix:t,ttl:r,prefix:n}),this.client=e,this.keyPrefix=t,this.config.ttl=r,this.config.client=e,this.config.prefix=void 0!==n?n:t+(t.endsWith("/")?"":"/")}async _set(e,t){let r=JSON.stringify(t);const n=r.length;return r=hs.gzipSync(r).toString("base64"),this.client.putObject({key:nt(this.keyPrefix,e),body:r,contentEncoding:"gzip",contentType:"application/gzip",metadata:{compressor:"zlib",compressed:"true","client-id":this.client.id,"length-serialized":String(n),"length-compressed":String(r.length),"compression-gain":(r.length/n).toFixed(2)}})}async _get(e){const[t,r,n]=await V(async()=>{const{Body:t}=await this.client.getObject(nt(this.keyPrefix,e));let r=await ys(t);return r=Buffer.from(r,"base64"),r=hs.unzipSync(r).toString(),JSON.parse(r)});if(t)return n;if("NoSuchKey"===r.name||"NotFound"===r.name)return null;throw r}async _del(e){return await this.client.deleteObject(nt(this.keyPrefix,e)),!0}async _clear(){const e=await this.client.getAllKeys({prefix:this.keyPrefix});await this.client.deleteObjects(e)}async size(){return(await this.keys()).length}async keys(){const e=await this.client.getAllKeys({prefix:this.keyPrefix}),t=this.keyPrefix.endsWith("/")?this.keyPrefix:this.keyPrefix+"/";return e.map(e=>e.startsWith(t)?e.slice(t.length):e)}}class bs extends fs{constructor(e={}){super(e),this.cache={},this.meta={},this.maxSize=e.maxSize||0,this.ttl=e.ttl||0}async _set(e,t){if(this.maxSize>0&&Object.keys(this.cache).length>=this.maxSize){const e=Object.entries(this.meta).sort((e,t)=>e[1].ts-t[1].ts)[0]?.[0];e&&(delete this.cache[e],delete this.meta[e])}return this.cache[e]=t,this.meta[e]={ts:Date.now()},t}async _get(e){if(!Object.prototype.hasOwnProperty.call(this.cache,e))return null;if(this.ttl>0){const t=Date.now(),r=this.meta[e];if(r&&t-r.ts>1e3*this.ttl)return delete this.cache[e],delete this.meta[e],null}return this.cache[e]}async _del(e){return delete this.cache[e],delete this.meta[e],!0}async _clear(e){if(!e)return this.cache={},this.meta={},!0;for(const t of Object.keys(this.cache))t.startsWith(e)&&(delete this.cache[t],delete this.meta[t]);return!0}async size(){return Object.keys(this.cache).length}async keys(){return Object.keys(this.cache)}}class vs extends Ke{constructor(e={}){super(e),this.driver=e.driver,this.config={includePartitions:!1!==e.includePartitions,...e}}async setup(e){await super.setup(e)}async onSetup(){this.config.driver?this.driver=this.config.driver:"memory"===this.config.driverType?this.driver=new bs(this.config.memoryOptions||{}):this.driver=new ws({client:this.database.client,...this.config.s3Options||{}}),this.installDatabaseProxy(),this.installResourceHooks()}async onStart(){}async onStop(){}installDatabaseProxy(){if(this.database._cacheProxyInstalled)return;const e=this.installResourceHooks.bind(this);this.database._originalCreateResourceForCache=this.database.createResource,this.database.createResource=async function(...t){const r=await this._originalCreateResourceForCache(...t);return e(r),r},this.database._cacheProxyInstalled=!0}installResourceHooks(){for(const e of Object.values(this.database.resources))this.installResourceHooksForResource(e)}installResourceHooksForResource(e){if(!this.driver)return;Object.defineProperty(e,"cache",{value:this.driver,writable:!0,configurable:!0,enumerable:!1}),e.cacheKeyFor=async(t={})=>{const{action:r,params:n={},partition:i,partitionValues:o}=t;return this.generateCacheKey(e,r,n,i,o)};const t=["count","listIds","getMany","getAll","page","list","get"];for(const r of t)e.useMiddleware(r,async(t,n)=>{let i;if("getMany"===r)i=await e.cacheKeyFor({action:r,params:{ids:t.args[0]}});else if("page"===r){const{offset:n,size:o,partition:s,partitionValues:a}=t.args[0]||{};i=await e.cacheKeyFor({action:r,params:{offset:n,size:o},partition:s,partitionValues:a})}else if("list"===r||"listIds"===r||"count"===r){const{partition:n,partitionValues:o}=t.args[0]||{};i=await e.cacheKeyFor({action:r,partition:n,partitionValues:o})}else"getAll"===r?i=await e.cacheKeyFor({action:r}):"get"===r&&(i=await e.cacheKeyFor({action:r,params:{id:t.args[0]}}));const[o,s,a]=await V(()=>e.cache.get(i));if(o&&null!=a)return a;if(!o&&"NoSuchKey"!==s.name)throw s;const c=await n();return await e.cache.set(i,c),c});const r=["insert","update","delete","deleteMany"];for(const t of r)e.useMiddleware(t,async(r,n)=>{const i=await n();if("insert"===t)await this.clearCacheForResource(e,r.args[0]);else if("update"===t)await this.clearCacheForResource(e,{id:r.args[0],...r.args[1]});else if("delete"===t){let t={id:r.args[0]};if("function"==typeof e.get){const[n,i,o]=await V(()=>e.get(r.args[0]));n&&o&&(t=o)}await this.clearCacheForResource(e,t)}else"deleteMany"===t&&await this.clearCacheForResource(e);return i})}async clearCacheForResource(e,t){if(!e.cache)return;const r=`resource=${e.name}`;if(await e.cache.clear(r),!0===this.config.includePartitions&&e.config?.partitions&&Object.keys(e.config.partitions).length>0)if(t){const n=this.getPartitionValues(t,e);for(const[t,i]of Object.entries(n))if(i&&Object.keys(i).length>0&&Object.values(i).some(e=>null!=e)){const n=nt(r,`partition=${t}`);await e.cache.clear(n)}}else for(const t of Object.keys(e.config.partitions)){const n=nt(r,`partition=${t}`);await e.cache.clear(n)}}async generateCacheKey(e,t,r={},n=null,i=null){const o=[`resource=${e.name}`,`action=${t}`];if(n&&i&&Object.keys(i).length>0){o.push(`partition:${n}`);for(const[e,t]of Object.entries(i))null!=t&&o.push(`${e}:${t}`)}if(Object.keys(r).length>0){const e=await this.hashParams(r);o.push(e)}return nt(...o)+".json.gz"}async hashParams(e){const t=Object.keys(e).sort().map(t=>`${t}:${e[t]}`).join("|")||"empty";return await Re(t)}async getCacheStats(){return this.driver?{size:await this.driver.size(),keys:await this.driver.keys(),driver:this.driver.constructor.name}:null}async clearAllCache(){if(this.driver)for(const e of Object.values(this.database.resources))if(e.cache){const t=`resource=${e.name}`;await e.cache.clear(t)}}async warmCache(e,t={}){const r=this.database.resources[e];if(!r)throw new Error(`Resource '${e}' not found`);const{includePartitions:n=!0}=t;if(await r.getAll(),n&&r.config.partitions)for(const[e,t]of Object.entries(r.config.partitions))if(t.fields){const t=await r.getAll(),n=Array.isArray(t)?t:[],i=new Set;for(const t of n.slice(0,10)){const n=this.getPartitionValues(t,r);n[e]&&i.add(JSON.stringify(n[e]))}for(const t of i){const n=JSON.parse(t);await r.list({partition:e,partitionValues:n})}}}}const Es={async setup(e){e&&e.client&&(this.client=e.client,this.map={PutObjectCommand:"put",GetObjectCommand:"get",HeadObjectCommand:"head",DeleteObjectCommand:"delete",DeleteObjectsCommand:"delete",ListObjectsV2Command:"list"},this.costs={total:0,prices:{put:5e-6,copy:5e-6,list:5e-6,post:5e-6,get:4e-4/1e3,select:4e-4/1e3,delete:4e-4/1e3,head:4e-4/1e3},requests:{total:0,put:0,post:0,copy:0,list:0,get:0,select:0,delete:0,head:0},events:{total:0,PutObjectCommand:0,GetObjectCommand:0,HeadObjectCommand:0,DeleteObjectCommand:0,DeleteObjectsCommand:0,ListObjectsV2Command:0}},this.client.costs=JSON.parse(JSON.stringify(this.costs)))},async start(){this.client&&(this.client.on("command.response",e=>this.addRequest(e,this.map[e])),this.client.on("command.error",e=>this.addRequest(e,this.map[e])))},addRequest(e,t){t&&(this.costs.events[e]++,this.costs.events.total++,this.costs.requests.total++,this.costs.requests[t]++,this.costs.total+=this.costs.prices[t],this.client&&this.client.costs&&(this.client.costs.events[e]++,this.client.costs.events.total++,this.client.costs.requests.total++,this.client.costs.requests[t]++,this.client.costs.total+=this.client.costs.prices[t]))}};class Is extends Ke{constructor(e={}){super(),this.indexResource=null,this.config={minWordLength:e.minWordLength||3,maxResults:e.maxResults||100,...e},this.indexes=new Map}async setup(e){this.database=e;const[t,r,n]=await V(()=>e.createResource({name:"fulltext_indexes",attributes:{id:"string|required",resourceName:"string|required",fieldName:"string|required",word:"string|required",recordIds:"json|required",count:"number|required",lastUpdated:"string|required"}}));this.indexResource=t?n:e.resources.fulltext_indexes,await this.loadIndexes(),this.installIndexingHooks()}async start(){}async stop(){await this.saveIndexes()}async loadIndexes(){if(!this.indexResource)return;const[e,t,r]=await V(()=>this.indexResource.getAll());if(e)for(const e of r){const t=`${e.resourceName}:${e.fieldName}:${e.word}`;this.indexes.set(t,{recordIds:e.recordIds||[],count:e.count||0})}}async saveIndexes(){if(!this.indexResource)return;const[e,t]=await V(async()=>{const e=await this.indexResource.getAll();for(const t of e)await this.indexResource.delete(t.id);for(const[e,t]of this.indexes.entries()){const[r,n,i]=e.split(":");await this.indexResource.insert({id:`index-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,resourceName:r,fieldName:n,word:i,recordIds:t.recordIds,count:t.count,lastUpdated:(new Date).toISOString()})}})}installIndexingHooks(){this.database.plugins||(this.database.plugins={}),this.database.plugins.fulltext=this;for(const e of Object.values(this.database.resources))"fulltext_indexes"!==e.name&&this.installResourceHooks(e);this.database._fulltextProxyInstalled||(this.database._previousCreateResourceForFullText=this.database.createResource,this.database.createResource=async function(...e){const t=await this._previousCreateResourceForFullText(...e);return this.plugins?.fulltext&&"fulltext_indexes"!==t.name&&this.plugins.fulltext.installResourceHooks(t),t},this.database._fulltextProxyInstalled=!0);for(const e of Object.values(this.database.resources))"fulltext_indexes"!==e.name&&this.installResourceHooks(e)}installResourceHooks(e){e._insert=e.insert,e._update=e.update,e._delete=e.delete,e._deleteMany=e.deleteMany,this.wrapResourceMethod(e,"insert",async(t,r,n)=>{const[i]=r;return this.indexRecord(e.name,t.id,i).catch(console.error),t}),this.wrapResourceMethod(e,"update",async(t,r,n)=>{const[i,o]=r;return this.removeRecordFromIndex(e.name,i).catch(console.error),this.indexRecord(e.name,i,t).catch(console.error),t}),this.wrapResourceMethod(e,"delete",async(t,r,n)=>{const[i]=r;return this.removeRecordFromIndex(e.name,i).catch(console.error),t}),this.wrapResourceMethod(e,"deleteMany",async(t,r,n)=>{const[i]=r;for(const t of i)this.removeRecordFromIndex(e.name,t).catch(console.error);return t})}async indexRecord(e,t,r){const n=this.getIndexedFields(e);if(n&&0!==n.length)for(const i of n){const n=this.getFieldValue(r,i);if(!n)continue;const o=this.tokenize(n);for(const r of o){if(r.length<this.config.minWordLength)continue;const n=`${e}:${i}:${r.toLowerCase()}`,o=this.indexes.get(n)||{recordIds:[],count:0};o.recordIds.includes(t)||(o.recordIds.push(t),o.count=o.recordIds.length),this.indexes.set(n,o)}}}async removeRecordFromIndex(e,t){for(const[r,n]of this.indexes.entries())if(r.startsWith(`${e}:`)){const e=n.recordIds.indexOf(t);e>-1&&(n.recordIds.splice(e,1),n.count=n.recordIds.length,0===n.recordIds.length?this.indexes.delete(r):this.indexes.set(r,n))}}getFieldValue(e,t){if(!t.includes("."))return e&&void 0!==e[t]?e[t]:null;const r=t.split(".");let n=e;for(const e of r){if(!n||"object"!=typeof n||!(e in n))return null;n=n[e]}return n}tokenize(e){if(!e)return[];return String(e).toLowerCase().replace(/[^\w\s\u00C0-\u017F]/g," ").split(/\s+/).filter(e=>e.length>0)}getIndexedFields(e){if(this.config.fields)return this.config.fields;return{users:["name","email"],products:["name","description"],articles:["title","content"]}[e]||[]}async search(e,t,r={}){const{fields:n=null,limit:i=this.config.maxResults,offset:o=0,exactMatch:s=!1}=r;if(!t||0===t.trim().length)return[];const a=this.tokenize(t),c=new Map,u=n||this.getIndexedFields(e);if(0===u.length)return[];for(const t of a)if(!(t.length<this.config.minWordLength))for(const r of u)if(s){const n=`${e}:${r}:${t.toLowerCase()}`,i=this.indexes.get(n);if(i)for(const e of i.recordIds){const t=c.get(e)||0;c.set(e,t+1)}}else for(const[n,i]of this.indexes.entries())if(n.startsWith(`${e}:${r}:${t.toLowerCase()}`))for(const e of i.recordIds){const t=c.get(e)||0;c.set(e,t+1)}return Array.from(c.entries()).map(([e,t])=>({recordId:e,score:t})).sort((e,t)=>t.score-e.score).slice(o,o+i)}async searchRecords(e,t,r={}){const n=await this.search(e,t,r);if(0===n.length)return[];const i=this.database.resources[e];if(!i)throw new Error(`Resource '${e}' not found`);const o=n.map(e=>e.recordId);return(await i.getMany(o)).filter(e=>e&&"object"==typeof e).map(e=>{const t=n.find(t=>t.recordId===e.id);return{...e,_searchScore:t?t.score:0}}).sort((e,t)=>t._searchScore-e._searchScore)}async rebuildIndex(e){const t=this.database.resources[e];if(!t)throw new Error(`Resource '${e}' not found`);for(const[t]of this.indexes.entries())t.startsWith(`${e}:`)&&this.indexes.delete(t);const r=await t.getAll();for(let t=0;t<r.length;t+=100){const n=r.slice(t,t+100);for(const t of n){const[r,n]=await V(()=>this.indexRecord(e,t.id,t))}}await this.saveIndexes()}async getIndexStats(){const e={totalIndexes:this.indexes.size,resources:{},totalWords:0};for(const[t,r]of this.indexes.entries()){const[n,i]=t.split(":");e.resources[n]||(e.resources[n]={fields:{},totalRecords:new Set,totalWords:0}),e.resources[n].fields[i]||(e.resources[n].fields[i]={words:0,totalOccurrences:0}),e.resources[n].fields[i].words++,e.resources[n].fields[i].totalOccurrences+=r.count,e.resources[n].totalWords++;for(const t of r.recordIds)e.resources[n].totalRecords.add(t);e.totalWords++}for(const t in e.resources)e.resources[t].totalRecords=e.resources[t].totalRecords.size;return e}async rebuildAllIndexes({timeout:e}={}){return e?Promise.race([this._rebuildAllIndexesInternal(),new Promise((t,r)=>setTimeout(()=>r(new Error("Timeout")),e))]):this._rebuildAllIndexesInternal()}async _rebuildAllIndexesInternal(){const e=Object.keys(this.database.resources).filter(e=>"fulltext_indexes"!==e);for(const t of e){const[e,r]=await V(()=>this.rebuildIndex(t))}}async clearIndex(e){for(const[t]of this.indexes.entries())t.startsWith(`${e}:`)&&this.indexes.delete(t);await this.saveIndexes()}async clearAllIndexes(){this.indexes.clear(),await this.saveIndexes()}}class _s extends Ke{constructor(e={}){super(),this.config={collectPerformance:!1!==e.collectPerformance,collectErrors:!1!==e.collectErrors,collectUsage:!1!==e.collectUsage,retentionDays:e.retentionDays||30,flushInterval:e.flushInterval||6e4,...e},this.metrics={operations:{insert:{count:0,totalTime:0,errors:0},update:{count:0,totalTime:0,errors:0},delete:{count:0,totalTime:0,errors:0},get:{count:0,totalTime:0,errors:0},list:{count:0,totalTime:0,errors:0},count:{count:0,totalTime:0,errors:0}},resources:{},errors:[],performance:[],startTime:(new Date).toISOString()},this.flushTimer=null}async setup(e){if(this.database=e,"test"===process.env.NODE_ENV)return;const[t,r]=await V(async()=>{const[t,r,n]=await V(()=>e.createResource({name:"metrics",attributes:{id:"string|required",type:"string|required",resourceName:"string",operation:"string",count:"number|required",totalTime:"number|required",errors:"number|required",avgTime:"number|required",timestamp:"string|required",metadata:"json"}}));this.metricsResource=t?n:e.resources.metrics;const[i,o,s]=await V(()=>e.createResource({name:"error_logs",attributes:{id:"string|required",resourceName:"string|required",operation:"string|required",error:"string|required",timestamp:"string|required",metadata:"json"}}));this.errorsResource=i?s:e.resources.error_logs;const[a,c,u]=await V(()=>e.createResource({name:"performance_logs",attributes:{id:"string|required",resourceName:"string|required",operation:"string|required",duration:"number|required",timestamp:"string|required",metadata:"json"}}));this.performanceResource=a?u:e.resources.performance_logs});t||(this.metricsResource=e.resources.metrics,this.errorsResource=e.resources.error_logs,this.performanceResource=e.resources.performance_logs),this.installMetricsHooks(),"test"!==process.env.NODE_ENV&&this.startFlushTimer()}async start(){}async stop(){this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null),"test"!==process.env.NODE_ENV&&await this.flushMetrics()}installMetricsHooks(){for(const e of Object.values(this.database.resources))["metrics","error_logs","performance_logs"].includes(e.name)||this.installResourceHooks(e);this.database._createResource=this.database.createResource,this.database.createResource=async function(...e){const t=await this._createResource(...e);return this.plugins?.metrics&&!["metrics","error_logs","performance_logs"].includes(t.name)&&this.plugins.metrics.installResourceHooks(t),t}}installResourceHooks(e){e._insert=e.insert,e._update=e.update,e._delete=e.delete,e._deleteMany=e.deleteMany,e._get=e.get,e._getMany=e.getMany,e._getAll=e.getAll,e._list=e.list,e._listIds=e.listIds,e._count=e.count,e._page=e.page,e.insert=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._insert(...t));if(this.recordOperation(e.name,"insert",Date.now()-r,!n),n||this.recordError(e.name,"insert",i),!n)throw i;return o}.bind(this),e.update=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._update(...t));if(this.recordOperation(e.name,"update",Date.now()-r,!n),n||this.recordError(e.name,"update",i),!n)throw i;return o}.bind(this),e.delete=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._delete(...t));if(this.recordOperation(e.name,"delete",Date.now()-r,!n),n||this.recordError(e.name,"delete",i),!n)throw i;return o}.bind(this),e.deleteMany=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._deleteMany(...t));if(this.recordOperation(e.name,"delete",Date.now()-r,!n),n||this.recordError(e.name,"delete",i),!n)throw i;return o}.bind(this),e.get=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._get(...t));if(this.recordOperation(e.name,"get",Date.now()-r,!n),n||this.recordError(e.name,"get",i),!n)throw i;return o}.bind(this),e.getMany=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._getMany(...t));if(this.recordOperation(e.name,"get",Date.now()-r,!n),n||this.recordError(e.name,"get",i),!n)throw i;return o}.bind(this),e.getAll=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._getAll(...t));if(this.recordOperation(e.name,"list",Date.now()-r,!n),n||this.recordError(e.name,"list",i),!n)throw i;return o}.bind(this),e.list=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._list(...t));if(this.recordOperation(e.name,"list",Date.now()-r,!n),n||this.recordError(e.name,"list",i),!n)throw i;return o}.bind(this),e.listIds=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._listIds(...t));if(this.recordOperation(e.name,"list",Date.now()-r,!n),n||this.recordError(e.name,"list",i),!n)throw i;return o}.bind(this),e.count=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._count(...t));if(this.recordOperation(e.name,"count",Date.now()-r,!n),n||this.recordError(e.name,"count",i),!n)throw i;return o}.bind(this),e.page=async function(...t){const r=Date.now(),[n,i,o]=await V(()=>e._page(...t));if(this.recordOperation(e.name,"list",Date.now()-r,!n),n||this.recordError(e.name,"list",i),!n)throw i;return o}.bind(this)}recordOperation(e,t,r,n){this.metrics.operations[t]&&(this.metrics.operations[t].count++,this.metrics.operations[t].totalTime+=r,n&&this.metrics.operations[t].errors++),this.metrics.resources[e]||(this.metrics.resources[e]={insert:{count:0,totalTime:0,errors:0},update:{count:0,totalTime:0,errors:0},delete:{count:0,totalTime:0,errors:0},get:{count:0,totalTime:0,errors:0},list:{count:0,totalTime:0,errors:0},count:{count:0,totalTime:0,errors:0}}),this.metrics.resources[e][t]&&(this.metrics.resources[e][t].count++,this.metrics.resources[e][t].totalTime+=r,n&&this.metrics.resources[e][t].errors++),this.config.collectPerformance&&this.metrics.performance.push({resourceName:e,operation:t,duration:r,timestamp:(new Date).toISOString()})}recordError(e,t,r){this.config.collectErrors&&this.metrics.errors.push({resourceName:e,operation:t,error:r.message,stack:r.stack,timestamp:(new Date).toISOString()})}startFlushTimer(){this.flushTimer&&clearInterval(this.flushTimer),this.config.flushInterval>0&&(this.flushTimer=setInterval(()=>{this.flushMetrics().catch(console.error)},this.config.flushInterval))}async flushMetrics(){if(!this.metricsResource)return;const[e,t]=await V(async()=>{const e="test"===process.env.NODE_ENV?{}:{global:"true"},t="test"===process.env.NODE_ENV?{}:{perf:"true"},r="test"===process.env.NODE_ENV?{}:{error:"true"},n="test"===process.env.NODE_ENV?{}:{resource:"true"};for(const[t,r]of Object.entries(this.metrics.operations))r.count>0&&await this.metricsResource.insert({id:`metrics-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"operation",resourceName:"global",operation:t,count:r.count,totalTime:r.totalTime,errors:r.errors,avgTime:r.count>0?r.totalTime/r.count:0,timestamp:(new Date).toISOString(),metadata:e});for(const[e,t]of Object.entries(this.metrics.resources))for(const[r,i]of Object.entries(t))i.count>0&&await this.metricsResource.insert({id:`metrics-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"operation",resourceName:e,operation:r,count:i.count,totalTime:i.totalTime,errors:i.errors,avgTime:i.count>0?i.totalTime/i.count:0,timestamp:(new Date).toISOString(),metadata:n});if(this.config.collectPerformance&&this.metrics.performance.length>0)for(const e of this.metrics.performance)await this.performanceResource.insert({id:`perf-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,resourceName:e.resourceName,operation:e.operation,duration:e.duration,timestamp:e.timestamp,metadata:t});if(this.config.collectErrors&&this.metrics.errors.length>0)for(const e of this.metrics.errors)await this.errorsResource.insert({id:`error-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,resourceName:e.resourceName,operation:e.operation,error:e.error,stack:e.stack,timestamp:e.timestamp,metadata:r});this.resetMetrics()});e||console.error("Failed to flush metrics:",t)}resetMetrics(){for(const e of Object.keys(this.metrics.operations))this.metrics.operations[e]={count:0,totalTime:0,errors:0};for(const e of Object.keys(this.metrics.resources))for(const t of Object.keys(this.metrics.resources[e]))this.metrics.resources[e][t]={count:0,totalTime:0,errors:0};this.metrics.performance=[],this.metrics.errors=[]}async getMetrics(e={}){const{type:t="operation",resourceName:r,operation:n,startDate:i,endDate:o,limit:s=100,offset:a=0}=e;if(!this.metricsResource)return[];let c=(await this.metricsResource.getAll()).filter(e=>(!t||e.type===t)&&((!r||e.resourceName===r)&&((!n||e.operation===n)&&(!(i&&new Date(e.timestamp)<new Date(i))&&!(o&&new Date(e.timestamp)>new Date(o))))));return c.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),c.slice(a,a+s)}async getErrorLogs(e={}){if(!this.errorsResource)return[];const{resourceName:t,operation:r,startDate:n,endDate:i,limit:o=100,offset:s=0}=e;let a=(await this.errorsResource.getAll()).filter(e=>(!t||e.resourceName===t)&&((!r||e.operation===r)&&(!(n&&new Date(e.timestamp)<new Date(n))&&!(i&&new Date(e.timestamp)>new Date(i)))));return a.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),a.slice(s,s+o)}async getPerformanceLogs(e={}){if(!this.performanceResource)return[];const{resourceName:t,operation:r,startDate:n,endDate:i,limit:o=100,offset:s=0}=e;let a=(await this.performanceResource.getAll()).filter(e=>(!t||e.resourceName===t)&&((!r||e.operation===r)&&(!(n&&new Date(e.timestamp)<new Date(n))&&!(i&&new Date(e.timestamp)>new Date(i)))));return a.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),a.slice(s,s+o)}async getStats(){const e=new Date,t=new Date(e.getTime()-864e5),[r,n,i]=await Promise.all([this.getMetrics({startDate:t.toISOString()}),this.getErrorLogs({startDate:t.toISOString()}),this.getPerformanceLogs({startDate:t.toISOString()})]),o={period:"24h",totalOperations:0,totalErrors:n.length,avgResponseTime:0,operationsByType:{},resources:{},uptime:{startTime:this.metrics.startTime,duration:e.getTime()-new Date(this.metrics.startTime).getTime()}};for(const e of r)if("operation"===e.type){o.totalOperations+=e.count,o.operationsByType[e.operation]||(o.operationsByType[e.operation]={count:0,errors:0,avgTime:0}),o.operationsByType[e.operation].count+=e.count,o.operationsByType[e.operation].errors+=e.errors;const t=o.operationsByType[e.operation],r=t.count,n=(t.avgTime*(r-e.count)+e.totalTime)/r;t.avgTime=n}const s=r.reduce((e,t)=>e+t.totalTime,0),a=r.reduce((e,t)=>e+t.count,0);return o.avgResponseTime=a>0?s/a:0,o}async cleanupOldData(){const e=new Date;if(e.setDate(e.getDate()-this.config.retentionDays),this.metricsResource){const t=await this.getMetrics({endDate:e.toISOString()});for(const e of t)await this.metricsResource.delete(e.id)}if(this.errorsResource){const t=await this.getErrorLogs({endDate:e.toISOString()});for(const e of t)await this.errorsResource.delete(e.id)}if(this.performanceResource){const t=await this.getPerformanceLogs({endDate:e.toISOString()});for(const e of t)await this.performanceResource.delete(e.id)}}}var As="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function ks(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Bs(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var r=function e(){var r=!1;try{r=this instanceof e}catch{}return r?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}),r}var xs,Ss,Os={},Us={};var Cs,Ns,Rs,Ts={};function Ls(){if(Rs)return Ns;Rs=1;var e=Ss?xs:(Ss=1,xs=function(e,t){if(t=t.split(":")[0],!(e=+e))return!1;switch(t){case"http":case"ws":return 80!==e;case"https":case"wss":return 443!==e;case"ftp":return 21!==e;case"gopher":return 70!==e;case"file":return!1}return 0!==e}),t=function(){if(Cs)return Ts;Cs=1;var e=Object.prototype.hasOwnProperty;function t(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function r(e){try{return encodeURIComponent(e)}catch(e){return null}}return Ts.stringify=function(t,n){n=n||"";var i,o,s=[];for(o in"string"!=typeof n&&(n="?"),t)if(e.call(t,o)){if((i=t[o])||null!=i&&!isNaN(i)||(i=""),o=r(o),i=r(i),null===o||null===i)continue;s.push(o+"="+i)}return s.length?n+s.join("&"):""},Ts.parse=function(e){for(var r,n=/([^=?#&]+)=?([^&]*)/g,i={};r=n.exec(e);){var o=t(r[1]),s=t(r[2]);null===o||null===s||o in i||(i[o]=s)}return i},Ts}(),r=/^[\x00-\x20\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/,n=/[\n\r\t]/g,i=/^[A-Za-z][A-Za-z0-9+-.]*:\/\//,o=/:\d+$/,s=/^([a-z][a-z0-9.+-]*:)?(\/\/)?([\\/]+)?([\S\s]*)/i,a=/^[a-zA-Z]:/;function c(e){return(e||"").toString().replace(r,"")}var u=[["#","hash"],["?","query"],function(e,t){return f(t.protocol)?e.replace(/\\/g,"/"):e},["/","pathname"],["@","auth",1],[NaN,"host",void 0,1,1],[/:(\d*)$/,"port",void 0,1],[NaN,"hostname",void 0,1,1]],l={hash:1,query:1};function h(e){var t,r=("undefined"!=typeof window?window:void 0!==As?As:"undefined"!=typeof self?self:{}).location||{},n={},o=typeof(e=e||r);if("blob:"===e.protocol)n=new p(unescape(e.pathname),{});else if("string"===o)for(t in n=new p(e,{}),l)delete n[t];else if("object"===o){for(t in e)t in l||(n[t]=e[t]);void 0===n.slashes&&(n.slashes=i.test(e.href))}return n}function f(e){return"file:"===e||"ftp:"===e||"http:"===e||"https:"===e||"ws:"===e||"wss:"===e}function d(e,t){e=(e=c(e)).replace(n,""),t=t||{};var r,i=s.exec(e),o=i[1]?i[1].toLowerCase():"",a=!!i[2],u=!!i[3],l=0;return a?u?(r=i[2]+i[3]+i[4],l=i[2].length+i[3].length):(r=i[2]+i[4],l=i[2].length):u?(r=i[3]+i[4],l=i[3].length):r=i[4],"file:"===o?l>=2&&(r=r.slice(2)):f(o)?r=i[4]:o?a&&(r=r.slice(2)):l>=2&&f(t.protocol)&&(r=i[4]),{protocol:o,slashes:a||f(o),slashesCount:l,rest:r}}function p(r,i,o){if(r=(r=c(r)).replace(n,""),!(this instanceof p))return new p(r,i,o);var s,l,g,m,y,w,b=u.slice(),v=typeof i,E=this,I=0;for("object"!==v&&"string"!==v&&(o=i,i=null),o&&"function"!=typeof o&&(o=t.parse),s=!(l=d(r||"",i=h(i))).protocol&&!l.slashes,E.slashes=l.slashes||s&&i.slashes,E.protocol=l.protocol||i.protocol||"",r=l.rest,("file:"===l.protocol&&(2!==l.slashesCount||a.test(r))||!l.slashes&&(l.protocol||l.slashesCount<2||!f(E.protocol)))&&(b[3]=[/(.*)/,"pathname"]);I<b.length;I++)"function"!=typeof(m=b[I])?(g=m[0],w=m[1],g!=g?E[w]=r:"string"==typeof g?~(y="@"===g?r.lastIndexOf(g):r.indexOf(g))&&("number"==typeof m[2]?(E[w]=r.slice(0,y),r=r.slice(y+m[2])):(E[w]=r.slice(y),r=r.slice(0,y))):(y=g.exec(r))&&(E[w]=y[1],r=r.slice(0,y.index)),E[w]=E[w]||s&&m[3]&&i[w]||"",m[4]&&(E[w]=E[w].toLowerCase())):r=m(r,E);o&&(E.query=o(E.query)),s&&i.slashes&&"/"!==E.pathname.charAt(0)&&(""!==E.pathname||""!==i.pathname)&&(E.pathname=function(e,t){if(""===e)return t;for(var r=(t||"/").split("/").slice(0,-1).concat(e.split("/")),n=r.length,i=r[n-1],o=!1,s=0;n--;)"."===r[n]?r.splice(n,1):".."===r[n]?(r.splice(n,1),s++):s&&(0===n&&(o=!0),r.splice(n,1),s--);return o&&r.unshift(""),"."!==i&&".."!==i||r.push(""),r.join("/")}(E.pathname,i.pathname)),"/"!==E.pathname.charAt(0)&&f(E.protocol)&&(E.pathname="/"+E.pathname),e(E.port,E.protocol)||(E.host=E.hostname,E.port=""),E.username=E.password="",E.auth&&(~(y=E.auth.indexOf(":"))?(E.username=E.auth.slice(0,y),E.username=encodeURIComponent(decodeURIComponent(E.username)),E.password=E.auth.slice(y+1),E.password=encodeURIComponent(decodeURIComponent(E.password))):E.username=encodeURIComponent(decodeURIComponent(E.auth)),E.auth=E.password?E.username+":"+E.password:E.username),E.origin="file:"!==E.protocol&&f(E.protocol)&&E.host?E.protocol+"//"+E.host:"null",E.href=E.toString()}return p.prototype={set:function(r,n,i){var s=this;switch(r){case"query":"string"==typeof n&&n.length&&(n=(i||t.parse)(n)),s[r]=n;break;case"port":s[r]=n,e(n,s.protocol)?n&&(s.host=s.hostname+":"+n):(s.host=s.hostname,s[r]="");break;case"hostname":s[r]=n,s.port&&(n+=":"+s.port),s.host=n;break;case"host":s[r]=n,o.test(n)?(n=n.split(":"),s.port=n.pop(),s.hostname=n.join(":")):(s.hostname=n,s.port="");break;case"protocol":s.protocol=n.toLowerCase(),s.slashes=!i;break;case"pathname":case"hash":if(n){var a="pathname"===r?"/":"#";s[r]=n.charAt(0)!==a?a+n:n}else s[r]=n;break;case"username":case"password":s[r]=encodeURIComponent(n);break;case"auth":var c=n.indexOf(":");~c?(s.username=n.slice(0,c),s.username=encodeURIComponent(decodeURIComponent(s.username)),s.password=n.slice(c+1),s.password=encodeURIComponent(decodeURIComponent(s.password))):s.username=encodeURIComponent(decodeURIComponent(n))}for(var l=0;l<u.length;l++){var h=u[l];h[4]&&(s[h[1]]=s[h[1]].toLowerCase())}return s.auth=s.password?s.username+":"+s.password:s.username,s.origin="file:"!==s.protocol&&f(s.protocol)&&s.host?s.protocol+"//"+s.host:"null",s.href=s.toString(),s},toString:function(e){e&&"function"==typeof e||(e=t.stringify);var r,n=this,i=n.host,s=n.protocol;s&&":"!==s.charAt(s.length-1)&&(s+=":");var a=s+(n.protocol&&n.slashes||f(n.protocol)?"//":"");return n.username?(a+=n.username,n.password&&(a+=":"+n.password),a+="@"):n.password?(a+=":"+n.password,a+="@"):"file:"!==n.protocol&&f(n.protocol)&&!i&&"/"!==n.pathname&&(a+="@"),(":"===i[i.length-1]||o.test(n.hostname)&&!n.port)&&(i+=":"),a+=i+n.pathname,(r="object"==typeof n.query?e(n.query):n.query)&&(a+="?"!==r.charAt(0)?"?"+r:r),n.hash&&(a+=n.hash),a}},p.extractProtocol=d,p.location=h,p.trimLeft=c,p.qs=t,Ns=p}function Ds(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var js=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function Ms(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}}function Ps(e,t,r,n){return t=t||"&",r=r||"=",null===e&&(e=void 0),"object"==typeof e?Fs(qs(e),function(n){var i=encodeURIComponent(Ms(n))+r;return js(e[n])?Fs(e[n],function(e){return i+encodeURIComponent(Ms(e))}).join(t):i+encodeURIComponent(Ms(e[n]))}).join(t):n?encodeURIComponent(Ms(n))+r+encodeURIComponent(Ms(e)):""}function Fs(e,t){if(e.map)return e.map(t);for(var r=[],n=0;n<e.length;n++)r.push(t(e[n],n));return r}var qs=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t};function Qs(e,t,r,n){t=t||"&",r=r||"=";var i={};if("string"!=typeof e||0===e.length)return i;var o=/\+/g;e=e.split(t);var s=1e3;n&&"number"==typeof n.maxKeys&&(s=n.maxKeys);var a=e.length;s>0&&a>s&&(a=s);for(var c=0;c<a;++c){var u,l,h,f,d=e[c].replace(o,"%20"),p=d.indexOf(r);p>=0?(u=d.substr(0,p),l=d.substr(p+1)):(u=d,l=""),h=decodeURIComponent(u),f=decodeURIComponent(l),Ds(i,h)?js(i[h])?i[h].push(f):i[h]=[i[h],f]:i[h]=f}return i}var zs,$s,Hs,Vs={encode:Ps,stringify:Ps,decode:Qs,parse:Qs},Gs=Bs(Object.freeze({__proto__:null,decode:Qs,default:Vs,encode:Ps,parse:Qs,stringify:Ps})),Ks={},Ws={},Js={},Zs={exports:{}};function Ys(){return zs||(zs=1,function(e){var t=4294967296,r=1/t,n=9007199254740991;function i(e){return e<=n&&e>=-n}function o(e,t,r){if("number"!=typeof(e=+e)||e<t||e>r||Math.floor(e)!==e)throw new TypeError('"value" argument is out of bounds');return e}function s(e,t,r){if(t<0||t+r>e.length)throw new RangeError("Index out of range")}e.exports.isContiguousInt=i,e.exports.assertContiguousInt=function(e){if(!i(e))throw new TypeError("number cannot be represented as a contiguous integer")},["UInt","Int"].forEach(function(t){var r=t+"8";e.exports["read"+r]=It.prototype["read"+r].call,e.exports["write"+r]=It.prototype["write"+r].call,["16","32"].forEach(function(r){["LE","BE"].forEach(function(n){var i=t+r+n,o=It.prototype["read"+i];e.exports["read"+i]=function(e,t){return o.call(e,t)};var s=It.prototype["write"+i];e.exports["write"+i]=function(e,t,r){return s.call(e,t,r)}})})}),e.exports.readUInt24BE=function(e,t){return e.readUInt8(t)<<16|e.readUInt16BE(t+1)},e.exports.writeUInt24BE=function(e,t,r){t=o(t,0,16777215),s(e,r,3),e.writeUInt8(t>>>16,r),e.writeUInt16BE(65535&t,r+1)},e.exports.readUInt40BE=function(e,r){return(e.readUInt8(r)||0)*t+e.readUInt32BE(r+1)},e.exports.writeUInt40BE=function(e,t,n){t=o(t,0,0xffffffffff),s(e,n,5),e.writeUInt8(Math.floor(t*r),n),e.writeInt32BE(-1&t,n+1)},e.exports.readUInt48BE=function(e,r){return e.readUInt16BE(r)*t+e.readUInt32BE(r+2)},e.exports.writeUInt48BE=function(e,t,n){t=o(t,0,0xffffffffffff),s(e,n,6),e.writeUInt16BE(Math.floor(t*r),n),e.writeInt32BE(-1&t,n+2)},e.exports.readUInt56BE=function(e,r){return((e.readUInt8(r)||0)<<16|e.readUInt16BE(r+1))*t+e.readUInt32BE(r+3)},e.exports.writeUInt56BE=function(e,t,n){if(t=o(t,0,72057594037927940),s(e,n,7),t<72057594037927940){var i=Math.floor(t*r);e.writeUInt8(i>>>16,n),e.writeUInt16BE(65535&i,n+1),e.writeInt32BE(-1&t,n+3)}else e[n]=255,e[n+1]=255,e[n+2]=255,e[n+3]=255,e[n+4]=255,e[n+5]=255,e[n+6]=255},e.exports.readUInt64BE=function(e,r){return e.readUInt32BE(r)*t+e.readUInt32BE(r+4)},e.exports.writeUInt64BE=function(e,t,n){t=o(t,0,0x10000000000000000),s(e,n,8),t<0x10000000000000000?(e.writeUInt32BE(Math.floor(t*r),n),e.writeInt32BE(-1&t,n+4)):(e[n]=255,e[n+1]=255,e[n+2]=255,e[n+3]=255,e[n+4]=255,e[n+5]=255,e[n+6]=255,e[n+7]=255)},e.exports.readUInt24LE=function(e,t){return e.readUInt8(t+2)<<16|e.readUInt16LE(t)},e.exports.writeUInt24LE=function(e,t,r){t=o(t,0,16777215),s(e,r,3),e.writeUInt16LE(65535&t,r),e.writeUInt8(t>>>16,r+2)},e.exports.readUInt40LE=function(e,r){return(e.readUInt8(r+4)||0)*t+e.readUInt32LE(r)},e.exports.writeUInt40LE=function(e,t,n){t=o(t,0,0xffffffffff),s(e,n,5),e.writeInt32LE(-1&t,n),e.writeUInt8(Math.floor(t*r),n+4)},e.exports.readUInt48LE=function(e,r){return e.readUInt16LE(r+4)*t+e.readUInt32LE(r)},e.exports.writeUInt48LE=function(e,t,n){t=o(t,0,0xffffffffffff),s(e,n,6),e.writeInt32LE(-1&t,n),e.writeUInt16LE(Math.floor(t*r),n+4)},e.exports.readUInt56LE=function(e,r){return((e.readUInt8(r+6)||0)<<16|e.readUInt16LE(r+4))*t+e.readUInt32LE(r)},e.exports.writeUInt56LE=function(e,t,n){if(t=o(t,0,72057594037927940),s(e,n,7),t<72057594037927940){e.writeInt32LE(-1&t,n);var i=Math.floor(t*r);e.writeUInt16LE(65535&i,n+4),e.writeUInt8(i>>>16,n+6)}else e[n]=255,e[n+1]=255,e[n+2]=255,e[n+3]=255,e[n+4]=255,e[n+5]=255,e[n+6]=255},e.exports.readUInt64LE=function(e,r){return e.readUInt32LE(r+4)*t+e.readUInt32LE(r)},e.exports.writeUInt64LE=function(e,t,n){t=o(t,0,0x10000000000000000),s(e,n,8),t<0x10000000000000000?(e.writeInt32LE(-1&t,n),e.writeUInt32LE(Math.floor(t*r),n+4)):(e[n]=255,e[n+1]=255,e[n+2]=255,e[n+3]=255,e[n+4]=255,e[n+5]=255,e[n+6]=255,e[n+7]=255)},e.exports.readInt24BE=function(e,t){return(e.readInt8(t)<<16)+e.readUInt16BE(t+1)},e.exports.writeInt24BE=function(e,t,r){t=o(t,-8388608,8388607),s(e,r,3),e.writeInt8(t>>16,r),e.writeUInt16BE(65535&t,r+1)},e.exports.readInt40BE=function(e,r){return(e.readInt8(r)||0)*t+e.readUInt32BE(r+1)},e.exports.writeInt40BE=function(e,t,n){t=o(t,-549755813888,549755813887),s(e,n,5),e.writeInt8(Math.floor(t*r),n),e.writeInt32BE(-1&t,n+1)},e.exports.readInt48BE=function(e,r){return e.readInt16BE(r)*t+e.readUInt32BE(r+2)},e.exports.writeInt48BE=function(e,t,n){t=o(t,-0x800000000000,0x7fffffffffff),s(e,n,6),e.writeInt16BE(Math.floor(t*r),n),e.writeInt32BE(-1&t,n+2)},e.exports.readInt56BE=function(e,r){return(((e.readInt8(r)||0)<<16)+e.readUInt16BE(r+1))*t+e.readUInt32BE(r+3)},e.exports.writeInt56BE=function(e,t,n){if(t=o(t,-0x800000000000000,0x80000000000000),s(e,n,7),t<0x80000000000000){var i=Math.floor(t*r);e.writeInt8(i>>16,n),e.writeUInt16BE(65535&i,n+1),e.writeInt32BE(-1&t,n+3)}else e[n]=127,e[n+1]=255,e[n+2]=255,e[n+3]=255,e[n+4]=255,e[n+5]=255,e[n+6]=255},e.exports.readInt64BE=function(e,r){return e.readInt32BE(r)*t+e.readUInt32BE(r+4)},e.exports.writeInt64BE=function(e,t,n){t=o(t,-23611832414348226e5,0x8000000000000000),s(e,n,8),t<0x8000000000000000?(e.writeInt32BE(Math.floor(t*r),n),e.writeInt32BE(-1&t,n+4)):(e[n]=127,e[n+1]=255,e[n+2]=255,e[n+3]=255,e[n+4]=255,e[n+5]=255,e[n+6]=255,e[n+7]=255)},e.exports.readInt24LE=function(e,t){return(e.readInt8(t+2)<<16)+e.readUInt16LE(t)},e.exports.writeInt24LE=function(e,t,r){t=o(t,-8388608,8388607),s(e,r,3),e.writeUInt16LE(65535&t,r),e.writeInt8(t>>16,r+2)},e.exports.readInt40LE=function(e,r){return(e.readInt8(r+4)||0)*t+e.readUInt32LE(r)},e.exports.writeInt40LE=function(e,t,n){t=o(t,-549755813888,549755813887),s(e,n,5),e.writeInt32LE(-1&t,n),e.writeInt8(Math.floor(t*r),n+4)},e.exports.readInt48LE=function(e,r){return e.readInt16LE(r+4)*t+e.readUInt32LE(r)},e.exports.writeInt48LE=function(e,t,n){t=o(t,-0x800000000000,0x7fffffffffff),s(e,n,6),e.writeInt32LE(-1&t,n),e.writeInt16LE(Math.floor(t*r),n+4)},e.exports.readInt56LE=function(e,r){return(((e.readInt8(r+6)||0)<<16)+e.readUInt16LE(r+4))*t+e.readUInt32LE(r)},e.exports.writeInt56LE=function(e,t,n){if(t=o(t,-0x80000000000000,0x80000000000000),s(e,n,7),t<0x80000000000000){e.writeInt32LE(-1&t,n);var i=Math.floor(t*r);e.writeUInt16LE(65535&i,n+4),e.writeInt8(i>>16,n+6)}else e[n]=255,e[n+1]=255,e[n+2]=255,e[n+3]=255,e[n+4]=255,e[n+5]=255,e[n+6]=127},e.exports.readInt64LE=function(e,r){return e.readInt32LE(r+4)*t+e.readUInt32LE(r)},e.exports.writeInt64LE=function(e,t,n){t=o(t,-0x8000000000000000,0x8000000000000000),s(e,n,8),t<0x8000000000000000?(e.writeInt32LE(-1&t,n),e.writeInt32LE(Math.floor(t*r),n+4)):(e[n]=255,e[n+1]=255,e[n+2]=255,e[n+3]=255,e[n+4]=255,e[n+5]=255,e[n+6]=255,e[n+7]=127)}}(Zs)),Zs.exports}function Xs(){if($s)return Js;$s=1;var e=Ys();function t(e,t,n){var i=n;for(var o in n+=4,t)if(void 0!==t[o]){var s=It.byteLength(o);e.writeUInt8(s,n),n++,e.write(o,n,"utf8"),n+=s,n+=r(e,t[o],n)}var a=n-i;return e.writeUInt32BE(a-4,i),a}function r(n,i,o){var s,a=o,c=typeof i,u=i;function l(e){n.write(e,o),o++}switch(i&&"object"===c&&i.hasOwnProperty("!")&&(u=i.value,c=i["!"]),"number"==c&&(c=(s=u)>=0x8000000000000000||Math.abs(s)<0x4000000000000&&Math.floor(s)!==s?"double":u<128&&u>=-128?"byte":u>=-32768&&u<32768?"short":u>=-2147483648&&u<2147483648?"int":"long"),c){case"string":var h=It.byteLength(u,"utf8");l("S"),n.writeUInt32BE(h,o),o+=4,n.write(u,o,"utf8"),o+=h;break;case"object":null===u?l("V"):Array.isArray(u)?(l("A"),o+=function(e,t,n){var i=n;n+=4;for(var o=0,s=t.length;o<s;o++)n+=r(e,t[o],n);var a=n-i;return e.writeUInt32BE(a-4,i),a}(n,u,o)):It.isBuffer(u)?(l("x"),n.writeUInt32BE(u.length,o),o+=4,u.copy(n,o),o+=u.length):(l("F"),o+=t(n,u,o));break;case"boolean":l("t"),n.writeUInt8(u?1:0,o),o++;break;case"double":case"float64":l("d"),n.writeDoubleBE(u,o),o+=8;break;case"byte":case"int8":l("b"),n.writeInt8(u,o),o++;break;case"unsignedbyte":case"uint8":l("B"),n.writeUInt8(u,o),o++;break;case"short":case"int16":l("s"),n.writeInt16BE(u,o),o+=2;break;case"unsignedshort":case"uint16":l("u"),n.writeUInt16BE(u,o),o+=2;break;case"int":case"int32":l("I"),n.writeInt32BE(u,o),o+=4;break;case"unsignedint":case"uint32":l("i"),n.writeUInt32BE(u,o),o+=4;break;case"long":case"int64":l("l"),e.writeInt64BE(n,u,o),o+=8;break;case"timestamp":l("T"),e.writeUInt64BE(n,u,o),o+=8;break;case"float":l("f"),n.writeFloatBE(u,o),o+=4;break;case"decimal":if(l("D"),!(u.hasOwnProperty("places")&&u.hasOwnProperty("digits")&&u.places>=0&&u.places<256))throw new TypeError("Decimal value must be {'places': 0..255, 'digits': uint32}, got "+JSON.stringify(u));n[o]=u.places,o++,n.writeUInt32BE(u.digits,o),o+=4;break;default:throw new TypeError("Unknown type to encode: "+c)}return o-a}return Js.encodeTable=t,Js.decodeFields=function t(r){var n,i,o,s={},a=0,c=r.length;function u(){var i=String.fromCharCode(r[a]);switch(a++,i){case"b":o=r.readInt8(a),a++;break;case"B":o=r.readUInt8(a),a++;break;case"S":n=r.readUInt32BE(a),a+=4,o=r.toString("utf8",a,a+n),a+=n;break;case"I":o=r.readInt32BE(a),a+=4;break;case"i":o=r.readUInt32BE(a),a+=4;break;case"D":var s=r[a];a++;var c=r.readUInt32BE(a);a+=4,o={"!":"decimal",value:{places:s,digits:c}};break;case"T":o=e.readUInt64BE(r,a),a+=8,o={"!":"timestamp",value:o};break;case"F":n=r.readUInt32BE(a),a+=4,o=t(r.subarray(a,a+n)),a+=n;break;case"A":n=r.readUInt32BE(a),function(e){var t=[];for(;a<e;)u(),t.push(o);o=t}((a+=4)+n);break;case"d":o=r.readDoubleBE(a),a+=8;break;case"f":o=r.readFloatBE(a),a+=4;break;case"l":o=e.readInt64BE(r,a),a+=8;break;case"s":o=r.readInt16BE(a),a+=2;break;case"u":o=r.readUInt16BE(a),a+=2;break;case"t":o=0!=r[a],a++;break;case"V":o=null;break;case"x":n=r.readUInt32BE(a),a+=4,o=r.subarray(a,a+n),a+=n;break;default:throw new TypeError('Unexpected type tag "'+i+'"')}}for(;a<c;)n=r.readUInt8(a),a++,i=r.toString("utf8",a,a+n),a+=n,u(),s[i]=o;return s},Js}function ea(){if(Hs)return Ws;Hs=1;var e=Xs(),t=Ys(),r=e.encodeTable,n=e.decodeFields,i=It.alloc(65536);Ws.constants={FRAME_METHOD:1,FRAME_HEADER:2,FRAME_BODY:3,FRAME_HEARTBEAT:8,FRAME_MIN_SIZE:4096,FRAME_END:206,REPLY_SUCCESS:200,CONTENT_TOO_LARGE:311,NO_ROUTE:312,NO_CONSUMERS:313,ACCESS_REFUSED:403,NOT_FOUND:404,RESOURCE_LOCKED:405,PRECONDITION_FAILED:406,CONNECTION_FORCED:320,INVALID_PATH:402,FRAME_ERROR:501,SYNTAX_ERROR:502,COMMAND_INVALID:503,CHANNEL_ERROR:504,UNEXPECTED_FRAME:505,RESOURCE_ERROR:506,NOT_ALLOWED:530,NOT_IMPLEMENTED:540,INTERNAL_ERROR:541},Ws.constant_strs={1:"FRAME-METHOD",2:"FRAME-HEADER",3:"FRAME-BODY",8:"FRAME-HEARTBEAT",200:"REPLY-SUCCESS",206:"FRAME-END",311:"CONTENT-TOO-LARGE",312:"NO-ROUTE",313:"NO-CONSUMERS",320:"CONNECTION-FORCED",402:"INVALID-PATH",403:"ACCESS-REFUSED",404:"NOT-FOUND",405:"RESOURCE-LOCKED",406:"PRECONDITION-FAILED",501:"FRAME-ERROR",502:"SYNTAX-ERROR",503:"COMMAND-INVALID",504:"CHANNEL-ERROR",505:"UNEXPECTED-FRAME",506:"RESOURCE-ERROR",530:"NOT-ALLOWED",540:"NOT-IMPLEMENTED",541:"INTERNAL-ERROR",4096:"FRAME-MIN-SIZE"},Ws.FRAME_OVERHEAD=8,Ws.decode=function(e,r){switch(e){case 3932170:return s=0,a={prefetchSize:void 0,prefetchCount:void 0,global:void 0},o=(i=r).readUInt32BE(s),s+=4,a.prefetchSize=o,o=i.readUInt16BE(s),s+=2,a.prefetchCount=o,o=!!(1&i[s]),a.global=o,a;case 3932171:case 3932271:case 655411:case 655421:case 655431:case 1310761:case 2621451:case 2621461:case 2621471:case 2621491:case 3276821:case 3276851:case 5898250:case 5898251:case 5898260:case 5898261:case 5898270:case 5898271:case 5570571:return{};case 3932180:return function(e){var t,r,i=0,o={ticket:void 0,queue:void 0,consumerTag:void 0,noLocal:void 0,noAck:void 0,exclusive:void 0,nowait:void 0,arguments:void 0};return t=e.readUInt16BE(i),i+=2,o.ticket=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.queue=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.consumerTag=t,t=!!(1&e[i]),o.noLocal=t,t=!!(2&e[i]),o.noAck=t,t=!!(4&e[i]),o.exclusive=t,t=!!(8&e[i]),o.nowait=t,i++,r=e.readUInt32BE(i),i+=4,t=n(e.subarray(i,i+r)),i+=r,o.arguments=t,o}(r);case 3932181:return function(e){var t,r,n=0,i={consumerTag:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.consumerTag=t,i}(r);case 3932190:return function(e){var t,r,n=0,i={consumerTag:void 0,nowait:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.consumerTag=t,t=!!(1&e[n]),i.nowait=t,i}(r);case 3932191:return function(e){var t,r,n=0,i={consumerTag:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.consumerTag=t,i}(r);case 3932200:return function(e){var t,r,n=0,i={ticket:void 0,exchange:void 0,routingKey:void 0,mandatory:void 0,immediate:void 0};return t=e.readUInt16BE(n),n+=2,i.ticket=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.exchange=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.routingKey=t,t=!!(1&e[n]),i.mandatory=t,t=!!(2&e[n]),i.immediate=t,i}(r);case 3932210:return function(e){var t,r,n=0,i={replyCode:void 0,replyText:void 0,exchange:void 0,routingKey:void 0};return t=e.readUInt16BE(n),n+=2,i.replyCode=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.replyText=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.exchange=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.routingKey=t,i}(r);case 3932220:return function(e){var r,n,i=0,o={consumerTag:void 0,deliveryTag:void 0,redelivered:void 0,exchange:void 0,routingKey:void 0};return n=e.readUInt8(i),i++,r=e.toString("utf8",i,i+n),i+=n,o.consumerTag=r,r=t.readUInt64BE(e,i),i+=8,o.deliveryTag=r,r=!!(1&e[i]),o.redelivered=r,i++,n=e.readUInt8(i),i++,r=e.toString("utf8",i,i+n),i+=n,o.exchange=r,n=e.readUInt8(i),i++,r=e.toString("utf8",i,i+n),i+=n,o.routingKey=r,o}(r);case 3932230:return function(e){var t,r,n=0,i={ticket:void 0,queue:void 0,noAck:void 0};return t=e.readUInt16BE(n),n+=2,i.ticket=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.queue=t,t=!!(1&e[n]),i.noAck=t,i}(r);case 3932231:return function(e){var r,n,i=0,o={deliveryTag:void 0,redelivered:void 0,exchange:void 0,routingKey:void 0,messageCount:void 0};return r=t.readUInt64BE(e,i),i+=8,o.deliveryTag=r,r=!!(1&e[i]),o.redelivered=r,i++,n=e.readUInt8(i),i++,r=e.toString("utf8",i,i+n),i+=n,o.exchange=r,n=e.readUInt8(i),i++,r=e.toString("utf8",i,i+n),i+=n,o.routingKey=r,r=e.readUInt32BE(i),i+=4,o.messageCount=r,o}(r);case 3932232:return function(e){var t,r,n=0,i={clusterId:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.clusterId=t,i}(r);case 3932240:return function(e){var r,n=0,i={deliveryTag:void 0,multiple:void 0};return r=t.readUInt64BE(e,n),n+=8,i.deliveryTag=r,r=!!(1&e[n]),i.multiple=r,i}(r);case 3932250:return function(e){var r,n=0,i={deliveryTag:void 0,requeue:void 0};return r=t.readUInt64BE(e,n),n+=8,i.deliveryTag=r,r=!!(1&e[n]),i.requeue=r,i}(r);case 3932260:return function(e){var t,r={requeue:void 0};return t=!!(1&e[0]),r.requeue=t,r}(r);case 3932270:return function(e){var t,r={requeue:void 0};return t=!!(1&e[0]),r.requeue=t,r}(r);case 3932280:return function(e){var r,n=0,i={deliveryTag:void 0,multiple:void 0,requeue:void 0};return r=t.readUInt64BE(e,n),n+=8,i.deliveryTag=r,r=!!(1&e[n]),i.multiple=r,r=!!(2&e[n]),i.requeue=r,i}(r);case 655370:return function(e){var t,r,i=0,o={versionMajor:void 0,versionMinor:void 0,serverProperties:void 0,mechanisms:void 0,locales:void 0};return t=e[i],i++,o.versionMajor=t,t=e[i],i++,o.versionMinor=t,r=e.readUInt32BE(i),i+=4,t=n(e.subarray(i,i+r)),i+=r,o.serverProperties=t,r=e.readUInt32BE(i),i+=4,t=e.subarray(i,i+r),i+=r,o.mechanisms=t,r=e.readUInt32BE(i),i+=4,t=e.subarray(i,i+r),i+=r,o.locales=t,o}(r);case 655371:return function(e){var t,r,i=0,o={clientProperties:void 0,mechanism:void 0,response:void 0,locale:void 0};return r=e.readUInt32BE(i),i+=4,t=n(e.subarray(i,i+r)),i+=r,o.clientProperties=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.mechanism=t,r=e.readUInt32BE(i),i+=4,t=e.subarray(i,i+r),i+=r,o.response=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.locale=t,o}(r);case 655380:return function(e){var t,r,n=0,i={challenge:void 0};return r=e.readUInt32BE(n),n+=4,t=e.subarray(n,n+r),n+=r,i.challenge=t,i}(r);case 655381:return function(e){var t,r,n=0,i={response:void 0};return r=e.readUInt32BE(n),n+=4,t=e.subarray(n,n+r),n+=r,i.response=t,i}(r);case 655390:return function(e){var t,r=0,n={channelMax:void 0,frameMax:void 0,heartbeat:void 0};return t=e.readUInt16BE(r),r+=2,n.channelMax=t,t=e.readUInt32BE(r),r+=4,n.frameMax=t,t=e.readUInt16BE(r),r+=2,n.heartbeat=t,n}(r);case 655391:return function(e){var t,r=0,n={channelMax:void 0,frameMax:void 0,heartbeat:void 0};return t=e.readUInt16BE(r),r+=2,n.channelMax=t,t=e.readUInt32BE(r),r+=4,n.frameMax=t,t=e.readUInt16BE(r),r+=2,n.heartbeat=t,n}(r);case 655400:return function(e){var t,r,n=0,i={virtualHost:void 0,capabilities:void 0,insist:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.virtualHost=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.capabilities=t,t=!!(1&e[n]),i.insist=t,i}(r);case 655401:return function(e){var t,r,n=0,i={knownHosts:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.knownHosts=t,i}(r);case 655410:return function(e){var t,r,n=0,i={replyCode:void 0,replyText:void 0,classId:void 0,methodId:void 0};return t=e.readUInt16BE(n),n+=2,i.replyCode=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.replyText=t,t=e.readUInt16BE(n),n+=2,i.classId=t,t=e.readUInt16BE(n),n+=2,i.methodId=t,i}(r);case 655420:return function(e){var t,r,n=0,i={reason:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.reason=t,i}(r);case 655430:return function(e){var t,r,n=0,i={newSecret:void 0,reason:void 0};return r=e.readUInt32BE(n),n+=4,t=e.subarray(n,n+r),n+=r,i.newSecret=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.reason=t,i}(r);case 1310730:return function(e){var t,r,n=0,i={outOfBand:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.outOfBand=t,i}(r);case 1310731:return function(e){var t,r,n=0,i={channelId:void 0};return r=e.readUInt32BE(n),n+=4,t=e.subarray(n,n+r),n+=r,i.channelId=t,i}(r);case 1310740:return function(e){var t,r={active:void 0};return t=!!(1&e[0]),r.active=t,r}(r);case 1310741:return function(e){var t,r={active:void 0};return t=!!(1&e[0]),r.active=t,r}(r);case 1310760:return function(e){var t,r,n=0,i={replyCode:void 0,replyText:void 0,classId:void 0,methodId:void 0};return t=e.readUInt16BE(n),n+=2,i.replyCode=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.replyText=t,t=e.readUInt16BE(n),n+=2,i.classId=t,t=e.readUInt16BE(n),n+=2,i.methodId=t,i}(r);case 1966090:return function(e){var t,r,n=0,i={realm:void 0,exclusive:void 0,passive:void 0,active:void 0,write:void 0,read:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.realm=t,t=!!(1&e[n]),i.exclusive=t,t=!!(2&e[n]),i.passive=t,t=!!(4&e[n]),i.active=t,t=!!(8&e[n]),i.write=t,t=!!(16&e[n]),i.read=t,i}(r);case 1966091:return function(e){var t,r=0,n={ticket:void 0};return t=e.readUInt16BE(r),r+=2,n.ticket=t,n}(r);case 2621450:return function(e){var t,r,i=0,o={ticket:void 0,exchange:void 0,type:void 0,passive:void 0,durable:void 0,autoDelete:void 0,internal:void 0,nowait:void 0,arguments:void 0};return t=e.readUInt16BE(i),i+=2,o.ticket=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.exchange=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.type=t,t=!!(1&e[i]),o.passive=t,t=!!(2&e[i]),o.durable=t,t=!!(4&e[i]),o.autoDelete=t,t=!!(8&e[i]),o.internal=t,t=!!(16&e[i]),o.nowait=t,i++,r=e.readUInt32BE(i),i+=4,t=n(e.subarray(i,i+r)),i+=r,o.arguments=t,o}(r);case 2621460:return function(e){var t,r,n=0,i={ticket:void 0,exchange:void 0,ifUnused:void 0,nowait:void 0};return t=e.readUInt16BE(n),n+=2,i.ticket=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.exchange=t,t=!!(1&e[n]),i.ifUnused=t,t=!!(2&e[n]),i.nowait=t,i}(r);case 2621470:return function(e){var t,r,i=0,o={ticket:void 0,destination:void 0,source:void 0,routingKey:void 0,nowait:void 0,arguments:void 0};return t=e.readUInt16BE(i),i+=2,o.ticket=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.destination=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.source=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.routingKey=t,t=!!(1&e[i]),o.nowait=t,i++,r=e.readUInt32BE(i),i+=4,t=n(e.subarray(i,i+r)),i+=r,o.arguments=t,o}(r);case 2621480:return function(e){var t,r,i=0,o={ticket:void 0,destination:void 0,source:void 0,routingKey:void 0,nowait:void 0,arguments:void 0};return t=e.readUInt16BE(i),i+=2,o.ticket=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.destination=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.source=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.routingKey=t,t=!!(1&e[i]),o.nowait=t,i++,r=e.readUInt32BE(i),i+=4,t=n(e.subarray(i,i+r)),i+=r,o.arguments=t,o}(r);case 3276810:return function(e){var t,r,i=0,o={ticket:void 0,queue:void 0,passive:void 0,durable:void 0,exclusive:void 0,autoDelete:void 0,nowait:void 0,arguments:void 0};return t=e.readUInt16BE(i),i+=2,o.ticket=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.queue=t,t=!!(1&e[i]),o.passive=t,t=!!(2&e[i]),o.durable=t,t=!!(4&e[i]),o.exclusive=t,t=!!(8&e[i]),o.autoDelete=t,t=!!(16&e[i]),o.nowait=t,i++,r=e.readUInt32BE(i),i+=4,t=n(e.subarray(i,i+r)),i+=r,o.arguments=t,o}(r);case 3276811:return function(e){var t,r,n=0,i={queue:void 0,messageCount:void 0,consumerCount:void 0};return r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.queue=t,t=e.readUInt32BE(n),n+=4,i.messageCount=t,t=e.readUInt32BE(n),n+=4,i.consumerCount=t,i}(r);case 3276820:return function(e){var t,r,i=0,o={ticket:void 0,queue:void 0,exchange:void 0,routingKey:void 0,nowait:void 0,arguments:void 0};return t=e.readUInt16BE(i),i+=2,o.ticket=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.queue=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.exchange=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.routingKey=t,t=!!(1&e[i]),o.nowait=t,i++,r=e.readUInt32BE(i),i+=4,t=n(e.subarray(i,i+r)),i+=r,o.arguments=t,o}(r);case 3276830:return function(e){var t,r,n=0,i={ticket:void 0,queue:void 0,nowait:void 0};return t=e.readUInt16BE(n),n+=2,i.ticket=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.queue=t,t=!!(1&e[n]),i.nowait=t,i}(r);case 3276831:return function(e){var t,r=0,n={messageCount:void 0};return t=e.readUInt32BE(r),r+=4,n.messageCount=t,n}(r);case 3276840:return function(e){var t,r,n=0,i={ticket:void 0,queue:void 0,ifUnused:void 0,ifEmpty:void 0,nowait:void 0};return t=e.readUInt16BE(n),n+=2,i.ticket=t,r=e.readUInt8(n),n++,t=e.toString("utf8",n,n+r),n+=r,i.queue=t,t=!!(1&e[n]),i.ifUnused=t,t=!!(2&e[n]),i.ifEmpty=t,t=!!(4&e[n]),i.nowait=t,i}(r);case 3276841:return function(e){var t,r=0,n={messageCount:void 0};return t=e.readUInt32BE(r),r+=4,n.messageCount=t,n}(r);case 3276850:return function(e){var t,r,i=0,o={ticket:void 0,queue:void 0,exchange:void 0,routingKey:void 0,arguments:void 0};return t=e.readUInt16BE(i),i+=2,o.ticket=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.queue=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.exchange=t,r=e.readUInt8(i),i++,t=e.toString("utf8",i,i+r),i+=r,o.routingKey=t,r=e.readUInt32BE(i),i+=4,t=n(e.subarray(i,i+r)),i+=r,o.arguments=t,o}(r);case 5570570:return function(e){var t,r={nowait:void 0};return t=!!(1&e[0]),r.nowait=t,r}(r);case 60:return function(e){var r,i,o,s=2;if(0===(r=e.readUInt16BE(0)))return{};var a={contentType:void 0,contentEncoding:void 0,headers:void 0,deliveryMode:void 0,priority:void 0,correlationId:void 0,replyTo:void 0,expiration:void 0,messageId:void 0,timestamp:void 0,type:void 0,userId:void 0,appId:void 0,clusterId:void 0};return 32768&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.contentType=i),16384&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.contentEncoding=i),8192&r&&(o=e.readUInt32BE(s),s+=4,i=n(e.subarray(s,s+o)),s+=o,a.headers=i),4096&r&&(i=e[s],s++,a.deliveryMode=i),2048&r&&(i=e[s],s++,a.priority=i),1024&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.correlationId=i),512&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.replyTo=i),256&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.expiration=i),128&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.messageId=i),64&r&&(i=t.readUInt64BE(e,s),s+=8,a.timestamp=i),32&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.type=i),16&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.userId=i),8&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.appId=i),4&r&&(o=e.readUInt8(s),s++,i=e.toString("utf8",s,s+o),s+=o,a.clusterId=i),a}(r);default:throw new Error("Unknown class/method ID")}var i,o,s,a},Ws.encodeMethod=function(e,n,o){switch(e){case 3932170:return function(e,t){var r=0,n=null,i=0,o=It.alloc(19);if(o[0]=1,o.writeUInt16BE(e,1),o.writeUInt32BE(3932170,7),r=11,void 0===(n=t.prefetchSize))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'prefetchSize' is the wrong type; must be a number (but not NaN)");if(o.writeUInt32BE(n,r),r+=4,void 0===(n=t.prefetchCount))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'prefetchCount' is the wrong type; must be a number (but not NaN)");return o.writeUInt16BE(n,r),r+=2,void 0===(n=t.global)&&(n=!1),n&&(i+=1),o[r]=i,o[++r]=206,o.writeUInt32BE(r-7,3),o}(n,o);case 3932171:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(3932171,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 3932180:return function(e,t){var n,o=0,s=null,a=0,c=0,u=0;if(void 0===(s=t.queue))s="";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'queue' is the wrong type; must be a string (up to 255 chars)");var l=It.byteLength(s,"utf8");if(c+=l,void 0===(s=t.consumerTag))s="";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'consumerTag' is the wrong type; must be a string (up to 255 chars)");var h=It.byteLength(s,"utf8");if(c+=h,void 0===(s=t.arguments))s={};else if("object"!=typeof s)throw new TypeError("Field 'arguments' is the wrong type; must be an object");n=r(i,s,u);var f=i.slice(u,u+n);u+=n,c+=f.length;var d=It.alloc(17+c);if(d[0]=1,d.writeUInt16BE(e,1),d.writeUInt32BE(3932180,7),o=11,void 0===(s=t.ticket))s=0;else if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return d.writeUInt16BE(s,o),o+=2,void 0===(s=t.queue)&&(s=""),d[o]=l,o++,d.write(s,o,"utf8"),o+=l,void 0===(s=t.consumerTag)&&(s=""),d[o]=h,o++,d.write(s,o,"utf8"),o+=h,void 0===(s=t.noLocal)&&(s=!1),s&&(a+=1),void 0===(s=t.noAck)&&(s=!1),s&&(a+=2),void 0===(s=t.exclusive)&&(s=!1),s&&(a+=4),void 0===(s=t.nowait)&&(s=!1),s&&(a+=8),d[o]=a,o++,a=0,d[o+=f.copy(d,o)]=206,d.writeUInt32BE(o-7,3),d}(n,o);case 3932181:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.consumerTag))throw new Error("Missing value for mandatory field 'consumerTag'");if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'consumerTag' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");i+=o;var s=It.alloc(13+i);return s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(3932181,7),r=11,void 0===(n=t.consumerTag)&&(n=void 0),s[r]=o,r++,s.write(n,r,"utf8"),s[r+=o]=206,s.writeUInt32BE(r-7,3),s}(n,o);case 3932190:return function(e,t){var r=0,n=null,i=0,o=0;if(void 0===(n=t.consumerTag))throw new Error("Missing value for mandatory field 'consumerTag'");if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'consumerTag' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(n,"utf8");o+=s;var a=It.alloc(14+o);return a[0]=1,a.writeUInt16BE(e,1),a.writeUInt32BE(3932190,7),r=11,void 0===(n=t.consumerTag)&&(n=void 0),a[r]=s,r++,a.write(n,r,"utf8"),r+=s,void 0===(n=t.nowait)&&(n=!1),n&&(i+=1),a[r]=i,a[++r]=206,a.writeUInt32BE(r-7,3),a}(n,o);case 3932191:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.consumerTag))throw new Error("Missing value for mandatory field 'consumerTag'");if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'consumerTag' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");i+=o;var s=It.alloc(13+i);return s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(3932191,7),r=11,void 0===(n=t.consumerTag)&&(n=void 0),s[r]=o,r++,s.write(n,r,"utf8"),s[r+=o]=206,s.writeUInt32BE(r-7,3),s}(n,o);case 3932200:return function(e,t){var r=0,n=null,i=0,o=0;if(void 0===(n=t.exchange))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'exchange' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(n,"utf8");if(o+=s,void 0===(n=t.routingKey))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'routingKey' is the wrong type; must be a string (up to 255 chars)");var a=It.byteLength(n,"utf8");o+=a;var c=It.alloc(17+o);if(c[0]=1,c.writeUInt16BE(e,1),c.writeUInt32BE(3932200,7),r=11,void 0===(n=t.ticket))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return c.writeUInt16BE(n,r),r+=2,void 0===(n=t.exchange)&&(n=""),c[r]=s,r++,c.write(n,r,"utf8"),r+=s,void 0===(n=t.routingKey)&&(n=""),c[r]=a,r++,c.write(n,r,"utf8"),r+=a,void 0===(n=t.mandatory)&&(n=!1),n&&(i+=1),void 0===(n=t.immediate)&&(n=!1),n&&(i+=2),c[r]=i,c[++r]=206,c.writeUInt32BE(r-7,3),c}(n,o);case 3932210:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.replyText))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'replyText' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");if(i+=o,void 0===(n=t.exchange))throw new Error("Missing value for mandatory field 'exchange'");if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'exchange' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(n,"utf8");if(i+=s,void 0===(n=t.routingKey))throw new Error("Missing value for mandatory field 'routingKey'");if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'routingKey' is the wrong type; must be a string (up to 255 chars)");var a=It.byteLength(n,"utf8");i+=a;var c=It.alloc(17+i);if(c[0]=1,c.writeUInt16BE(e,1),c.writeUInt32BE(3932210,7),r=11,void 0===(n=t.replyCode))throw new Error("Missing value for mandatory field 'replyCode'");if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'replyCode' is the wrong type; must be a number (but not NaN)");return c.writeUInt16BE(n,r),r+=2,void 0===(n=t.replyText)&&(n=""),c[r]=o,r++,c.write(n,r,"utf8"),r+=o,void 0===(n=t.exchange)&&(n=void 0),c[r]=s,r++,c.write(n,r,"utf8"),r+=s,void 0===(n=t.routingKey)&&(n=void 0),c[r]=a,r++,c.write(n,r,"utf8"),c[r+=a]=206,c.writeUInt32BE(r-7,3),c}(n,o);case 3932220:return function(e,r){var n=0,i=null,o=0,s=0;if(void 0===(i=r.consumerTag))throw new Error("Missing value for mandatory field 'consumerTag'");if(!("string"==typeof i&&It.byteLength(i)<256))throw new TypeError("Field 'consumerTag' is the wrong type; must be a string (up to 255 chars)");var a=It.byteLength(i,"utf8");if(s+=a,void 0===(i=r.exchange))throw new Error("Missing value for mandatory field 'exchange'");if(!("string"==typeof i&&It.byteLength(i)<256))throw new TypeError("Field 'exchange' is the wrong type; must be a string (up to 255 chars)");var c=It.byteLength(i,"utf8");if(s+=c,void 0===(i=r.routingKey))throw new Error("Missing value for mandatory field 'routingKey'");if(!("string"==typeof i&&It.byteLength(i)<256))throw new TypeError("Field 'routingKey' is the wrong type; must be a string (up to 255 chars)");var u=It.byteLength(i,"utf8");s+=u;var l=It.alloc(24+s);if(l[0]=1,l.writeUInt16BE(e,1),l.writeUInt32BE(3932220,7),n=11,void 0===(i=r.consumerTag)&&(i=void 0),l[n]=a,n++,l.write(i,n,"utf8"),n+=a,void 0===(i=r.deliveryTag))throw new Error("Missing value for mandatory field 'deliveryTag'");if("number"!=typeof i||isNaN(i))throw new TypeError("Field 'deliveryTag' is the wrong type; must be a number (but not NaN)");return t.writeUInt64BE(l,i,n),n+=8,void 0===(i=r.redelivered)&&(i=!1),i&&(o+=1),l[n]=o,n++,o=0,void 0===(i=r.exchange)&&(i=void 0),l[n]=c,n++,l.write(i,n,"utf8"),n+=c,void 0===(i=r.routingKey)&&(i=void 0),l[n]=u,n++,l.write(i,n,"utf8"),l[n+=u]=206,l.writeUInt32BE(n-7,3),l}(n,o);case 3932230:return function(e,t){var r=0,n=null,i=0,o=0;if(void 0===(n=t.queue))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'queue' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(n,"utf8");o+=s;var a=It.alloc(16+o);if(a[0]=1,a.writeUInt16BE(e,1),a.writeUInt32BE(3932230,7),r=11,void 0===(n=t.ticket))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return a.writeUInt16BE(n,r),r+=2,void 0===(n=t.queue)&&(n=""),a[r]=s,r++,a.write(n,r,"utf8"),r+=s,void 0===(n=t.noAck)&&(n=!1),n&&(i+=1),a[r]=i,a[++r]=206,a.writeUInt32BE(r-7,3),a}(n,o);case 3932231:return function(e,r){var n=0,i=null,o=0,s=0;if(void 0===(i=r.exchange))throw new Error("Missing value for mandatory field 'exchange'");if(!("string"==typeof i&&It.byteLength(i)<256))throw new TypeError("Field 'exchange' is the wrong type; must be a string (up to 255 chars)");var a=It.byteLength(i,"utf8");if(s+=a,void 0===(i=r.routingKey))throw new Error("Missing value for mandatory field 'routingKey'");if(!("string"==typeof i&&It.byteLength(i)<256))throw new TypeError("Field 'routingKey' is the wrong type; must be a string (up to 255 chars)");var c=It.byteLength(i,"utf8");s+=c;var u=It.alloc(27+s);if(u[0]=1,u.writeUInt16BE(e,1),u.writeUInt32BE(3932231,7),n=11,void 0===(i=r.deliveryTag))throw new Error("Missing value for mandatory field 'deliveryTag'");if("number"!=typeof i||isNaN(i))throw new TypeError("Field 'deliveryTag' is the wrong type; must be a number (but not NaN)");if(t.writeUInt64BE(u,i,n),n+=8,void 0===(i=r.redelivered)&&(i=!1),i&&(o+=1),u[n]=o,n++,o=0,void 0===(i=r.exchange)&&(i=void 0),u[n]=a,n++,u.write(i,n,"utf8"),n+=a,void 0===(i=r.routingKey)&&(i=void 0),u[n]=c,n++,u.write(i,n,"utf8"),n+=c,void 0===(i=r.messageCount))throw new Error("Missing value for mandatory field 'messageCount'");if("number"!=typeof i||isNaN(i))throw new TypeError("Field 'messageCount' is the wrong type; must be a number (but not NaN)");return u.writeUInt32BE(i,n),u[n+=4]=206,u.writeUInt32BE(n-7,3),u}(n,o);case 3932232:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.clusterId))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'clusterId' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");i+=o;var s=It.alloc(13+i);return s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(3932232,7),r=11,void 0===(n=t.clusterId)&&(n=""),s[r]=o,r++,s.write(n,r,"utf8"),s[r+=o]=206,s.writeUInt32BE(r-7,3),s}(n,o);case 3932240:return function(e,r){var n=0,i=null,o=0,s=It.alloc(21);if(s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(3932240,7),n=11,void 0===(i=r.deliveryTag))i=0;else if("number"!=typeof i||isNaN(i))throw new TypeError("Field 'deliveryTag' is the wrong type; must be a number (but not NaN)");return t.writeUInt64BE(s,i,n),n+=8,void 0===(i=r.multiple)&&(i=!1),i&&(o+=1),s[n]=o,s[++n]=206,s.writeUInt32BE(n-7,3),s}(n,o);case 3932250:return function(e,r){var n=0,i=null,o=0,s=It.alloc(21);if(s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(3932250,7),n=11,void 0===(i=r.deliveryTag))throw new Error("Missing value for mandatory field 'deliveryTag'");if("number"!=typeof i||isNaN(i))throw new TypeError("Field 'deliveryTag' is the wrong type; must be a number (but not NaN)");return t.writeUInt64BE(s,i,n),n+=8,void 0===(i=r.requeue)&&(i=!0),i&&(o+=1),s[n]=o,s[++n]=206,s.writeUInt32BE(n-7,3),s}(n,o);case 3932260:return function(e,t){var r=0,n=null,i=0,o=It.alloc(13);return o[0]=1,o.writeUInt16BE(e,1),o.writeUInt32BE(3932260,7),r=11,void 0===(n=t.requeue)&&(n=!1),n&&(i+=1),o[r]=i,o[++r]=206,o.writeUInt32BE(r-7,3),o}(n,o);case 3932270:return function(e,t){var r=0,n=null,i=0,o=It.alloc(13);return o[0]=1,o.writeUInt16BE(e,1),o.writeUInt32BE(3932270,7),r=11,void 0===(n=t.requeue)&&(n=!1),n&&(i+=1),o[r]=i,o[++r]=206,o.writeUInt32BE(r-7,3),o}(n,o);case 3932271:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(3932271,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 3932280:return function(e,r){var n=0,i=null,o=0,s=It.alloc(21);if(s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(3932280,7),n=11,void 0===(i=r.deliveryTag))i=0;else if("number"!=typeof i||isNaN(i))throw new TypeError("Field 'deliveryTag' is the wrong type; must be a number (but not NaN)");return t.writeUInt64BE(s,i,n),n+=8,void 0===(i=r.multiple)&&(i=!1),i&&(o+=1),void 0===(i=r.requeue)&&(i=!0),i&&(o+=2),s[n]=o,s[++n]=206,s.writeUInt32BE(n-7,3),s}(n,o);case 655370:return function(e,t){var n,o=0,s=null,a=0,c=0;if(void 0===(s=t.serverProperties))throw new Error("Missing value for mandatory field 'serverProperties'");if("object"!=typeof s)throw new TypeError("Field 'serverProperties' is the wrong type; must be an object");n=r(i,s,c);var u=i.slice(c,c+n);if(c+=n,a+=u.length,void 0===(s=t.mechanisms))s=It.from("PLAIN");else if(!It.isBuffer(s))throw new TypeError("Field 'mechanisms' is the wrong type; must be a Buffer");if(a+=s.length,void 0===(s=t.locales))s=It.from("en_US");else if(!It.isBuffer(s))throw new TypeError("Field 'locales' is the wrong type; must be a Buffer");a+=s.length;var l=It.alloc(22+a);if(l[0]=1,l.writeUInt16BE(e,1),l.writeUInt32BE(655370,7),o=11,void 0===(s=t.versionMajor))s=0;else if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'versionMajor' is the wrong type; must be a number (but not NaN)");if(l.writeUInt8(s,o),o++,void 0===(s=t.versionMinor))s=9;else if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'versionMinor' is the wrong type; must be a number (but not NaN)");return l.writeUInt8(s,o),o++,o+=u.copy(l,o),void 0===(s=t.mechanisms)&&(s=It.from("PLAIN")),n=s.length,l.writeUInt32BE(n,o),o+=4,s.copy(l,o),o+=n,void 0===(s=t.locales)&&(s=It.from("en_US")),n=s.length,l.writeUInt32BE(n,o),o+=4,s.copy(l,o),l[o+=n]=206,l.writeUInt32BE(o-7,3),l}(n,o);case 655371:return function(e,t){var n,o=0,s=null,a=0,c=0;if(void 0===(s=t.clientProperties))throw new Error("Missing value for mandatory field 'clientProperties'");if("object"!=typeof s)throw new TypeError("Field 'clientProperties' is the wrong type; must be an object");n=r(i,s,c);var u=i.slice(c,c+n);if(c+=n,a+=u.length,void 0===(s=t.mechanism))s="PLAIN";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'mechanism' is the wrong type; must be a string (up to 255 chars)");var l=It.byteLength(s,"utf8");if(a+=l,void 0===(s=t.response))throw new Error("Missing value for mandatory field 'response'");if(!It.isBuffer(s))throw new TypeError("Field 'response' is the wrong type; must be a Buffer");if(a+=s.length,void 0===(s=t.locale))s="en_US";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'locale' is the wrong type; must be a string (up to 255 chars)");var h=It.byteLength(s,"utf8");a+=h;var f=It.alloc(18+a);return f[0]=1,f.writeUInt16BE(e,1),f.writeUInt32BE(655371,7),o=11,o+=u.copy(f,o),void 0===(s=t.mechanism)&&(s="PLAIN"),f[o]=l,o++,f.write(s,o,"utf8"),o+=l,void 0===(s=t.response)&&(s=It.from(void 0)),n=s.length,f.writeUInt32BE(n,o),o+=4,s.copy(f,o),o+=n,void 0===(s=t.locale)&&(s="en_US"),f[o]=h,o++,f.write(s,o,"utf8"),f[o+=h]=206,f.writeUInt32BE(o-7,3),f}(n,o);case 655380:return function(e,t){var r,n=0,i=null,o=0;if(void 0===(i=t.challenge))throw new Error("Missing value for mandatory field 'challenge'");if(!It.isBuffer(i))throw new TypeError("Field 'challenge' is the wrong type; must be a Buffer");o+=i.length;var s=It.alloc(16+o);return s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(655380,7),n=11,void 0===(i=t.challenge)&&(i=It.from(void 0)),r=i.length,s.writeUInt32BE(r,n),n+=4,i.copy(s,n),s[n+=r]=206,s.writeUInt32BE(n-7,3),s}(n,o);case 655381:return function(e,t){var r,n=0,i=null,o=0;if(void 0===(i=t.response))throw new Error("Missing value for mandatory field 'response'");if(!It.isBuffer(i))throw new TypeError("Field 'response' is the wrong type; must be a Buffer");o+=i.length;var s=It.alloc(16+o);return s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(655381,7),n=11,void 0===(i=t.response)&&(i=It.from(void 0)),r=i.length,s.writeUInt32BE(r,n),n+=4,i.copy(s,n),s[n+=r]=206,s.writeUInt32BE(n-7,3),s}(n,o);case 655390:return function(e,t){var r=0,n=null,i=It.alloc(20);if(i[0]=1,i.writeUInt16BE(e,1),i.writeUInt32BE(655390,7),r=11,void 0===(n=t.channelMax))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'channelMax' is the wrong type; must be a number (but not NaN)");if(i.writeUInt16BE(n,r),r+=2,void 0===(n=t.frameMax))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'frameMax' is the wrong type; must be a number (but not NaN)");if(i.writeUInt32BE(n,r),r+=4,void 0===(n=t.heartbeat))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'heartbeat' is the wrong type; must be a number (but not NaN)");return i.writeUInt16BE(n,r),i[r+=2]=206,i.writeUInt32BE(r-7,3),i}(n,o);case 655391:return function(e,t){var r=0,n=null,i=It.alloc(20);if(i[0]=1,i.writeUInt16BE(e,1),i.writeUInt32BE(655391,7),r=11,void 0===(n=t.channelMax))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'channelMax' is the wrong type; must be a number (but not NaN)");if(i.writeUInt16BE(n,r),r+=2,void 0===(n=t.frameMax))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'frameMax' is the wrong type; must be a number (but not NaN)");if(i.writeUInt32BE(n,r),r+=4,void 0===(n=t.heartbeat))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'heartbeat' is the wrong type; must be a number (but not NaN)");return i.writeUInt16BE(n,r),i[r+=2]=206,i.writeUInt32BE(r-7,3),i}(n,o);case 655400:return function(e,t){var r=0,n=null,i=0,o=0;if(void 0===(n=t.virtualHost))n="/";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'virtualHost' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(n,"utf8");if(o+=s,void 0===(n=t.capabilities))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'capabilities' is the wrong type; must be a string (up to 255 chars)");var a=It.byteLength(n,"utf8");o+=a;var c=It.alloc(15+o);return c[0]=1,c.writeUInt16BE(e,1),c.writeUInt32BE(655400,7),r=11,void 0===(n=t.virtualHost)&&(n="/"),c[r]=s,r++,c.write(n,r,"utf8"),r+=s,void 0===(n=t.capabilities)&&(n=""),c[r]=a,r++,c.write(n,r,"utf8"),r+=a,void 0===(n=t.insist)&&(n=!1),n&&(i+=1),c[r]=i,c[++r]=206,c.writeUInt32BE(r-7,3),c}(n,o);case 655401:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.knownHosts))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'knownHosts' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");i+=o;var s=It.alloc(13+i);return s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(655401,7),r=11,void 0===(n=t.knownHosts)&&(n=""),s[r]=o,r++,s.write(n,r,"utf8"),s[r+=o]=206,s.writeUInt32BE(r-7,3),s}(n,o);case 655410:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.replyText))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'replyText' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");i+=o;var s=It.alloc(19+i);if(s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(655410,7),r=11,void 0===(n=t.replyCode))throw new Error("Missing value for mandatory field 'replyCode'");if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'replyCode' is the wrong type; must be a number (but not NaN)");if(s.writeUInt16BE(n,r),r+=2,void 0===(n=t.replyText)&&(n=""),s[r]=o,r++,s.write(n,r,"utf8"),r+=o,void 0===(n=t.classId))throw new Error("Missing value for mandatory field 'classId'");if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'classId' is the wrong type; must be a number (but not NaN)");if(s.writeUInt16BE(n,r),r+=2,void 0===(n=t.methodId))throw new Error("Missing value for mandatory field 'methodId'");if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'methodId' is the wrong type; must be a number (but not NaN)");return s.writeUInt16BE(n,r),s[r+=2]=206,s.writeUInt32BE(r-7,3),s}(n,o);case 655411:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(655411,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 655420:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.reason))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'reason' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");i+=o;var s=It.alloc(13+i);return s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(655420,7),r=11,void 0===(n=t.reason)&&(n=""),s[r]=o,r++,s.write(n,r,"utf8"),s[r+=o]=206,s.writeUInt32BE(r-7,3),s}(n,o);case 655421:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(655421,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 655430:return function(e,t){var r,n=0,i=null,o=0;if(void 0===(i=t.newSecret))throw new Error("Missing value for mandatory field 'newSecret'");if(!It.isBuffer(i))throw new TypeError("Field 'newSecret' is the wrong type; must be a Buffer");if(o+=i.length,void 0===(i=t.reason))throw new Error("Missing value for mandatory field 'reason'");if(!("string"==typeof i&&It.byteLength(i)<256))throw new TypeError("Field 'reason' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(i,"utf8");o+=s;var a=It.alloc(17+o);return a[0]=1,a.writeUInt16BE(e,1),a.writeUInt32BE(655430,7),n=11,void 0===(i=t.newSecret)&&(i=It.from(void 0)),r=i.length,a.writeUInt32BE(r,n),n+=4,i.copy(a,n),n+=r,void 0===(i=t.reason)&&(i=void 0),a[n]=s,n++,a.write(i,n,"utf8"),a[n+=s]=206,a.writeUInt32BE(n-7,3),a}(n,o);case 655431:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(655431,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 1310730:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.outOfBand))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'outOfBand' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");i+=o;var s=It.alloc(13+i);return s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(1310730,7),r=11,void 0===(n=t.outOfBand)&&(n=""),s[r]=o,r++,s.write(n,r,"utf8"),s[r+=o]=206,s.writeUInt32BE(r-7,3),s}(n,o);case 1310731:return function(e,t){var r,n=0,i=null,o=0;if(void 0===(i=t.channelId))i=It.from("");else if(!It.isBuffer(i))throw new TypeError("Field 'channelId' is the wrong type; must be a Buffer");o+=i.length;var s=It.alloc(16+o);return s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(1310731,7),n=11,void 0===(i=t.channelId)&&(i=It.from("")),r=i.length,s.writeUInt32BE(r,n),n+=4,i.copy(s,n),s[n+=r]=206,s.writeUInt32BE(n-7,3),s}(n,o);case 1310740:return function(e,t){var r,n=0,i=0,o=It.alloc(13);if(o[0]=1,o.writeUInt16BE(e,1),o.writeUInt32BE(1310740,7),n=11,void 0===(r=t.active))throw new Error("Missing value for mandatory field 'active'");return r&&(i+=1),o[n]=i,o[++n]=206,o.writeUInt32BE(n-7,3),o}(n,o);case 1310741:return function(e,t){var r,n=0,i=0,o=It.alloc(13);if(o[0]=1,o.writeUInt16BE(e,1),o.writeUInt32BE(1310741,7),n=11,void 0===(r=t.active))throw new Error("Missing value for mandatory field 'active'");return r&&(i+=1),o[n]=i,o[++n]=206,o.writeUInt32BE(n-7,3),o}(n,o);case 1310760:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.replyText))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'replyText' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");i+=o;var s=It.alloc(19+i);if(s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(1310760,7),r=11,void 0===(n=t.replyCode))throw new Error("Missing value for mandatory field 'replyCode'");if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'replyCode' is the wrong type; must be a number (but not NaN)");if(s.writeUInt16BE(n,r),r+=2,void 0===(n=t.replyText)&&(n=""),s[r]=o,r++,s.write(n,r,"utf8"),r+=o,void 0===(n=t.classId))throw new Error("Missing value for mandatory field 'classId'");if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'classId' is the wrong type; must be a number (but not NaN)");if(s.writeUInt16BE(n,r),r+=2,void 0===(n=t.methodId))throw new Error("Missing value for mandatory field 'methodId'");if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'methodId' is the wrong type; must be a number (but not NaN)");return s.writeUInt16BE(n,r),s[r+=2]=206,s.writeUInt32BE(r-7,3),s}(n,o);case 1310761:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(1310761,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 1966090:return function(e,t){var r=0,n=null,i=0,o=0;if(void 0===(n=t.realm))n="/data";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'realm' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(n,"utf8");o+=s;var a=It.alloc(14+o);return a[0]=1,a.writeUInt16BE(e,1),a.writeUInt32BE(1966090,7),r=11,void 0===(n=t.realm)&&(n="/data"),a[r]=s,r++,a.write(n,r,"utf8"),r+=s,void 0===(n=t.exclusive)&&(n=!1),n&&(i+=1),void 0===(n=t.passive)&&(n=!0),n&&(i+=2),void 0===(n=t.active)&&(n=!0),n&&(i+=4),void 0===(n=t.write)&&(n=!0),n&&(i+=8),void 0===(n=t.read)&&(n=!0),n&&(i+=16),a[r]=i,a[++r]=206,a.writeUInt32BE(r-7,3),a}(n,o);case 1966091:return function(e,t){var r=0,n=null,i=It.alloc(14);if(i[0]=1,i.writeUInt16BE(e,1),i.writeUInt32BE(1966091,7),r=11,void 0===(n=t.ticket))n=1;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return i.writeUInt16BE(n,r),i[r+=2]=206,i.writeUInt32BE(r-7,3),i}(n,o);case 2621450:return function(e,t){var n,o=0,s=null,a=0,c=0,u=0;if(void 0===(s=t.exchange))throw new Error("Missing value for mandatory field 'exchange'");if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'exchange' is the wrong type; must be a string (up to 255 chars)");var l=It.byteLength(s,"utf8");if(c+=l,void 0===(s=t.type))s="direct";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'type' is the wrong type; must be a string (up to 255 chars)");var h=It.byteLength(s,"utf8");if(c+=h,void 0===(s=t.arguments))s={};else if("object"!=typeof s)throw new TypeError("Field 'arguments' is the wrong type; must be an object");n=r(i,s,u);var f=i.slice(u,u+n);u+=n,c+=f.length;var d=It.alloc(17+c);if(d[0]=1,d.writeUInt16BE(e,1),d.writeUInt32BE(2621450,7),o=11,void 0===(s=t.ticket))s=0;else if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return d.writeUInt16BE(s,o),o+=2,void 0===(s=t.exchange)&&(s=void 0),d[o]=l,o++,d.write(s,o,"utf8"),o+=l,void 0===(s=t.type)&&(s="direct"),d[o]=h,o++,d.write(s,o,"utf8"),o+=h,void 0===(s=t.passive)&&(s=!1),s&&(a+=1),void 0===(s=t.durable)&&(s=!1),s&&(a+=2),void 0===(s=t.autoDelete)&&(s=!1),s&&(a+=4),void 0===(s=t.internal)&&(s=!1),s&&(a+=8),void 0===(s=t.nowait)&&(s=!1),s&&(a+=16),d[o]=a,o++,a=0,d[o+=f.copy(d,o)]=206,d.writeUInt32BE(o-7,3),d}(n,o);case 2621451:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(2621451,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 2621460:return function(e,t){var r=0,n=null,i=0,o=0;if(void 0===(n=t.exchange))throw new Error("Missing value for mandatory field 'exchange'");if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'exchange' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(n,"utf8");o+=s;var a=It.alloc(16+o);if(a[0]=1,a.writeUInt16BE(e,1),a.writeUInt32BE(2621460,7),r=11,void 0===(n=t.ticket))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return a.writeUInt16BE(n,r),r+=2,void 0===(n=t.exchange)&&(n=void 0),a[r]=s,r++,a.write(n,r,"utf8"),r+=s,void 0===(n=t.ifUnused)&&(n=!1),n&&(i+=1),void 0===(n=t.nowait)&&(n=!1),n&&(i+=2),a[r]=i,a[++r]=206,a.writeUInt32BE(r-7,3),a}(n,o);case 2621461:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(2621461,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 2621470:return function(e,t){var n,o=0,s=null,a=0,c=0,u=0;if(void 0===(s=t.destination))throw new Error("Missing value for mandatory field 'destination'");if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'destination' is the wrong type; must be a string (up to 255 chars)");var l=It.byteLength(s,"utf8");if(c+=l,void 0===(s=t.source))throw new Error("Missing value for mandatory field 'source'");if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'source' is the wrong type; must be a string (up to 255 chars)");var h=It.byteLength(s,"utf8");if(c+=h,void 0===(s=t.routingKey))s="";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'routingKey' is the wrong type; must be a string (up to 255 chars)");var f=It.byteLength(s,"utf8");if(c+=f,void 0===(s=t.arguments))s={};else if("object"!=typeof s)throw new TypeError("Field 'arguments' is the wrong type; must be an object");n=r(i,s,u);var d=i.slice(u,u+n);u+=n,c+=d.length;var p=It.alloc(18+c);if(p[0]=1,p.writeUInt16BE(e,1),p.writeUInt32BE(2621470,7),o=11,void 0===(s=t.ticket))s=0;else if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return p.writeUInt16BE(s,o),o+=2,void 0===(s=t.destination)&&(s=void 0),p[o]=l,o++,p.write(s,o,"utf8"),o+=l,void 0===(s=t.source)&&(s=void 0),p[o]=h,o++,p.write(s,o,"utf8"),o+=h,void 0===(s=t.routingKey)&&(s=""),p[o]=f,o++,p.write(s,o,"utf8"),o+=f,void 0===(s=t.nowait)&&(s=!1),s&&(a+=1),p[o]=a,o++,a=0,p[o+=d.copy(p,o)]=206,p.writeUInt32BE(o-7,3),p}(n,o);case 2621471:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(2621471,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 2621480:return function(e,t){var n,o=0,s=null,a=0,c=0,u=0;if(void 0===(s=t.destination))throw new Error("Missing value for mandatory field 'destination'");if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'destination' is the wrong type; must be a string (up to 255 chars)");var l=It.byteLength(s,"utf8");if(c+=l,void 0===(s=t.source))throw new Error("Missing value for mandatory field 'source'");if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'source' is the wrong type; must be a string (up to 255 chars)");var h=It.byteLength(s,"utf8");if(c+=h,void 0===(s=t.routingKey))s="";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'routingKey' is the wrong type; must be a string (up to 255 chars)");var f=It.byteLength(s,"utf8");if(c+=f,void 0===(s=t.arguments))s={};else if("object"!=typeof s)throw new TypeError("Field 'arguments' is the wrong type; must be an object");n=r(i,s,u);var d=i.slice(u,u+n);u+=n,c+=d.length;var p=It.alloc(18+c);if(p[0]=1,p.writeUInt16BE(e,1),p.writeUInt32BE(2621480,7),o=11,void 0===(s=t.ticket))s=0;else if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return p.writeUInt16BE(s,o),o+=2,void 0===(s=t.destination)&&(s=void 0),p[o]=l,o++,p.write(s,o,"utf8"),o+=l,void 0===(s=t.source)&&(s=void 0),p[o]=h,o++,p.write(s,o,"utf8"),o+=h,void 0===(s=t.routingKey)&&(s=""),p[o]=f,o++,p.write(s,o,"utf8"),o+=f,void 0===(s=t.nowait)&&(s=!1),s&&(a+=1),p[o]=a,o++,a=0,p[o+=d.copy(p,o)]=206,p.writeUInt32BE(o-7,3),p}(n,o);case 2621491:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(2621491,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 3276810:return function(e,t){var n,o=0,s=null,a=0,c=0,u=0;if(void 0===(s=t.queue))s="";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'queue' is the wrong type; must be a string (up to 255 chars)");var l=It.byteLength(s,"utf8");if(c+=l,void 0===(s=t.arguments))s={};else if("object"!=typeof s)throw new TypeError("Field 'arguments' is the wrong type; must be an object");n=r(i,s,u);var h=i.slice(u,u+n);u+=n,c+=h.length;var f=It.alloc(16+c);if(f[0]=1,f.writeUInt16BE(e,1),f.writeUInt32BE(3276810,7),o=11,void 0===(s=t.ticket))s=0;else if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return f.writeUInt16BE(s,o),o+=2,void 0===(s=t.queue)&&(s=""),f[o]=l,o++,f.write(s,o,"utf8"),o+=l,void 0===(s=t.passive)&&(s=!1),s&&(a+=1),void 0===(s=t.durable)&&(s=!1),s&&(a+=2),void 0===(s=t.exclusive)&&(s=!1),s&&(a+=4),void 0===(s=t.autoDelete)&&(s=!1),s&&(a+=8),void 0===(s=t.nowait)&&(s=!1),s&&(a+=16),f[o]=a,o++,a=0,f[o+=h.copy(f,o)]=206,f.writeUInt32BE(o-7,3),f}(n,o);case 3276811:return function(e,t){var r=0,n=null,i=0;if(void 0===(n=t.queue))throw new Error("Missing value for mandatory field 'queue'");if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'queue' is the wrong type; must be a string (up to 255 chars)");var o=It.byteLength(n,"utf8");i+=o;var s=It.alloc(21+i);if(s[0]=1,s.writeUInt16BE(e,1),s.writeUInt32BE(3276811,7),r=11,void 0===(n=t.queue)&&(n=void 0),s[r]=o,r++,s.write(n,r,"utf8"),r+=o,void 0===(n=t.messageCount))throw new Error("Missing value for mandatory field 'messageCount'");if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'messageCount' is the wrong type; must be a number (but not NaN)");if(s.writeUInt32BE(n,r),r+=4,void 0===(n=t.consumerCount))throw new Error("Missing value for mandatory field 'consumerCount'");if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'consumerCount' is the wrong type; must be a number (but not NaN)");return s.writeUInt32BE(n,r),s[r+=4]=206,s.writeUInt32BE(r-7,3),s}(n,o);case 3276820:return function(e,t){var n,o=0,s=null,a=0,c=0,u=0;if(void 0===(s=t.queue))s="";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'queue' is the wrong type; must be a string (up to 255 chars)");var l=It.byteLength(s,"utf8");if(c+=l,void 0===(s=t.exchange))throw new Error("Missing value for mandatory field 'exchange'");if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'exchange' is the wrong type; must be a string (up to 255 chars)");var h=It.byteLength(s,"utf8");if(c+=h,void 0===(s=t.routingKey))s="";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'routingKey' is the wrong type; must be a string (up to 255 chars)");var f=It.byteLength(s,"utf8");if(c+=f,void 0===(s=t.arguments))s={};else if("object"!=typeof s)throw new TypeError("Field 'arguments' is the wrong type; must be an object");n=r(i,s,u);var d=i.slice(u,u+n);u+=n,c+=d.length;var p=It.alloc(18+c);if(p[0]=1,p.writeUInt16BE(e,1),p.writeUInt32BE(3276820,7),o=11,void 0===(s=t.ticket))s=0;else if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return p.writeUInt16BE(s,o),o+=2,void 0===(s=t.queue)&&(s=""),p[o]=l,o++,p.write(s,o,"utf8"),o+=l,void 0===(s=t.exchange)&&(s=void 0),p[o]=h,o++,p.write(s,o,"utf8"),o+=h,void 0===(s=t.routingKey)&&(s=""),p[o]=f,o++,p.write(s,o,"utf8"),o+=f,void 0===(s=t.nowait)&&(s=!1),s&&(a+=1),p[o]=a,o++,a=0,p[o+=d.copy(p,o)]=206,p.writeUInt32BE(o-7,3),p}(n,o);case 3276821:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(3276821,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 3276830:return function(e,t){var r=0,n=null,i=0,o=0;if(void 0===(n=t.queue))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'queue' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(n,"utf8");o+=s;var a=It.alloc(16+o);if(a[0]=1,a.writeUInt16BE(e,1),a.writeUInt32BE(3276830,7),r=11,void 0===(n=t.ticket))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return a.writeUInt16BE(n,r),r+=2,void 0===(n=t.queue)&&(n=""),a[r]=s,r++,a.write(n,r,"utf8"),r+=s,void 0===(n=t.nowait)&&(n=!1),n&&(i+=1),a[r]=i,a[++r]=206,a.writeUInt32BE(r-7,3),a}(n,o);case 3276831:return function(e,t){var r,n=0,i=It.alloc(16);if(i[0]=1,i.writeUInt16BE(e,1),i.writeUInt32BE(3276831,7),n=11,void 0===(r=t.messageCount))throw new Error("Missing value for mandatory field 'messageCount'");if("number"!=typeof r||isNaN(r))throw new TypeError("Field 'messageCount' is the wrong type; must be a number (but not NaN)");return i.writeUInt32BE(r,n),i[n+=4]=206,i.writeUInt32BE(n-7,3),i}(n,o);case 3276840:return function(e,t){var r=0,n=null,i=0,o=0;if(void 0===(n=t.queue))n="";else if(!("string"==typeof n&&It.byteLength(n)<256))throw new TypeError("Field 'queue' is the wrong type; must be a string (up to 255 chars)");var s=It.byteLength(n,"utf8");o+=s;var a=It.alloc(16+o);if(a[0]=1,a.writeUInt16BE(e,1),a.writeUInt32BE(3276840,7),r=11,void 0===(n=t.ticket))n=0;else if("number"!=typeof n||isNaN(n))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return a.writeUInt16BE(n,r),r+=2,void 0===(n=t.queue)&&(n=""),a[r]=s,r++,a.write(n,r,"utf8"),r+=s,void 0===(n=t.ifUnused)&&(n=!1),n&&(i+=1),void 0===(n=t.ifEmpty)&&(n=!1),n&&(i+=2),void 0===(n=t.nowait)&&(n=!1),n&&(i+=4),a[r]=i,a[++r]=206,a.writeUInt32BE(r-7,3),a}(n,o);case 3276841:return function(e,t){var r,n=0,i=It.alloc(16);if(i[0]=1,i.writeUInt16BE(e,1),i.writeUInt32BE(3276841,7),n=11,void 0===(r=t.messageCount))throw new Error("Missing value for mandatory field 'messageCount'");if("number"!=typeof r||isNaN(r))throw new TypeError("Field 'messageCount' is the wrong type; must be a number (but not NaN)");return i.writeUInt32BE(r,n),i[n+=4]=206,i.writeUInt32BE(n-7,3),i}(n,o);case 3276850:return function(e,t){var n,o=0,s=null,a=0,c=0;if(void 0===(s=t.queue))s="";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'queue' is the wrong type; must be a string (up to 255 chars)");var u=It.byteLength(s,"utf8");if(a+=u,void 0===(s=t.exchange))throw new Error("Missing value for mandatory field 'exchange'");if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'exchange' is the wrong type; must be a string (up to 255 chars)");var l=It.byteLength(s,"utf8");if(a+=l,void 0===(s=t.routingKey))s="";else if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'routingKey' is the wrong type; must be a string (up to 255 chars)");var h=It.byteLength(s,"utf8");if(a+=h,void 0===(s=t.arguments))s={};else if("object"!=typeof s)throw new TypeError("Field 'arguments' is the wrong type; must be an object");n=r(i,s,c);var f=i.slice(c,c+n);c+=n,a+=f.length;var d=It.alloc(17+a);if(d[0]=1,d.writeUInt16BE(e,1),d.writeUInt32BE(3276850,7),o=11,void 0===(s=t.ticket))s=0;else if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'ticket' is the wrong type; must be a number (but not NaN)");return d.writeUInt16BE(s,o),o+=2,void 0===(s=t.queue)&&(s=""),d[o]=u,o++,d.write(s,o,"utf8"),o+=u,void 0===(s=t.exchange)&&(s=void 0),d[o]=l,o++,d.write(s,o,"utf8"),o+=l,void 0===(s=t.routingKey)&&(s=""),d[o]=h,o++,d.write(s,o,"utf8"),o+=h,d[o+=f.copy(d,o)]=206,d.writeUInt32BE(o-7,3),d}(n,o);case 3276851:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(3276851,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 5898250:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(5898250,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 5898251:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(5898251,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 5898260:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(5898260,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 5898261:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(5898261,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 5898270:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(5898270,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 5898271:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(5898271,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);case 5570570:return function(e,t){var r=0,n=null,i=0,o=It.alloc(13);return o[0]=1,o.writeUInt16BE(e,1),o.writeUInt32BE(5570570,7),r=11,void 0===(n=t.nowait)&&(n=!1),n&&(i+=1),o[r]=i,o[++r]=206,o.writeUInt32BE(r-7,3),o}(n,o);case 5570571:return function(e){var t=It.alloc(12);return t[0]=1,t.writeUInt16BE(e,1),t.writeUInt32BE(5570571,7),t[11]=206,t.writeUInt32BE(4,3),t}(n);default:throw new Error("Unknown class/method ID")}},Ws.encodeProperties=function(e,n,o,s){if(60===e)return function(e,n,o){var s,a,c=0,u=0,l=0,h=0;if(null!=(s=o.contentType)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'contentType' is the wrong type; must be a string (up to 255 chars)");var f=It.byteLength(s,"utf8");h+=1,h+=f}if(null!=(s=o.contentEncoding)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'contentEncoding' is the wrong type; must be a string (up to 255 chars)");var d=It.byteLength(s,"utf8");h+=1,h+=d}if(null!=(s=o.headers)){if("object"!=typeof s)throw new TypeError("Field 'headers' is the wrong type; must be an object");a=r(i,s,l);var p=i.slice(l,l+a);l+=a,h+=p.length}if(null!=(s=o.deliveryMode)){if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'deliveryMode' is the wrong type; must be a number (but not NaN)");h+=1}if(null!=(s=o.priority)){if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'priority' is the wrong type; must be a number (but not NaN)");h+=1}if(null!=(s=o.correlationId)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'correlationId' is the wrong type; must be a string (up to 255 chars)");var g=It.byteLength(s,"utf8");h+=1,h+=g}if(null!=(s=o.replyTo)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'replyTo' is the wrong type; must be a string (up to 255 chars)");var m=It.byteLength(s,"utf8");h+=1,h+=m}if(null!=(s=o.expiration)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'expiration' is the wrong type; must be a string (up to 255 chars)");var y=It.byteLength(s,"utf8");h+=1,h+=y}if(null!=(s=o.messageId)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'messageId' is the wrong type; must be a string (up to 255 chars)");var w=It.byteLength(s,"utf8");h+=1,h+=w}if(null!=(s=o.timestamp)){if("number"!=typeof s||isNaN(s))throw new TypeError("Field 'timestamp' is the wrong type; must be a number (but not NaN)");h+=8}if(null!=(s=o.type)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'type' is the wrong type; must be a string (up to 255 chars)");var b=It.byteLength(s,"utf8");h+=1,h+=b}if(null!=(s=o.userId)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'userId' is the wrong type; must be a string (up to 255 chars)");var v=It.byteLength(s,"utf8");h+=1,h+=v}if(null!=(s=o.appId)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'appId' is the wrong type; must be a string (up to 255 chars)");var E=It.byteLength(s,"utf8");h+=1,h+=E}if(null!=(s=o.clusterId)){if(!("string"==typeof s&&It.byteLength(s)<256))throw new TypeError("Field 'clusterId' is the wrong type; must be a string (up to 255 chars)");var I=It.byteLength(s,"utf8");h+=1,h+=I}var _=It.alloc(22+h);return _[0]=2,_.writeUInt16BE(e,1),_.writeUInt32BE(3932160,7),t.writeUInt64BE(_,n,11),u=0,c=21,null!=(s=o.contentType)&&(u+=32768,_[c]=f,c++,_.write(s,c,"utf8"),c+=f),null!=(s=o.contentEncoding)&&(u+=16384,_[c]=d,c++,_.write(s,c,"utf8"),c+=d),null!=(s=o.headers)&&(u+=8192,c+=p.copy(_,c)),null!=(s=o.deliveryMode)&&(u+=4096,_.writeUInt8(s,c),c++),null!=(s=o.priority)&&(u+=2048,_.writeUInt8(s,c),c++),null!=(s=o.correlationId)&&(u+=1024,_[c]=g,c++,_.write(s,c,"utf8"),c+=g),null!=(s=o.replyTo)&&(u+=512,_[c]=m,c++,_.write(s,c,"utf8"),c+=m),null!=(s=o.expiration)&&(u+=256,_[c]=y,c++,_.write(s,c,"utf8"),c+=y),null!=(s=o.messageId)&&(u+=128,_[c]=w,c++,_.write(s,c,"utf8"),c+=w),null!=(s=o.timestamp)&&(u+=64,t.writeUInt64BE(_,s,c),c+=8),null!=(s=o.type)&&(u+=32,_[c]=b,c++,_.write(s,c,"utf8"),c+=b),null!=(s=o.userId)&&(u+=16,_[c]=v,c++,_.write(s,c,"utf8"),c+=v),null!=(s=o.appId)&&(u+=8,_[c]=E,c++,_.write(s,c,"utf8"),c+=E),null!=(s=o.clusterId)&&(u+=4,_[c]=I,c++,_.write(s,c,"utf8"),c+=I),_[c]=206,_.writeUInt32BE(c-7,3),_.writeUInt16BE(u,19),_.subarray(0,c+1)}(n,o,s);throw new Error("Unknown class/properties ID")},Ws.info=function(e){switch(e){case 3932170:return o;case 3932171:return s;case 3932180:return a;case 3932181:return c;case 3932190:return u;case 3932191:return l;case 3932200:return h;case 3932210:return f;case 3932220:return d;case 3932230:return p;case 3932231:return g;case 3932232:return m;case 3932240:return y;case 3932250:return w;case 3932260:return b;case 3932270:return v;case 3932271:return E;case 3932280:return I;case 655370:return _;case 655371:return A;case 655380:return k;case 655381:return B;case 655390:return x;case 655391:return S;case 655400:return O;case 655401:return U;case 655410:return C;case 655411:return N;case 655420:return R;case 655421:return T;case 655430:return L;case 655431:return D;case 1310730:return j;case 1310731:return M;case 1310740:return P;case 1310741:return F;case 1310760:return q;case 1310761:return Q;case 1966090:return z;case 1966091:return $;case 2621450:return H;case 2621451:return V;case 2621460:return G;case 2621461:return K;case 2621470:return W;case 2621471:return J;case 2621480:return Z;case 2621491:return Y;case 3276810:return X;case 3276811:return ee;case 3276820:return te;case 3276821:return re;case 3276830:return ne;case 3276831:return ie;case 3276840:return oe;case 3276841:return se;case 3276850:return ae;case 3276851:return ce;case 5898250:return ue;case 5898251:return le;case 5898260:return he;case 5898261:return fe;case 5898270:return de;case 5898271:return pe;case 5570570:return ge;case 5570571:return me;case 60:return ye;default:throw new Error("Unknown class/method ID")}},Ws.BasicQos=3932170;var o=Ws.methodInfoBasicQos={id:3932170,classId:60,methodId:10,name:"BasicQos",args:[{type:"long",name:"prefetchSize",default:0},{type:"short",name:"prefetchCount",default:0},{type:"bit",name:"global",default:!1}]};Ws.BasicQosOk=3932171;var s=Ws.methodInfoBasicQosOk={id:3932171,classId:60,methodId:11,name:"BasicQosOk",args:[]};Ws.BasicConsume=3932180;var a=Ws.methodInfoBasicConsume={id:3932180,classId:60,methodId:20,name:"BasicConsume",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"queue",default:""},{type:"shortstr",name:"consumerTag",default:""},{type:"bit",name:"noLocal",default:!1},{type:"bit",name:"noAck",default:!1},{type:"bit",name:"exclusive",default:!1},{type:"bit",name:"nowait",default:!1},{type:"table",name:"arguments",default:{}}]};Ws.BasicConsumeOk=3932181;var c=Ws.methodInfoBasicConsumeOk={id:3932181,classId:60,methodId:21,name:"BasicConsumeOk",args:[{type:"shortstr",name:"consumerTag"}]};Ws.BasicCancel=3932190;var u=Ws.methodInfoBasicCancel={id:3932190,classId:60,methodId:30,name:"BasicCancel",args:[{type:"shortstr",name:"consumerTag"},{type:"bit",name:"nowait",default:!1}]};Ws.BasicCancelOk=3932191;var l=Ws.methodInfoBasicCancelOk={id:3932191,classId:60,methodId:31,name:"BasicCancelOk",args:[{type:"shortstr",name:"consumerTag"}]};Ws.BasicPublish=3932200;var h=Ws.methodInfoBasicPublish={id:3932200,classId:60,methodId:40,name:"BasicPublish",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"exchange",default:""},{type:"shortstr",name:"routingKey",default:""},{type:"bit",name:"mandatory",default:!1},{type:"bit",name:"immediate",default:!1}]};Ws.BasicReturn=3932210;var f=Ws.methodInfoBasicReturn={id:3932210,classId:60,methodId:50,name:"BasicReturn",args:[{type:"short",name:"replyCode"},{type:"shortstr",name:"replyText",default:""},{type:"shortstr",name:"exchange"},{type:"shortstr",name:"routingKey"}]};Ws.BasicDeliver=3932220;var d=Ws.methodInfoBasicDeliver={id:3932220,classId:60,methodId:60,name:"BasicDeliver",args:[{type:"shortstr",name:"consumerTag"},{type:"longlong",name:"deliveryTag"},{type:"bit",name:"redelivered",default:!1},{type:"shortstr",name:"exchange"},{type:"shortstr",name:"routingKey"}]};Ws.BasicGet=3932230;var p=Ws.methodInfoBasicGet={id:3932230,classId:60,methodId:70,name:"BasicGet",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"queue",default:""},{type:"bit",name:"noAck",default:!1}]};Ws.BasicGetOk=3932231;var g=Ws.methodInfoBasicGetOk={id:3932231,classId:60,methodId:71,name:"BasicGetOk",args:[{type:"longlong",name:"deliveryTag"},{type:"bit",name:"redelivered",default:!1},{type:"shortstr",name:"exchange"},{type:"shortstr",name:"routingKey"},{type:"long",name:"messageCount"}]};Ws.BasicGetEmpty=3932232;var m=Ws.methodInfoBasicGetEmpty={id:3932232,classId:60,methodId:72,name:"BasicGetEmpty",args:[{type:"shortstr",name:"clusterId",default:""}]};Ws.BasicAck=3932240;var y=Ws.methodInfoBasicAck={id:3932240,classId:60,methodId:80,name:"BasicAck",args:[{type:"longlong",name:"deliveryTag",default:0},{type:"bit",name:"multiple",default:!1}]};Ws.BasicReject=3932250;var w=Ws.methodInfoBasicReject={id:3932250,classId:60,methodId:90,name:"BasicReject",args:[{type:"longlong",name:"deliveryTag"},{type:"bit",name:"requeue",default:!0}]};Ws.BasicRecoverAsync=3932260;var b=Ws.methodInfoBasicRecoverAsync={id:3932260,classId:60,methodId:100,name:"BasicRecoverAsync",args:[{type:"bit",name:"requeue",default:!1}]};Ws.BasicRecover=3932270;var v=Ws.methodInfoBasicRecover={id:3932270,classId:60,methodId:110,name:"BasicRecover",args:[{type:"bit",name:"requeue",default:!1}]};Ws.BasicRecoverOk=3932271;var E=Ws.methodInfoBasicRecoverOk={id:3932271,classId:60,methodId:111,name:"BasicRecoverOk",args:[]};Ws.BasicNack=3932280;var I=Ws.methodInfoBasicNack={id:3932280,classId:60,methodId:120,name:"BasicNack",args:[{type:"longlong",name:"deliveryTag",default:0},{type:"bit",name:"multiple",default:!1},{type:"bit",name:"requeue",default:!0}]};Ws.ConnectionStart=655370;var _=Ws.methodInfoConnectionStart={id:655370,classId:10,methodId:10,name:"ConnectionStart",args:[{type:"octet",name:"versionMajor",default:0},{type:"octet",name:"versionMinor",default:9},{type:"table",name:"serverProperties"},{type:"longstr",name:"mechanisms",default:"PLAIN"},{type:"longstr",name:"locales",default:"en_US"}]};Ws.ConnectionStartOk=655371;var A=Ws.methodInfoConnectionStartOk={id:655371,classId:10,methodId:11,name:"ConnectionStartOk",args:[{type:"table",name:"clientProperties"},{type:"shortstr",name:"mechanism",default:"PLAIN"},{type:"longstr",name:"response"},{type:"shortstr",name:"locale",default:"en_US"}]};Ws.ConnectionSecure=655380;var k=Ws.methodInfoConnectionSecure={id:655380,classId:10,methodId:20,name:"ConnectionSecure",args:[{type:"longstr",name:"challenge"}]};Ws.ConnectionSecureOk=655381;var B=Ws.methodInfoConnectionSecureOk={id:655381,classId:10,methodId:21,name:"ConnectionSecureOk",args:[{type:"longstr",name:"response"}]};Ws.ConnectionTune=655390;var x=Ws.methodInfoConnectionTune={id:655390,classId:10,methodId:30,name:"ConnectionTune",args:[{type:"short",name:"channelMax",default:0},{type:"long",name:"frameMax",default:0},{type:"short",name:"heartbeat",default:0}]};Ws.ConnectionTuneOk=655391;var S=Ws.methodInfoConnectionTuneOk={id:655391,classId:10,methodId:31,name:"ConnectionTuneOk",args:[{type:"short",name:"channelMax",default:0},{type:"long",name:"frameMax",default:0},{type:"short",name:"heartbeat",default:0}]};Ws.ConnectionOpen=655400;var O=Ws.methodInfoConnectionOpen={id:655400,classId:10,methodId:40,name:"ConnectionOpen",args:[{type:"shortstr",name:"virtualHost",default:"/"},{type:"shortstr",name:"capabilities",default:""},{type:"bit",name:"insist",default:!1}]};Ws.ConnectionOpenOk=655401;var U=Ws.methodInfoConnectionOpenOk={id:655401,classId:10,methodId:41,name:"ConnectionOpenOk",args:[{type:"shortstr",name:"knownHosts",default:""}]};Ws.ConnectionClose=655410;var C=Ws.methodInfoConnectionClose={id:655410,classId:10,methodId:50,name:"ConnectionClose",args:[{type:"short",name:"replyCode"},{type:"shortstr",name:"replyText",default:""},{type:"short",name:"classId"},{type:"short",name:"methodId"}]};Ws.ConnectionCloseOk=655411;var N=Ws.methodInfoConnectionCloseOk={id:655411,classId:10,methodId:51,name:"ConnectionCloseOk",args:[]};Ws.ConnectionBlocked=655420;var R=Ws.methodInfoConnectionBlocked={id:655420,classId:10,methodId:60,name:"ConnectionBlocked",args:[{type:"shortstr",name:"reason",default:""}]};Ws.ConnectionUnblocked=655421;var T=Ws.methodInfoConnectionUnblocked={id:655421,classId:10,methodId:61,name:"ConnectionUnblocked",args:[]};Ws.ConnectionUpdateSecret=655430;var L=Ws.methodInfoConnectionUpdateSecret={id:655430,classId:10,methodId:70,name:"ConnectionUpdateSecret",args:[{type:"longstr",name:"newSecret"},{type:"shortstr",name:"reason"}]};Ws.ConnectionUpdateSecretOk=655431;var D=Ws.methodInfoConnectionUpdateSecretOk={id:655431,classId:10,methodId:71,name:"ConnectionUpdateSecretOk",args:[]};Ws.ChannelOpen=1310730;var j=Ws.methodInfoChannelOpen={id:1310730,classId:20,methodId:10,name:"ChannelOpen",args:[{type:"shortstr",name:"outOfBand",default:""}]};Ws.ChannelOpenOk=1310731;var M=Ws.methodInfoChannelOpenOk={id:1310731,classId:20,methodId:11,name:"ChannelOpenOk",args:[{type:"longstr",name:"channelId",default:""}]};Ws.ChannelFlow=1310740;var P=Ws.methodInfoChannelFlow={id:1310740,classId:20,methodId:20,name:"ChannelFlow",args:[{type:"bit",name:"active"}]};Ws.ChannelFlowOk=1310741;var F=Ws.methodInfoChannelFlowOk={id:1310741,classId:20,methodId:21,name:"ChannelFlowOk",args:[{type:"bit",name:"active"}]};Ws.ChannelClose=1310760;var q=Ws.methodInfoChannelClose={id:1310760,classId:20,methodId:40,name:"ChannelClose",args:[{type:"short",name:"replyCode"},{type:"shortstr",name:"replyText",default:""},{type:"short",name:"classId"},{type:"short",name:"methodId"}]};Ws.ChannelCloseOk=1310761;var Q=Ws.methodInfoChannelCloseOk={id:1310761,classId:20,methodId:41,name:"ChannelCloseOk",args:[]};Ws.AccessRequest=1966090;var z=Ws.methodInfoAccessRequest={id:1966090,classId:30,methodId:10,name:"AccessRequest",args:[{type:"shortstr",name:"realm",default:"/data"},{type:"bit",name:"exclusive",default:!1},{type:"bit",name:"passive",default:!0},{type:"bit",name:"active",default:!0},{type:"bit",name:"write",default:!0},{type:"bit",name:"read",default:!0}]};Ws.AccessRequestOk=1966091;var $=Ws.methodInfoAccessRequestOk={id:1966091,classId:30,methodId:11,name:"AccessRequestOk",args:[{type:"short",name:"ticket",default:1}]};Ws.ExchangeDeclare=2621450;var H=Ws.methodInfoExchangeDeclare={id:2621450,classId:40,methodId:10,name:"ExchangeDeclare",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"exchange"},{type:"shortstr",name:"type",default:"direct"},{type:"bit",name:"passive",default:!1},{type:"bit",name:"durable",default:!1},{type:"bit",name:"autoDelete",default:!1},{type:"bit",name:"internal",default:!1},{type:"bit",name:"nowait",default:!1},{type:"table",name:"arguments",default:{}}]};Ws.ExchangeDeclareOk=2621451;var V=Ws.methodInfoExchangeDeclareOk={id:2621451,classId:40,methodId:11,name:"ExchangeDeclareOk",args:[]};Ws.ExchangeDelete=2621460;var G=Ws.methodInfoExchangeDelete={id:2621460,classId:40,methodId:20,name:"ExchangeDelete",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"exchange"},{type:"bit",name:"ifUnused",default:!1},{type:"bit",name:"nowait",default:!1}]};Ws.ExchangeDeleteOk=2621461;var K=Ws.methodInfoExchangeDeleteOk={id:2621461,classId:40,methodId:21,name:"ExchangeDeleteOk",args:[]};Ws.ExchangeBind=2621470;var W=Ws.methodInfoExchangeBind={id:2621470,classId:40,methodId:30,name:"ExchangeBind",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"destination"},{type:"shortstr",name:"source"},{type:"shortstr",name:"routingKey",default:""},{type:"bit",name:"nowait",default:!1},{type:"table",name:"arguments",default:{}}]};Ws.ExchangeBindOk=2621471;var J=Ws.methodInfoExchangeBindOk={id:2621471,classId:40,methodId:31,name:"ExchangeBindOk",args:[]};Ws.ExchangeUnbind=2621480;var Z=Ws.methodInfoExchangeUnbind={id:2621480,classId:40,methodId:40,name:"ExchangeUnbind",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"destination"},{type:"shortstr",name:"source"},{type:"shortstr",name:"routingKey",default:""},{type:"bit",name:"nowait",default:!1},{type:"table",name:"arguments",default:{}}]};Ws.ExchangeUnbindOk=2621491;var Y=Ws.methodInfoExchangeUnbindOk={id:2621491,classId:40,methodId:51,name:"ExchangeUnbindOk",args:[]};Ws.QueueDeclare=3276810;var X=Ws.methodInfoQueueDeclare={id:3276810,classId:50,methodId:10,name:"QueueDeclare",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"queue",default:""},{type:"bit",name:"passive",default:!1},{type:"bit",name:"durable",default:!1},{type:"bit",name:"exclusive",default:!1},{type:"bit",name:"autoDelete",default:!1},{type:"bit",name:"nowait",default:!1},{type:"table",name:"arguments",default:{}}]};Ws.QueueDeclareOk=3276811;var ee=Ws.methodInfoQueueDeclareOk={id:3276811,classId:50,methodId:11,name:"QueueDeclareOk",args:[{type:"shortstr",name:"queue"},{type:"long",name:"messageCount"},{type:"long",name:"consumerCount"}]};Ws.QueueBind=3276820;var te=Ws.methodInfoQueueBind={id:3276820,classId:50,methodId:20,name:"QueueBind",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"queue",default:""},{type:"shortstr",name:"exchange"},{type:"shortstr",name:"routingKey",default:""},{type:"bit",name:"nowait",default:!1},{type:"table",name:"arguments",default:{}}]};Ws.QueueBindOk=3276821;var re=Ws.methodInfoQueueBindOk={id:3276821,classId:50,methodId:21,name:"QueueBindOk",args:[]};Ws.QueuePurge=3276830;var ne=Ws.methodInfoQueuePurge={id:3276830,classId:50,methodId:30,name:"QueuePurge",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"queue",default:""},{type:"bit",name:"nowait",default:!1}]};Ws.QueuePurgeOk=3276831;var ie=Ws.methodInfoQueuePurgeOk={id:3276831,classId:50,methodId:31,name:"QueuePurgeOk",args:[{type:"long",name:"messageCount"}]};Ws.QueueDelete=3276840;var oe=Ws.methodInfoQueueDelete={id:3276840,classId:50,methodId:40,name:"QueueDelete",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"queue",default:""},{type:"bit",name:"ifUnused",default:!1},{type:"bit",name:"ifEmpty",default:!1},{type:"bit",name:"nowait",default:!1}]};Ws.QueueDeleteOk=3276841;var se=Ws.methodInfoQueueDeleteOk={id:3276841,classId:50,methodId:41,name:"QueueDeleteOk",args:[{type:"long",name:"messageCount"}]};Ws.QueueUnbind=3276850;var ae=Ws.methodInfoQueueUnbind={id:3276850,classId:50,methodId:50,name:"QueueUnbind",args:[{type:"short",name:"ticket",default:0},{type:"shortstr",name:"queue",default:""},{type:"shortstr",name:"exchange"},{type:"shortstr",name:"routingKey",default:""},{type:"table",name:"arguments",default:{}}]};Ws.QueueUnbindOk=3276851;var ce=Ws.methodInfoQueueUnbindOk={id:3276851,classId:50,methodId:51,name:"QueueUnbindOk",args:[]};Ws.TxSelect=5898250;var ue=Ws.methodInfoTxSelect={id:5898250,classId:90,methodId:10,name:"TxSelect",args:[]};Ws.TxSelectOk=5898251;var le=Ws.methodInfoTxSelectOk={id:5898251,classId:90,methodId:11,name:"TxSelectOk",args:[]};Ws.TxCommit=5898260;var he=Ws.methodInfoTxCommit={id:5898260,classId:90,methodId:20,name:"TxCommit",args:[]};Ws.TxCommitOk=5898261;var fe=Ws.methodInfoTxCommitOk={id:5898261,classId:90,methodId:21,name:"TxCommitOk",args:[]};Ws.TxRollback=5898270;var de=Ws.methodInfoTxRollback={id:5898270,classId:90,methodId:30,name:"TxRollback",args:[]};Ws.TxRollbackOk=5898271;var pe=Ws.methodInfoTxRollbackOk={id:5898271,classId:90,methodId:31,name:"TxRollbackOk",args:[]};Ws.ConfirmSelect=5570570;var ge=Ws.methodInfoConfirmSelect={id:5570570,classId:85,methodId:10,name:"ConfirmSelect",args:[{type:"bit",name:"nowait",default:!1}]};Ws.ConfirmSelectOk=5570571;var me=Ws.methodInfoConfirmSelectOk={id:5570571,classId:85,methodId:11,name:"ConfirmSelectOk",args:[]};Ws.BasicProperties=60;var ye=Ws.propertiesInfoBasicProperties={id:60,name:"BasicProperties",args:[{type:"shortstr",name:"contentType"},{type:"shortstr",name:"contentEncoding"},{type:"table",name:"headers"},{type:"octet",name:"deliveryMode"},{type:"octet",name:"priority"},{type:"shortstr",name:"correlationId"},{type:"shortstr",name:"replyTo"},{type:"shortstr",name:"expiration"},{type:"shortstr",name:"messageId"},{type:"timestamp",name:"timestamp"},{type:"shortstr",name:"type"},{type:"shortstr",name:"userId"},{type:"shortstr",name:"appId"},{type:"shortstr",name:"clusterId"}]};return Ws}var ta,ra={};function na(){if(ta)return ra;ta=1;const e=Ys();var t=ea(),r=t.constants,n=t.decode;ra.PROTOCOL_HEADER="AMQP"+String.fromCharCode(0,0,9,1);var i=r.FRAME_METHOD,o=r.FRAME_HEARTBEAT,s=r.FRAME_HEADER,a=r.FRAME_BODY,c=r.FRAME_END;ra.makeBodyFrame=function(e,t){const r=7+t.length+1,n=It.alloc(r);let i=0;return i=n.writeUInt8(a,i),i=n.writeUInt16BE(e,i),i=n.writeInt32BE(t.length,i),t.copy(n,i),i+=t.length,n.writeUInt8(c,i),n},ra.parseFrame=function(e){if(e.length<7)return!1;const t=e.readUInt8(0),r=e.readUInt16BE(1),n=e.readUInt32BE(3),i=7+n+1;if(e.length<i)return!1;if(e.readUInt8(7+n)!==c)throw new Error("Invalid frame");return{type:t,channel:r,size:n,payload:e.subarray(7,7+n),rest:e.subarray(i)}};var u={channel:0};return ra.decodeFrame=t=>{const r=t.payload,c=t.channel;switch(t.type){case i:{const e=r.readUInt32BE(0),t=r.subarray(4);return{id:e,channel:c,fields:n(e,t)}}case s:{const t=r.readUInt16BE(0),i=(l=r,h=4,"function"==typeof It.prototype.readBigInt64BE?Number(l.readBigInt64BE(h)):e.readInt64BE(l,h)),o=r.subarray(12);return{id:t,channel:c,size:i,fields:n(t,o)}}case a:return{channel:c,content:r};case o:return u;default:throw new Error("Unknown frame type "+t.type)}var l,h},ra.HEARTBEAT_BUF=It.from([r.FRAME_HEARTBEAT,0,0,0,0,0,0,r.FRAME_END]),ra.HEARTBEAT=u,ra}var ia={};function oa(e,t){if(e===t)return 0;for(var r=e.length,n=t.length,i=0,o=Math.min(r,n);i<o;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0}var sa,aa=Object.prototype.hasOwnProperty,ca=Object.keys||function(e){var t=[];for(var r in e)aa.call(e,r)&&t.push(r);return t},ua=Array.prototype.slice;function la(){return void 0!==sa?sa:sa="foo"===function(){}.name}function ha(e){return Object.prototype.toString.call(e)}function fa(e){return!or(e)&&("function"==typeof at.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):!!e&&(e instanceof DataView||!!(e.buffer&&e.buffer instanceof ArrayBuffer))))}function da(e,t){e||ba(e,!0,t,"==",va)}var pa=/\s*function\s+([^\(\s]*)\s*/;function ga(e){if(on(e)){if(la())return e.name;var t=e.toString().match(pa);return t&&t[1]}}function ma(e){this.name="AssertionError",this.actual=e.actual,this.expected=e.expected,this.operator=e.operator,e.message?(this.message=e.message,this.generatedMessage=!1):(this.message=function(e){return ya(wa(e.actual),128)+" "+e.operator+" "+ya(wa(e.expected),128)}(this),this.generatedMessage=!0);var t=e.stackStartFunction||ba;if(Error.captureStackTrace)Error.captureStackTrace(this,t);else{var r=new Error;if(r.stack){var n=r.stack,i=ga(t),o=n.indexOf("\n"+i);if(o>=0){var s=n.indexOf("\n",o+1);n=n.substring(s+1)}this.stack=n}}}function ya(e,t){return"string"==typeof e?e.length<t?e:e.slice(0,t):e}function wa(e){if(la()||!on(e))return Fr(e);var t=ga(e);return"[Function"+(t?": "+t:"")+"]"}function ba(e,t,r,n,i){throw new ma({message:r,actual:e,expected:t,operator:n,stackStartFunction:i})}function va(e,t){e||ba(e,!0,t,"==",va)}function Ea(e,t,r){e!=t&&ba(e,t,r,"==",Ea)}function Ia(e,t,r){e==t&&ba(e,t,r,"!=",Ia)}function _a(e,t,r){ka(e,t,!1)||ba(e,t,r,"deepEqual",_a)}function Aa(e,t,r){ka(e,t,!0)||ba(e,t,r,"deepStrictEqual",Aa)}function ka(e,t,r,n){if(e===t)return!0;if(or(e)&&or(t))return 0===oa(e,t);if(rn(e)&&rn(t))return e.getTime()===t.getTime();if(en(e)&&en(t))return e.source===t.source&&e.global===t.global&&e.multiline===t.multiline&&e.lastIndex===t.lastIndex&&e.ignoreCase===t.ignoreCase;if(null!==e&&"object"==typeof e||null!==t&&"object"==typeof t){if(fa(e)&&fa(t)&&ha(e)===ha(t)&&!(e instanceof Float32Array||e instanceof Float64Array))return 0===oa(new Uint8Array(e.buffer),new Uint8Array(t.buffer));if(or(e)!==or(t))return!1;var i=(n=n||{actual:[],expected:[]}).actual.indexOf(e);return-1!==i&&i===n.expected.indexOf(t)||(n.actual.push(e),n.expected.push(t),function(e,t,r,n){if(null==e||null==t)return!1;if(sn(e)||sn(t))return e===t;if(r&&Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1;var i=Ba(e),o=Ba(t);if(i&&!o||!i&&o)return!1;if(i)return ka(e=ua.call(e),t=ua.call(t),r);var s,a,c=ca(e),u=ca(t);if(c.length!==u.length)return!1;for(c.sort(),u.sort(),a=c.length-1;a>=0;a--)if(c[a]!==u[a])return!1;for(a=c.length-1;a>=0;a--)if(!ka(e[s=c[a]],t[s],r,n))return!1;return!0}(e,t,r,n))}return r?e===t:e==t}function Ba(e){return"[object Arguments]"==Object.prototype.toString.call(e)}function xa(e,t,r){ka(e,t,!1)&&ba(e,t,r,"notDeepEqual",xa)}function Sa(e,t,r){ka(e,t,!0)&&ba(e,t,r,"notDeepStrictEqual",Sa)}function Oa(e,t,r){e!==t&&ba(e,t,r,"===",Oa)}function Ua(e,t,r){e===t&&ba(e,t,r,"!==",Ua)}function Ca(e,t){if(!e||!t)return!1;if("[object RegExp]"==Object.prototype.toString.call(t))return t.test(e);try{if(e instanceof t)return!0}catch(e){}return!Error.isPrototypeOf(t)&&!0===t.call({},e)}function Na(e,t,r,n){var i;if("function"!=typeof t)throw new TypeError('"block" argument must be a function');"string"==typeof r&&(n=r,r=null),i=function(e){var t;try{e()}catch(e){t=e}return t}(t),n=(r&&r.name?" ("+r.name+").":".")+(n?" "+n:"."),e&&!i&&ba(i,r,"Missing expected exception"+n);var o="string"==typeof n,s=!e&&i&&!r;if((!e&&nn(i)&&o&&Ca(i,r)||s)&&ba(i,r,"Got unwanted exception"+n),e&&i&&r&&!Ca(i,r)||!e&&i)throw i}function Ra(e,t,r){Na(!0,e,t,r)}function Ta(e,t,r){Na(!1,e,t,r)}function La(e){if(e)throw e}da.AssertionError=ma,Cr(ma,Error),da.fail=ba,da.ok=va,da.equal=Ea,da.notEqual=Ia,da.deepEqual=_a,da.deepStrictEqual=Aa,da.notDeepEqual=xa,da.notDeepStrictEqual=Sa,da.strictEqual=Oa,da.notStrictEqual=Ua,da.throws=Ra,da.doesNotThrow=Ta,da.ifError=La;var Da,ja=Bs(Object.freeze({__proto__:null,AssertionError:ma,assert:va,deepEqual:_a,deepStrictEqual:Aa,default:da,doesNotThrow:Ta,equal:Ea,fail:ba,ifError:La,notDeepEqual:xa,notDeepStrictEqual:Sa,notEqual:Ia,notStrictEqual:Ua,ok:va,strictEqual:Oa,throws:Ra}));var Ma,Pa=Bs(li),Fa=Bs(Ge),qa={exports:{}};var Qa,za={},$a=Bs(bn);function Ha(){if(Qa)return za;Qa=1;var e=ea(),t=$a.format,r=na().HEARTBEAT;return za.closeMessage=function(r){var n=r.fields.replyCode;return t('%d (%s) with message "%s"',n,e.constant_strs[n],r.fields.replyText)},za.methodName=function(t){return e.info(t).name},za.inspect=function(n,i){if(n===r)return"<Heartbeat>";if(n.id){var o=e.info(n.id);return t("<%s channel:%d%s>",o.name,n.channel,i?" "+JSON.stringify(n.fields,void 0,2):"")}return t("<Content channel:%d size:%d>",n.channel,n.size)},za}var Va,Ga={};var Ka,Wa,Ja={};function Za(){if(Ka)return Ja;function e(e,t){return e&&e.split("\n").slice(t).join("\n")}function t(t,r){var n=new Error;this.message=t,this.stack=this.toString()+"\n"+e(n.stack,2),this.stackAtStateChange=r}return Ka=1,(0,$a.inherits)(t,Error),t.prototype.name="IllegalOperationError",Ja.IllegalOperationError=t,Ja.stackCapture=function(t){return"Stack capture: "+t+"\n"+e((new Error).stack,2)},Ja}function Ya(){if(Wa)return Ks;Wa=1;var e=ea(),t=e.constants,r=na(),n=r.HEARTBEAT,i=function(){if(Da)return ia;Da=1;var e=ja,t="function"==typeof setImmediate?setImmediate:Nr.nextTick;return ia.Mux=class{constructor(e){this.newStreams=[],this.oldStreams=[],this.blocked=!1,this.scheduledRead=!1,this.out=e;var t=this;e.on("drain",function(){t.blocked=!1,t._readIncoming()})}_readIncoming(){if(!this.blocked){var t=!0,r=this.out;n(this.newStreams),t?(e.equal(0,this.newStreams.length),n(this.oldStreams)):(e(this.newStreams.length>0,"Expect some new streams to remain"),Array.prototype.push.apply(this.oldStreams,this.newStreams),this.newStreams=[]),this.blocked=!t}function n(e){for(var n;t&&(n=e.shift());){var i=n.read();null!==i&&(t=r.write(i),e.push(n))}}}_scheduleRead(){var e=this;e.scheduledRead||(t(function(){e.scheduledRead=!1,e._readIncoming()}),e.scheduledRead=!0)}pipeFrom(e){var t=this;function r(){t.newStreams.push(e),t._scheduleRead()}function n(){e.removeListener("readable",r),e.removeListener("error",n),e.removeListener("end",n),e.removeListener("unpipeFrom",i)}function i(e){e===t&&n()}e.on("unpipeFrom",i),e.on("end",n),e.on("error",n),e.on("readable",r)}unpipeFrom(e){e.emit("unpipeFrom",this)}},ia}().Mux,o=Pa.Duplex,s=Fa,a=(Ma||(Ma=1,function(e){var t=Fa;e.exports.UNITS_TO_MS=1e3,e.exports.Heart=class extends t{constructor(t,r,n){super(),this.interval=t;var i=t*e.exports.UNITS_TO_MS,o=this.emit.bind(this,"beat"),s=this.emit.bind(this,"timeout");this.sendTimer=setInterval(this.runHeartbeat.bind(this,r,o),i/2);var a=0;this.recvTimer=setInterval(this.runHeartbeat.bind(this,function(){return n()?(a=0,!0):++a<2},s),i)}clear(){clearInterval(this.sendTimer),clearInterval(this.recvTimer)}runHeartbeat(e,t){e()||t()}}}(qa)),qa.exports).Heart,c=Ha().methodName,u=Ha().closeMessage,l=Ha().inspect,h=function(){if(Va)return Ga;function e(e){return Math.floor(e/32)}function t(e){if(0===e)return 32;let t,r=31;return t=e<<16,0!=t&&(r-=16,e=t),t=e<<8,0!=t&&(r-=8,e=t),t=e<<4,0!=t&&(r-=4,e=t),t=e<<2,0!=t&&(r-=2,e=t),r-(e<<1>>>31)}return Va=1,Ga.BitSet=class{constructor(e){if(e){const t=Math.ceil(e/32);this.words=new Array(t)}else this.words=[];this.wordsInUse=0}ensureSize(e){const t=this.words.length;t<e&&(this.words=this.words.concat(new Array(e-t)))}set(t){const r=e(t);r>=this.wordsInUse&&(this.ensureSize(r+1),this.wordsInUse=r+1);const n=1<<t;this.words[r]|=n}clear(t){const r=e(t);if(r>=this.wordsInUse)return;const n=~(1<<t);this.words[r]&=n}get(t){const r=e(t);if(r>=this.wordsInUse)return!1;const n=1<<t;return!!(this.words[r]&n)}nextSetBit(r){let n=e(r);if(n>=this.wordsInUse)return-1;let i=this.words[n]&4294967295<<r;for(;;){if(i)return 32*n+t(i);if(n++,n===this.wordsInUse)return-1;i=this.words[n]}}nextClearBit(r){let n=e(r);if(n>=this.wordsInUse)return r;let i=~this.words[n]&4294967295<<r;for(;;){if(i)return 32*n+t(i);if(n++,n==this.wordsInUse)return 32*n;i=~this.words[n]}}},Ga}().BitSet,f=$a.format,d=Pa.PassThrough,p=Za().IllegalOperationError,g=Za().stackCapture;function m(e){var r=this.channels[e.channel];if(r)return r.channel.accept(e);this.closeWithError(f("Frame on unknown channel %d",e.channel),t.CHANNEL_ERROR,new Error(f("Frame on unknown channel: %s",l(e,!1))))}function y(r){return function(i){if(i===n);else if(i.id===e.ConnectionClose){r.sendMethod(0,e.ConnectionCloseOk,{});var o=f("Connection closed: %s",u(i)),s=g(o),a=new Error(o);a.code=i.fields.replyCode,B(a)&&r.emit("error",a),r.toClosed(s,a)}else i.id===e.ConnectionBlocked?r.emit("blocked",i.fields.reason):i.id===e.ConnectionUnblocked?r.emit("unblocked"):i.id===e.ConnectionUpdateSecretOk?r.emit("update-secret-ok"):r.closeWithError(f("Unexpected frame on channel 0"),t.UNEXPECTED_FRAME,new Error(f("Unexpected frame on channel 0: %s",l(i,!1))))}}function w(e,t){return function(){throw new p(e,t)}}function b(e,t,r){e.sendMethod=e.sendContent=e.sendMessage=w(t,r)}var v=e.encodeMethod,E=e.encodeProperties,I=e.FRAME_OVERHEAD,_=r.makeBodyFrame,A=r.parseFrame,k=r.decodeFrame;function B(t){switch(t&&t.code){case e.constants.CONNECTION_FORCED:case e.constants.REPLY_SUCCESS:return!1;default:return!0}}return Ks.Connection=class extends s{constructor(e){super();var r=this.stream=function(e){if(e instanceof o)return e;var t=new o;return t.wrap(e),t._write=function(t,r,n){return e.write(t,r,n)},t}(e);this.muxer=new i(r),this.rest=It.alloc(0),this.frameMax=t.FRAME_MIN_SIZE,this.sentSinceLastCheck=!1,this.recvSinceLastCheck=!1,this.expectSocketClose=!1,this.freeChannels=new h,this.channels=[{channel:{accept:y(this)},buffer:e}]}sendProtocolHeader(){this.sendBytes(r.PROTOCOL_HEADER)}open(t,r){var n=this,i=r||function(){},o=Object.create(t);function s(e){n.step(function(t,r){null!==t?h(t):0!==r.channel?h(new Error(f("Frame on channel != 0 during handshake: %s",l(r,!1)))):e(r)})}function a(e,t){s(function(r){r.id===e?t(r):h(new Error(f("Expected %s; got %s",c(e),l(r,!1))))})}function h(e){i(e)}function d(e){n.sendMethod(0,e,o)}function p(e,t){return 0===e||0===t?Math.max(e,t):Math.min(e,t)}function g(r){switch(r.id){case e.ConnectionSecure:h(new Error("Wasn't expecting to have to go through secure"));break;case e.ConnectionClose:h(new Error(f("Handshake terminated by server: %s",u(r))));break;case e.ConnectionTune:var n=r.fields;o.frameMax=p(n.frameMax,t.frameMax),o.channelMax=p(n.channelMax,t.channelMax),o.heartbeat=p(n.heartbeat,t.heartbeat);try{d(e.ConnectionTuneOk),d(e.ConnectionOpen)}catch(e){return void h(e)}a(e.ConnectionOpenOk,y);break;default:h(new Error(f("Expected connection.secure, connection.close, or connection.tune during handshake; got %s",l(r,!1))))}}function y(e){n.channelMax=o.channelMax||65535,n.frameMax=o.frameMax||4294967295,n.heartbeat=o.heartbeat,n.heartbeater=n.startHeartbeater(),n.accept=m,function(e){n.stream.removeListener("end",w),n.stream.removeListener("error",w),n.stream.on("error",n.onSocketError.bind(n)),n.stream.on("end",n.onSocketError.bind(n,new Error("Unexpected close"))),n.on("frameError",n.onSocketError.bind(n)),n.acceptLoop(),i(null,e)}(e)}function w(e){h(e||new Error("Socket closed abruptly during opening handshake"))}this.stream.on("end",w),this.stream.on("error",w),this.sendProtocolHeader(),a(e.ConnectionStart,function(r){if(r.fields.mechanisms.toString().split(" ").indexOf(t.mechanism)<0)h(new Error(f("SASL mechanism %s is not provided by the server",t.mechanism)));else{n.serverProperties=r.fields.serverProperties;try{d(e.ConnectionStartOk)}catch(e){return void h(e)}s(g)}})}close(e){var r=e&&function(){e(null)};this.closeBecause("Cheers, thanks",t.REPLY_SUCCESS,r)}closeBecause(t,r,n){this.sendMethod(0,e.ConnectionClose,{replyText:t,replyCode:r,methodId:0,classId:0});var i=g("closeBecause called: "+t);this.toClosing(i,n)}closeWithError(e,t,r){this.emit("error",r),this.closeBecause(e,t)}onSocketError(e){if(!this.expectSocketClose){this.expectSocketClose=!0,this.emit("error",e);var t=g("Socket error");this.toClosed(t,e)}}toClosing(t,r){var n=this.sendMethod.bind(this);this.accept=function(t){if(t.id===e.ConnectionCloseOk){r&&r();var i=g("ConnectionCloseOk received");this.toClosed(i,void 0)}else t.id===e.ConnectionClose&&n(0,e.ConnectionCloseOk,{})},b(this,"Connection closing",t)}_closeChannels(e){for(var t=1;t<this.channels.length;t++){var r=this.channels[t];null!==r&&r.channel.toClosed(e)}}toClosed(e,t){this._closeChannels(e);var r=f("Connection closed (%s)",t?t.toString():"by client");b(this,r,e),this.accept=w(r,e),this.close=function(t){t&&t(new p(r,e))},this.heartbeater&&this.heartbeater.clear(),this.expectSocketClose=!0,this.stream.end(),this.emit("close",t)}_updateSecret(t,r,n){this.sendMethod(0,e.ConnectionUpdateSecret,{newSecret:t,reason:r}),this.once("update-secret-ok",n)}startHeartbeater(){if(0===this.heartbeat)return null;var e=this,t=new a(this.heartbeat,this.checkSend.bind(this),this.checkRecv.bind(this));return t.on("timeout",function(){var t=new Error("Heartbeat timeout");e.emit("error",t);var r=g("Heartbeat timeout");e.toClosed(r,t)}),t.on("beat",function(){e.sendHeartbeat()}),t}freshChannel(e,t){var r=this.freeChannels.nextClearBit(1);if(r<0||r>this.channelMax)throw new Error("No channels left to allocate");this.freeChannels.set(r);var n=t&&t.highWaterMark||1024,i=new d({objectMode:!0,highWaterMark:n});return this.channels[r]={channel:e,buffer:i},i.on("drain",function(){e.onBufferDrain()}),this.muxer.pipeFrom(i),r}releaseChannel(e){this.freeChannels.clear(e),this.channels[e].buffer.end(),this.channels[e]=null}acceptLoop(){var e=this;function t(){try{for(var t;t=e.recvFrame();)e.accept(t)}catch(t){e.emit("frameError",t)}}e.stream.on("readable",t),t()}step(e){var t=this;!function r(){var n;try{n=t.recvFrame()}catch(t){return void e(t,null)}n?e(null,n):t.stream.once("readable",r)}()}checkSend(){var e=this.sentSinceLastCheck;return this.sentSinceLastCheck=!1,e}checkRecv(){var e=this.recvSinceLastCheck;return this.recvSinceLastCheck=!1,e}sendBytes(e){this.sentSinceLastCheck=!0,this.stream.write(e)}sendHeartbeat(){return this.sendBytes(r.HEARTBEAT_BUF)}sendMethod(e,t,r){var n=v(t,e,r);return this.sentSinceLastCheck=!0,this.channels[e].buffer.write(n)}sendMessage(e,t,r,n,i,o){if(!It.isBuffer(o))throw new TypeError("content is not a buffer");var s=v(t,e,r),a=E(n,e,o.length,i),c=this.channels[e].buffer;this.sentSinceLastCheck=!0;var u=s.length+a.length,l=o.length>0?o.length+I:0,h=u+l;if(h<2048){var f=It.allocUnsafe(h),d=s.copy(f,0);return d+=a.copy(f,d),l>0&&_(e,o).copy(f,d),c.write(f)}if(u<2048){var p=It.allocUnsafe(u);d=s.copy(p,0);a.copy(p,d),c.write(p)}else c.write(s),c.write(a);return this.sendContent(e,o)}sendContent(e,t){if(!It.isBuffer(t))throw new TypeError(f("Expected buffer; got %s",t));for(var r=!0,n=this.channels[e].buffer,i=this.frameMax-I,o=0;o<t.length;o+=i){var s=o+i,a=s>t.length?t.subarray(o):t.subarray(o,s),c=_(e,a);r=n.write(c)}return this.sentSinceLastCheck=!0,r}recvFrame(){var e=A(this.rest);if(e)return this.rest=e.rest,k(e);var t=this.stream.read();return null!==t&&(this.recvSinceLastCheck=!0,this.rest=It.concat([this.rest,t]),this.recvFrame())}},Ks.isFatalError=B,Ks}var Xa,ec={};function tc(){if(Xa)return ec;Xa=1;var e=Xs();return ec.plain=function(e,t){return{mechanism:"PLAIN",response:function(){return It.from(["",e,t].join(String.fromCharCode(0)))},username:e,password:t}},ec.amqplain=function(t,r){return{mechanism:"AMQPLAIN",response:function(){const n=It.alloc(16384),i=e.encodeTable(n,{LOGIN:t,PASSWORD:r},0);return n.subarray(4,i)},username:t,password:r}},ec.external=function(){return{mechanism:"EXTERNAL",response:function(){return It.from("")}}},ec}var rc,nc="0.10.8",ic=Bs(Object.freeze({__proto__:null,default:{}})),oc=Bs(Object.freeze({__proto__:null,default:{}}));function sc(){if(rc)return Us;rc=1;var e=Ls(),t=Gs,r=Ya().Connection,n=$a.format,i=tc();function o(e,t){for(var r=Object.keys(e),n=r.length;n--;){var i=r[n];t[i]=e[i]}return t}var s={product:"amqplib",version:nc,platform:n("Node.JS %s",Nr.version),information:"https://amqp-node.github.io/amqplib/",capabilities:{publisher_confirms:!0,exchange_exchange_bindings:!0,"basic.nack":!0,consumer_cancel_notify:!0,"connection.blocked":!0,authentication_failure_close:!0}};function a(e,r,n,i){e=e?t.unescape(e):"/";r=r||{};function a(e,t){return void 0===e?t:parseInt(e)}return{clientProperties:o(i,Object.create(s)),mechanism:n.mechanism,response:n.response(),locale:r.locale||"en_US",channelMax:a(r.channelMax,0),frameMax:a(r.frameMax,131072),heartbeat:a(r.heartbeat,0),virtualHost:e,capabilities:"",insist:0}}function c(e){var t="guest",r="guest";return""==e.username&&""==e.password||(t=e.username?unescape(e.username):"",r=e.password?unescape(e.password):""),i.plain(t,r)}return Us.connect=function(t,n,s){var u=o(n||{},{});t=t||"amqp://localhost";var l,h,f=!!u.noDelay,d=u.timeout,p=!!u.keepAlive,g=u.keepAliveDelay||0,m=u.clientProperties||{};if("object"==typeof t){var y,w;l=(t.protocol||"amqp")+":",u.host=t.hostname,u.servername=u.servername||t.hostname,u.port=t.port||("amqp:"===l?5672:5671),null==t.username&&null==t.password?(y="guest",w="guest"):(y=t.username||"",w=t.password||"");var b={locale:t.locale,channelMax:t.channelMax,frameMax:t.frameMax,heartbeat:t.heartbeat};h=a(t.vhost,b,u.credentials||i.plain(y,w),m)}else{var v=e(t,!0);l=v.protocol,u.host=v.hostname,u.servername=u.servername||v.hostname,u.port=parseInt(v.port)||("amqp:"===l?5672:5671);var E=v.pathname?v.pathname.substr(1):null;h=a(E,v.query,u.credentials||c(v),m)}var I,_=!1;function A(){_=!0,I.setNoDelay(f),p&&I.setKeepAlive(p,g);var e=new r(I);e.open(h,function(t,r){d&&I.setTimeout(0),null===t?s(null,e):(I.end(),I.destroy(),s(t))})}if("amqp:"===l)I=ic.connect(u,A);else{if("amqps:"!==l)throw new Error("Expected amqp: or amqps: as the protocol; got "+l);I=oc.connect(u,A)}d&&I.setTimeout(d,function(){I.end(),I.destroy(),s(new Error("connect ETIMEDOUT"))}),I.once("error",function(e){_||s(e)})},Us.credentialsFromUrl=c,Us}var ac,cc,uc,lc,hc,fc={},dc={};function pc(){if(ac)return dc;ac=1;var e=ea(),t=Ha().closeMessage,r=Ha().inspect,n=Ha().methodName,i=ja,o=Fa,s=$a.format,a=Za().IllegalOperationError,c=Za().stackCapture;class u extends o{constructor(e){super(),this.connection=e,this.reply=null,this.pending=[],this.lwm=1,this.unconfirmed=[],this.on("ack",this.handleConfirm.bind(this,function(e){e&&e(null)})),this.on("nack",this.handleConfirm.bind(this,function(e){e&&e(new Error("message nacked"))})),this.on("close",function(){for(var e;e=this.unconfirmed.shift();)e&&e(new Error("channel closed"))}),this.handleMessage=f}setOptions(e){this.options=e}allocate(){return this.ch=this.connection.freshChannel(this,this.options),this}sendImmediately(e,t){return this.connection.sendMethod(this.ch,e,t)}sendOrEnqueue(e,t,r){this.reply?this.pending.push({method:e,fields:t,reply:r}):(i(0===this.pending.length),this.reply=r,this.sendImmediately(e,t))}sendMessage(t,r,n){return this.connection.sendMessage(this.ch,e.BasicPublish,t,e.BasicProperties,r,n)}_rpc(i,o,a,c){var u=this;this.sendOrEnqueue(i,o,function(o,l){if(null===o){if(l.id===a)return c(null,l);var h=n(a),f=new Error(s("Expected %s; got %s",h,r(l,!1)));return u.closeWithError(l.id,s("Expected %s; got %s",h,n(l.id)),e.constants.UNEXPECTED_FRAME,f),c(f)}if(o instanceof Error)return c(o);var d=(o.fields.classId<<16)+o.fields.methodId,p=(f=i===d?s("Operation failed: %s; %s",n(i),t(o)):s("Channel closed by server: %s",t(o)),new Error(f));return p.code=o.fields.replyCode,p.classId=o.fields.classId,p.methodId=o.fields.methodId,c(p)})}toClosed(e){this._rejectPending(),h(this,"Channel closed",e),this.accept=l("Channel closed",e),this.connection.releaseChannel(this.ch),this.emit("close")}toClosing(t,r){var n=this.sendImmediately.bind(this);h(this,"Channel closing",t),this.accept=function(t){if(t.id===e.ChannelCloseOk){r&&r();var i=c("ChannelCloseOk frame received");this.toClosed(i)}else t.id===e.ChannelClose&&n(e.ChannelCloseOk,{})}}_rejectPending(){function e(e){e(new Error("Channel ended, no reply will be forthcoming"))}var t;for(null!==this.reply&&e(this.reply),this.reply=null;t=this.pending.shift();)e(t.reply);this.pending=null}closeBecause(t,r,n){this.sendImmediately(e.ChannelClose,{replyText:t,replyCode:r,methodId:0,classId:0});var i=c("closeBecause called: "+t);this.toClosing(i,n)}closeWithError(t,r,n,i){var o=this;this.closeBecause(r,n,function(){i.code=n,t&&(i.classId=e.info(t).classId,i.methodId=e.info(t).methodId),o.emit("error",i)})}acceptMessageFrame(t){try{this.handleMessage=this.handleMessage(t)}catch(r){"string"==typeof r?this.closeWithError(t.id,r,e.constants.UNEXPECTED_FRAME,new Error(r)):r instanceof Error?this.closeWithError(t.id,"Error while processing message",e.constants.INTERNAL_ERROR,r):this.closeWithError(t.id,"Internal error while processing message",e.constants.INTERNAL_ERROR,new Error(r.toString()))}}handleConfirm(e,t){var r=t.deliveryTag;if(t.multiple){var n=this.unconfirmed.splice(0,r-this.lwm+1);this.lwm=r+1,n.forEach(e)}else{var i;if(r===this.lwm)for(i=this.unconfirmed.shift(),this.lwm++;null===this.unconfirmed[0];)this.unconfirmed.shift(),this.lwm++;else i=this.unconfirmed[r-this.lwm],this.unconfirmed[r-this.lwm]=null;e(i)}}pushConfirmCallback(e){this.unconfirmed.push(e||!1)}onBufferDrain(){this.emit("drain")}accept(r){switch(r.id){case void 0:case e.BasicDeliver:case e.BasicReturn:case e.BasicProperties:return this.acceptMessageFrame(r);case e.BasicAck:return this.emit("ack",r.fields);case e.BasicNack:return this.emit("nack",r.fields);case e.BasicCancel:return this.emit("cancel",r.fields);case e.ChannelClose:if(this.reply){var n=this.reply;this.reply=null,n(r)}var i="Channel closed by server: "+t(r);this.sendImmediately(e.ChannelCloseOk,{});var o=new Error(i);o.code=r.fields.replyCode,o.classId=r.fields.classId,o.methodId=r.fields.methodId,this.emit("error",o);var s=c(i);return void this.toClosed(s);case e.BasicFlow:return this.closeWithError(r.id,"Flow not implemented",e.constants.NOT_IMPLEMENTED,new Error("Flow not implemented"));default:n=this.reply;if(this.reply=null,this.pending.length>0){var a=this.pending.shift();this.reply=a.reply,this.sendImmediately(a.method,a.fields)}return n(null,r)}}}function l(e,t){return function(){throw new a(e,t)}}function h(e,t,r){e.sendImmediately=e.sendOrEnqueue=e.sendMessage=l(t,r)}function f(t){var n;if(t.id===e.BasicDeliver)n="delivery";else{if(t.id!==e.BasicReturn)throw s("Expected BasicDeliver or BasicReturn; got %s",r(t));n="return"}var i=this,o=t.fields;return d(function(e){e.fields=o,i.emit(n,e)})}function d(t){var r=0,n=0,i=null,o={fields:null,properties:null,content:null};return function(i){if(i.id===e.BasicProperties)return o.properties=i.fields,0===(r=n=i.size)?(o.content=It.alloc(0),t(o),f):a;throw"Expected headers frame after delivery"};function a(e){if(e.content){var c=e.content.length;if(0===(n-=c))return null!==i?(i.push(e.content),o.content=It.concat(i)):o.content=e.content,t(o),f;if(n<0)throw s("Too much content sent! Expected %d bytes",r);return null!==i?i.push(e.content):i=[e.content],a}throw"Expected content frame after headers"}}return dc.acceptMessage=d,dc.BaseChannel=class extends u{constructor(e){super(e),this.consumers=new Map}registerConsumer(e,t){this.consumers.set(e,t)}unregisterConsumer(e){this.consumers.delete(e)}dispatchMessage(e,t){var r=e.consumerTag,n=this.consumers.get(r);if(n)return n(t);throw new Error("Unknown consumer: "+r)}handleDelivery(e){return this.dispatchMessage(e.fields,e)}handleCancel(e){var t=this.dispatchMessage(e,null);return this.unregisterConsumer(e.consumerTag),t}},dc.Channel=u,dc}function gc(){if(lc)return fc;lc=1;const e=Fa,t=$a.promisify,r=ea(),{BaseChannel:n}=pc(),{acceptMessage:i}=pc(),o=function(){if(uc)return cc;function e(e,t,r){null!=r&&(e[t]=r)}uc=1;var t=Object.freeze({}),r={assertQueue:function(r,n){r=r||"",n=n||t;var i=Object.create(n.arguments||null);return e(i,"x-expires",n.expires),e(i,"x-message-ttl",n.messageTtl),e(i,"x-dead-letter-exchange",n.deadLetterExchange),e(i,"x-dead-letter-routing-key",n.deadLetterRoutingKey),e(i,"x-max-length",n.maxLength),e(i,"x-max-priority",n.maxPriority),e(i,"x-overflow",n.overflow),e(i,"x-queue-mode",n.queueMode),{queue:r,exclusive:!!n.exclusive,durable:void 0===n.durable||n.durable,autoDelete:!!n.autoDelete,arguments:i,passive:!1,ticket:0,nowait:!1}},checkQueue:function(e){return{queue:e,passive:!0,nowait:!1,durable:!0,autoDelete:!1,exclusive:!1,ticket:0}},deleteQueue:function(e,r){return{queue:e,ifUnused:!!(r=r||t).ifUnused,ifEmpty:!!r.ifEmpty,ticket:0,nowait:!1}},purgeQueue:function(e){return{queue:e,ticket:0,nowait:!1}},bindQueue:function(e,t,r,n){return{queue:e,exchange:t,routingKey:r,arguments:n,ticket:0,nowait:!1}},unbindQueue:function(e,t,r,n){return{queue:e,exchange:t,routingKey:r,arguments:n,ticket:0,nowait:!1}},assertExchange:function(r,n,i){i=i||t;var o=Object.create(i.arguments||null);return e(o,"alternate-exchange",i.alternateExchange),{exchange:r,ticket:0,type:n,passive:!1,durable:void 0===i.durable||i.durable,autoDelete:!!i.autoDelete,internal:!!i.internal,nowait:!1,arguments:o}},checkExchange:function(e){return{exchange:e,passive:!0,nowait:!1,durable:!0,internal:!1,type:"",autoDelete:!1,ticket:0}},deleteExchange:function(e,r){return{exchange:e,ifUnused:!!(r=r||t).ifUnused,ticket:0,nowait:!1}},bindExchange:function(e,t,r,n){return{source:t,destination:e,routingKey:r,arguments:n,ticket:0,nowait:!1}},unbindExchange:function(e,t,r,n){return{source:t,destination:e,routingKey:r,arguments:n,ticket:0,nowait:!1}},publish:function(r,n,i){function o(e){return void 0===e?void 0:Array.isArray(e)?e.map(String):[String(e)]}i=i||t;var s,a=Object.create(i.headers||null);e(a,"CC",o(i.CC)),e(a,"BCC",o(i.BCC)),void 0!==i.persistent?s=i.persistent?2:1:"number"==typeof i.deliveryMode?s=i.deliveryMode:i.deliveryMode&&(s=2);var c=i.expiration;return void 0!==c&&(c=c.toString()),{exchange:r,routingKey:n,mandatory:!!i.mandatory,immediate:!1,ticket:void 0,contentType:i.contentType,contentEncoding:i.contentEncoding,headers:a,deliveryMode:s,priority:i.priority,correlationId:i.correlationId,replyTo:i.replyTo,expiration:c,messageId:i.messageId,timestamp:i.timestamp,type:i.type,userId:i.userId,appId:i.appId,clusterId:void 0}},consume:function(r,n){n=n||t;var i=Object.create(n.arguments||null);return e(i,"x-priority",n.priority),{ticket:0,queue:r,consumerTag:n.consumerTag||"",noLocal:!!n.noLocal,noAck:!!n.noAck,exclusive:!!n.exclusive,nowait:!1,arguments:i}},cancel:function(e){return{consumerTag:e,nowait:!1}},get:function(e,r){return{ticket:0,queue:e,noAck:!!(r=r||t).noAck}},ack:function(e,t){return{deliveryTag:e,multiple:!!t}},nack:function(e,t,r){return{deliveryTag:e,multiple:!!t,requeue:void 0===r||r}},reject:function(e,t){return{deliveryTag:e,requeue:void 0===t||t}},prefetch:function(e,t){return{prefetchCount:e||0,prefetchSize:0,global:!!t}},recover:function(){return{requeue:!0}}};return cc=Object.freeze(r)}(),{inspect:s}=Ha();class a extends n{constructor(e){super(e),this.on("delivery",this.handleDelivery.bind(this)),this.on("cancel",this.handleCancel.bind(this))}async rpc(e,r,n){return(await t(t=>this._rpc(e,r,n,t))()).fields}async open(){return(await this.allocate.bind(this)()).rpc(r.ChannelOpen,{outOfBand:""},r.ChannelOpenOk)}close(){return t(e=>this.closeBecause("Goodbye",r.constants.REPLY_SUCCESS,e))()}assertQueue(e,t){return this.rpc(r.QueueDeclare,o.assertQueue(e,t),r.QueueDeclareOk)}checkQueue(e){return this.rpc(r.QueueDeclare,o.checkQueue(e),r.QueueDeclareOk)}deleteQueue(e,t){return this.rpc(r.QueueDelete,o.deleteQueue(e,t),r.QueueDeleteOk)}purgeQueue(e){return this.rpc(r.QueuePurge,o.purgeQueue(e),r.QueuePurgeOk)}bindQueue(e,t,n,i){return this.rpc(r.QueueBind,o.bindQueue(e,t,n,i),r.QueueBindOk)}unbindQueue(e,t,n,i){return this.rpc(r.QueueUnbind,o.unbindQueue(e,t,n,i),r.QueueUnbindOk)}assertExchange(e,t,n){return this.rpc(r.ExchangeDeclare,o.assertExchange(e,t,n),r.ExchangeDeclareOk).then(t=>({exchange:e}))}checkExchange(e){return this.rpc(r.ExchangeDeclare,o.checkExchange(e),r.ExchangeDeclareOk)}deleteExchange(e,t){return this.rpc(r.ExchangeDelete,o.deleteExchange(e,t),r.ExchangeDeleteOk)}bindExchange(e,t,n,i){return this.rpc(r.ExchangeBind,o.bindExchange(e,t,n,i),r.ExchangeBindOk)}unbindExchange(e,t,n,i){return this.rpc(r.ExchangeUnbind,o.unbindExchange(e,t,n,i),r.ExchangeUnbindOk)}publish(e,t,r,n){const i=o.publish(e,t,n);return this.sendMessage(i,i,r)}sendToQueue(e,t,r){return this.publish("",e,t,r)}consume(e,t,n){const i=o.consume(e,n);return new Promise((e,n)=>{this._rpc(r.BasicConsume,i,r.BasicConsumeOk,(r,i)=>{if(r)return n(r);this.registerConsumer(i.fields.consumerTag,t),e(i.fields)})})}async cancel(e){await t(t=>{this._rpc(r.BasicCancel,o.cancel(e),r.BasicCancelOk,t)})().then(t=>(this.unregisterConsumer(e),t.fields))}get(e,t){const n=o.get(e,t);return new Promise((e,t)=>{this.sendOrEnqueue(r.BasicGet,n,(n,o)=>{if(n)return t(n);if(o.id===r.BasicGetEmpty)return e(!1);if(o.id===r.BasicGetOk){const t=o.fields;this.handleMessage=i(r=>{r.fields=t,e(r)})}else t(new Error(`Unexpected response to BasicGet: ${s(o)}`))})})}ack(e,t){this.sendImmediately(r.BasicAck,o.ack(e.fields.deliveryTag,t))}ackAll(){this.sendImmediately(r.BasicAck,o.ack(0,!0))}nack(e,t,n){this.sendImmediately(r.BasicNack,o.nack(e.fields.deliveryTag,t,n))}nackAll(e){this.sendImmediately(r.BasicNack,o.nack(0,!0,e))}reject(e,t){this.sendImmediately(r.BasicReject,o.reject(e.fields.deliveryTag,t))}recover(){return this.rpc(r.BasicRecover,o.recover(),r.BasicRecoverOk)}qos(e,t){return this.rpc(r.BasicQos,o.prefetch(e,t),r.BasicQosOk)}}a.prototype.prefetch=a.prototype.qos;class c extends a{publish(e,t,r,n,i){return this.pushConfirmCallback(i),super.publish(e,t,r,n)}sendToQueue(e,t,r,n){return this.publish("",e,t,r,n)}waitForConfirms(){const e=[],t=this.unconfirmed;if(t.forEach((r,n)=>{if(null!==r){const i=new Promise((e,i)=>{t[n]=t=>{r&&r(t),null===t?e():i(t)}});e.push(i)}}),!this.pending)for(var r;r=this.unconfirmed.shift();)r&&r(new Error("channel closed"));return Promise.all(e)}}return fc.ConfirmChannel=c,fc.Channel=a,fc.ChannelModel=class extends e{constructor(e){super(),this.connection=e,["error","close","blocked","unblocked"].forEach(t=>{e.on(t,this.emit.bind(this,t))})}close(){return t(this.connection.close.bind(this.connection))()}updateSecret(e,r){return t(this.connection._updateSecret.bind(this.connection))(e,r)}async createChannel(e){const t=new a(this.connection);return t.setOptions(e),await t.open(),t}async createConfirmChannel(e){const t=new c(this.connection);return t.setOptions(e),await t.open(),await t.rpc(r.ConfirmSelect,{nowait:!1},r.ConfirmSelectOk),t}},fc}!function(){if(hc)return Os;hc=1;var e=sc().connect,t=gc().ChannelModel,r=$a.promisify;Os.connect=function(n,i){return r(function(t){return e(n,i,t)})().then(function(e){return new t(e)})},Os.credentials=tc(),Os.IllegalOperationError=Za().IllegalOperationError}();class mc extends qe{constructor(e={}){super(),this.config=e,this.name=this.constructor.name,this.enabled=!1!==e.enabled}async initialize(e){this.database=e,this.emit("initialized",{replicator:this.name})}async replicate(e,t,r,n){throw new Error(`replicate() method must be implemented by ${this.name}`)}async replicateBatch(e,t){throw new Error(`replicateBatch() method must be implemented by ${this.name}`)}async testConnection(){throw new Error(`testConnection() method must be implemented by ${this.name}`)}async getStatus(){return{name:this.name,config:this.config,connected:!1}}async cleanup(){this.emit("cleanup",{replicator:this.name})}validateConfig(){return{isValid:!0,errors:[]}}}var yc,wc,bc,vc,Ec,Ic,_c,Ac,kc,Bc,xc,Sc,Oc,Uc={};function Cc(){if(wc)return yc;var e,t;wc=1;var r,n={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function i(t){throw{name:"SyntaxError",message:t,at:e,text:r}}function o(n){return n&&n!==t&&i("Expected '"+n+"' instead of '"+t+"'"),t=r.charAt(e),e+=1,t}function s(){var e,r="";for("-"===t&&(r="-",o("-"));t>="0"&&t<="9";)r+=t,o();if("."===t)for(r+=".";o()&&t>="0"&&t<="9";)r+=t;if("e"===t||"E"===t)for(r+=t,o(),"-"!==t&&"+"!==t||(r+=t,o());t>="0"&&t<="9";)r+=t,o();return e=Number(r),isFinite(e)||i("Bad number"),e}function a(){var e,r,s,a="";if('"'===t)for(;o();){if('"'===t)return o(),a;if("\\"===t)if(o(),"u"===t){for(s=0,r=0;r<4&&(e=parseInt(o(),16),isFinite(e));r+=1)s=16*s+e;a+=String.fromCharCode(s)}else{if("string"!=typeof n[t])break;a+=n[t]}else a+=t}i("Bad string")}function c(){for(;t&&t<=" ";)o()}function u(){switch(c(),t){case"{":return function(){var e,r={};if("{"===t){if(o("{"),c(),"}"===t)return o("}"),r;for(;t;){if(e=a(),c(),o(":"),Object.prototype.hasOwnProperty.call(r,e)&&i('Duplicate key "'+e+'"'),r[e]=u(),c(),"}"===t)return o("}"),r;o(","),c()}}i("Bad object")}();case"[":return function(){var e=[];if("["===t){if(o("["),c(),"]"===t)return o("]"),e;for(;t;){if(e.push(u()),c(),"]"===t)return o("]"),e;o(","),c()}}i("Bad array")}();case'"':return a();case"-":return s();default:return t>="0"&&t<="9"?s():function(){switch(t){case"t":return o("t"),o("r"),o("u"),o("e"),!0;case"f":return o("f"),o("a"),o("l"),o("s"),o("e"),!1;case"n":return o("n"),o("u"),o("l"),o("l"),null;default:i("Unexpected '"+t+"'")}}()}}return yc=function(n,o){var s;return r=n,e=0,t=" ",s=u(),c(),t&&i("Syntax error"),"function"==typeof o?function e(t,r){var n,i,s=t[r];if(s&&"object"==typeof s)for(n in u)Object.prototype.hasOwnProperty.call(s,n)&&(void 0===(i=e(s,n))?delete s[n]:s[n]=i);return o.call(t,r,s)}({"":s},""):s},yc}function Nc(){if(vc)return bc;vc=1;var e,t,r,n=/[\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,i={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function o(e){return n.lastIndex=0,n.test(e)?'"'+e.replace(n,function(e){var t=i[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function s(n,i){var a,c,u,l,h,f=e,d=i[n];switch(d&&"object"==typeof d&&"function"==typeof d.toJSON&&(d=d.toJSON(n)),"function"==typeof r&&(d=r.call(i,n,d)),typeof d){case"string":return o(d);case"number":return isFinite(d)?String(d):"null";case"boolean":case"null":return String(d);case"object":if(!d)return"null";if(e+=t,h=[],"[object Array]"===Object.prototype.toString.apply(d)){for(l=d.length,a=0;a<l;a+=1)h[a]=s(a,d)||"null";return u=0===h.length?"[]":e?"[\n"+e+h.join(",\n"+e)+"\n"+f+"]":"["+h.join(",")+"]",e=f,u}if(r&&"object"==typeof r)for(l=r.length,a=0;a<l;a+=1)"string"==typeof(c=r[a])&&(u=s(c,d))&&h.push(o(c)+(e?": ":":")+u);else for(c in d)Object.prototype.hasOwnProperty.call(d,c)&&(u=s(c,d))&&h.push(o(c)+(e?": ":":")+u);return u=0===h.length?"{}":e?"{\n"+e+h.join(",\n"+e)+"\n"+f+"}":"{"+h.join(",")+"}",e=f,u}}return bc=function(n,i,o){var a;if(e="",t="","number"==typeof o)for(a=0;a<o;a+=1)t+=" ";else"string"==typeof o&&(t=o);if(r=i,i&&"function"!=typeof i&&("object"!=typeof i||"number"!=typeof i.length))throw new Error("JSON.stringify");return s("",{"":n})}}function Rc(){if(kc)return Ac;kc=1;var e=Object.prototype.toString;return Ac=function(t){var r=e.call(t),n="[object Arguments]"===r;return n||(n="[object Array]"!==r&&null!==t&&"object"==typeof t&&"number"==typeof t.length&&t.length>=0&&"[object Function]"===e.call(t.callee)),n}}function Tc(){if(xc)return Bc;var e;if(xc=1,!Object.keys){var t=Object.prototype.hasOwnProperty,r=Object.prototype.toString,n=Rc(),i=Object.prototype.propertyIsEnumerable,o=!i.call({toString:null},"toString"),s=i.call(function(){},"prototype"),a=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],c=function(e){var t=e.constructor;return t&&t.prototype===e},u={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},l=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!u["$"+e]&&t.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{c(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();e=function(e){var i=null!==e&&"object"==typeof e,u="[object Function]"===r.call(e),h=n(e),f=i&&"[object String]"===r.call(e),d=[];if(!i&&!u&&!h)throw new TypeError("Object.keys called on a non-object");var p=s&&u;if(f&&e.length>0&&!t.call(e,0))for(var g=0;g<e.length;++g)d.push(String(g));if(h&&e.length>0)for(var m=0;m<e.length;++m)d.push(String(m));else for(var y in e)p&&"prototype"===y||!t.call(e,y)||d.push(String(y));if(o)for(var w=function(e){if("undefined"==typeof window||!l)return c(e);try{return c(e)}catch(e){return!1}}(e),b=0;b<a.length;++b)w&&"constructor"===a[b]||!t.call(e,a[b])||d.push(a[b]);return d}}return Bc=e}function Lc(){if(Oc)return Sc;Oc=1;var e=Array.prototype.slice,t=Rc(),r=Object.keys,n=r?function(e){return r(e)}:Tc(),i=Object.keys;return n.shim=function(){if(Object.keys){var r=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);r||(Object.keys=function(r){return t(r)?i(e.call(r)):i(r)})}else Object.keys=n;return Object.keys||n},Sc=n}var Dc,jc,Mc,Pc,Fc,qc,Qc,zc,$c,Hc,Vc,Gc,Kc,Wc,Jc,Zc,Yc,Xc,eu,tu,ru,nu,iu,ou,su,au,cu,uu,lu,hu,fu,du,pu,gu,mu,yu,wu,bu,vu,Eu,Iu,_u,Au,ku,Bu,xu,Su,Ou,Uu,Cu,Nu,Ru,Tu,Lu,Du,ju,Mu,Pu,Fu,qu,Qu,zu,$u,Hu,Vu,Gu,Ku,Wu,Ju,Zu,Yu,Xu,el,tl,rl,nl,il,ol,sl,al,cl,ul={exports:{}};function ll(){return jc?Dc:(jc=1,Dc=Object)}function hl(){return Pc?Mc:(Pc=1,Mc=Error)}function fl(){return qc?Fc:(qc=1,Fc=EvalError)}function dl(){return zc?Qc:(zc=1,Qc=RangeError)}function pl(){return Hc?$c:(Hc=1,$c=ReferenceError)}function gl(){return Gc?Vc:(Gc=1,Vc=SyntaxError)}function ml(){return Wc?Kc:(Wc=1,Kc=TypeError)}function yl(){return Zc?Jc:(Zc=1,Jc=URIError)}function wl(){return Xc?Yc:(Xc=1,Yc=Math.abs)}function bl(){return tu?eu:(tu=1,eu=Math.floor)}function vl(){return nu?ru:(nu=1,ru=Math.max)}function El(){return ou?iu:(ou=1,iu=Math.min)}function Il(){return au?su:(au=1,su=Math.pow)}function _l(){return uu?cu:(uu=1,cu=Math.round)}function Al(){if(du)return fu;du=1;var e=hu?lu:(hu=1,lu=Number.isNaN||function(e){return e!=e});return fu=function(t){return e(t)||0===t?t:t<0?-1:1}}function kl(){if(yu)return mu;yu=1;var e=gu?pu:(gu=1,pu=Object.getOwnPropertyDescriptor);if(e)try{e([],"length")}catch(t){e=null}return mu=e}function Bl(){if(bu)return wu;bu=1;var e=Object.defineProperty||!1;if(e)try{e({},"a",{value:1})}catch(t){e=!1}return wu=e}function xl(){if(_u)return Iu;_u=1;var e="undefined"!=typeof Symbol&&Symbol,t=Eu?vu:(Eu=1,vu=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),r=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(r))return!1;for(var n in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var i=Object.getOwnPropertySymbols(e);if(1!==i.length||i[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var o=Object.getOwnPropertyDescriptor(e,t);if(42!==o.value||!0!==o.enumerable)return!1}return!0});return Iu=function(){return"function"==typeof e&&("function"==typeof Symbol&&("symbol"==typeof e("foo")&&("symbol"==typeof Symbol("bar")&&t())))}}function Sl(){return ku?Au:(ku=1,Au="undefined"!=typeof Reflect&&Reflect.getPrototypeOf||null)}function Ol(){return xu?Bu:(xu=1,Bu=ll().getPrototypeOf||null)}function Ul(){if(Ou)return Su;Ou=1;var e=Object.prototype.toString,t=Math.max,r=function(e,t){for(var r=[],n=0;n<e.length;n+=1)r[n]=e[n];for(var i=0;i<t.length;i+=1)r[i+e.length]=t[i];return r};return Su=function(n){var i=this;if("function"!=typeof i||"[object Function]"!==e.apply(i))throw new TypeError("Function.prototype.bind called on incompatible "+i);for(var o,s=function(e,t){for(var r=[],n=t,i=0;n<e.length;n+=1,i+=1)r[i]=e[n];return r}(arguments,1),a=t(0,i.length-s.length),c=[],u=0;u<a;u++)c[u]="$"+u;if(o=Function("binder","return function ("+function(e,t){for(var r="",n=0;n<e.length;n+=1)r+=e[n],n+1<e.length&&(r+=t);return r}(c,",")+"){ return binder.apply(this,arguments); }")(function(){if(this instanceof o){var e=i.apply(this,r(s,arguments));return Object(e)===e?e:this}return i.apply(n,r(s,arguments))}),i.prototype){var l=function(){};l.prototype=i.prototype,o.prototype=new l,l.prototype=null}return o},Su}function Cl(){if(Cu)return Uu;Cu=1;var e=Ul();return Uu=Function.prototype.bind||e}function Nl(){return Ru?Nu:(Ru=1,Nu=Function.prototype.call)}function Rl(){return Lu?Tu:(Lu=1,Tu=Function.prototype.apply)}function Tl(){if(Pu)return Mu;Pu=1;var e=Cl(),t=Rl(),r=Nl(),n=ju?Du:(ju=1,Du="undefined"!=typeof Reflect&&Reflect&&Reflect.apply);return Mu=n||e.call(r,t)}function Ll(){if(qu)return Fu;qu=1;var e=Cl(),t=ml(),r=Nl(),n=Tl();return Fu=function(i){if(i.length<1||"function"!=typeof i[0])throw new t("a function is required");return n(e,r,i)}}function Dl(){if(zu)return Qu;zu=1;var e,t=Ll(),r=kl();try{e=[].__proto__===Array.prototype}catch(e){if(!e||"object"!=typeof e||!("code"in e)||"ERR_PROTO_ACCESS"!==e.code)throw e}var n=!!e&&r&&r(Object.prototype,"__proto__"),i=Object,o=i.getPrototypeOf;return Qu=n&&"function"==typeof n.get?t([n.get]):"function"==typeof o&&function(e){return o(null==e?e:i(e))}}function jl(){if(Hu)return $u;Hu=1;var e=Sl(),t=Ol(),r=Dl();return $u=e?function(t){return e(t)}:t?function(e){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new TypeError("getProto: not an object");return t(e)}:r?function(e){return r(e)}:null}function Ml(){if(Gu)return Vu;Gu=1;var e=Function.prototype.call,t=Object.prototype.hasOwnProperty,r=Cl();return Vu=r.call(e,t)}function Pl(){if(Wu)return Ku;var e;Wu=1;var t=ll(),r=hl(),n=fl(),i=dl(),o=pl(),s=gl(),a=ml(),c=yl(),u=wl(),l=bl(),h=vl(),f=El(),d=Il(),p=_l(),g=Al(),m=Function,y=function(e){try{return m('"use strict"; return ('+e+").constructor;")()}catch(e){}},w=kl(),b=Bl(),v=function(){throw new a},E=w?function(){try{return v}catch(e){try{return w(arguments,"callee").get}catch(e){return v}}}():v,I=xl()(),_=jl(),A=Ol(),k=Sl(),B=Rl(),x=Nl(),S={},O="undefined"!=typeof Uint8Array&&_?_(Uint8Array):e,U={__proto__:null,"%AggregateError%":"undefined"==typeof AggregateError?e:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?e:ArrayBuffer,"%ArrayIteratorPrototype%":I&&_?_([][Symbol.iterator]()):e,"%AsyncFromSyncIteratorPrototype%":e,"%AsyncFunction%":S,"%AsyncGenerator%":S,"%AsyncGeneratorFunction%":S,"%AsyncIteratorPrototype%":S,"%Atomics%":"undefined"==typeof Atomics?e:Atomics,"%BigInt%":"undefined"==typeof BigInt?e:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?e:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?e:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?e:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":r,"%eval%":eval,"%EvalError%":n,"%Float16Array%":"undefined"==typeof Float16Array?e:Float16Array,"%Float32Array%":"undefined"==typeof Float32Array?e:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?e:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?e:FinalizationRegistry,"%Function%":m,"%GeneratorFunction%":S,"%Int8Array%":"undefined"==typeof Int8Array?e:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?e:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?e:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":I&&_?_(_([][Symbol.iterator]())):e,"%JSON%":"object"==typeof JSON?JSON:e,"%Map%":"undefined"==typeof Map?e:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&I&&_?_((new Map)[Symbol.iterator]()):e,"%Math%":Math,"%Number%":Number,"%Object%":t,"%Object.getOwnPropertyDescriptor%":w,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?e:Promise,"%Proxy%":"undefined"==typeof Proxy?e:Proxy,"%RangeError%":i,"%ReferenceError%":o,"%Reflect%":"undefined"==typeof Reflect?e:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?e:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&I&&_?_((new Set)[Symbol.iterator]()):e,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?e:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":I&&_?_(""[Symbol.iterator]()):e,"%Symbol%":I?Symbol:e,"%SyntaxError%":s,"%ThrowTypeError%":E,"%TypedArray%":O,"%TypeError%":a,"%Uint8Array%":"undefined"==typeof Uint8Array?e:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?e:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?e:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?e:Uint32Array,"%URIError%":c,"%WeakMap%":"undefined"==typeof WeakMap?e:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?e:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?e:WeakSet,"%Function.prototype.call%":x,"%Function.prototype.apply%":B,"%Object.defineProperty%":b,"%Object.getPrototypeOf%":A,"%Math.abs%":u,"%Math.floor%":l,"%Math.max%":h,"%Math.min%":f,"%Math.pow%":d,"%Math.round%":p,"%Math.sign%":g,"%Reflect.getPrototypeOf%":k};if(_)try{null.error}catch(e){var C=_(_(e));U["%Error.prototype%"]=C}var N=function e(t){var r;if("%AsyncFunction%"===t)r=y("async function () {}");else if("%GeneratorFunction%"===t)r=y("function* () {}");else if("%AsyncGeneratorFunction%"===t)r=y("async function* () {}");else if("%AsyncGenerator%"===t){var n=e("%AsyncGeneratorFunction%");n&&(r=n.prototype)}else if("%AsyncIteratorPrototype%"===t){var i=e("%AsyncGenerator%");i&&_&&(r=_(i.prototype))}return U[t]=r,r},R={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},T=Cl(),L=Ml(),D=T.call(x,Array.prototype.concat),j=T.call(B,Array.prototype.splice),M=T.call(x,String.prototype.replace),P=T.call(x,String.prototype.slice),F=T.call(x,RegExp.prototype.exec),q=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,Q=/\\(\\)?/g,z=function(e,t){var r,n=e;if(L(R,n)&&(n="%"+(r=R[n])[0]+"%"),L(U,n)){var i=U[n];if(i===S&&(i=N(n)),void 0===i&&!t)throw new a("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:r,name:n,value:i}}throw new s("intrinsic "+e+" does not exist!")};return Ku=function(e,t){if("string"!=typeof e||0===e.length)throw new a("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new a('"allowMissing" argument must be a boolean');if(null===F(/^%?[^%]*%?$/,e))throw new s("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var r=function(e){var t=P(e,0,1),r=P(e,-1);if("%"===t&&"%"!==r)throw new s("invalid intrinsic syntax, expected closing `%`");if("%"===r&&"%"!==t)throw new s("invalid intrinsic syntax, expected opening `%`");var n=[];return M(e,q,function(e,t,r,i){n[n.length]=r?M(i,Q,"$1"):t||e}),n}(e),n=r.length>0?r[0]:"",i=z("%"+n+"%",t),o=i.name,c=i.value,u=!1,l=i.alias;l&&(n=l[0],j(r,D([0,1],l)));for(var h=1,f=!0;h<r.length;h+=1){var d=r[h],p=P(d,0,1),g=P(d,-1);if(('"'===p||"'"===p||"`"===p||'"'===g||"'"===g||"`"===g)&&p!==g)throw new s("property names with quotes must have matching quotes");if("constructor"!==d&&f||(u=!0),L(U,o="%"+(n+="."+d)+"%"))c=U[o];else if(null!=c){if(!(d in c)){if(!t)throw new a("base intrinsic for "+e+" exists, but the property is not available.");return}if(w&&h+1>=r.length){var m=w(c,d);c=(f=!!m)&&"get"in m&&!("originalValue"in m.get)?m.get:c[d]}else f=L(c,d),c=c[d];f&&!u&&(U[o]=c)}}return c},Ku}function Fl(){if(Zu)return Ju;Zu=1;var e=Bl(),t=gl(),r=ml(),n=kl();return Ju=function(i,o,s){if(!i||"object"!=typeof i&&"function"!=typeof i)throw new r("`obj` must be an object or a function`");if("string"!=typeof o&&"symbol"!=typeof o)throw new r("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new r("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new r("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new r("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new r("`loose`, if provided, must be a boolean");var a=arguments.length>3?arguments[3]:null,c=arguments.length>4?arguments[4]:null,u=arguments.length>5?arguments[5]:null,l=arguments.length>6&&arguments[6],h=!!n&&n(i,o);if(e)e(i,o,{configurable:null===u&&h?h.configurable:!u,enumerable:null===a&&h?h.enumerable:!a,value:s,writable:null===c&&h?h.writable:!c});else{if(!l&&(a||c||u))throw new t("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");i[o]=s}},Ju}function ql(){if(Xu)return Yu;Xu=1;var e=Bl(),t=function(){return!!e};return t.hasArrayLengthDefineBug=function(){if(!e)return null;try{return 1!==e([],"length",{value:1}).length}catch(e){return!0}},Yu=t}function Ql(){if(tl)return el;tl=1;var e=Pl(),t=Fl(),r=ql()(),n=kl(),i=ml(),o=e("%Math.floor%");return el=function(e,s){if("function"!=typeof e)throw new i("`fn` is not a function");if("number"!=typeof s||s<0||s>4294967295||o(s)!==s)throw new i("`length` must be a positive 32-bit integer");var a=arguments.length>2&&!!arguments[2],c=!0,u=!0;if("length"in e&&n){var l=n(e,"length");l&&!l.configurable&&(c=!1),l&&!l.writable&&(u=!1)}return(c||u||!a)&&(r?t(e,"length",s,!0,!0):t(e,"length",s)),e},el}function zl(){if(nl)return rl;nl=1;var e=Cl(),t=Rl(),r=Tl();return rl=function(){return r(e,t,arguments)},rl}function $l(){return il||(il=1,function(e){var t=Ql(),r=Bl(),n=Ll(),i=zl();e.exports=function(e){var r=n(arguments),i=e.length-(arguments.length-1);return t(r,1+(i>0?i:0),!0)},r?r(e.exports,"apply",{value:i}):e.exports.apply=i}(ul)),ul.exports}function Hl(){if(sl)return ol;sl=1;var e=Pl(),t=Ll(),r=t([e("%String.prototype.indexOf%")]);return ol=function(n,i){var o=e(n,!!i);return"function"==typeof o&&r(n,".prototype.")>-1?t([o]):o}}var Vl,Gl=function(){if(cl)return al;cl=1;var e=("undefined"!=typeof JSON?JSON:(Ec||(Ec=1,Uc.parse=Cc(),Uc.stringify=Nc()),Uc)).stringify,t=function(){if(_c)return Ic;_c=1;var e={}.toString;return Ic=Array.isArray||function(t){return"[object Array]"==e.call(t)}}(),r=Lc(),n=$l(),i=Hl(),o=i("Array.prototype.join"),s=i("Array.prototype.indexOf"),a=i("Array.prototype.splice"),c=i("Array.prototype.sort"),u=function(e,t){for(var r="",n=0;n<e;n+=1)r+=t;return r},l=function(e,t,r){return r};return al=function(i){var h=arguments.length>1?arguments[1]:void 0,f=h&&h.space||"";"number"==typeof f&&(f=u(f," "));var d=!!h&&"boolean"==typeof h.cycles&&h.cycles,p=h&&h.replacer?n(h.replacer):l;if(h&&void 0!==h.collapseEmpty&&"boolean"!=typeof h.collapseEmpty)throw new TypeError("`collapseEmpty` must be a boolean, if provided");var g=!!h&&h.collapseEmpty,m="function"==typeof h?h:h&&h.cmp,y=m&&function(e){var t=m.length>2&&function(t){return e[t]};return function(r,n){return m({key:r,value:e[r]},{key:n,value:e[n]},t?{__proto__:null,get:t}:void 0)}},w=[];return function n(i,l,h,m){var b=f?"\n"+u(m,f):"",v=f?": ":":";if(h&&h.toJSON&&"function"==typeof h.toJSON&&(h=h.toJSON()),void 0!==(h=p(i,l,h))){if("object"!=typeof h||null===h)return e(h);var E=function(e,t){return g&&0===e.length?t:("[]"===t?"[":"{")+o(e,",")+b+("[]"===t?"]":"}")};if(t(h)){for(var I=[],_=0;_<h.length;_++){var A=n(h,_,h[_],m+1)||e(null);I[I.length]=b+f+A}return E(I,"[]")}if(-1!==s(w,h)){if(d)return e("__cycle__");throw new TypeError("Converting circular structure to JSON")}w[w.length]=h;var k=c(r(h),y&&y(h));for(I=[],_=0;_<k.length;_++){var B=n(h,l=k[_],h[l],m+1);if(B){var x=e(l)+v+B;I[I.length]=b+f+x}}return a(w,s(w,h),1),E(I,"{}")}}({"":i},"",i,0)},al}(),Kl=ks(Gl);function Wl(e,t,r,n){return new(r||(r=Promise))(function(t,i){function o(e){try{a(n.next(e))}catch(e){i(e)}}function s(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r(function(e){e(n)})).then(o,s)}a((n=n.apply(e,[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class Jl{constructor(){this.mutex=Promise.resolve()}lock(){let e=()=>{};return this.mutex=this.mutex.then(()=>new Promise(e)),new Promise(t=>{e=t})}dispatch(e){return Wl(this,0,void 0,function*(){const t=yield this.lock();try{return yield Promise.resolve(e())}finally{t()}})}}const Zl="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:at,Yl=null!==(Vl=Zl.Buffer)&&void 0!==Vl?Vl:null,Xl=Zl.TextEncoder?new Zl.TextEncoder:null;function eh(e,t){return(15&e)+(e>>6|e>>3&8)<<4|(15&t)+(t>>6|t>>3&8)}const th="a".charCodeAt(0)-10,rh="0".charCodeAt(0);function nh(e,t,r){let n=0;for(let i=0;i<r;i++){let r=t[i]>>>4;e[n++]=r>9?r+th:r+rh,r=15&t[i],e[n++]=r>9?r+th:r+rh}return String.fromCharCode.apply(null,e)}const ih=null!==Yl?e=>{if("string"==typeof e){const t=Yl.from(e,"utf8");return new Uint8Array(t.buffer,t.byteOffset,t.length)}if(Yl.isBuffer(e))return new Uint8Array(e.buffer,e.byteOffset,e.length);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Invalid data type!")}:e=>{if("string"==typeof e)return Xl.encode(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Invalid data type!")},oh="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",sh=new Uint8Array(256);for(let e=0;e<64;e++)sh[oh.charCodeAt(e)]=e;function ah(e){const t=function(e){let t=Math.floor(.75*e.length);const r=e.length;return"="===e[r-1]&&(t-=1,"="===e[r-2]&&(t-=1)),t}(e),r=e.length,n=new Uint8Array(t);let i=0;for(let t=0;t<r;t+=4){const r=sh[e.charCodeAt(t)],o=sh[e.charCodeAt(t+1)],s=sh[e.charCodeAt(t+2)],a=sh[e.charCodeAt(t+3)];n[i]=r<<2|o>>4,i+=1,n[i]=(15&o)<<4|s>>2,i+=1,n[i]=(3&s)<<6|63&a,i+=1}return n}const ch=16384,uh=new Jl,lh=new Map;function hh(e,t){return Wl(this,0,void 0,function*(){let r=null,n=null,i=!1;if("undefined"==typeof WebAssembly)throw new Error("WebAssembly is not supported in this environment!");const o=()=>new DataView(r.exports.memory.buffer).getUint32(r.exports.STATE_SIZE,!0),s=uh.dispatch(()=>Wl(this,0,void 0,function*(){if(!lh.has(e.name)){const t=ah(e.data),r=WebAssembly.compile(t);lh.set(e.name,r)}const t=yield lh.get(e.name);r=yield WebAssembly.instantiate(t,{})})),a=(e=null)=>{i=!0,r.exports.Hash_Init(e)},c=e=>{if(!i)throw new Error("update() called before init()");(e=>{let t=0;for(;t<e.length;){const i=e.subarray(t,t+ch);t+=i.length,n.set(i),r.exports.Hash_Update(i.length)}})(ih(e))},u=new Uint8Array(2*t),l=(e,o=null)=>{if(!i)throw new Error("digest() called before init()");return i=!1,r.exports.Hash_Final(o),"binary"===e?n.slice(0,t):nh(u,n,t)},h=e=>"string"==typeof e?e.length<4096:e.byteLength<ch;let f=h;switch(e.name){case"argon2":case"scrypt":f=()=>!0;break;case"blake2b":case"blake2s":f=(e,t)=>t<=512&&h(e);break;case"blake3":f=(e,t)=>0===t&&h(e);break;case"xxhash64":case"xxhash3":case"xxhash128":case"crc64":f=()=>!1}return yield(()=>Wl(this,0,void 0,function*(){r||(yield s);const e=r.exports.Hash_GetBuffer(),t=r.exports.memory.buffer;n=new Uint8Array(t,e,ch)}))(),{getMemory:()=>n,writeMemory:(e,t=0)=>{n.set(e,t)},getExports:()=>r.exports,setMemorySize:e=>{r.exports.Hash_SetMemorySize(e);const t=r.exports.Hash_GetBuffer(),i=r.exports.memory.buffer;n=new Uint8Array(i,t,e)},init:a,update:c,digest:l,save:()=>{if(!i)throw new Error("save() can only be called after init() and before digest()");const t=r.exports.Hash_GetState(),n=o(),s=r.exports.memory.buffer,a=new Uint8Array(s,t,n),c=new Uint8Array(4+n);return function(e,t){const r=t.length>>1;for(let n=0;n<r;n++){const r=n<<1;e[n]=eh(t.charCodeAt(r),t.charCodeAt(r+1))}}(c,e.hash),c.set(a,4),c},load:t=>{if(!(t instanceof Uint8Array))throw new Error("load() expects an Uint8Array generated by save()");const n=r.exports.Hash_GetState(),s=o(),a=4+s,c=r.exports.memory.buffer;if(t.length!==a)throw new Error(`Bad state length (expected ${a} bytes, got ${t.length})`);if(!function(e,t){if(e.length!==2*t.length)return!1;for(let r=0;r<t.length;r++){const n=r<<1;if(t[r]!==eh(e.charCodeAt(n),e.charCodeAt(n+1)))return!1}return!0}(e.hash,t.subarray(0,4)))throw new Error("This state was written by an incompatible hash implementation");const u=t.subarray(4);new Uint8Array(c,n,s).set(u),i=!0},calculate:(e,i=null,o=null)=>{if(!f(e,i))return a(i),c(e),l("hex",o);const s=ih(e);return n.set(s),r.exports.Hash_Calculate(s.length,i,o),nh(u,n,t)},hashLength:t}})}new Jl,new Jl,new Jl,new Jl,new Jl,new Jl,new Jl;var fh={name:"md5",data:"AGFzbQEAAAABEgRgAAF/YAAAYAF/AGACf38BfwMIBwABAgMBAAIFBAEBAgIGDgJ/AUGgigULfwBBgAgLB3AIBm1lbW9yeQIADkhhc2hfR2V0QnVmZmVyAAAJSGFzaF9Jbml0AAELSGFzaF9VcGRhdGUAAgpIYXNoX0ZpbmFsAAQNSGFzaF9HZXRTdGF0ZQAFDkhhc2hfQ2FsY3VsYXRlAAYKU1RBVEVfU0laRQMBCoMaBwUAQYAJCy0AQQBC/rnrxemOlZkQNwKQiQFBAEKBxpS6lvHq5m83AoiJAUEAQgA3AoCJAQu+BQEHf0EAQQAoAoCJASIBIABqQf////8BcSICNgKAiQFBAEEAKAKEiQEgAiABSWogAEEddmo2AoSJAQJAAkACQAJAAkACQCABQT9xIgMNAEGACSEEDAELIABBwAAgA2siBUkNASAFQQNxIQZBACEBAkAgA0E/c0EDSQ0AIANBgIkBaiEEIAVB/ABxIQdBACEBA0AgBCABaiICQRhqIAFBgAlqLQAAOgAAIAJBGWogAUGBCWotAAA6AAAgAkEaaiABQYIJai0AADoAACACQRtqIAFBgwlqLQAAOgAAIAcgAUEEaiIBRw0ACwsCQCAGRQ0AIANBmIkBaiECA0AgAiABaiABQYAJai0AADoAACABQQFqIQEgBkF/aiIGDQALC0GYiQFBwAAQAxogACAFayEAIAVBgAlqIQQLIABBwABPDQEgACECDAILIABFDQIgAEEDcSEGQQAhAQJAIABBBEkNACADQYCJAWohBCAAQXxxIQBBACEBA0AgBCABaiICQRhqIAFBgAlqLQAAOgAAIAJBGWogAUGBCWotAAA6AAAgAkEaaiABQYIJai0AADoAACACQRtqIAFBgwlqLQAAOgAAIAAgAUEEaiIBRw0ACwsgBkUNAiADQZiJAWohAgNAIAIgAWogAUGACWotAAA6AAAgAUEBaiEBIAZBf2oiBg0ADAMLCyAAQT9xIQIgBCAAQUBxEAMhBAsgAkUNACACQQNxIQZBACEBAkAgAkEESQ0AIAJBPHEhAEEAIQEDQCABQZiJAWogBCABaiICLQAAOgAAIAFBmYkBaiACQQFqLQAAOgAAIAFBmokBaiACQQJqLQAAOgAAIAFBm4kBaiACQQNqLQAAOgAAIAAgAUEEaiIBRw0ACwsgBkUNAANAIAFBmIkBaiAEIAFqLQAAOgAAIAFBAWohASAGQX9qIgYNAAsLC4cQARl/QQAoApSJASECQQAoApCJASEDQQAoAoyJASEEQQAoAoiJASEFA0AgACgCCCIGIAAoAhgiByAAKAIoIgggACgCOCIJIAAoAjwiCiAAKAIMIgsgACgCHCIMIAAoAiwiDSAMIAsgCiANIAkgCCAHIAMgBmogAiAAKAIEIg5qIAUgBCACIANzcSACc2ogACgCACIPakH4yKq7fWpBB3cgBGoiECAEIANzcSADc2pB1u6exn5qQQx3IBBqIhEgECAEc3EgBHNqQdvhgaECakERdyARaiISaiAAKAIUIhMgEWogACgCECIUIBBqIAQgC2ogEiARIBBzcSAQc2pB7p33jXxqQRZ3IBJqIhAgEiARc3EgEXNqQa+f8Kt/akEHdyAQaiIRIBAgEnNxIBJzakGqjJ+8BGpBDHcgEWoiEiARIBBzcSAQc2pBk4zBwXpqQRF3IBJqIhVqIAAoAiQiFiASaiAAKAIgIhcgEWogDCAQaiAVIBIgEXNxIBFzakGBqppqakEWdyAVaiIQIBUgEnNxIBJzakHYsYLMBmpBB3cgEGoiESAQIBVzcSAVc2pBr++T2nhqQQx3IBFqIhIgESAQc3EgEHNqQbG3fWpBEXcgEmoiFWogACgCNCIYIBJqIAAoAjAiGSARaiANIBBqIBUgEiARc3EgEXNqQb6v88p4akEWdyAVaiIQIBUgEnNxIBJzakGiosDcBmpBB3cgEGoiESAQIBVzcSAVc2pBk+PhbGpBDHcgEWoiFSARIBBzcSAQc2pBjofls3pqQRF3IBVqIhJqIAcgFWogDiARaiAKIBBqIBIgFSARc3EgEXNqQaGQ0M0EakEWdyASaiIQIBJzIBVxIBJzakHiyviwf2pBBXcgEGoiESAQcyAScSAQc2pBwOaCgnxqQQl3IBFqIhIgEXMgEHEgEXNqQdG0+bICakEOdyASaiIVaiAIIBJqIBMgEWogDyAQaiAVIBJzIBFxIBJzakGqj9vNfmpBFHcgFWoiECAVcyAScSAVc2pB3aC8sX1qQQV3IBBqIhEgEHMgFXEgEHNqQdOokBJqQQl3IBFqIhIgEXMgEHEgEXNqQYHNh8V9akEOdyASaiIVaiAJIBJqIBYgEWogFCAQaiAVIBJzIBFxIBJzakHI98++fmpBFHcgFWoiECAVcyAScSAVc2pB5puHjwJqQQV3IBBqIhEgEHMgFXEgEHNqQdaP3Jl8akEJdyARaiISIBFzIBBxIBFzakGHm9Smf2pBDncgEmoiFWogBiASaiAYIBFqIBcgEGogFSAScyARcSASc2pB7anoqgRqQRR3IBVqIhAgFXMgEnEgFXNqQYXSj896akEFdyAQaiIRIBBzIBVxIBBzakH4x75nakEJdyARaiISIBFzIBBxIBFzakHZhby7BmpBDncgEmoiFWogFyASaiATIBFqIBkgEGogFSAScyARcSASc2pBipmp6XhqQRR3IBVqIhAgFXMiFSASc2pBwvJoakEEdyAQaiIRIBVzakGB7ce7eGpBC3cgEWoiEiARcyIaIBBzakGiwvXsBmpBEHcgEmoiFWogFCASaiAOIBFqIAkgEGogFSAac2pBjPCUb2pBF3cgFWoiECAVcyIVIBJzakHE1PulempBBHcgEGoiESAVc2pBqZ/73gRqQQt3IBFqIhIgEXMiCSAQc2pB4JbttX9qQRB3IBJqIhVqIA8gEmogGCARaiAIIBBqIBUgCXNqQfD4/vV7akEXdyAVaiIQIBVzIhUgEnNqQcb97cQCakEEdyAQaiIRIBVzakH6z4TVfmpBC3cgEWoiEiARcyIIIBBzakGF4bynfWpBEHcgEmoiFWogGSASaiAWIBFqIAcgEGogFSAIc2pBhbqgJGpBF3cgFWoiESAVcyIQIBJzakG5oNPOfWpBBHcgEWoiEiAQc2pB5bPutn5qQQt3IBJqIhUgEnMiByARc2pB+PmJ/QFqQRB3IBVqIhBqIAwgFWogDyASaiAGIBFqIBAgB3NqQeWssaV8akEXdyAQaiIRIBVBf3NyIBBzakHExKShf2pBBncgEWoiEiAQQX9zciARc2pBl/+rmQRqQQp3IBJqIhAgEUF/c3IgEnNqQafH0Nx6akEPdyAQaiIVaiALIBBqIBkgEmogEyARaiAVIBJBf3NyIBBzakG5wM5kakEVdyAVaiIRIBBBf3NyIBVzakHDs+2qBmpBBncgEWoiECAVQX9zciARc2pBkpmz+HhqQQp3IBBqIhIgEUF/c3IgEHNqQf3ov39qQQ93IBJqIhVqIAogEmogFyAQaiAOIBFqIBUgEEF/c3IgEnNqQdG7kax4akEVdyAVaiIQIBJBf3NyIBVzakHP/KH9BmpBBncgEGoiESAVQX9zciAQc2pB4M2zcWpBCncgEWoiEiAQQX9zciARc2pBlIaFmHpqQQ93IBJqIhVqIA0gEmogFCARaiAYIBBqIBUgEUF/c3IgEnNqQaGjoPAEakEVdyAVaiIQIBJBf3NyIBVzakGC/c26f2pBBncgEGoiESAVQX9zciAQc2pBteTr6XtqQQp3IBFqIhIgEEF/c3IgEXNqQbul39YCakEPdyASaiIVIARqIBYgEGogFSARQX9zciASc2pBkaeb3H5qQRV3aiEEIBUgA2ohAyASIAJqIQIgESAFaiEFIABBwABqIQAgAUFAaiIBDQALQQAgAjYClIkBQQAgAzYCkIkBQQAgBDYCjIkBQQAgBTYCiIkBIAALyAMBBX9BACgCgIkBQT9xIgBBmIkBakGAAToAACAAQQFqIQECQAJAAkACQCAAQT9zIgJBB0sNACACRQ0BIAFBmIkBakEAOgAAIAJBAUYNASAAQZqJAWpBADoAACACQQJGDQEgAEGbiQFqQQA6AAAgAkEDRg0BIABBnIkBakEAOgAAIAJBBEYNASAAQZ2JAWpBADoAACACQQVGDQEgAEGeiQFqQQA6AAAgAkEGRg0BIABBn4kBakEAOgAADAELIAJBCEYNAkE2IABrIgMhBAJAIAJBA3EiAEUNAEEAIABrIQRBACEAA0AgAEHPiQFqQQA6AAAgBCAAQX9qIgBHDQALIAMgAGohBAsgA0EDSQ0CDAELQZiJAUHAABADGkEAIQFBNyEECyABQYCJAWohAEF/IQIDQCAAIARqQRVqQQA2AAAgAEF8aiEAIAQgAkEEaiICRw0ACwtBAEEAKAKEiQE2AtSJAUEAQQAoAoCJASIAQRV2OgDTiQFBACAAQQ12OgDSiQFBACAAQQV2OgDRiQFBACAAQQN0IgA6ANCJAUEAIAA2AoCJAUGYiQFBwAAQAxpBAEEAKQKIiQE3A4AJQQBBACkCkIkBNwOICQsGAEGAiQELMwBBAEL+uevF6Y6VmRA3ApCJAUEAQoHGlLqW8ermbzcCiIkBQQBCADcCgIkBIAAQAhAECwsLAQBBgAgLBJgAAAA=",hash:"e6508e4b"};const dh=new Jl;let ph=null;function gh(e){if(null===ph)return function(e,t,r){return Wl(this,0,void 0,function*(){const n=yield e.lock(),i=yield hh(t,r);return n(),i})}(dh,fh,16).then(t=>(ph=t,ph.calculate(e)));try{const t=ph.calculate(e);return Promise.resolve(t)}catch(e){return Promise.reject(e)}}new Jl,new Jl,new Jl,new Jl,new Jl,new Jl,new Jl,new Jl,new Jl,new Jl,new Jl,new Jl,new Jl,new Jl;const mh="us-east-1",yh="https://s3.us-east-1.amazonaws.com";class wh{constructor(e){let t;const[r,n,i]=V(()=>new URL(e));if(!r)throw new xe("Invalid connection string: "+e,{original:n,input:e});t=i,this.region=mh,"s3:"===t.protocol?this.defineFromS3(t):this.defineFromCustomUri(t);for(const[e,r]of t.searchParams.entries())this[e]=r}defineFromS3(e){const[t,r,n]=G(()=>decodeURIComponent(e.hostname));if(!t)throw new xe("Invalid bucket in connection string",{original:r,input:e.hostname});this.bucket=n||"s3db";const[i,o,s]=G(()=>decodeURIComponent(e.username));if(!i)throw new xe("Invalid accessKeyId in connection string",{original:o,input:e.username});this.accessKeyId=s;const[a,c,u]=G(()=>decodeURIComponent(e.password));if(!a)throw new xe("Invalid secretAccessKey in connection string",{original:c,input:e.password});if(this.secretAccessKey=u,this.endpoint=yh,["/","",null].includes(e.pathname))this.keyPrefix="";else{let[,...t]=e.pathname.split("/");this.keyPrefix=[...t||[]].join("/")}}defineFromCustomUri(e){this.forcePathStyle=!0,this.endpoint=e.origin;const[t,r,n]=G(()=>decodeURIComponent(e.username));if(!t)throw new xe("Invalid accessKeyId in connection string",{original:r,input:e.username});this.accessKeyId=n;const[i,o,s]=G(()=>decodeURIComponent(e.password));if(!i)throw new xe("Invalid secretAccessKey in connection string",{original:o,input:e.password});if(this.secretAccessKey=s,["/","",null].includes(e.pathname))this.bucket="s3db",this.keyPrefix="";else{let[,t,...r]=e.pathname.split("/");if(t){const[e,r,n]=G(()=>decodeURIComponent(t));if(!e)throw new xe("Invalid bucket in connection string",{original:r,input:t});this.bucket=n}else this.bucket="s3db";this.keyPrefix=[...r||[]].join("/")}}}class bh extends qe{constructor({verbose:e=!1,id:t=null,AwsS3Client:r,connectionString:n,parallelism:i=10}){super(),this.verbose=e,this.id=t??je(),this.parallelism=i,this.config=new wh(n),this.client=r||this.createClient()}createClient(){let e={region:this.config.region,endpoint:this.config.endpoint};this.config.forcePathStyle&&(e.forcePathStyle=!0),this.config.accessKeyId&&(e.credentials={accessKeyId:this.config.accessKeyId,secretAccessKey:this.config.secretAccessKey});const t=new y(e);return t.middlewareStack.add((e,t)=>async r=>{if("DeleteObjectsCommand"===t.commandName){const e=r.request.body;if(e&&"string"==typeof e){const t=Buffer.from(await gh(e),"hex").toString("base64");r.request.headers["Content-MD5"]=t}}return e(r)},{step:"build",name:"addContentMd5ForDeleteObjects",priority:"high"}),t}async sendCommand(e){this.emit("command.request",e.constructor.name,e.input);const[t,r,n]=await V(()=>this.client.send(e));if(!t){throw Be(r,{bucket:this.config.bucket,key:e.input&&e.input.Key,commandName:e.constructor.name,commandInput:e.input})}return this.emit("command.response",e.constructor.name,n,e.input),n}async putObject({key:e,metadata:t,contentType:r,body:n,contentEncoding:i,contentLength:o}){const s="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"";s&&it.join(s,e);const a={};if(t)for(const[e,r]of Object.entries(t)){a[String(e).replace(/[^a-zA-Z0-9\-_]/g,"_")]=String(r)}const c={Bucket:this.config.bucket,Key:s?it.join(s,e):e,Metadata:a,Body:n||Buffer.alloc(0)};let u,l;void 0!==r&&(c.ContentType=r),void 0!==i&&(c.ContentEncoding=i),void 0!==o&&(c.ContentLength=o);try{return u=await this.sendCommand(new w(c)),u}catch(t){throw l=t,Be(t,{bucket:this.config.bucket,key:e,commandName:"PutObjectCommand",commandInput:c})}finally{this.emit("putObject",l||u,{key:e,metadata:t,contentType:r,body:n,contentEncoding:i,contentLength:o})}}async getObject(e){const t="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"",r={Bucket:this.config.bucket,Key:t?it.join(t,e):e};let n,i;try{return n=await this.sendCommand(new b(r)),n}catch(t){throw i=t,Be(t,{bucket:this.config.bucket,key:e,commandName:"GetObjectCommand",commandInput:r})}finally{this.emit("getObject",i||n,{key:e})}}async headObject(e){const t="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"",r={Bucket:this.config.bucket,Key:t?it.join(t,e):e};let n,i;try{return n=await this.sendCommand(new v(r)),n}catch(t){throw i=t,Be(t,{bucket:this.config.bucket,key:e,commandName:"HeadObjectCommand",commandInput:r})}finally{this.emit("headObject",i||n,{key:e})}}async copyObject({from:e,to:t}){const r={Bucket:this.config.bucket,Key:this.config.keyPrefix?it.join(this.config.keyPrefix,t):t,CopySource:it.join(this.config.bucket,this.config.keyPrefix?it.join(this.config.keyPrefix,e):e)};let n,i;try{return n=await this.sendCommand(new E(r)),n}catch(e){throw i=e,Be(e,{bucket:this.config.bucket,key:t,commandName:"CopyObjectCommand",commandInput:r})}finally{this.emit("copyObject",i||n,{from:e,to:t})}}async exists(e){const[t,r]=await V(()=>this.headObject(e));if(t)return!0;if("NoSuchKey"===r.name||"NotFound"===r.name)return!1;throw r}async deleteObject(e){const t="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"";t&&it.join(t,e);const r={Bucket:this.config.bucket,Key:t?it.join(t,e):e};let n,i;try{return n=await this.sendCommand(new I(r)),n}catch(t){throw i=t,Be(t,{bucket:this.config.bucket,key:e,commandName:"DeleteObjectCommand",commandInput:r})}finally{this.emit("deleteObject",i||n,{key:e})}}async deleteObjects(e){const t="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"",n=i(e,1e3),{results:o,errors:s}=await r.for(n).withConcurrency(this.parallelism).process(async e=>{for(const r of e)t&&it.join(t,r),this.config.bucket,await this.exists(r);const r={Bucket:this.config.bucket,Delete:{Objects:e.map(e=>({Key:t?it.join(t,e):e}))}};let n;const[i,o,s]=await V(()=>this.sendCommand(new _(r)));if(!i)throw o;return n=s,n&&n.Errors&&n.Errors.length,n&&n.Deleted&&(n.Deleted.length,e.length),n}),a={deleted:o,notFound:s};return this.emit("deleteObjects",a,e),a}async deleteAll({prefix:e}={}){const t="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"";let r,n=0;do{const i=new A({Bucket:this.config.bucket,Prefix:t?it.join(t,e||""):e||"",ContinuationToken:r}),o=await this.client.send(i);if(o.Contents&&o.Contents.length>0){const t=new _({Bucket:this.config.bucket,Delete:{Objects:o.Contents.map(e=>({Key:e.Key}))}}),r=await this.client.send(t),i=r.Deleted?r.Deleted.length:0;n+=i,this.emit("deleteAll",{prefix:e,batch:i,total:n})}r=o.IsTruncated?o.NextContinuationToken:void 0}while(r);return this.emit("deleteAllComplete",{prefix:e,totalDeleted:n}),n}async moveObject({from:e,to:t}){const[r,n]=await V(async()=>{await this.copyObject({from:e,to:t}),await this.deleteObject(e)});if(!r)throw new Ae("Unknown error in moveObject",{bucket:this.config.bucket,from:e,to:t,original:n});return!0}async listObjects({prefix:e,maxKeys:t=1e3,continuationToken:r}={}){const n={Bucket:this.config.bucket,MaxKeys:t,ContinuationToken:r,Prefix:this.config.keyPrefix?it.join(this.config.keyPrefix,e||""):e||""},[i,o,s]=await V(()=>this.sendCommand(new A(n)));if(!i)throw new Ae("Unknown error in listObjects",{prefix:e,bucket:this.config.bucket,original:o});return this.emit("listObjects",s,n),s}async count({prefix:e}={}){let t,r=0,n=!0;for(;n;){const i={prefix:e,continuationToken:t},o=await this.listObjects(i);r+=o.KeyCount||0,n=o.IsTruncated||!1,t=o.NextContinuationToken}return this.emit("count",r,{prefix:e}),r}async getAllKeys({prefix:e}={}){let t,r=[],n=!0;for(;n;){const i={prefix:e,continuationToken:t},o=await this.listObjects(i);o.Contents&&(r=r.concat(o.Contents.map(e=>e.Key))),n=o.IsTruncated||!1,t=o.NextContinuationToken}return this.config.keyPrefix&&(r=r.map(e=>e.replace(this.config.keyPrefix,"")).map(e=>e.startsWith("/")?e.replace("/",""):e)),this.emit("getAllKeys",r,{prefix:e}),r}async getContinuationTokenAfterOffset(e={}){const{prefix:t,offset:r=1e3}=e;if(0===r)return null;let n,i=!0,o=0;for(;i;){const e={prefix:t,maxKeys:r<1e3?r:r-o>1e3?1e3:r-o,continuationToken:n},s=await this.listObjects(e);if(s.Contents&&(o+=s.Contents.length),i=s.IsTruncated||!1,n=s.NextContinuationToken,o>=r)break}return this.emit("getContinuationTokenAfterOffset",n||null,e),n||null}async getKeysPage(e={}){const{prefix:t,offset:r=0,amount:n=100}=e;let i,o=[],s=!0;if(r>0&&(i=await this.getContinuationTokenAfterOffset({prefix:t,offset:r}),!i))return this.emit("getKeysPage",[],e),[];for(;s;){const e={prefix:t,continuationToken:i},r=await this.listObjects(e);if(r.Contents&&(o=o.concat(r.Contents.map(e=>e.Key))),s=r.IsTruncated||!1,i=r.NextContinuationToken,o.length>=n){o=o.slice(0,n);break}}return this.config.keyPrefix&&(o=o.map(e=>e.replace(this.config.keyPrefix,"")).map(e=>e.startsWith("/")?e.replace("/",""):e)),this.emit("getKeysPage",o,e),o}async moveAllObjects({prefixFrom:e,prefixTo:t}){const n=await this.getAllKeys({prefix:e}),{results:i,errors:o}=await r.for(n).withConcurrency(this.parallelism).process(async r=>{const n=r.replace(e,t),[i,o]=await V(async()=>{await this.moveObject({from:r,to:n})});if(!i)throw new Ae("Unknown error in moveAllObjects",{bucket:this.config.bucket,from:r,to:n,original:o});return n});if(this.emit("moveAllObjects",{results:i,errors:o},{prefixFrom:e,prefixTo:t}),o.length>0)throw new Error("Some objects could not be moved");return i}}async function vh(e,t,r){if(!this.passphrase)return t.push(new pe("Missing configuration for secrets encryption.",{actual:e,type:"encryptionKeyMissing",suggestion:"Provide a passphrase for secret encryption."})),e;const[n,i,o]=await V(()=>Te(String(e),this.passphrase));return n?o:(t.push(new pe("Problem encrypting secret.",{actual:e,type:"encryptionProblem",error:i,suggestion:"Check the passphrase and input value."})),e)}async function Eh(e,t,r){if(s(e))return e;const[n,i,o]=G(()=>JSON.stringify(e));if(!n)throw new pe("Failed to stringify JSON",{original:i,input:e});return o}class Ih extends x{constructor({options:e,passphrase:t,autoEncrypt:r=!0}={}){super(o({},{useNewCustomCheckerFunction:!0,messages:{encryptionKeyMissing:"Missing configuration for secrets encryption.",encryptionProblem:"Problem encrypting secret. Actual: {actual}. Error: {error}"},defaults:{string:{trim:!0},object:{strict:"remove"},number:{convert:!0}}},e)),this.passphrase=t,this.autoEncrypt=r,this.alias("secret",{type:"string",custom:this.autoEncrypt?vh:void 0,messages:{string:"The '{field}' field must be a string.",stringMin:"This secret '{field}' field length must be at least {expected} long."}}),this.alias("secretAny",{type:"any",custom:this.autoEncrypt?vh:void 0}),this.alias("secretNumber",{type:"number",custom:this.autoEncrypt?vh:void 0}),this.alias("json",{type:"any",custom:this.autoEncrypt?Eh:void 0})}}const _h=new Proxy(Ih,{instance:null,construct(e,t){return this.instance||(this.instance=new e(...t)),this.instance}});const Ah={trim:e=>null==e?e:e.trim(),encrypt:async(e,{passphrase:t})=>{if(null==e)return e;const[r,n,i]=await V(()=>Te(e,t));return r?i:e},decrypt:async(e,{passphrase:t})=>{if(null==e)return e;const[r,n,i]=await V(()=>Le(e,t));return r?"null"===i?null:"undefined"!==i?i:void 0:e},toString:e=>null==e?e:String(e),fromArray:(e,{separator:t})=>{if(null==e||!Array.isArray(e))return e;if(0===e.length)return"";return e.map(e=>"string"==typeof e?e.replace(/\\/g,"\\\\").replace(new RegExp(`\\${t}`,"g"),`\\${t}`):String(e)).join(t)},toArray:(e,{separator:t})=>{if(Array.isArray(e))return e;if(null==e)return e;if(""===e)return[];const r=[];let n="",i=0;const o=String(e);for(;i<o.length;)"\\"===o[i]&&i+1<o.length?(n+=o[i+1],i+=2):o[i]===t?(r.push(n),n="",i++):(n+=o[i],i++);return r.push(n),r},toJSON:e=>{if(null===e)return null;if(void 0===e)return;if("string"==typeof e){const[t,r,n]=G(()=>JSON.parse(e));return e}const[t,r,n]=G(()=>JSON.stringify(e));return t?n:e},fromJSON:e=>{if(null===e)return null;if(void 0===e)return;if("string"!=typeof e)return e;if(""===e)return"";const[t,r,n]=G(()=>JSON.parse(e));return t?n:e},toNumber:e=>s(e)?e.includes(".")?parseFloat(e):parseInt(e):e,toBool:e=>[!0,1,"true","1","yes","y"].includes(e),fromBool:e=>[!0,1,"true","1","yes","y"].includes(e)?"1":"0",fromBase62:e=>{if(null==e||""===e)return e;if("number"==typeof e)return e;if("string"==typeof e){const t=ce(e);return isNaN(t)?void 0:t}},toBase62:e=>{if(null==e||""===e)return e;if("number"==typeof e)return ae(e);if("string"==typeof e){const t=Number(e);return isNaN(t)?e:ae(t)}return e},fromBase62Decimal:e=>{if(null==e||""===e)return e;if("number"==typeof e)return e;if("string"==typeof e){const t=le(e);return isNaN(t)?void 0:t}},toBase62Decimal:e=>{if(null==e||""===e)return e;if("number"==typeof e)return ue(e);if("string"==typeof e){const t=Number(e);return isNaN(t)?e:ue(t)}return e},fromArrayOfNumbers:(e,{separator:t})=>{if(null==e||!Array.isArray(e))return e;if(0===e.length)return"";return e.map(e=>{if("number"==typeof e&&!isNaN(e))return ae(e);const t=Number(e);return isNaN(t)?"":ae(t)}).join(t)},toArrayOfNumbers:(e,{separator:t})=>{if(Array.isArray(e))return e.map(e=>"number"==typeof e?e:ce(e));if(null==e)return e;if(""===e)return[];const r=String(e),n=[];let i="",o=0;for(;o<r.length;)"\\"===r[o]&&o+1<r.length?(i+=r[o+1],o+=2):r[o]===t?(n.push(i),i="",o++):(i+=r[o],o++);return n.push(i),n.map(e=>{if("number"==typeof e)return e;if("string"==typeof e&&""!==e){const t=ce(e);return isNaN(t)?NaN:t}return NaN})},fromArrayOfDecimals:(e,{separator:t})=>{if(null==e||!Array.isArray(e))return e;if(0===e.length)return"";return e.map(e=>{if("number"==typeof e&&!isNaN(e))return ue(e);const t=Number(e);return isNaN(t)?"":ue(t)}).join(t)},toArrayOfDecimals:(e,{separator:t})=>{if(Array.isArray(e))return e.map(e=>"number"==typeof e?e:le(e));if(null==e)return e;if(""===e)return[];const r=String(e),n=[];let i="",o=0;for(;o<r.length;)"\\"===r[o]&&o+1<r.length?(i+=r[o+1],o+=2):r[o]===t?(n.push(i),i="",o++):(i+=r[o],o++);return n.push(i),n.map(e=>{if("number"==typeof e)return e;if("string"==typeof e&&""!==e){const t=le(e);return isNaN(t)?NaN:t}return NaN})}};class kh{constructor(e){const{map:t,name:r,attributes:n,passphrase:i,version:s=1,options:u={}}=e;this.name=r,this.version=s,this.attributes=n||{},this.passphrase=i??"secret",this.options=o({},this.defaultOptions(),u),this.allNestedObjectsOptional=this.options.allNestedObjectsOptional??!1;const l=this.preprocessAttributesForValidation(this.attributes);if(this.validator=new _h({autoEncrypt:!1}).compile(o({$$async:!0},l)),this.options.generateAutoHooks&&this.generateAutoHooks(),a(t)){const e=k(this.attributes,{safe:!0}),t=Object.keys(e).filter(e=>!e.includes("$$")),r=this.extractObjectKeys(this.attributes),n=[...new Set([...t,...r])],{mapping:i,reversedMapping:o}=function(e){const t={},r={};return e.forEach((e,n)=>{const i=ae(n);t[e]=i,r[i]=e}),{mapping:t,reversedMapping:r}}(n);this.map=i,this.reversedMap=o}else this.map=t,this.reversedMap=c(t)}defaultOptions(){return{autoEncrypt:!0,autoDecrypt:!0,arraySeparator:"|",generateAutoHooks:!0,hooks:{beforeMap:{},afterMap:{},beforeUnmap:{},afterUnmap:{}}}}addHook(e,t,r){this.options.hooks[e][t]||(this.options.hooks[e][t]=[]),this.options.hooks[e][t]=u([...this.options.hooks[e][t],r])}extractObjectKeys(e,t=""){const r=[];for(const[n,i]of Object.entries(e)){if(n.startsWith("$$"))continue;const e=t?`${t}.${n}`:n;"object"!=typeof i||null===i||Array.isArray(i)||(r.push(e),"object"===i.$$type&&r.push(...this.extractObjectKeys(i,e)))}return r}generateAutoHooks(){const e=k(l(this.attributes),{safe:!0});for(const[t,r]of Object.entries(e))if(r.includes("array")){if(r.includes("items:string"))this.addHook("beforeMap",t,"fromArray"),this.addHook("afterUnmap",t,"toArray");else if(r.includes("items:number")){r.includes("integer:true")||r.includes("|integer:")||r.includes("|integer")?(this.addHook("beforeMap",t,"fromArrayOfNumbers"),this.addHook("afterUnmap",t,"toArrayOfNumbers")):(this.addHook("beforeMap",t,"fromArrayOfDecimals"),this.addHook("afterUnmap",t,"toArrayOfDecimals"))}}else if(r.includes("secret"))this.options.autoEncrypt&&this.addHook("beforeMap",t,"encrypt"),this.options.autoDecrypt&&this.addHook("afterUnmap",t,"decrypt");else{if(r.includes("number")){r.includes("integer:true")||r.includes("|integer:")||r.includes("|integer")?(this.addHook("beforeMap",t,"toBase62"),this.addHook("afterUnmap",t,"fromBase62")):(this.addHook("beforeMap",t,"toBase62Decimal"),this.addHook("afterUnmap",t,"fromBase62Decimal"));continue}r.includes("boolean")?(this.addHook("beforeMap",t,"fromBool"),this.addHook("afterUnmap",t,"toBool")):(r.includes("json")||"object"===r||r.includes("object"))&&(this.addHook("beforeMap",t,"toJSON"),this.addHook("afterUnmap",t,"fromJSON"))}}static import(e){let{map:t,name:r,options:n,version:i,attributes:o}=s(e)?JSON.parse(e):e;const[a,c,u]=G(()=>kh._importAttributes(o));if(!a)throw new Oe("Failed to import schema attributes",{original:c,input:o});o=u;return new kh({map:t,name:r,options:n,version:i,attributes:o})}static _importAttributes(e){if("string"==typeof e){const[t,r,n]=G(()=>JSON.parse(e));if(t&&"object"==typeof n&&null!==n){const[t,r,i]=G(()=>kh._importAttributes(n));if(!t)throw new Oe("Failed to parse nested schema attribute",{original:r,input:e});return i}return e}if(Array.isArray(e)){const[t,r,n]=G(()=>e.map(e=>kh._importAttributes(e)));if(!t)throw new Oe("Failed to import array schema attributes",{original:r,input:e});return n}if("object"==typeof e&&null!==e){const t={};for(const[r,n]of Object.entries(e)){const[e,i,o]=G(()=>kh._importAttributes(n));if(!e)throw new Oe("Failed to import object schema attribute",{original:i,key:r,input:n});t[r]=o}return t}return e}export(){return{version:this.version,name:this.name,options:this.options,attributes:this._exportAttributes(this.attributes),map:this.map}}_exportAttributes(e){if("string"==typeof e)return e;if(Array.isArray(e))return e.map(e=>this._exportAttributes(e));if("object"==typeof e&&null!==e){const t={};for(const[r,n]of Object.entries(e))t[r]=this._exportAttributes(n);return t}return e}async applyHooksActions(e,t){const r=l(e);for(const[e,n]of Object.entries(this.options.hooks[t]))for(const t of n){const n=h(r,e);void 0!==n&&"function"==typeof Ah[t]&&f(r,e,await Ah[t](n,{passphrase:this.passphrase,separator:this.options.arraySeparator}))}return r}async validate(e,{mutateOriginal:t=!1}={}){let r=t?e:l(e);return await this.validator(r)}async mapper(e){let t=l(e);t=await this.applyHooksActions(t,"beforeMap");const r=k(t,{safe:!0}),n={_v:this.version+""};for(const[e,t]of Object.entries(r)){const r=this.map[e]||e,i=this.getAttributeDefinition(e);"number"==typeof t&&"string"==typeof i&&i.includes("number")?n[r]=ae(t):"string"==typeof t?"[object Object]"===t?n[r]="{}":(t.startsWith("{")||t.startsWith("["),n[r]=t):Array.isArray(t)||"object"==typeof t&&null!==t?n[r]=JSON.stringify(t):n[r]=t}return await this.applyHooksActions(n,"afterMap"),n}async unmapper(e,t){let r=l(e);delete r._v,r=await this.applyHooksActions(r,"beforeUnmap");const n=t?c(t):this.reversedMap,i={};for(const[e,t]of Object.entries(r)){const r=n&&n[e]?n[e]:e;let o=t;const s=this.getAttributeDefinition(r);if("string"!=typeof s||!s.includes("number")||s.includes("array")||s.includes("decimal")){if("string"==typeof t)if("[object Object]"===t)o={};else if(t.startsWith("{")||t.startsWith("[")){const[e,r,n]=G(()=>JSON.parse(t));e&&(o=n)}}else"string"==typeof o&&""!==o?o=ce(o):"number"==typeof o||(o=void 0);if(this.attributes&&"string"==typeof s&&s.includes("array"))if(Array.isArray(o));else if("string"==typeof o&&o.trim().startsWith("[")){const[e,t,r]=G(()=>JSON.parse(o));e&&Array.isArray(r)&&(o=r)}else o=Ah.toArray(o,{separator:this.options.arraySeparator});if(this.options.hooks&&this.options.hooks.afterUnmap&&this.options.hooks.afterUnmap[r])for(const e of this.options.hooks.afterUnmap[r])"function"==typeof Ah[e]&&(o=await Ah[e](o,{passphrase:this.passphrase,separator:this.options.arraySeparator}));i[r]=o}await this.applyHooksActions(i,"afterUnmap");const o=B(i);for(const[t,r]of Object.entries(e))t.startsWith("$")&&(o[t]=r);return o}getAttributeDefinition(e){const t=e.split(".");let r=this.attributes;for(const e of t){if(!r)return;r=r[e]}return r}preprocessAttributesForValidation(e){const t={};for(const[r,n]of Object.entries(e))if("object"!=typeof n||null===n||Array.isArray(n))t[r]=n;else{const e=n.$$type&&n.$$type.includes("required"),i=n.$$type&&n.$$type.includes("optional"),o={type:"object",properties:this.preprocessAttributesForValidation(n),strict:!1};e||(i||this.allNestedObjectsOptional)&&(o.optional=!0),t[r]=o}return t}}class Bh extends qe{constructor(e={}){super(),this._instanceId=Math.random().toString(36).slice(2,8);const t=function(e){const t=[];e.name?"string"!=typeof e.name?t.push("Resource 'name' must be a string"):""===e.name.trim()&&t.push("Resource 'name' cannot be empty"):t.push("Resource 'name' is required");e.client||t.push("S3 'client' is required");e.attributes?"object"!=typeof e.attributes||Array.isArray(e.attributes)?t.push("Resource 'attributes' must be an object"):0===Object.keys(e.attributes).length&&t.push("Resource 'attributes' cannot be empty"):t.push("Resource 'attributes' are required");void 0!==e.version&&"string"!=typeof e.version&&t.push("Resource 'version' must be a string");void 0!==e.behavior&&"string"!=typeof e.behavior&&t.push("Resource 'behavior' must be a string");void 0!==e.passphrase&&"string"!=typeof e.passphrase&&t.push("Resource 'passphrase' must be a string");void 0!==e.parallelism&&("number"==typeof e.parallelism&&Number.isInteger(e.parallelism)?e.parallelism<1&&t.push("Resource 'parallelism' must be greater than 0"):t.push("Resource 'parallelism' must be an integer"));void 0===e.observers||Array.isArray(e.observers)||t.push("Resource 'observers' must be an array");const r=["cache","autoDecrypt","timestamps","paranoid","allNestedObjectsOptional"];for(const n of r)void 0!==e[n]&&"boolean"!=typeof e[n]&&t.push(`Resource '${n}' must be a boolean`);void 0!==e.idGenerator&&("function"!=typeof e.idGenerator&&"number"!=typeof e.idGenerator?t.push("Resource 'idGenerator' must be a function or a number (size)"):"number"==typeof e.idGenerator&&e.idGenerator<=0&&t.push("Resource 'idGenerator' size must be greater than 0"));void 0!==e.idSize&&("number"==typeof e.idSize&&Number.isInteger(e.idSize)?e.idSize<=0&&t.push("Resource 'idSize' must be greater than 0"):t.push("Resource 'idSize' must be an integer"));if(void 0!==e.partitions)if("object"!=typeof e.partitions||Array.isArray(e.partitions))t.push("Resource 'partitions' must be an object");else for(const[r,n]of Object.entries(e.partitions))if("object"!=typeof n||Array.isArray(n))t.push(`Partition '${r}' must be an object`);else if(n.fields)if("object"!=typeof n.fields||Array.isArray(n.fields))t.push(`Partition '${r}.fields' must be an object`);else for(const[e,i]of Object.entries(n.fields))"string"!=typeof i&&t.push(`Partition '${r}.fields.${e}' must be a string`);else t.push(`Partition '${r}' must have a 'fields' property`);if(void 0!==e.hooks)if("object"!=typeof e.hooks||Array.isArray(e.hooks))t.push("Resource 'hooks' must be an object");else{const r=["beforeInsert","afterInsert","beforeUpdate","afterUpdate","beforeDelete","afterDelete"];for(const[n,i]of Object.entries(e.hooks))if(r.includes(n))if(Array.isArray(i))for(let e=0;e<i.length;e++){const t=i[e];if("function"==typeof t);else if("string"==typeof t)continue}else t.push(`Resource 'hooks.${n}' must be an array`);else t.push(`Invalid hook event '${n}'. Valid events: ${r.join(", ")}`)}return{isValid:0===t.length,errors:t}}(e);if(!t.isValid)throw new Ue(`Invalid Resource ${e.name} configuration`,{resourceName:e.name,validation:t.errors,operation:"constructor",suggestion:"Check resource config and attributes."});const{name:r,client:n,version:i="1",attributes:o={},behavior:s=ie,passphrase:a="secret",parallelism:c=10,observers:u=[],cache:l=!1,autoDecrypt:h=!0,timestamps:f=!1,partitions:d={},paranoid:p=!0,allNestedObjectsOptional:g=!0,hooks:m={},idGenerator:y,idSize:w=22,versioningEnabled:b=!1}=e;if(this.name=r,this.client=n,this.version=i,this.behavior=s,this.observers=u,this.parallelism=c,this.passphrase=a??"secret",this.versioningEnabled=b,this.idGenerator=this.configureIdGenerator(y,w),this.config={cache:l,hooks:m,paranoid:p,timestamps:f,partitions:d,autoDecrypt:h,allNestedObjectsOptional:g},this.hooks={beforeInsert:[],afterInsert:[],beforeUpdate:[],afterUpdate:[],beforeDelete:[],afterDelete:[]},this.attributes=o||{},this.map=e.map,this.applyConfiguration({map:this.map}),m)for(const[e,t]of Object.entries(m))if(Array.isArray(t)&&this.hooks[e])for(const r of t)"function"==typeof r&&this.hooks[e].push(r.bind(this));this._initMiddleware()}configureIdGenerator(r,n){return"function"==typeof r?r:"number"==typeof r&&r>0?e(t,r):"number"==typeof n&&n>0&&22!==n?e(t,n):je}get options(){return{timestamps:this.config.timestamps,partitions:this.config.partitions||{},cache:this.config.cache,autoDecrypt:this.config.autoDecrypt,paranoid:this.config.paranoid,allNestedObjectsOptional:this.config.allNestedObjectsOptional}}export(){const e=this.schema.export();return e.behavior=this.behavior,e.timestamps=this.config.timestamps,e.partitions=this.config.partitions||{},e.paranoid=this.config.paranoid,e.allNestedObjectsOptional=this.config.allNestedObjectsOptional,e.autoDecrypt=this.config.autoDecrypt,e.cache=this.config.cache,e.hooks=this.hooks,e.map=this.map,e}applyConfiguration({map:e}={}){this.config.timestamps&&(this.attributes.createdAt||(this.attributes.createdAt="string|optional"),this.attributes.updatedAt||(this.attributes.updatedAt="string|optional"),this.config.partitions||(this.config.partitions={}),this.config.partitions.byCreatedDate||(this.config.partitions.byCreatedDate={fields:{createdAt:"date|maxlength:10"}}),this.config.partitions.byUpdatedDate||(this.config.partitions.byUpdatedDate={fields:{updatedAt:"date|maxlength:10"}})),this.setupPartitionHooks(),this.versioningEnabled&&(this.config.partitions.byVersion||(this.config.partitions.byVersion={fields:{_v:"string"}})),this.schema=new kh({name:this.name,attributes:this.attributes,passphrase:this.passphrase,version:this.version,options:{autoDecrypt:this.config.autoDecrypt,allNestedObjectsOptional:this.config.allNestedObjectsOptional},map:e||this.map}),this.validatePartitions()}updateAttributes(e){const t=this.attributes;return this.attributes=e,this.applyConfiguration({map:this.schema?.map}),{oldAttributes:t,newAttributes:e}}addHook(e,t){this.hooks[e]&&this.hooks[e].push(t.bind(this))}async executeHooks(e,t){if(!this.hooks[e])return t;let r=t;for(const t of this.hooks[e])r=await t(r);return r}setupPartitionHooks(){if(!this.config.partitions)return;const e=this.config.partitions;0!==Object.keys(e).length&&(this.hooks.afterInsert||(this.hooks.afterInsert=[]),this.hooks.afterInsert.push(async e=>(await this.createPartitionReferences(e),e)),this.hooks.afterDelete||(this.hooks.afterDelete=[]),this.hooks.afterDelete.push(async e=>(await this.deletePartitionReferences(e),e)))}async validate(e){const t={original:l(e),isValid:!1,errors:[]},r=await this.schema.validate(e,{mutateOriginal:!1});return!0===r?t.isValid=!0:t.errors=r,t.data=e,t}validatePartitions(){if(!this.config.partitions)return;const e=this.config.partitions;if(0===Object.keys(e).length)return;const t=Object.keys(this.attributes||{});for(const[r,n]of Object.entries(e))if(n.fields)for(const e of Object.keys(n.fields))if(!this.fieldExistsInAttributes(e))throw new Ce(`Partition '${r}' uses field '${e}' which does not exist in resource attributes. Available fields: ${t.join(", ")}.`,{resourceName:this.name,partitionName:r,fieldName:e,availableFields:t,operation:"validatePartitions"})}fieldExistsInAttributes(e){if(e.startsWith("_"))return!0;if(!e.includes("."))return Object.keys(this.attributes||{}).includes(e);const t=e.split(".");let r=this.attributes||{};for(const e of t){if(!r||"object"!=typeof r||!(e in r))return!1;r=r[e]}return!0}applyPartitionRule(e,t){if(null==e)return e;let r=e;if("string"==typeof t&&t.includes("maxlength:")){const e=t.match(/maxlength:(\d+)/);if(e){const t=parseInt(e[1]);"string"==typeof r&&r.length>t&&(r=r.substring(0,t))}}if(t.includes("date"))if(r instanceof Date)r=r.toISOString().split("T")[0];else if("string"==typeof r)if(r.includes("T")&&r.includes("Z"))r=r.split("T")[0];else{const e=new Date(r);isNaN(e.getTime())||(r=e.toISOString().split("T")[0])}return r}getResourceKey(e){return nt("resource="+this.name,"data",`id=${e}`)}getPartitionKey({partitionName:e,id:t,data:r}){if(!this.config.partitions||!this.config.partitions[e])throw new Ce(`Partition '${e}' not found`,{resourceName:this.name,partitionName:e,operation:"getPartitionKey"});const n=this.config.partitions[e],i=[],o=Object.entries(n.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,t]of o){const n=this.getNestedFieldValue(r,e),o=this.applyPartitionRule(n,t);if(null==o)return null;i.push(`${e}=${o}`)}if(0===i.length)return null;const s=t||r?.id;return s?nt(`resource=${this.name}`,`partition=${e}`,...i,`id=${s}`):null}getNestedFieldValue(e,t){if(!t.includes("."))return e[t];const r=t.split(".");let n=e;for(const e of r){if(!n||"object"!=typeof n||!(e in n))return;n=n[e]}return n}calculateContentLength(e){return e?Buffer.isBuffer(e)?e.length:"string"==typeof e?Buffer.byteLength(e,"utf8"):"object"==typeof e?Buffer.byteLength(JSON.stringify(e),"utf8"):Buffer.byteLength(String(e),"utf8"):0}async insert({id:e,...t}){if(await this.exists(e))throw new Error(`Resource with id '${e}' already exists`);this.getResourceKey(e||"(auto)"),this.options.timestamps&&(t.createdAt=(new Date).toISOString(),t.updatedAt=(new Date).toISOString());const r={id:e,...this.applyDefaults(t)},n=await this.executeHooks("beforeInsert",r),i=Object.keys(n).filter(e=>!(e in r)||n[e]!==r[e]),o={};for(const e of i)o[e]=n[e];const{errors:s,isValid:a,data:c}=await this.validate(n);if(!a){const e=s&&s.length&&s[0].message?s[0].message:"Insert failed";throw new _e({bucket:this.client.config.bucket,resourceName:this.name,attributes:n,validation:s,message:e})}const{id:u,...l}=c;Object.assign(l,o);const h=u||e||this.idGenerator(),f=await this.schema.mapper(l);f._v=String(this.version);const d=re(this.behavior),{mappedData:p,body:g}=await d.handleInsert({resource:this,data:l,mappedData:f,originalData:r}),m=p,y=this.getResourceKey(h);let w;if(g&&""!==g){const[e,t]=await V(()=>Promise.resolve(JSON.parse(g)));e&&(w="application/json")}if("body-only"===this.behavior&&(!g||""===g))throw new Error(`[Resource.insert] Tentativa de gravar objeto sem body! Dados: id=${h}, resource=${this.name}`);const[b,v,E]=await V(()=>this.client.putObject({key:y,body:g,contentType:w,metadata:m}));if(!b){const e=v&&v.message?v.message:"";if(e.includes("metadata headers exceed")||e.includes("Insert failed")){const e=N(m),t=L({s3Limit:2047,systemConfig:{version:this.version,timestamps:this.config.timestamps,id:h}}),r=e-t;throw v.totalSize=e,v.limit=2047,v.effectiveLimit=t,v.excess=r,new Ue("metadata headers exceed",{resourceName:this.name,operation:"insert",id:h,totalSize:e,effectiveLimit:t,excess:r,suggestion:"Reduce metadata size or number of fields."})}throw Be(v,{bucket:this.client.config.bucket,key:y,resourceName:this.name,operation:"insert",id:h})}let I=await this.composeFullObjectFromWrite({id:h,metadata:m,body:g,behavior:this.behavior});const _=await this.executeHooks("afterInsert",I);return this.emit("insert",{...I,$before:{...r},$after:{..._}}),_}async get(e){if(d(e))throw new Error("id cannot be an object");if(a(e))throw new Error("id cannot be empty");const t=this.getResourceKey(e),[r,n,i]=await V(()=>this.client.getObject(t));if(!r)throw Be(n,{bucket:this.client.config.bucket,key:t,resourceName:this.name,operation:"get",id:e});if(0===i.ContentLength){const r=new Error(`No such key: ${t} [bucket:${this.client.config.bucket}]`);throw r.name="NoSuchKey",Be(r,{bucket:this.client.config.bucket,key:t,resourceName:this.name,operation:"get",id:e})}const o=i.Metadata?._v||this.version,s="string"==typeof o&&o.startsWith("v")?o.slice(1):o,c=await this.getSchemaForVersion(s);let u=await c.unmapper(i.Metadata);const l=re(this.behavior);let h="";if(i.ContentLength>0){const[e,r,n]=await V(()=>this.client.getObject(t));h=e?await ys(n.Body):""}const{metadata:f}=await l.handleGet({resource:this,metadata:u,body:h});let p=await this.composeFullObjectFromWrite({id:e,metadata:f,body:h,behavior:this.behavior});p._contentLength=i.ContentLength,p._lastModified=i.LastModified,p._hasContent=i.ContentLength>0,p._mimeType=i.ContentType||null,p._v=s,i.VersionId&&(p._versionId=i.VersionId),i.Expiration&&(p._expiresAt=i.Expiration),p._definitionHash=this.getDefinitionHash(),s!==this.version&&(p=await this.applyVersionMapping(p,s,this.version)),this.emit("get",p);return p}async exists(e){const t=this.getResourceKey(e),[r,n]=await V(()=>this.client.headObject(t));return r}async update(e,t){if(a(e))throw new Error("id cannot be empty");if(!await this.exists(e))throw new Error(`Resource with id '${e}' does not exist`);const r=await this.get(e),n=l(t);let i=l(r);for(const[e,t]of Object.entries(n))if(e.includes(".")){let r=i;const n=e.split(".");for(let e=0;e<n.length-1;e++)"object"==typeof r[n[e]]&&null!==r[n[e]]||(r[n[e]]={}),r=r[n[e]];r[n[n.length-1]]=l(t)}else"object"!=typeof t||null===t||Array.isArray(t)?i[e]=l(t):i[e]=o({},i[e],t);if(this.config.timestamps){const e=(new Date).toISOString();i.updatedAt=e,i.metadata||(i.metadata={}),i.metadata.updatedAt=e}const s=await this.executeHooks("beforeUpdate",l(i)),c={...r,...s,id:e},{isValid:u,errors:h,data:f}=await this.validate(l(c));if(!u)throw new _e({bucket:this.client.config.bucket,resourceName:this.name,attributes:s,validation:h,message:"validation: "+(h&&h.length?JSON.stringify(h):"unknown")});await this.schema.mapper(f);const d=re(this.behavior),p=await this.schema.mapper({...r,...s});p._v=String(this.version),await d.handleUpdate({resource:this,id:e,data:{...r,...s},mappedData:p,originalData:{...n,id:e}});const{id:g,...m}=f,y={...r,id:e},w={...m,id:e};await this.handlePartitionReferenceUpdates(y,w);const b=await this.schema.mapper(m);b._v=String(this.version);const v=re(this.behavior),{mappedData:E,body:I}=await v.handleUpdate({resource:this,id:e,data:m,mappedData:b,originalData:{...n,id:e}}),_=E,A=this.getResourceKey(e);let k,B=I;if(""===I&&"body-overflow"!==this.behavior){const[e,t,r]=await V(()=>this.client.getObject(A));if(e&&r.ContentLength>0){const e=Buffer.from(await r.Body.transformToByteArray()),t=e.toString(),[n,i]=await V(()=>Promise.resolve(JSON.parse(t)));n||(B=e,k=r.ContentType)}}let x=k;if(B&&""!==B&&!x){const[e,t]=await V(()=>Promise.resolve(JSON.parse(B)));e&&(x="application/json")}this.versioningEnabled&&r._v!==this.version&&await this.createHistoricalVersion(e,r);const[S,O]=await V(()=>this.client.putObject({key:A,body:B,contentType:x,metadata:_}));if(!S&&O&&O.message&&O.message.includes("metadata headers exceed")){const t=N(_),r=L({s3Limit:2047,systemConfig:{version:this.version,timestamps:this.config.timestamps,id:e}}),n=t-r;throw O.totalSize=t,O.limit=2047,O.effectiveLimit=r,O.excess=n,this.emit("exceedsLimit",{operation:"update",totalSize:t,limit:2047,effectiveLimit:r,excess:n,data:m}),new Ue("metadata headers exceed",{resourceName:this.name,operation:"update",id:e,totalSize:t,effectiveLimit:r,excess:n,suggestion:"Reduce metadata size or number of fields."})}if(!S)throw Be(O,{bucket:this.client.config.bucket,key:A,resourceName:this.name,operation:"update",id:e});const U=await this.composeFullObjectFromWrite({id:e,metadata:_,body:B,behavior:this.behavior}),C=await this.executeHooks("afterUpdate",U);return this.emit("update",{...U,$before:{...r},$after:{...C}}),C}async delete(e){if(a(e))throw new Error("id cannot be empty");let t,r=null;const[n,i,o]=await V(()=>this.get(e));n?t=o:(t={id:e},r=i),await this.executeHooks("beforeDelete",t);const s=this.getResourceKey(e),[c,u,l]=await V(()=>this.client.deleteObject(s));if(this.emit("delete",{...t,$before:{...t},$after:null}),r)throw Be(r,{bucket:this.client.config.bucket,key:s,resourceName:this.name,operation:"delete",id:e});if(!c)throw Be(u,{key:s,resourceName:this.name,operation:"delete",id:e});return await this.executeHooks("afterDelete",t),l}async upsert({id:e,...t}){return await this.exists(e)?this.update(e,t):this.insert({id:e,...t})}async count({partition:e=null,partitionValues:t={}}={}){let r;if(e&&Object.keys(t).length>0){const n=this.config.partitions[e];if(!n)throw new Ce(`Partition '${e}' not found`,{resourceName:this.name,partitionName:e,operation:"count"});const i=[],o=Object.entries(n.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,r]of o){const n=t[e];if(null!=n){const t=this.applyPartitionRule(n,r);i.push(`${e}=${t}`)}}r=i.length>0?`resource=${this.name}/partition=${e}/${i.join("/")}`:`resource=${this.name}/partition=${e}`}else r=`resource=${this.name}/data`;const n=await this.client.count({prefix:r});return this.emit("count",n),n}async insertMany(e){const{results:t}=await r.for(e).withConcurrency(this.parallelism).handleError(async(e,t)=>{this.emit("error",e,t),this.observers.map(r=>r.emit("error",this.name,e,t))}).process(async e=>await this.insert(e));return this.emit("insertMany",e.length),t}async deleteMany(e){const t=i(e.map(e=>this.getResourceKey(e)),1e3);e.map(e=>this.getResourceKey(e));const{results:n}=await r.for(t).withConcurrency(this.parallelism).handleError(async(e,t)=>{this.emit("error",e,t),this.observers.map(r=>r.emit("error",this.name,e,t))}).process(async e=>{const t=await this.client.deleteObjects(e);return e.forEach(e=>{const t=e.split("/").find(e=>e.startsWith("id=")),r=t?t.replace("id=",""):null;r&&(this.emit("deleted",r),this.observers.map(e=>e.emit("deleted",this.name,r)))}),t});return this.emit("deleteMany",e.length),n}async deleteAll(){if(!1!==this.config.paranoid)throw new Ue("deleteAll() is a dangerous operation and requires paranoid: false option.",{resourceName:this.name,operation:"deleteAll",paranoid:this.config.paranoid,suggestion:"Set paranoid: false to allow deleteAll."});const e=`resource=${this.name}/data`,t=await this.client.deleteAll({prefix:e});return this.emit("deleteAll",{version:this.version,prefix:e,deletedCount:t}),{deletedCount:t,version:this.version}}async deleteAllData(){if(!1!==this.config.paranoid)throw new Ue("deleteAllData() is a dangerous operation and requires paranoid: false option.",{resourceName:this.name,operation:"deleteAllData",paranoid:this.config.paranoid,suggestion:"Set paranoid: false to allow deleteAllData."});const e=`resource=${this.name}`,t=await this.client.deleteAll({prefix:e});return this.emit("deleteAllData",{resource:this.name,prefix:e,deletedCount:t}),{deletedCount:t,resource:this.name}}async listIds({partition:e=null,partitionValues:t={},limit:r,offset:n=0}={}){let i;if(e&&Object.keys(t).length>0){if(!this.config.partitions||!this.config.partitions[e])throw new Ce(`Partition '${e}' not found`,{resourceName:this.name,partitionName:e,operation:"listIds"});const r=this.config.partitions[e],n=[],o=Object.entries(r.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,r]of o){const i=t[e];if(null!=i){const t=this.applyPartitionRule(i,r);n.push(`${e}=${t}`)}}i=n.length>0?`resource=${this.name}/partition=${e}/${n.join("/")}`:`resource=${this.name}/partition=${e}`}else i=`resource=${this.name}/data`;const o=(await this.client.getKeysPage({prefix:i,offset:n,amount:r||1e3})).map(e=>{const t=e.split("/").find(e=>e.startsWith("id="));return t?t.replace("id=",""):null}).filter(Boolean);return this.emit("listIds",o.length),o}async list({partition:e=null,partitionValues:t={},limit:r,offset:n=0}={}){const[i,o,s]=await V(async()=>e?await this.listPartition({partition:e,partitionValues:t,limit:r,offset:n}):await this.listMain({limit:r,offset:n}));return i?s:this.handleListError(o,{partition:e,partitionValues:t})}async listMain({limit:e,offset:t=0}){const[r,n,i]=await V(()=>this.listIds({limit:e,offset:t}));if(!r)throw n;const o=await this.processListResults(i,"main");return this.emit("list",{count:o.length,errors:0}),o}async listPartition({partition:e,partitionValues:t,limit:r,offset:n=0}){if(!this.config.partitions?.[e])return this.emit("list",{partition:e,partitionValues:t,count:0,errors:0}),[];const i=this.config.partitions[e],o=this.buildPartitionPrefix(e,i,t),[s,a,c]=await V(()=>this.client.getAllKeys({prefix:o}));if(!s)throw a;const u=this.extractIdsFromKeys(c).slice(n),l=r?u.slice(0,r):u,h=await this.processPartitionResults(l,e,i,c);return this.emit("list",{partition:e,partitionValues:t,count:h.length,errors:0}),h}buildPartitionPrefix(e,t,r){const n=[],i=Object.entries(t.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,t]of i){const i=r[e];if(null!=i){const r=this.applyPartitionRule(i,t);n.push(`${e}=${r}`)}}return n.length>0?`resource=${this.name}/partition=${e}/${n.join("/")}`:`resource=${this.name}/partition=${e}`}extractIdsFromKeys(e){return e.map(e=>{const t=e.split("/").find(e=>e.startsWith("id="));return t?t.replace("id=",""):null}).filter(Boolean)}async processListResults(e,t="main"){const{results:n,errors:i}=await r.for(e).withConcurrency(this.parallelism).handleError(async(e,t)=>{this.emit("error",e,content),this.observers.map(t=>t.emit("error",this.name,e,content))}).process(async e=>{const[r,n,i]=await V(()=>this.get(e));return r?i:this.handleResourceError(n,e,t)});return this.emit("list",{count:n.length,errors:0}),n}async processPartitionResults(e,t,n,i){const o=Object.entries(n.fields).sort(([e],[t])=>e.localeCompare(t)),{results:s,errors:a}=await r.for(e).withConcurrency(this.parallelism).handleError(async(e,t)=>{this.emit("error",e,content),this.observers.map(t=>t.emit("error",this.name,e,content))}).process(async e=>{const[r,n,s]=await V(async()=>{const r=this.extractPartitionValuesFromKey(e,i,o);return await this.getFromPartition({id:e,partitionName:t,partitionValues:r})});return r?s:this.handleResourceError(n,e,"partition")});return s.filter(e=>null!==e)}extractPartitionValuesFromKey(e,t,r){const n=t.find(t=>t.includes(`id=${e}`));if(!n)throw new Ce(`Partition key not found for ID ${e}`,{resourceName:this.name,id:e,operation:"extractPartitionValuesFromKey"});const i=n.split("/"),o={};for(const[e]of r){const t=i.find(t=>t.startsWith(`${e}=`));if(t){const r=t.replace(`${e}=`,"");o[e]=r}}return o}handleResourceError(e,t,r){if(e.message.includes("Cipher job failed")||e.message.includes("OperationError"))return{id:t,_decryptionFailed:!0,_error:e.message,..."partition"===r&&{_partition:r}};throw e}handleListError(e,{partition:t,partitionValues:r}){return e.message.includes("Partition '")&&e.message.includes("' not found"),this.emit("list",{partition:t,partitionValues:r,count:0,errors:1}),[]}async getMany(e){const{results:t,errors:n}=await r.for(e).withConcurrency(this.client.parallelism).handleError(async(e,t)=>(this.emit("error",e,content),this.observers.map(t=>t.emit("error",this.name,e,content)),{id:t,_error:e.message,_decryptionFailed:e.message.includes("Cipher job failed")||e.message.includes("OperationError")})).process(async e=>{const[t,r,n]=await V(()=>this.get(e));if(t)return n;if(r.message.includes("Cipher job failed")||r.message.includes("OperationError"))return{id:e,_decryptionFailed:!0,_error:r.message};throw r});return this.emit("getMany",e.length),t}async getAll(){const[e,t,r]=await V(()=>this.listIds());if(!e)throw t;const n=[];for(const e of r){const[t,r,i]=await V(()=>this.get(e));t&&n.push(i)}return n}async page({offset:e=0,size:t=100,partition:r=null,partitionValues:n={},skipCount:i=!1}={}){const[o,s,a]=await V(async()=>{let o=null,s=null;if(!i){const[e,i,a]=await V(()=>this.count({partition:r,partitionValues:n}));e?(o=a,s=Math.ceil(o/t)):(o=null,s=null)}const a=Math.floor(e/t);let c=[];if(t<=0)c=[];else{const[i,o,s]=await V(()=>this.list({partition:r,partitionValues:n,limit:t,offset:e}));c=i?s:[]}const u={items:c,totalItems:o,page:a,pageSize:t,totalPages:s,hasMore:c.length===t&&e+t<(o||1/0),_debug:{requestedSize:t,requestedOffset:e,actualItemsReturned:c.length,skipCount:i,hasTotalItems:null!==o}};return this.emit("page",u),u});return o?a:{items:[],totalItems:null,page:Math.floor(e/t),pageSize:t,totalPages:null,_debug:{requestedSize:t,requestedOffset:e,actualItemsReturned:0,skipCount:i,hasTotalItems:!1,error:s.message}}}readable(){return new gs({resource:this}).build()}writable(){return new ms({resource:this}).build()}async setContent({id:e,buffer:t,contentType:r="application/octet-stream"}){const[n,i,o]=await V(()=>this.get(e));if(!n||!o)throw new Ue(`Resource with id '${e}' not found`,{resourceName:this.name,id:e,operation:"setContent"});const s={...o,_hasContent:!0,_contentLength:t.length,_mimeType:r},a=await this.schema.mapper(s),[c,u]=await V(()=>this.client.putObject({key:this.getResourceKey(e),metadata:a,body:t,contentType:r}));if(!c)throw u;return this.emit("setContent",{id:e,contentType:r,contentLength:t.length}),s}async content(e){const t=this.getResourceKey(e),[r,n,i]=await V(()=>this.client.getObject(t));if(!r){if("NoSuchKey"===n.name)return{buffer:null,contentType:null};throw n}const o=Buffer.from(await i.Body.transformToByteArray()),s=i.ContentType||null;return this.emit("content",e,o.length,s),{buffer:o,contentType:s}}async hasContent(e){const t=this.getResourceKey(e),[r,n,i]=await V(()=>this.client.headObject(t));return!!r&&i.ContentLength>0}async deleteContent(e){const t=this.getResourceKey(e),[r,n,i]=await V(()=>this.client.headObject(t));if(!r)throw n;const o=i.Metadata||{},[s,a,c]=await V(()=>this.client.putObject({key:t,body:"",metadata:o}));if(!s)throw a;return this.emit("deleteContent",e),c}getDefinitionHash(){const e={attributes:this.attributes,behavior:this.behavior},t=Kl(e);return`sha256:${m("sha256").update(t).digest("hex")}`}extractVersionFromKey(e){const t=e.split("/").find(e=>e.startsWith("v="));return t?t.replace("v=",""):null}async getSchemaForVersion(e){if(e===this.version)return this.schema;const[t,r,n]=await V(()=>Promise.resolve(new kh({name:this.name,attributes:this.attributes,passphrase:this.passphrase,version:e,options:{...this.config,autoDecrypt:!0,autoEncrypt:!0}})));return t?n:this.schema}async createPartitionReferences(e){const t=this.config.partitions;if(t&&0!==Object.keys(t).length)for(const[r,n]of Object.entries(t)){const t=this.getPartitionKey({partitionName:r,id:e.id,data:e});if(t){const e={_v:String(this.version)};await this.client.putObject({key:t,metadata:e,body:"",contentType:void 0})}}}async deletePartitionReferences(e){const t=this.config.partitions;if(!t||0===Object.keys(t).length)return;const r=[];for(const[n,i]of Object.entries(t)){const t=this.getPartitionKey({partitionName:n,id:e.id,data:e});t&&r.push(t)}if(r.length>0){const[e,t]=await V(()=>this.client.deleteObjects(r))}}async query(e={},{limit:t=100,offset:r=0,partition:n=null,partitionValues:i={}}={}){if(0===Object.keys(e).length)return await this.list({partition:n,partitionValues:i,limit:t,offset:r});const o=[];let s=r;const a=Math.min(t,50);for(;o.length<t;){const t=await this.list({partition:n,partitionValues:i,limit:a,offset:s});if(0===t.length)break;const r=t.filter(t=>Object.entries(e).every(([e,r])=>t[e]===r));if(o.push(...r),s+=a,t.length<a)break}return o.slice(0,t)}async handlePartitionReferenceUpdates(e,t){const r=this.config.partitions;if(!r||0===Object.keys(r).length)return;for(const[n,i]of Object.entries(r)){const[r,o]=await V(()=>this.handlePartitionReferenceUpdate(n,i,e,t))}const n=t.id||e.id;for(const[e,i]of Object.entries(r)){const r=`resource=${this.name}/partition=${e}`;let i=[];const[o,s,a]=await V(()=>this.client.getAllKeys({prefix:r}));if(!o)continue;i=a;const c=this.getPartitionKey({partitionName:e,id:n,data:t});for(const e of i)if(e.endsWith(`/id=${n}`)&&e!==c){const[t,r]=await V(()=>this.client.deleteObject(e))}}}async handlePartitionReferenceUpdate(e,t,r,n){const i=n.id||r.id,o=this.getPartitionKey({partitionName:e,id:i,data:r}),s=this.getPartitionKey({partitionName:e,id:i,data:n});if(o!==s){if(o){const[e,t]=await V(async()=>{await this.client.deleteObject(o)})}if(s){const[e,t]=await V(async()=>{const e={_v:String(this.version)};await this.client.putObject({key:s,metadata:e,body:"",contentType:void 0})})}}else if(s){const[e,t]=await V(async()=>{const e={_v:String(this.version)};await this.client.putObject({key:s,metadata:e,body:"",contentType:void 0})})}}async updatePartitionReferences(e){const t=this.config.partitions;if(t&&0!==Object.keys(t).length)for(const[r,n]of Object.entries(t)){if(!n||!n.fields||"object"!=typeof n.fields)continue;const t=this.getPartitionKey({partitionName:r,id:e.id,data:e});if(t){const e={_v:String(this.version)},[r,n]=await V(async()=>{await this.client.putObject({key:t,metadata:e,body:"",contentType:void 0})})}}}async getFromPartition({id:e,partitionName:t,partitionValues:r={}}){if(!this.config.partitions||!this.config.partitions[t])throw new Ce(`Partition '${t}' not found`,{resourceName:this.name,partitionName:t,operation:"getFromPartition"});const n=this.config.partitions[t],i=[],o=Object.entries(n.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,t]of o){const n=r[e];if(null!=n){const r=this.applyPartitionRule(n,t);i.push(`${e}=${r}`)}}if(0===i.length)throw new Ce(`No partition values provided for partition '${t}'`,{resourceName:this.name,partitionName:t,operation:"getFromPartition"});const s=nt(`resource=${this.name}`,`partition=${t}`,...i,`id=${e}`),[a,c]=await V(async()=>{await this.client.headObject(s)});if(!a)throw new Ue(`Resource with id '${e}' not found in partition '${t}'`,{resourceName:this.name,id:e,partitionName:t,operation:"getFromPartition"});const u=await this.get(e);return u._partition=t,u._partitionValues=r,this.emit("getFromPartition",u),u}async createHistoricalVersion(e,t){const r=nt(`resource=${this.name}`,"historical",`id=${e}`),n={...t,_v:t._v||this.version,_historicalTimestamp:(new Date).toISOString()},i=await this.schema.mapper(n),o=re(this.behavior),{mappedData:s,body:a}=await o.handleInsert({resource:this,data:n,mappedData:i}),c={...s,_v:t._v||this.version,_historicalTimestamp:n._historicalTimestamp};let u;if(a&&""!==a){const[e,t]=await V(()=>Promise.resolve(JSON.parse(a)));e&&(u="application/json")}await this.client.putObject({key:r,metadata:c,body:a,contentType:u})}async applyVersionMapping(e,t,r){if(t===r)return e;return{...e,_v:r,_originalVersion:t,_versionMapped:!0}}async composeFullObjectFromWrite({id:e,metadata:t,body:r,behavior:n}){const i={};t&&"true"===t.$truncated&&(i.$truncated="true"),t&&"true"===t.$overflow&&(i.$overflow="true");let o={};const[s,a,c]=await V(()=>this.schema.unmapper(t));o=s?c:t;const u=e=>{if(!e||"object"!=typeof e)return e;const t={};for(const[r,n]of Object.entries(e))r.startsWith("_")||(t[r]=n);return t},l=e=>{if("object"==typeof e&&null!==e)return e;if("string"==typeof e){if("[object Object]"===e)return{};if(e.startsWith("{")||e.startsWith("[")){const[t,r,n]=G(()=>JSON.parse(e));return t?n:e}return e}return e};if("body-overflow"===n){const n=t&&"true"===t.$overflow;let i={};if(n&&r){const[e,t,n]=await V(()=>Promise.resolve(JSON.parse(r)));if(e){const[e,t,r]=await V(()=>this.schema.unmapper(n));i=e?r:{}}}const s={...o,...i,id:e};Object.keys(s).forEach(e=>{s[e]=l(s[e])});const a=u(s);return n&&(a.$overflow="true"),a}if("body-only"===n){const[n,i,o]=await V(()=>Promise.resolve(r?JSON.parse(r):{}));let s=this.schema.map;if(t&&t._map){const[e,r,n]=await V(()=>Promise.resolve("string"==typeof t._map?JSON.parse(t._map):t._map));s=e?n:this.schema.map}const[a,c,u]=await V(()=>this.schema.unmapper(o,s)),h=a?{...u,id:e}:{id:e};return Object.keys(h).forEach(e=>{h[e]=l(h[e])}),h}const h={...o,id:e};Object.keys(h).forEach(e=>{h[e]=l(h[e])});const f=u(h);return i.$truncated&&(f.$truncated=i.$truncated),i.$overflow&&(f.$overflow=i.$overflow),f}emit(e,...t){return super.emit(e,...t)}async replace(e,t){await this.delete(e),await new Promise(e=>setTimeout(e,100));const r=Date.now();for(;Date.now()-r<5e3;){if(!await this.exists(e))break;await new Promise(e=>setTimeout(e,50))}try{return await this.insert({...t,id:e})}catch(r){if(r&&r.message&&r.message.includes("already exists")){return await this.update(e,t)}throw r}}_initMiddleware(){this._middlewares=new Map,this._middlewareMethods=["get","list","listIds","getAll","count","page","insert","update","delete","deleteMany","exists","getMany"];for(const e of this._middlewareMethods)this._middlewares.set(e,[]),this[`_original_${e}`]||(this[`_original_${e}`]=this[e].bind(this),this[e]=async(...t)=>{const r={resource:this,args:t,method:e};let n=-1;const i=this._middlewares.get(e),o=async t=>{if(t<=n)throw new Error("next() called multiple times");return n=t,t<i.length?await i[t](r,()=>o(t+1)):await this[`_original_${e}`](...r.args)};return await o(0)})}useMiddleware(e,t){if(this._middlewares||this._initMiddleware(),!this._middlewares.has(e))throw new Ue(`No such method for middleware: ${e}`,{operation:"useMiddleware",method:e});this._middlewares.get(e).push(t)}applyDefaults(e){const t={...e};for(const[e,r]of Object.entries(this.attributes))if(void 0===t[e]&&"string"==typeof r&&r.includes("default:")){const n=r.match(/default:([^|]+)/);if(n){let i=n[1];r.includes("boolean")?i="true"===i:r.includes("number")&&(i=Number(i)),t[e]=i}}return t}}class xh extends qe{constructor(e){super(),this.version="1",this.s3dbVersion=(()=>{const[e,t,r]=V(()=>"6.2.0");return e?r:"latest"})(),this.resources={},this.savedMetadata=null,this.options=e,this.verbose=e.verbose||!1,this.parallelism=parseInt(e.parallelism+"")||10,this.plugins=e.plugins||[],this.pluginList=e.plugins||[],this.cache=e.cache,this.passphrase=e.passphrase||"secret",this.versioningEnabled=e.versioningEnabled||!1;let t=e.connectionString;if(!t&&(e.bucket||e.accessKeyId||e.secretAccessKey)){const{bucket:r,region:n,accessKeyId:i,secretAccessKey:o,endpoint:s,forcePathStyle:a}=e;if(s){const e=new URL(s);i&&(e.username=encodeURIComponent(i)),o&&(e.password=encodeURIComponent(o)),e.pathname=`/${r||"s3db"}`,a&&e.searchParams.set("forcePathStyle","true"),t=e.toString()}else if(i&&o){const e=new URLSearchParams;e.set("region",n||"us-east-1"),a&&e.set("forcePathStyle","true"),t=`s3://${encodeURIComponent(i)}:${encodeURIComponent(o)}@${r||"s3db"}?${e.toString()}`}}this.client=e.client||new bh({verbose:this.verbose,parallelism:this.parallelism,connectionString:t}),this.bucket=this.client.bucket,this.keyPrefix=this.client.keyPrefix,this._exitListenerRegistered||(this._exitListenerRegistered=!0,process.on("exit",async()=>{if(this.isConnected())try{await this.disconnect()}catch(e){}}))}async connect(){await this.startPlugins();let e=null;if(await this.client.exists("s3db.json")){const t=await this.client.getObject("s3db.json");e=JSON.parse(await ys(t?.Body))}else e=this.blankMetadataStructure(),await this.uploadMetadataFile();this.savedMetadata=e;const t=this.detectDefinitionChanges(e);for(const[t,r]of Object.entries(e.resources||{})){const e=r.currentVersion||"v0",n=r.versions?.[e];n&&(this.resources[t]=new Bh({name:t,client:this.client,database:this,version:e,attributes:n.attributes,behavior:n.behavior||"user-managed",parallelism:this.parallelism,passphrase:this.passphrase,observers:[this],cache:this.cache,timestamps:void 0!==n.timestamps&&n.timestamps,partitions:r.partitions||n.partitions||{},paranoid:void 0===n.paranoid||n.paranoid,allNestedObjectsOptional:void 0===n.allNestedObjectsOptional||n.allNestedObjectsOptional,autoDecrypt:void 0===n.autoDecrypt||n.autoDecrypt,hooks:n.hooks||{},versioningEnabled:this.versioningEnabled,map:n.map}))}t.length>0&&this.emit("resourceDefinitionsChanged",{changes:t,metadata:this.savedMetadata}),this.emit("connected",new Date)}detectDefinitionChanges(e){const t=[];for(const[r,n]of Object.entries(this.resources)){const i=this.generateDefinitionHash(n.export()),o=e.resources?.[r];if(o){const e=o.currentVersion||"v0",n=o.versions?.[e],s=n?.hash;s!==i&&t.push({type:"changed",resourceName:r,currentHash:i,savedHash:s,fromVersion:e,toVersion:this.getNextVersion(o.versions)})}else t.push({type:"new",resourceName:r,currentHash:i,savedHash:null})}for(const[r,n]of Object.entries(e.resources||{}))if(!this.resources[r]){const e=n.currentVersion||"v0",i=n.versions?.[e];t.push({type:"deleted",resourceName:r,currentHash:null,savedHash:i?.hash,deletedVersion:e})}return t}generateDefinitionHash(e,t=void 0){const r={...e.attributes};e.timestamps&&(delete r.createdAt,delete r.updatedAt);const n={attributes:r,behavior:t||e.behavior||"user-managed",partitions:e.partitions||{}},i=Kl(n);return`sha256:${m("sha256").update(i).digest("hex")}`}getNextVersion(e={}){const t=Object.keys(e).filter(e=>e.startsWith("v")).map(e=>parseInt(e.substring(1))).filter(e=>!isNaN(e));return`v${(t.length>0?Math.max(...t):-1)+1}`}async startPlugins(){const e=this;if(!a(this.pluginList)){const t=this.pluginList.map(e=>p(e)?new e(this):e),r=t.map(async t=>{t.beforeSetup&&await t.beforeSetup(),await t.setup(e),t.afterSetup&&await t.afterSetup()});await Promise.all(r);const n=t.map(async e=>{e.beforeStart&&await e.beforeStart(),await e.start(),e.afterStart&&await e.afterStart()});await Promise.all(n)}}async usePlugin(e,t=null){const r=t||e.constructor.name.replace("Plugin","").toLowerCase();return this.plugins[r]=e,this.isConnected()&&(await e.setup(this),await e.start()),e}async uploadMetadataFile(){const e={version:this.version,s3dbVersion:this.s3dbVersion,lastUpdated:(new Date).toISOString(),resources:{}};Object.entries(this.resources).forEach(([t,r])=>{const n=r.export(),i=this.generateDefinitionHash(n),o=this.savedMetadata?.resources?.[t],s=o?.currentVersion||"v0",a=o?.versions?.[s];let c,u;a&&a.hash===i?(c=s,u=!1):(c=this.getNextVersion(o?.versions),u=!0),e.resources[t]={currentVersion:c,partitions:r.config.partitions||{},versions:{...o?.versions,[c]:{hash:i,attributes:n.attributes,behavior:n.behavior||"user-managed",timestamps:r.config.timestamps,partitions:r.config.partitions,paranoid:r.config.paranoid,allNestedObjectsOptional:r.config.allNestedObjectsOptional,autoDecrypt:r.config.autoDecrypt,cache:r.config.cache,hooks:r.config.hooks,createdAt:u?(new Date).toISOString():a?.createdAt}}},r.version!==c&&(r.version=c,r.emit("versionUpdated",{oldVersion:s,newVersion:c}))}),await this.client.putObject({key:"s3db.json",body:JSON.stringify(e,null,2),contentType:"application/json"}),this.savedMetadata=e,this.emit("metadataUploaded",e)}blankMetadataStructure(){return{version:"1",s3dbVersion:this.s3dbVersion,resources:{}}}resourceExists(e){return!!this.resources[e]}resourceExistsWithSameHash({name:e,attributes:t,behavior:r="user-managed",partitions:n={},options:i={}}){if(!this.resources[e])return{exists:!1,sameHash:!1,hash:null};const o=this.resources[e],s=this.generateDefinitionHash(o.export()),a=new Bh({name:e,attributes:t,behavior:r,partitions:n,client:this.client,version:o.version,passphrase:this.passphrase,versioningEnabled:this.versioningEnabled,...i}),c=this.generateDefinitionHash(a.export());return{exists:!0,sameHash:s===c,hash:c,existingHash:s}}async createResource({name:e,attributes:t,behavior:r="user-managed",hooks:n,...i}){if(this.resources[e]){const o=this.resources[e];if(Object.assign(o.config,{cache:this.cache,...i}),r&&(o.behavior=r),o.versioningEnabled=this.versioningEnabled,o.updateAttributes(t),n)for(const[e,t]of Object.entries(n))if(Array.isArray(t)&&o.hooks[e])for(const r of t)"function"==typeof r&&o.hooks[e].push(r.bind(o));const s=this.generateDefinitionHash(o.export(),o.behavior),a=this.savedMetadata?.resources?.[e],c=a?.currentVersion||"v0",u=a?.versions?.[c];return u&&u.hash===s||await this.uploadMetadataFile(),this.emit("s3db.resourceUpdated",e),o}const o=this.savedMetadata?.resources?.[e],s=o?.currentVersion||"v0",a=new Bh({name:e,client:this.client,version:void 0!==i.version?i.version:s,attributes:t,behavior:r,parallelism:this.parallelism,passphrase:void 0!==i.passphrase?i.passphrase:this.passphrase,observers:[this],cache:void 0!==i.cache?i.cache:this.cache,timestamps:void 0!==i.timestamps&&i.timestamps,partitions:i.partitions||{},paranoid:void 0===i.paranoid||i.paranoid,allNestedObjectsOptional:void 0===i.allNestedObjectsOptional||i.allNestedObjectsOptional,autoDecrypt:void 0===i.autoDecrypt||i.autoDecrypt,hooks:n||{},versioningEnabled:this.versioningEnabled,map:i.map,idGenerator:i.idGenerator,idSize:i.idSize});return a.database=this,this.resources[e]=a,await this.uploadMetadataFile(),this.emit("s3db.resourceCreated",e),a}resource(e){return this.resources[e]?this.resources[e]:Promise.reject(`resource ${e} does not exist`)}async listResources(){return Object.keys(this.resources).map(e=>({name:e}))}async getResource(e){if(!this.resources[e])throw new we({bucket:this.client.config.bucket,resourceName:e,id:e});return this.resources[e]}get config(){return{version:this.version,s3dbVersion:this.s3dbVersion,bucket:this.bucket,keyPrefix:this.keyPrefix,parallelism:this.parallelism,verbose:this.verbose}}isConnected(){return!!this.savedMetadata}async disconnect(){try{if(this.pluginList&&this.pluginList.length>0){for(const e of this.pluginList)e&&"function"==typeof e.removeAllListeners&&e.removeAllListeners();const e=this.pluginList.map(async e=>{try{e&&"function"==typeof e.stop&&await e.stop()}catch(e){}});await Promise.all(e)}if(this.resources&&Object.keys(this.resources).length>0){for(const[e,t]of Object.entries(this.resources))try{t&&"function"==typeof t.removeAllListeners&&t.removeAllListeners(),t._pluginWrappers&&t._pluginWrappers.clear(),t._pluginMiddlewares&&(t._pluginMiddlewares={}),t.observers&&Array.isArray(t.observers)&&(t.observers=[])}catch(e){}Object.keys(this.resources).forEach(e=>delete this.resources[e])}this.client&&"function"==typeof this.client.removeAllListeners&&this.client.removeAllListeners(),this.removeAllListeners(),this.savedMetadata=null,this.plugins={},this.pluginList=[],this.emit("disconnected",new Date)}catch(e){}}}class Sh extends xh{}function Oh(e){return"string"==typeof e?e.trim().toLowerCase():e}const Uh={s3db:class extends mc{constructor(e={},t=[],r=null){super(e),this.instanceId=Math.random().toString(36).slice(2,10),this.client=r,this.connectionString=e.connectionString;let n=t;if(t)if(Array.isArray(t)){n={};for(const e of t)"string"==typeof e&&(n[Oh(e)]=e)}else"string"==typeof t&&(n[Oh(t)]=t);else n={};this.resourcesMap=this._normalizeResources(n)}_normalizeResources(e){if(!e)return{};if(Array.isArray(e)){const t={};for(const r of e)"string"==typeof r?t[Oh(r)]=r:Array.isArray(r)&&"string"==typeof r[0]?t[Oh(r[0])]=r:"object"==typeof r&&r.resource&&(t[Oh(r.resource)]={...r});return t}if("object"==typeof e){const t={};for(const[r,n]of Object.entries(e)){const e=Oh(r);"string"==typeof n?t[e]=n:Array.isArray(n)?t[e]=n.map(e=>"string"==typeof e||"function"==typeof e?e:"object"==typeof e&&e.resource?{...e}:e):"function"==typeof n?t[e]=n:"object"==typeof n&&n.resource&&(t[e]={...n})}return t}if("function"==typeof e)return e;if("string"==typeof e){return{[Oh(e)]:e}}return{}}validateConfig(){const e=[];return this.client||this.connectionString||e.push("You must provide a client or a connectionString"),(!this.resourcesMap||"object"==typeof this.resourcesMap&&0===Object.keys(this.resourcesMap).length)&&e.push("You must provide a resources map or array"),{isValid:0===e.length,errors:e}}async initialize(e){try{if(await super.initialize(e),this.client)this.targetDatabase=this.client;else{if(!this.connectionString)throw new Error("S3dbReplicator: No client or connectionString provided");{const e={connectionString:this.connectionString,region:this.region,keyPrefix:this.keyPrefix,verbose:this.config.verbose||!1};this.targetDatabase=new Sh(e),await this.targetDatabase.connect()}}this.emit("connected",{replicator:this.name,target:this.connectionString||"client-provided"})}catch(e){throw e}}async replicate({resource:e,operation:t,data:r,id:n}){const i=Oh(e),o=this._resolveDestResource(i,r),s=this._getDestResourceObj(o),a=this._applyTransformer(i,r);let c;if("insert"===t)c=await s.insert(a);else if("update"===t)c=await s.update(n,a);else{if("delete"!==t)throw new Error(`Invalid operation: ${t}. Supported operations are: insert, update, delete`);c=await s.delete(n)}return c}_applyTransformer(e,t){const r=Oh(e),n=this.resourcesMap[r];let i;return n?(Array.isArray(n)&&"function"==typeof n[1]?i=n[1](t):"function"==typeof n?i=n(t):"object"==typeof n?"function"==typeof n.transform?i=n.transform(t):"function"==typeof n.transformer&&(i=n.transformer(t)):i=t,i&&t&&t.id&&!i.id&&(i.id=t.id),!i&&t&&(i=t),i):t}_resolveDestResource(e,t){const r=Oh(e),n=this.resourcesMap[r];if(!n)return e;if(Array.isArray(n)){if("string"==typeof n[0])return n[0];if("object"==typeof n[0]&&n[0].resource)return n[0].resource;if("function"==typeof n[0])return e}return"string"==typeof n?n:"function"==typeof n?e:"object"==typeof n&&n.resource?n.resource:e}_getDestResourceObj(e){if(!this.client||!this.client.resources)return null;const t=Object.keys(this.client.resources),r=Oh(e),n=t.find(e=>Oh(e)===r);if(!n)throw new Error(`[S3dbReplicator] Destination resource not found: ${e}. Available: ${t.join(", ")}`);return this.client.resources[n]}async replicateBatch(e,t){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};const r=[],n=[];for(const i of t){const[t,o,s]=await V(()=>this.replicate({resource:e,operation:i.operation,id:i.id,data:i.data,beforeData:i.beforeData}));t?r.push(s):n.push({id:i.id,error:o.message})}return this.emit("batch_replicated",{replicator:this.name,resourceName:e,total:t.length,successful:r.length,errors:n.length}),{success:0===n.length,results:r,errors:n,total:t.length}}async testConnection(){const[e,t]=await V(async()=>(this.targetDatabase||await this.initialize(this.database),await this.targetDatabase.listResources(),!0));return!!e||(this.emit("connection_error",{replicator:this.name,error:t.message}),!1)}async getStatus(){return{...await super.getStatus(),connected:!!this.targetDatabase,targetDatabase:this.connectionString||"client-provided",resources:Object.keys(this.resourcesMap||{}),totalreplicators:this.listenerCount("replicated"),totalErrors:this.listenerCount("replicator_error")}}async cleanup(){this.targetDatabase&&this.targetDatabase.removeAllListeners(),await super.cleanup()}shouldReplicateResource(e,t){const r=Oh(e),n=this.resourcesMap[r];if(!n)return!1;if(!t)return!0;if(Array.isArray(n)){for(const e of n)if("object"==typeof e&&e.resource){if(!e.actions||!Array.isArray(e.actions))return!0;if(e.actions.includes(t))return!0}else if("string"==typeof e||"function"==typeof e)return!0;return!1}return"object"==typeof n&&n.resource?!n.actions||!Array.isArray(n.actions)||n.actions.includes(t):"string"==typeof n||"function"==typeof n}},sqs:class extends mc{constructor(e={},t=[],r=null){if(super(e),this.resources=t,this.client=r,this.queueUrl=e.queueUrl,this.queues=e.queues||{},this.defaultQueue=e.defaultQueue||e.defaultQueueUrl||e.queueUrlDefault,this.region=e.region||"us-east-1",this.sqsClient=r||null,this.messageGroupId=e.messageGroupId,this.deduplicationId=e.deduplicationId,t&&"object"==typeof t)for(const[e,r]of Object.entries(t))r.queueUrl&&(this.queues[e]=r.queueUrl)}validateConfig(){const e=[];return this.queueUrl||0!==Object.keys(this.queues).length||this.defaultQueue||this.resourceQueueMap||e.push("Either queueUrl, queues object, defaultQueue, or resourceQueueMap must be provided"),{isValid:0===e.length,errors:e}}getQueueUrlsForResource(e){if(this.resourceQueueMap&&this.resourceQueueMap[e])return this.resourceQueueMap[e];if(this.queues[e])return[this.queues[e]];if(this.queueUrl)return[this.queueUrl];if(this.defaultQueue)return[this.defaultQueue];throw new Error(`No queue URL found for resource '${e}'`)}_applyTransformer(e,t){const r=this.resources[e];let n=t;return r?("function"==typeof r.transform?n=r.transform(t):"function"==typeof r.transformer&&(n=r.transformer(t)),n||t):t}createMessage(e,t,r,n,i=null){const o={resource:e,action:t,timestamp:(new Date).toISOString(),source:"s3db-replicator"};switch(t){case"insert":case"delete":default:return{...o,data:r};case"update":return{...o,before:i,data:r}}}async initialize(e,t){if(await super.initialize(e),!this.sqsClient){const[e,r,n]=await V(()=>import("@aws-sdk/client-sqs"));if(!e)throw this.emit("initialization_error",{replicator:this.name,error:r.message}),r;const{SQSClient:i}=n;this.sqsClient=t||new i({region:this.region,credentials:this.config.credentials}),this.emit("initialized",{replicator:this.name,queueUrl:this.queueUrl,queues:this.queues,defaultQueue:this.defaultQueue})}}async replicate(e,t,r,n,i=null){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};const[o,s,a]=await V(async()=>{const{SendMessageCommand:o}=await import("@aws-sdk/client-sqs"),s=this.getQueueUrlsForResource(e),a=this._applyTransformer(e,r),c=this.createMessage(e,t,a,n,i),u=[];for(const r of s){const i=new o({QueueUrl:r,MessageBody:JSON.stringify(c),MessageGroupId:this.messageGroupId,MessageDeduplicationId:this.deduplicationId?`${e}:${t}:${n}`:void 0}),s=await this.sqsClient.send(i);u.push({queueUrl:r,messageId:s.MessageId}),this.emit("replicated",{replicator:this.name,resource:e,operation:t,id:n,queueUrl:r,messageId:s.MessageId,success:!0})}return{success:!0,results:u}});return o?a:(this.emit("replicator_error",{replicator:this.name,resource:e,operation:t,id:n,error:s.message}),{success:!1,error:s.message})}async replicateBatch(e,t){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};const[r,n,i]=await V(async()=>{const{SendMessageBatchCommand:r}=await import("@aws-sdk/client-sqs"),n=this.getQueueUrlsForResource(e),i=[];for(let e=0;e<t.length;e+=10)i.push(t.slice(e,e+10));const o=[],s=[];for(const t of i){const[i,a]=await V(async()=>{const i=t.map((t,r)=>({Id:`${t.id}-${r}`,MessageBody:JSON.stringify(this.createMessage(e,t.operation,t.data,t.id,t.beforeData)),MessageGroupId:this.messageGroupId,MessageDeduplicationId:this.deduplicationId?`${e}:${t.operation}:${t.id}`:void 0})),s=new r({QueueUrl:n[0],Entries:i}),a=await this.sqsClient.send(s);o.push(a)});if(!i&&(s.push({batch:t.length,error:a.message}),a.message&&(a.message.includes("Batch error")||a.message.includes("Connection")||a.message.includes("Network"))))throw a}return this.emit("batch_replicated",{replicator:this.name,resource:e,queueUrl:n[0],total:t.length,successful:o.length,errors:s.length}),{success:0===s.length,results:o,errors:s,total:t.length,queueUrl:n[0]}});if(r)return i;const o=n?.message||n||"Unknown error";return this.emit("batch_replicator_error",{replicator:this.name,resource:e,error:o}),{success:!1,error:o}}async testConnection(){const[e,t]=await V(async()=>{this.sqsClient||await this.initialize(this.database);const{GetQueueAttributesCommand:e}=await import("@aws-sdk/client-sqs"),t=new e({QueueUrl:this.queueUrl,AttributeNames:["QueueArn"]});return await this.sqsClient.send(t),!0});return!!e||(this.emit("connection_error",{replicator:this.name,error:t.message}),!1)}async getStatus(){return{...await super.getStatus(),connected:!!this.sqsClient,queueUrl:this.queueUrl,region:this.region,resources:this.resources,totalreplicators:this.listenerCount("replicated"),totalErrors:this.listenerCount("replicator_error")}}async cleanup(){this.sqsClient&&this.sqsClient.destroy(),await super.cleanup()}shouldReplicateResource(e){return this.resourceQueueMap&&Object.keys(this.resourceQueueMap).includes(e)||this.queues&&Object.keys(this.queues).includes(e)||!(!this.defaultQueue&&!this.queueUrl)||this.resources&&Object.keys(this.resources).includes(e)||!1}},bigquery:class extends mc{constructor(e={},t={}){super(e),this.projectId=e.projectId,this.datasetId=e.datasetId,this.bigqueryClient=null,this.credentials=e.credentials,this.location=e.location||"US",this.logTable=e.logTable,this.resources=this.parseResourcesConfig(t)}parseResourcesConfig(e){const t={};for(const[r,n]of Object.entries(e))"string"==typeof n?t[r]=[{table:n,actions:["insert"]}]:Array.isArray(n)?t[r]=n.map(e=>"string"==typeof e?{table:e,actions:["insert"]}:{table:e.table,actions:e.actions||["insert"]}):"object"==typeof n&&(t[r]=[{table:n.table,actions:n.actions||["insert"]}]);return t}validateConfig(){const e=[];this.projectId||e.push("projectId is required"),this.datasetId||e.push("datasetId is required"),0===Object.keys(this.resources).length&&e.push("At least one resource must be configured");for(const[t,r]of Object.entries(this.resources))for(const n of r){n.table||e.push(`Table name is required for resource '${t}'`),Array.isArray(n.actions)&&0!==n.actions.length||e.push(`Actions array is required for resource '${t}'`);const r=["insert","update","delete"],i=n.actions.filter(e=>!r.includes(e));i.length>0&&e.push(`Invalid actions for resource '${t}': ${i.join(", ")}. Valid actions: ${r.join(", ")}`)}return{isValid:0===e.length,errors:e}}async initialize(e){await super.initialize(e);const[t,r,n]=await V(()=>import("@google-cloud/bigquery"));if(!t)throw this.emit("initialization_error",{replicator:this.name,error:r.message}),r;const{BigQuery:i}=n;this.bigqueryClient=new i({projectId:this.projectId,credentials:this.credentials,location:this.location}),this.emit("initialized",{replicator:this.name,projectId:this.projectId,datasetId:this.datasetId,resources:Object.keys(this.resources)})}shouldReplicateResource(e){return this.resources.hasOwnProperty(e)}shouldReplicateAction(e,t){return!!this.resources[e]&&this.resources[e].some(e=>e.actions.includes(t))}getTablesForResource(e,t){return this.resources[e]?this.resources[e].filter(e=>e.actions.includes(t)).map(e=>e.table):[]}async replicate(e,t,r,n,i=null){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};if(!this.shouldReplicateAction(e,t))return{skipped:!0,reason:"action_not_included"};const o=this.getTablesForResource(e,t);if(0===o.length)return{skipped:!0,reason:"no_tables_for_action"};const s=[],a=[],[c,u,l]=await V(async()=>{const i=this.bigqueryClient.dataset(this.datasetId);for(const e of o){const[o,c]=await V(async()=>{const o=i.table(e);let a;if("insert"===t){const e={...r};a=await o.insert([e])}else if("update"===t){const t=Object.keys(r).filter(e=>"id"!==e),i=t.map(e=>`${e}=@${e}`).join(", "),o={id:n};t.forEach(e=>{o[e]=r[e]});const s=`UPDATE \`${this.projectId}.${this.datasetId}.${e}\` SET ${i} WHERE id=@id`,[c]=await this.bigqueryClient.createQueryJob({query:s,params:o});await c.getQueryResults(),a=[c]}else{if("delete"!==t)throw new Error(`Unsupported operation: ${t}`);{const t=`DELETE FROM \`${this.projectId}.${this.datasetId}.${e}\` WHERE id=@id`,[r]=await this.bigqueryClient.createQueryJob({query:t,params:{id:n}});await r.getQueryResults(),a=[r]}}s.push({table:e,success:!0,jobId:a[0]?.id})});o||a.push({table:e,error:c.message})}if(this.logTable){const[o,s]=await V(async()=>{const o=i.table(this.logTable);await o.insert([{resource_name:e,operation:t,record_id:n,data:JSON.stringify(r),timestamp:(new Date).toISOString(),source:"s3db-replicator"}])})}const c=0===a.length;return this.emit("replicated",{replicator:this.name,resourceName:e,operation:t,id:n,tables:o,results:s,errors:a,success:c}),{success:c,results:s,errors:a,tables:o}});return c?l:(this.emit("replicator_error",{replicator:this.name,resourceName:e,operation:t,id:n,error:u.message}),{success:!1,error:u.message})}async replicateBatch(e,t){const r=[],n=[];for(const i of t){const[t,o,s]=await V(()=>this.replicate(e,i.operation,i.data,i.id,i.beforeData));t?r.push(s):n.push({id:i.id,error:o.message})}return{success:0===n.length,results:r,errors:n}}async testConnection(){const[e,t]=await V(async()=>{this.bigqueryClient||await this.initialize();const e=this.bigqueryClient.dataset(this.datasetId);return await e.getMetadata(),!0});return!!e||(this.emit("connection_error",{replicator:this.name,error:t.message}),!1)}async cleanup(){}getStatus(){return{...super.getStatus(),projectId:this.projectId,datasetId:this.datasetId,resources:this.resources,logTable:this.logTable}}},postgres:class extends mc{constructor(e={},t={}){super(e),this.connectionString=e.connectionString,this.host=e.host,this.port=e.port||5432,this.database=e.database,this.user=e.user,this.password=e.password,this.client=null,this.ssl=e.ssl,this.logTable=e.logTable,this.resources=this.parseResourcesConfig(t)}parseResourcesConfig(e){const t={};for(const[r,n]of Object.entries(e))"string"==typeof n?t[r]=[{table:n,actions:["insert"]}]:Array.isArray(n)?t[r]=n.map(e=>"string"==typeof e?{table:e,actions:["insert"]}:{table:e.table,actions:e.actions||["insert"]}):"object"==typeof n&&(t[r]=[{table:n.table,actions:n.actions||["insert"]}]);return t}validateConfig(){const e=[];this.connectionString||this.host&&this.database||e.push("Either connectionString or host+database must be provided"),0===Object.keys(this.resources).length&&e.push("At least one resource must be configured");for(const[t,r]of Object.entries(this.resources))for(const n of r){n.table||e.push(`Table name is required for resource '${t}'`),Array.isArray(n.actions)&&0!==n.actions.length||e.push(`Actions array is required for resource '${t}'`);const r=["insert","update","delete"],i=n.actions.filter(e=>!r.includes(e));i.length>0&&e.push(`Invalid actions for resource '${t}': ${i.join(", ")}. Valid actions: ${r.join(", ")}`)}return{isValid:0===e.length,errors:e}}async initialize(e){await super.initialize(e);const[t,r,n]=await V(()=>import("pg"));if(!t)throw this.emit("initialization_error",{replicator:this.name,error:r.message}),r;const{Client:i}=n,o=this.connectionString?{connectionString:this.connectionString,ssl:this.ssl}:{host:this.host,port:this.port,database:this.database,user:this.user,password:this.password,ssl:this.ssl};this.client=new i(o),await this.client.connect(),this.logTable&&await this.createLogTableIfNotExists(),this.emit("initialized",{replicator:this.name,database:this.database||"postgres",resources:Object.keys(this.resources)})}async createLogTableIfNotExists(){const e=`\n      CREATE TABLE IF NOT EXISTS ${this.logTable} (\n        id SERIAL PRIMARY KEY,\n        resource_name VARCHAR(255) NOT NULL,\n        operation VARCHAR(50) NOT NULL,\n        record_id VARCHAR(255) NOT NULL,\n        data JSONB,\n        timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n        source VARCHAR(100) DEFAULT 's3db-replicator',\n        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n      );\n      CREATE INDEX IF NOT EXISTS idx_${this.logTable}_resource_name ON ${this.logTable}(resource_name);\n      CREATE INDEX IF NOT EXISTS idx_${this.logTable}_operation ON ${this.logTable}(operation);\n      CREATE INDEX IF NOT EXISTS idx_${this.logTable}_record_id ON ${this.logTable}(record_id);\n      CREATE INDEX IF NOT EXISTS idx_${this.logTable}_timestamp ON ${this.logTable}(timestamp);\n    `;await this.client.query(e)}shouldReplicateResource(e){return this.resources.hasOwnProperty(e)}shouldReplicateAction(e,t){return!!this.resources[e]&&this.resources[e].some(e=>e.actions.includes(t))}getTablesForResource(e,t){return this.resources[e]?this.resources[e].filter(e=>e.actions.includes(t)).map(e=>e.table):[]}async replicate(e,t,r,n,i=null){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};if(!this.shouldReplicateAction(e,t))return{skipped:!0,reason:"action_not_included"};const o=this.getTablesForResource(e,t);if(0===o.length)return{skipped:!0,reason:"no_tables_for_action"};const s=[],a=[],[c,u,l]=await V(async()=>{for(const e of o){const[i,o]=await V(async()=>{let i;if("insert"===t){const t=Object.keys(r),n=t.map(e=>r[e]),o=t.map(e=>`"${e}"`).join(", "),s=t.map((e,t)=>`$${t+1}`).join(", "),a=`INSERT INTO ${e} (${o}) VALUES (${s}) ON CONFLICT (id) DO NOTHING RETURNING *`;i=await this.client.query(a,n)}else if("update"===t){const t=Object.keys(r).filter(e=>"id"!==e),o=t.map((e,t)=>`"${e}"=$${t+1}`).join(", "),s=t.map(e=>r[e]);s.push(n);const a=`UPDATE ${e} SET ${o} WHERE id=$${t.length+1} RETURNING *`;i=await this.client.query(a,s)}else{if("delete"!==t)throw new Error(`Unsupported operation: ${t}`);{const t=`DELETE FROM ${e} WHERE id=$1 RETURNING *`;i=await this.client.query(t,[n])}}s.push({table:e,success:!0,rows:i.rows,rowCount:i.rowCount})});i||a.push({table:e,error:o.message})}if(this.logTable){const[i,o]=await V(async()=>{await this.client.query(`INSERT INTO ${this.logTable} (resource_name, operation, record_id, data, timestamp, source) VALUES ($1, $2, $3, $4, $5, $6)`,[e,t,n,JSON.stringify(r),(new Date).toISOString(),"s3db-replicator"])})}const i=0===a.length;return this.emit("replicated",{replicator:this.name,resourceName:e,operation:t,id:n,tables:o,results:s,errors:a,success:i}),{success:i,results:s,errors:a,tables:o}});return c?l:(this.emit("replicator_error",{replicator:this.name,resourceName:e,operation:t,id:n,error:u.message}),{success:!1,error:u.message})}async replicateBatch(e,t){const r=[],n=[];for(const i of t){const[t,o,s]=await V(()=>this.replicate(e,i.operation,i.data,i.id,i.beforeData));t?r.push(s):n.push({id:i.id,error:o.message})}return{success:0===n.length,results:r,errors:n}}async testConnection(){const[e,t]=await V(async()=>(this.client||await this.initialize(),await this.client.query("SELECT 1"),!0));return!!e||(this.emit("connection_error",{replicator:this.name,error:t.message}),!1)}async cleanup(){this.client&&await this.client.end()}getStatus(){return{...super.getStatus(),database:this.database||"postgres",resources:this.resources,logTable:this.logTable}}}};function Ch(e,t={},r=[],n=null){const i=Uh[e];if(!i)throw new Error(`Unknown replicator driver: ${e}. Available drivers: ${Object.keys(Uh).join(", ")}`);return new i(t,r,n)}function Nh(e){return"string"==typeof e?e.trim().toLowerCase():e}class Rh extends Ke{constructor(e={}){if(super(),e.verbose&&console.log("[PLUGIN][CONSTRUCTOR] ReplicatorPlugin constructor called"),e.verbose&&console.log("[PLUGIN][constructor] New ReplicatorPlugin instance created with config:",e),!e.replicators||!Array.isArray(e.replicators))throw new Error("ReplicatorPlugin: replicators array is required");for(const t of e.replicators)if(!t.driver)throw new Error("ReplicatorPlugin: each replicator must have a driver");this.config={verbose:e.verbose??!1,persistReplicatorLog:e.persistReplicatorLog??!1,replicatorLogResource:e.replicatorLogResource??"replicator_logs",replicators:e.replicators||[]},this.replicators=[],this.queue=[],this.isProcessing=!1,this.stats={totalOperations:0,totalErrors:0,lastError:null},this._installedListeners=[]}async decompressData(e){return e}filterInternalFields(e){if(!e||"object"!=typeof e)return e;const t={};for(const[r,n]of Object.entries(e))r.startsWith("_")||"$overflow"===r||"$before"===r||"$after"===r||(t[r]=n);return t}installEventListeners(e){const t=this;t.config.verbose&&console.log("[PLUGIN] installEventListeners called for:",e&&e.name,{hasDatabase:!!e.database,sameDatabase:e.database===t.database,alreadyInstalled:e._replicatorListenersInstalled,resourceObj:e,resourceObjId:e&&e.id,resourceObjType:typeof e,resourceObjIs:e&&Object.is(e,t.database.resources&&t.database.resources[e.name]),resourceObjEq:e===(t.database.resources&&t.database.resources[e.name])}),e&&e.name!==t.config.replicatorLogResource&&e.database&&e.database===t.database&&(e._replicatorListenersInstalled||(e._replicatorListenersInstalled=!0,this._installedListeners.push(e),t.config.verbose&&console.log(`[PLUGIN] installEventListeners INSTALLED for resource: ${e&&e.name}`),e.on("insert",async r=>{t.config.verbose&&console.log("[PLUGIN] Listener INSERT on",e.name,"plugin.replicators.length:",t.replicators.length,t.replicators.map(e=>({id:e.id,driver:e.driver})));try{const n=await t.getCompleteData(e,r);t.config.verbose&&console.log(`[PLUGIN] Listener INSERT completeData for ${e.name} id=${r&&r.id}:`,n),await t.processReplicatorEvent(e.name,"insert",r.id,n,null)}catch(n){t.config.verbose&&console.error(`[PLUGIN] Listener INSERT error on ${e.name} id=${r&&r.id}:`,n)}}),e.on("update",async r=>{console.log("[PLUGIN][Listener][UPDATE][START] triggered for resource:",e.name,"data:",r);const n=r&&r.$before;t.config.verbose&&console.log("[PLUGIN] Listener UPDATE on",e.name,"plugin.replicators.length:",t.replicators.length,t.replicators.map(e=>({id:e.id,driver:e.driver})),"data:",r,"beforeData:",n);try{let i;const[o,s,a]=await V(()=>e.get(r.id));i=o&&a?a:r,await t.processReplicatorEvent(e.name,"update",r.id,i,n)}catch(n){t.config.verbose&&console.error(`[PLUGIN] Listener UPDATE erro em ${e.name} id=${r&&r.id}:`,n)}}),e.on("delete",async(r,n)=>{t.config.verbose&&console.log("[PLUGIN] Listener DELETE on",e.name,"plugin.replicators.length:",t.replicators.length,t.replicators.map(e=>({id:e.id,driver:e.driver})));try{await t.processReplicatorEvent(e.name,"delete",r.id,null,n)}catch(n){t.config.verbose&&console.error(`[PLUGIN] Listener DELETE erro em ${e.name} id=${r&&r.id}:`,n)}}),t.config.verbose&&console.log(`[PLUGIN] Listeners instalados para resource: ${e&&e.name} (insert: ${e.listenerCount("insert")}, update: ${e.listenerCount("update")}, delete: ${e.listenerCount("delete")})`)))}async getCompleteData(e,t){const[r,n,i]=await V(()=>e.get(t.id));return r?i:t}async setup(e){if(console.log("[PLUGIN][SETUP] setup called"),this.config.verbose&&console.log("[PLUGIN][setup] called with database:",e&&e.name),this.database=e,this.config.persistReplicatorLog){let t=e.resources[Nh(this.config.replicatorLogResource)];t||(t=await e.createResource({name:this.config.replicatorLogResource,behavior:"truncate-data",attributes:{id:"string|required",resource:"string|required",action:"string|required",data:"object",timestamp:"number|required",createdAt:"string|required"},partitions:{byDate:{fields:{createdAt:"string|maxlength:10"}}}}),this.config.verbose&&console.log("[PLUGIN] Log resource created:",this.config.replicatorLogResource,!!t)),e.resources[Nh(this.config.replicatorLogResource)]=t,this.replicatorLog=t,this.config.verbose&&console.log("[PLUGIN] Log resource created and registered:",this.config.replicatorLogResource,!!e.resources[Nh(this.config.replicatorLogResource)]),"function"==typeof e.uploadMetadataFile&&(await e.uploadMetadataFile(),this.config.verbose&&console.log("[PLUGIN] uploadMetadataFile called. database.resources keys:",Object.keys(e.resources)))}this.config.replicators&&this.config.replicators.length>0&&0===this.replicators.length&&(await this.initializeReplicators(),console.log("[PLUGIN][SETUP] after initializeReplicators, replicators.length:",this.replicators.length),this.config.verbose&&console.log("[PLUGIN][setup] After initializeReplicators, replicators.length:",this.replicators.length,this.replicators.map(e=>({id:e.id,driver:e.driver}))));for(const t in e.resources)Nh(t)!==Nh(this.config.replicatorLogResource)&&this.installEventListeners(e.resources[t]);e.on("connected",()=>{for(const t in e.resources)Nh(t)!==Nh(this.config.replicatorLogResource)&&this.installEventListeners(e.resources[t])});const t=e.createResource.bind(e);e.createResource=async e=>{this.config.verbose&&console.log("[PLUGIN] createResource proxy called for:",e&&e.name);const r=await t(e);return r&&r.name!==this.config.replicatorLogResource&&this.installEventListeners(r),r},e.on("s3db.resourceCreated",t=>{const r=e.resources[t];r&&r.name!==this.config.replicatorLogResource&&this.installEventListeners(r)}),e.on("s3db.resourceUpdated",t=>{const r=e.resources[t];r&&r.name!==this.config.replicatorLogResource&&this.installEventListeners(r)})}async initializeReplicators(){console.log("[PLUGIN][INIT] initializeReplicators called");for(const e of this.config.replicators)try{console.log("[PLUGIN][INIT] processing replicatorConfig:",e);const t=e.driver,r=e.resources,n=Ch(t,e,r,e.client);n?(await n.initialize(this.database),this.replicators.push({id:Math.random().toString(36).slice(2),driver:t,config:e,resources:r,instance:n}),console.log("[PLUGIN][INIT] pushed replicator:",t,r)):console.log("[PLUGIN][INIT] createReplicator returned null/undefined for driver:",t)}catch(e){console.error("[PLUGIN][INIT] Error creating replicator:",e)}}async start(){}async stop(){}async processReplicatorEvent(e,t,r,n,i=null){if(this.config.verbose&&(console.log("[PLUGIN][processReplicatorEvent] replicators.length:",this.replicators.length,this.replicators.map(e=>({id:e.id,driver:e.driver}))),console.log(`[PLUGIN][processReplicatorEvent] operation: ${t}, resource: ${e}, recordId: ${r}, data:`,n,"beforeData:",i)),this.config.verbose&&console.log(`[PLUGIN] processReplicatorEvent: resource=${e} op=${t} id=${r} data=`,n),this.config.verbose&&console.log(`[PLUGIN] processReplicatorEvent: resource=${e} op=${t} replicators=${this.replicators.length}`),0===this.replicators.length)return void(this.config.verbose&&console.log("[PLUGIN] No replicators registered"));const o=this.replicators.filter(r=>{const n=r.instance.shouldReplicateResource(e,t);return this.config.verbose&&console.log(`[PLUGIN] Replicator ${r.driver} shouldReplicateResource(${e}, ${t}):`,n),n});if(this.config.verbose&&console.log(`[PLUGIN] processReplicatorEvent: applicableReplicators for resource=${e}:`,o.map(e=>e.driver)),0===o.length)return void(this.config.verbose&&console.log("[PLUGIN] No applicable replicators for resource",e));const s=this.filterInternalFields(g(n)?n:{raw:n}),a=i?this.filterInternalFields(g(i)?i:{raw:i}):null,c={id:`repl-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,resourceName:e,operation:t,recordId:r,data:s,beforeData:a,timestamp:(new Date).toISOString(),attempts:0},u=await this.logreplicator(c),[l,h,f]=await V(async()=>this.processreplicatorItem(c));l?(u&&await this.updatereplicatorLog(u,{status:f.success?"success":"failed",attempts:1,error:f.success?"":JSON.stringify(f.results)}),this.stats.totalOperations++,f.success?this.stats.successfulOperations++:this.stats.failedOperations++):(u&&await this.updatereplicatorLog(u,{status:"failed",attempts:1,error:h.message}),this.stats.failedOperations++)}async processreplicatorItem(e){this.config.verbose&&console.log("[PLUGIN][processreplicatorItem] called with item:",e);const t=this.replicators.filter(t=>{const r=t.instance.shouldReplicateResource(e.resourceName,e.operation);return this.config.verbose&&console.log(`[PLUGIN] processreplicatorItem: Replicator ${t.driver} shouldReplicateResource(${e.resourceName}, ${e.operation}):`,r),r});if(this.config.verbose&&console.log(`[PLUGIN] processreplicatorItem: applicableReplicators for resource=${e.resourceName}:`,t.map(e=>e.driver)),0===t.length)return this.config.verbose&&console.log("[PLUGIN] processreplicatorItem: No applicable replicators for resource",e.resourceName),{success:!0,skipped:!0,reason:"no_applicable_replicators"};const r=[];for(const n of t){let t,i,o;this.config.verbose&&console.log("[PLUGIN] processReplicatorItem",{resource:e.resourceName,operation:e.operation,data:e.data,beforeData:e.beforeData,replicator:n.instance?.constructor?.name}),n.instance&&n.instance.constructor&&"S3dbReplicator"===n.instance.constructor.name?[i,o,t]=await V(()=>n.instance.replicate({resource:e.resourceName,operation:e.operation,data:e.data,id:e.recordId,beforeData:e.beforeData})):[i,o,t]=await V(()=>n.instance.replicate(e.resourceName,e.operation,e.data,e.recordId,e.beforeData)),r.push({replicatorId:n.id,driver:n.driver,success:t&&t.success,error:t&&t.error,skipped:t&&t.skipped})}return{success:r.every(e=>e.success||e.skipped),results:r}}async logreplicator(e){const t=this.replicatorLog||this.database.resources[Nh(this.config.replicatorLogResource)];if(!t)return this.config.verbose&&console.error("[PLUGIN] replicator log resource not found!"),this.database&&(this.config.verbose&&console.warn("[PLUGIN] database.resources keys:",Object.keys(this.database.resources)),this.database.options&&this.database.options.connectionString&&this.config.verbose&&console.warn("[PLUGIN] database connectionString:",this.database.options.connectionString)),void this.emit("replicator.log.failed",{error:"replicator log resource not found",item:e});const r={id:e.id||`repl-${Date.now()}-${Math.random().toString(36).slice(2)}`,resource:e.resource||e.resourceName||"",action:e.operation||e.action||"",data:e.data||{},timestamp:"number"==typeof e.timestamp?e.timestamp:Date.now(),createdAt:e.createdAt||(new Date).toISOString().slice(0,10)};try{await t.insert(r)}catch(t){this.config.verbose&&console.error("[PLUGIN] Error writing to replicator log:",t),this.emit("replicator.log.failed",{error:t,item:e})}}async updatereplicatorLog(e,t){if(!this.replicatorLog)return;const[r,n]=await V(async()=>{await this.replicatorLog.update(e,{...t,lastAttempt:(new Date).toISOString()})});r||this.emit("replicator.updateLog.failed",{error:n.message,logId:e,updates:t})}async getreplicatorStats(){const e=await Promise.all(this.replicators.map(async e=>{const t=await e.instance.getStatus();return{id:e.id,driver:e.driver,config:e.config,status:t}}));return{replicators:e,queue:{length:this.queue.length,isProcessing:this.isProcessing},stats:this.stats,lastSync:this.stats.lastSync}}async getreplicatorLogs(e={}){if(!this.replicatorLog)return[];const{resourceName:t,operation:r,status:n,limit:i=100,offset:o=0}=e;let s={};t&&(s.resourceName=t),r&&(s.operation=r),n&&(s.status=n);return(await this.replicatorLog.list(s)).slice(o,o+i)}async retryFailedreplicators(){if(!this.replicatorLog)return{retried:0};const e=await this.replicatorLog.list({status:"failed"});let t=0;for(const r of e){const[e,n]=await V(async()=>{await this.processReplicatorEvent(r.resourceName,r.operation,r.recordId,r.data)});e?t++:this.config.verbose&&console.error("Failed to retry replicator:",n)}return{retried:t}}async syncAllData(e){const t=this.replicators.find(t=>t.id===e);if(!t)throw new Error(`Replicator not found: ${e}`);this.stats.lastSync=(new Date).toISOString();for(const r in this.database.resources)if(Nh(r)!==Nh("replicator_logs")&&t.instance.shouldReplicateResource(r)){this.emit("replicator.sync.resource",{resourceName:r,replicatorId:e});const n=this.database.resources[r],i=await n.getAll();for(const e of i)await t.instance.replicate(r,"insert",e,e.id)}this.emit("replicator.sync.completed",{replicatorId:e,stats:this.stats})}async cleanup(){if(this.config.verbose&&console.log("[PLUGIN][CLEANUP] Cleaning up ReplicatorPlugin"),this._installedListeners&&Array.isArray(this._installedListeners)){for(const e of this._installedListeners)e&&"function"==typeof e.removeAllListeners&&(e.removeAllListeners("insert"),e.removeAllListeners("update"),e.removeAllListeners("delete")),e._replicatorListenersInstalled=!1;this._installedListeners=[]}if(this.database&&"function"==typeof this.database.removeAllListeners&&this.database.removeAllListeners(),this.replicators&&Array.isArray(this.replicators)){for(const e of this.replicators)e.instance&&"function"==typeof e.instance.cleanup&&await e.instance.cleanup();this.replicators=[]}this.queue=[],this.isProcessing=!1,this.stats={totalOperations:0,totalErrors:0,lastError:null},this.config.verbose&&console.log("[PLUGIN][CLEANUP] ReplicatorPlugin cleanup complete")}}export{ne as AVAILABLE_BEHAVIORS,Je as AuditPlugin,ge as AuthenticationError,he as BaseError,vs as CachePlugin,bh as Client,wh as ConnectionString,xe as ConnectionStringError,Es as CostsPlugin,Se as CryptoError,ie as DEFAULT_BEHAVIOR,xh as Database,de as DatabaseError,ye as EncryptionError,ke as ErrorMap,Is as FullTextPlugin,_e as InvalidResourceItem,_s as MetricsPlugin,Ie as MissingMetadata,be as NoSuchBucket,ve as NoSuchKey,Ee as NotFound,Ce as PartitionError,me as PermissionError,Ke as Plugin,We as PluginObject,Rh as ReplicatorPlugin,Bh as Resource,Ue as ResourceError,ps as ResourceIdsPageReader,ds as ResourceIdsReader,we as ResourceNotFound,gs as ResourceReader,ms as ResourceWriter,yh as S3_DEFAULT_ENDPOINT,mh as S3_DEFAULT_REGION,Sh as S3db,fe as S3dbError,kh as Schema,Ah as SchemaActions,Oe as SchemaError,Ae as UnknownError,pe as ValidationError,Ih as Validator,_h as ValidatorManager,te as behaviors,O as calculateAttributeNamesSize,C as calculateAttributeSizes,L as calculateEffectiveLimit,T as calculateSystemOverhead,N as calculateTotalSize,S as calculateUTF8Bytes,ce as decode,le as decodeDecimal,Le as decrypt,Sh as default,ae as encode,ue as encodeDecimal,Te as encrypt,re as getBehavior,R as getSizeBreakdown,je as idGenerator,Be as mapAwsError,Me as passwordGenerator,Re as sha256,ys as streamToString,U as transformValue,V as tryFn,G as tryFnSync};
