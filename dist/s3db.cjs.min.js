"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("lodash-es"),t=require("@supercharge/promise-pool"),r=require("nanoid"),i=require("@aws-sdk/client-s3"),n=require("crypto"),s=require("flat"),o=require("fastest-validator"),a=require("node:stream/web");function c(e,t){for(var r=0,i=e.length-1;i>=0;i--){var n=e[i];"."===n?e.splice(i,1):".."===n?(e.splice(i,1),r++):r&&(e.splice(i,1),r--)}if(t)for(;r--;r)e.unshift("..");return e}var l=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,u=function(e){return l.exec(e).slice(1)};function h(){for(var e="",t=!1,r=arguments.length-1;r>=-1&&!t;r--){var i=r>=0?arguments[r]:"/";if("string"!=typeof i)throw new TypeError("Arguments to path.resolve must be strings");i&&(e=i+"/"+e,t="/"===i.charAt(0))}return(t?"/":"")+(e=c(m(e.split("/"),function(e){return!!e}),!t).join("/"))||"."}function f(e){var t=d(e),r="/"===b(e,-1);return(e=c(m(e.split("/"),function(e){return!!e}),!t).join("/"))||t||(e="."),e&&r&&(e+="/"),(t?"/":"")+e}function d(e){return"/"===e.charAt(0)}function p(){return f(m(Array.prototype.slice.call(arguments,0),function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e}).join("/"))}var g={extname:function(e){return u(e)[3]},basename:function(e,t){var r=u(e)[2];return t&&r.substr(-1*t.length)===t&&(r=r.substr(0,r.length-t.length)),r},dirname:function(e){var t=u(e),r=t[0],i=t[1];return r||i?(i&&(i=i.substr(0,i.length-1)),r+i):"."},sep:"/",delimiter:":",relative:function(e,t){function r(e){for(var t=0;t<e.length&&""===e[t];t++);for(var r=e.length-1;r>=0&&""===e[r];r--);return t>r?[]:e.slice(t,r-t+1)}e=h(e).substr(1),t=h(t).substr(1);for(var i=r(e.split("/")),n=r(t.split("/")),s=Math.min(i.length,n.length),o=s,a=0;a<s;a++)if(i[a]!==n[a]){o=a;break}var c=[];for(a=o;a<i.length;a++)c.push("..");return(c=c.concat(n.slice(o))).join("/")},join:p,isAbsolute:d,normalize:f,resolve:h};function m(e,t){if(e.filter)return e.filter(t);for(var r=[],i=0;i<e.length;i++)t(e[i],i,e)&&r.push(e[i]);return r}var y,b="b"==="ab".substr(-1)?function(e,t,r){return e.substr(t,r)}:function(e,t,r){return t<0&&(t=e.length+t),e.substr(t,r)};function w(){}function v(){v.init.call(this)}function _(e){return void 0===e._maxListeners?v.defaultMaxListeners:e._maxListeners}function A(e,t,r,i){var n,s,o,a;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),o=s[t]):(s=e._events=new w,e._eventsCount=0),o){if("function"==typeof o?o=s[t]=i?[r,o]:[o,r]:i?o.unshift(r):o.push(r),!o.warned&&(n=_(e))&&n>0&&o.length>n){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,a=c,"function"==typeof console.warn?console.warn(a):console.log(a)}}else o=s[t]=r,++e._eventsCount;return e}function k(e,t,r){var i=!1;function n(){e.removeListener(t,n),i||(i=!0,r.apply(e,arguments))}return n.listener=r,n}function E(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function I(e,t){for(var r=new Array(t);t--;)r[t]=e[t];return r}w.prototype=Object.create(null),v.EventEmitter=v,v.usingDomains=!1,v.prototype.domain=void 0,v.prototype._events=void 0,v.prototype._maxListeners=void 0,v.defaultMaxListeners=10,v.init=function(){this.domain=null,v.usingDomains&&(!y.active||this instanceof y.Domain||(this.domain=y.active)),this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new w,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},v.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},v.prototype.getMaxListeners=function(){return _(this)},v.prototype.emit=function(e){var t,r,i,n,s,o,a,c="error"===e;if(o=this._events)c=c&&null==o.error;else if(!c)return!1;if(a=this.domain,c){if(t=arguments[1],!a){if(t instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=a,t.domainThrown=!1,a.emit("error",t),!1}if(!(r=o[e]))return!1;var u="function"==typeof r;switch(i=arguments.length){case 1:!function(e,t,r){if(t)e.call(r);else for(var i=e.length,n=I(e,i),s=0;s<i;++s)n[s].call(r)}(r,u,this);break;case 2:!function(e,t,r,i){if(t)e.call(r,i);else for(var n=e.length,s=I(e,n),o=0;o<n;++o)s[o].call(r,i)}(r,u,this,arguments[1]);break;case 3:!function(e,t,r,i,n){if(t)e.call(r,i,n);else for(var s=e.length,o=I(e,s),a=0;a<s;++a)o[a].call(r,i,n)}(r,u,this,arguments[1],arguments[2]);break;case 4:!function(e,t,r,i,n,s){if(t)e.call(r,i,n,s);else for(var o=e.length,a=I(e,o),c=0;c<o;++c)a[c].call(r,i,n,s)}(r,u,this,arguments[1],arguments[2],arguments[3]);break;default:for(n=new Array(i-1),s=1;s<i;s++)n[s-1]=arguments[s];!function(e,t,r,i){if(t)e.apply(r,i);else for(var n=e.length,s=I(e,n),o=0;o<n;++o)s[o].apply(r,i)}(r,u,this,n)}return!0},v.prototype.addListener=function(e,t){return A(this,e,t,!1)},v.prototype.on=v.prototype.addListener,v.prototype.prependListener=function(e,t){return A(this,e,t,!0)},v.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,k(this,e,t)),this},v.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,k(this,e,t)),this},v.prototype.removeListener=function(e,t){var r,i,n,s,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(r=i[e]))return this;if(r===t||r.listener&&r.listener===t)0===--this._eventsCount?this._events=new w:(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(n=-1,s=r.length;s-- >0;)if(r[s]===t||r[s].listener&&r[s].listener===t){o=r[s].listener,n=s;break}if(n<0)return this;if(1===r.length){if(r[0]=void 0,0===--this._eventsCount)return this._events=new w,this;delete i[e]}else!function(e,t){for(var r=t,i=r+1,n=e.length;i<n;r+=1,i+=1)e[r]=e[i];e.pop()}(r,n);i.removeListener&&this.emit("removeListener",e,o||t)}return this},v.prototype.off=function(e,t){return this.removeListener(e,t)},v.prototype.removeAllListeners=function(e){var t,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new w,this._eventsCount=0):r[e]&&(0===--this._eventsCount?this._events=new w:delete r[e]),this;if(0===arguments.length){for(var i,n=Object.keys(r),s=0;s<n.length;++s)"removeListener"!==(i=n[s])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=new w,this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},v.prototype.listeners=function(e){var t,r=this._events;return r&&(t=r[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(t):[]},v.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):E.call(e,t)},v.prototype.listenerCount=E,v.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};const S=r.customAlphabet(r.urlAlphabet,22),O=r.customAlphabet("ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789",16);function x(e){if(null==e){const e=new Error("fnOrPromise cannot be null or undefined");return e.stack=(new Error).stack,[!1,e,void 0]}if("function"==typeof e)try{const t=e();return null==t?[!0,null,t]:"function"==typeof t.then?t.then(e=>[!0,null,e]).catch(e=>{if(e instanceof Error&&Object.isExtensible(e)){const t=Object.getOwnPropertyDescriptor(e,"stack");if(t&&t.writable&&t.configurable&&e.hasOwnProperty("stack"))try{e.stack=(new Error).stack}catch(e){}}return[!1,e,void 0]}):[!0,null,t]}catch(e){if(e instanceof Error&&Object.isExtensible(e)){const t=Object.getOwnPropertyDescriptor(e,"stack");if(t&&t.writable&&t.configurable&&e.hasOwnProperty("stack"))try{e.stack=(new Error).stack}catch(e){}}return[!1,e,void 0]}return"function"==typeof e.then?Promise.resolve(e).then(e=>[!0,null,e]).catch(e=>{if(e instanceof Error&&Object.isExtensible(e)){const t=Object.getOwnPropertyDescriptor(e,"stack");if(t&&t.writable&&t.configurable&&e.hasOwnProperty("stack"))try{e.stack=(new Error).stack}catch(e){}}return[!1,e,void 0]}):[!0,null,e]}function R(e){try{return[!0,null,e()]}catch(e){return[!1,e,null]}}var N,B="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function C(e,t,r,i){return new(r||(r=Promise))(function(t,n){function s(e){try{a(i.next(e))}catch(e){n(e)}}function o(e){try{a(i.throw(e))}catch(e){n(e)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r(function(e){e(i)})).then(s,o)}a((i=i.apply(e,[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class j{constructor(){this.mutex=Promise.resolve()}lock(){let e=()=>{};return this.mutex=this.mutex.then(()=>new Promise(e)),new Promise(t=>{e=t})}dispatch(e){return C(this,0,void 0,function*(){const t=yield this.lock();try{return yield Promise.resolve(e())}finally{t()}})}}const D="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:B,P=null!==(N=D.Buffer)&&void 0!==N?N:null,L=D.TextEncoder?new D.TextEncoder:null;function T(e,t){return(15&e)+(e>>6|e>>3&8)<<4|(15&t)+(t>>6|t>>3&8)}const M="a".charCodeAt(0)-10,U="0".charCodeAt(0);function F(e,t,r){let i=0;for(let n=0;n<r;n++){let r=t[n]>>>4;e[i++]=r>9?r+M:r+U,r=15&t[n],e[i++]=r>9?r+M:r+U}return String.fromCharCode.apply(null,e)}const $=null!==P?e=>{if("string"==typeof e){const t=P.from(e,"utf8");return new Uint8Array(t.buffer,t.byteOffset,t.length)}if(P.isBuffer(e))return new Uint8Array(e.buffer,e.byteOffset,e.length);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Invalid data type!")}:e=>{if("string"==typeof e)return L.encode(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Invalid data type!")},z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",q=new Uint8Array(256);for(let e=0;e<64;e++)q[z.charCodeAt(e)]=e;function Q(e){const t=function(e){let t=Math.floor(.75*e.length);const r=e.length;return"="===e[r-1]&&(t-=1,"="===e[r-2]&&(t-=1)),t}(e),r=e.length,i=new Uint8Array(t);let n=0;for(let t=0;t<r;t+=4){const r=q[e.charCodeAt(t)],s=q[e.charCodeAt(t+1)],o=q[e.charCodeAt(t+2)],a=q[e.charCodeAt(t+3)];i[n]=r<<2|s>>4,n+=1,i[n]=(15&s)<<4|o>>2,n+=1,i[n]=(3&o)<<6|63&a,n+=1}return i}const V=16384,G=new j,H=new Map;function J(e,t){return C(this,0,void 0,function*(){let r=null,i=null,n=!1;if("undefined"==typeof WebAssembly)throw new Error("WebAssembly is not supported in this environment!");const s=()=>new DataView(r.exports.memory.buffer).getUint32(r.exports.STATE_SIZE,!0),o=G.dispatch(()=>C(this,0,void 0,function*(){if(!H.has(e.name)){const t=Q(e.data),r=WebAssembly.compile(t);H.set(e.name,r)}const t=yield H.get(e.name);r=yield WebAssembly.instantiate(t,{})})),a=(e=null)=>{n=!0,r.exports.Hash_Init(e)},c=e=>{if(!n)throw new Error("update() called before init()");(e=>{let t=0;for(;t<e.length;){const n=e.subarray(t,t+V);t+=n.length,i.set(n),r.exports.Hash_Update(n.length)}})($(e))},l=new Uint8Array(2*t),u=(e,s=null)=>{if(!n)throw new Error("digest() called before init()");return n=!1,r.exports.Hash_Final(s),"binary"===e?i.slice(0,t):F(l,i,t)},h=e=>"string"==typeof e?e.length<4096:e.byteLength<V;let f=h;switch(e.name){case"argon2":case"scrypt":f=()=>!0;break;case"blake2b":case"blake2s":f=(e,t)=>t<=512&&h(e);break;case"blake3":f=(e,t)=>0===t&&h(e);break;case"xxhash64":case"xxhash3":case"xxhash128":case"crc64":f=()=>!1}return yield(()=>C(this,0,void 0,function*(){r||(yield o);const e=r.exports.Hash_GetBuffer(),t=r.exports.memory.buffer;i=new Uint8Array(t,e,V)}))(),{getMemory:()=>i,writeMemory:(e,t=0)=>{i.set(e,t)},getExports:()=>r.exports,setMemorySize:e=>{r.exports.Hash_SetMemorySize(e);const t=r.exports.Hash_GetBuffer(),n=r.exports.memory.buffer;i=new Uint8Array(n,t,e)},init:a,update:c,digest:u,save:()=>{if(!n)throw new Error("save() can only be called after init() and before digest()");const t=r.exports.Hash_GetState(),i=s(),o=r.exports.memory.buffer,a=new Uint8Array(o,t,i),c=new Uint8Array(4+i);return function(e,t){const r=t.length>>1;for(let i=0;i<r;i++){const r=i<<1;e[i]=T(t.charCodeAt(r),t.charCodeAt(r+1))}}(c,e.hash),c.set(a,4),c},load:t=>{if(!(t instanceof Uint8Array))throw new Error("load() expects an Uint8Array generated by save()");const i=r.exports.Hash_GetState(),o=s(),a=4+o,c=r.exports.memory.buffer;if(t.length!==a)throw new Error(`Bad state length (expected ${a} bytes, got ${t.length})`);if(!function(e,t){if(e.length!==2*t.length)return!1;for(let r=0;r<t.length;r++){const i=r<<1;if(t[r]!==T(e.charCodeAt(i),e.charCodeAt(i+1)))return!1}return!0}(e.hash,t.subarray(0,4)))throw new Error("This state was written by an incompatible hash implementation");const l=t.subarray(4);new Uint8Array(c,i,o).set(l),n=!0},calculate:(e,n=null,s=null)=>{if(!f(e,n))return a(n),c(e),u("hex",s);const o=$(e);return i.set(o),r.exports.Hash_Calculate(o.length,n,s),F(l,i,t)},hashLength:t}})}new j,new j,new j,new j,new j,new j,new j;var W={name:"md5",data:"AGFzbQEAAAABEgRgAAF/YAAAYAF/AGACf38BfwMIBwABAgMBAAIFBAEBAgIGDgJ/AUGgigULfwBBgAgLB3AIBm1lbW9yeQIADkhhc2hfR2V0QnVmZmVyAAAJSGFzaF9Jbml0AAELSGFzaF9VcGRhdGUAAgpIYXNoX0ZpbmFsAAQNSGFzaF9HZXRTdGF0ZQAFDkhhc2hfQ2FsY3VsYXRlAAYKU1RBVEVfU0laRQMBCoMaBwUAQYAJCy0AQQBC/rnrxemOlZkQNwKQiQFBAEKBxpS6lvHq5m83AoiJAUEAQgA3AoCJAQu+BQEHf0EAQQAoAoCJASIBIABqQf////8BcSICNgKAiQFBAEEAKAKEiQEgAiABSWogAEEddmo2AoSJAQJAAkACQAJAAkACQCABQT9xIgMNAEGACSEEDAELIABBwAAgA2siBUkNASAFQQNxIQZBACEBAkAgA0E/c0EDSQ0AIANBgIkBaiEEIAVB/ABxIQdBACEBA0AgBCABaiICQRhqIAFBgAlqLQAAOgAAIAJBGWogAUGBCWotAAA6AAAgAkEaaiABQYIJai0AADoAACACQRtqIAFBgwlqLQAAOgAAIAcgAUEEaiIBRw0ACwsCQCAGRQ0AIANBmIkBaiECA0AgAiABaiABQYAJai0AADoAACABQQFqIQEgBkF/aiIGDQALC0GYiQFBwAAQAxogACAFayEAIAVBgAlqIQQLIABBwABPDQEgACECDAILIABFDQIgAEEDcSEGQQAhAQJAIABBBEkNACADQYCJAWohBCAAQXxxIQBBACEBA0AgBCABaiICQRhqIAFBgAlqLQAAOgAAIAJBGWogAUGBCWotAAA6AAAgAkEaaiABQYIJai0AADoAACACQRtqIAFBgwlqLQAAOgAAIAAgAUEEaiIBRw0ACwsgBkUNAiADQZiJAWohAgNAIAIgAWogAUGACWotAAA6AAAgAUEBaiEBIAZBf2oiBg0ADAMLCyAAQT9xIQIgBCAAQUBxEAMhBAsgAkUNACACQQNxIQZBACEBAkAgAkEESQ0AIAJBPHEhAEEAIQEDQCABQZiJAWogBCABaiICLQAAOgAAIAFBmYkBaiACQQFqLQAAOgAAIAFBmokBaiACQQJqLQAAOgAAIAFBm4kBaiACQQNqLQAAOgAAIAAgAUEEaiIBRw0ACwsgBkUNAANAIAFBmIkBaiAEIAFqLQAAOgAAIAFBAWohASAGQX9qIgYNAAsLC4cQARl/QQAoApSJASECQQAoApCJASEDQQAoAoyJASEEQQAoAoiJASEFA0AgACgCCCIGIAAoAhgiByAAKAIoIgggACgCOCIJIAAoAjwiCiAAKAIMIgsgACgCHCIMIAAoAiwiDSAMIAsgCiANIAkgCCAHIAMgBmogAiAAKAIEIg5qIAUgBCACIANzcSACc2ogACgCACIPakH4yKq7fWpBB3cgBGoiECAEIANzcSADc2pB1u6exn5qQQx3IBBqIhEgECAEc3EgBHNqQdvhgaECakERdyARaiISaiAAKAIUIhMgEWogACgCECIUIBBqIAQgC2ogEiARIBBzcSAQc2pB7p33jXxqQRZ3IBJqIhAgEiARc3EgEXNqQa+f8Kt/akEHdyAQaiIRIBAgEnNxIBJzakGqjJ+8BGpBDHcgEWoiEiARIBBzcSAQc2pBk4zBwXpqQRF3IBJqIhVqIAAoAiQiFiASaiAAKAIgIhcgEWogDCAQaiAVIBIgEXNxIBFzakGBqppqakEWdyAVaiIQIBUgEnNxIBJzakHYsYLMBmpBB3cgEGoiESAQIBVzcSAVc2pBr++T2nhqQQx3IBFqIhIgESAQc3EgEHNqQbG3fWpBEXcgEmoiFWogACgCNCIYIBJqIAAoAjAiGSARaiANIBBqIBUgEiARc3EgEXNqQb6v88p4akEWdyAVaiIQIBUgEnNxIBJzakGiosDcBmpBB3cgEGoiESAQIBVzcSAVc2pBk+PhbGpBDHcgEWoiFSARIBBzcSAQc2pBjofls3pqQRF3IBVqIhJqIAcgFWogDiARaiAKIBBqIBIgFSARc3EgEXNqQaGQ0M0EakEWdyASaiIQIBJzIBVxIBJzakHiyviwf2pBBXcgEGoiESAQcyAScSAQc2pBwOaCgnxqQQl3IBFqIhIgEXMgEHEgEXNqQdG0+bICakEOdyASaiIVaiAIIBJqIBMgEWogDyAQaiAVIBJzIBFxIBJzakGqj9vNfmpBFHcgFWoiECAVcyAScSAVc2pB3aC8sX1qQQV3IBBqIhEgEHMgFXEgEHNqQdOokBJqQQl3IBFqIhIgEXMgEHEgEXNqQYHNh8V9akEOdyASaiIVaiAJIBJqIBYgEWogFCAQaiAVIBJzIBFxIBJzakHI98++fmpBFHcgFWoiECAVcyAScSAVc2pB5puHjwJqQQV3IBBqIhEgEHMgFXEgEHNqQdaP3Jl8akEJdyARaiISIBFzIBBxIBFzakGHm9Smf2pBDncgEmoiFWogBiASaiAYIBFqIBcgEGogFSAScyARcSASc2pB7anoqgRqQRR3IBVqIhAgFXMgEnEgFXNqQYXSj896akEFdyAQaiIRIBBzIBVxIBBzakH4x75nakEJdyARaiISIBFzIBBxIBFzakHZhby7BmpBDncgEmoiFWogFyASaiATIBFqIBkgEGogFSAScyARcSASc2pBipmp6XhqQRR3IBVqIhAgFXMiFSASc2pBwvJoakEEdyAQaiIRIBVzakGB7ce7eGpBC3cgEWoiEiARcyIaIBBzakGiwvXsBmpBEHcgEmoiFWogFCASaiAOIBFqIAkgEGogFSAac2pBjPCUb2pBF3cgFWoiECAVcyIVIBJzakHE1PulempBBHcgEGoiESAVc2pBqZ/73gRqQQt3IBFqIhIgEXMiCSAQc2pB4JbttX9qQRB3IBJqIhVqIA8gEmogGCARaiAIIBBqIBUgCXNqQfD4/vV7akEXdyAVaiIQIBVzIhUgEnNqQcb97cQCakEEdyAQaiIRIBVzakH6z4TVfmpBC3cgEWoiEiARcyIIIBBzakGF4bynfWpBEHcgEmoiFWogGSASaiAWIBFqIAcgEGogFSAIc2pBhbqgJGpBF3cgFWoiESAVcyIQIBJzakG5oNPOfWpBBHcgEWoiEiAQc2pB5bPutn5qQQt3IBJqIhUgEnMiByARc2pB+PmJ/QFqQRB3IBVqIhBqIAwgFWogDyASaiAGIBFqIBAgB3NqQeWssaV8akEXdyAQaiIRIBVBf3NyIBBzakHExKShf2pBBncgEWoiEiAQQX9zciARc2pBl/+rmQRqQQp3IBJqIhAgEUF/c3IgEnNqQafH0Nx6akEPdyAQaiIVaiALIBBqIBkgEmogEyARaiAVIBJBf3NyIBBzakG5wM5kakEVdyAVaiIRIBBBf3NyIBVzakHDs+2qBmpBBncgEWoiECAVQX9zciARc2pBkpmz+HhqQQp3IBBqIhIgEUF/c3IgEHNqQf3ov39qQQ93IBJqIhVqIAogEmogFyAQaiAOIBFqIBUgEEF/c3IgEnNqQdG7kax4akEVdyAVaiIQIBJBf3NyIBVzakHP/KH9BmpBBncgEGoiESAVQX9zciAQc2pB4M2zcWpBCncgEWoiEiAQQX9zciARc2pBlIaFmHpqQQ93IBJqIhVqIA0gEmogFCARaiAYIBBqIBUgEUF/c3IgEnNqQaGjoPAEakEVdyAVaiIQIBJBf3NyIBVzakGC/c26f2pBBncgEGoiESAVQX9zciAQc2pBteTr6XtqQQp3IBFqIhIgEEF/c3IgEXNqQbul39YCakEPdyASaiIVIARqIBYgEGogFSARQX9zciASc2pBkaeb3H5qQRV3aiEEIBUgA2ohAyASIAJqIQIgESAFaiEFIABBwABqIQAgAUFAaiIBDQALQQAgAjYClIkBQQAgAzYCkIkBQQAgBDYCjIkBQQAgBTYCiIkBIAALyAMBBX9BACgCgIkBQT9xIgBBmIkBakGAAToAACAAQQFqIQECQAJAAkACQCAAQT9zIgJBB0sNACACRQ0BIAFBmIkBakEAOgAAIAJBAUYNASAAQZqJAWpBADoAACACQQJGDQEgAEGbiQFqQQA6AAAgAkEDRg0BIABBnIkBakEAOgAAIAJBBEYNASAAQZ2JAWpBADoAACACQQVGDQEgAEGeiQFqQQA6AAAgAkEGRg0BIABBn4kBakEAOgAADAELIAJBCEYNAkE2IABrIgMhBAJAIAJBA3EiAEUNAEEAIABrIQRBACEAA0AgAEHPiQFqQQA6AAAgBCAAQX9qIgBHDQALIAMgAGohBAsgA0EDSQ0CDAELQZiJAUHAABADGkEAIQFBNyEECyABQYCJAWohAEF/IQIDQCAAIARqQRVqQQA2AAAgAEF8aiEAIAQgAkEEaiICRw0ACwtBAEEAKAKEiQE2AtSJAUEAQQAoAoCJASIAQRV2OgDTiQFBACAAQQ12OgDSiQFBACAAQQV2OgDRiQFBACAAQQN0IgA6ANCJAUEAIAA2AoCJAUGYiQFBwAAQAxpBAEEAKQKIiQE3A4AJQQBBACkCkIkBNwOICQsGAEGAiQELMwBBAEL+uevF6Y6VmRA3ApCJAUEAQoHGlLqW8ermbzcCiIkBQQBCADcCgIkBIAAQAhAECwsLAQBBgAgLBJgAAAA=",hash:"e6508e4b"};const K=new j;let Z=null;function Y(e){if(null===Z)return function(e,t,r){return C(this,0,void 0,function*(){const i=yield e.lock(),n=yield J(t,r);return i(),n})}(K,W,16).then(t=>(Z=t,Z.calculate(e)));try{const t=Z.calculate(e);return Promise.resolve(t)}catch(e){return Promise.reject(e)}}new j,new j,new j,new j,new j,new j,new j,new j,new j,new j,new j,new j,new j,new j;class X extends Error{constructor({verbose:e,bucket:t,key:r,message:i,code:n,statusCode:s,requestId:o,awsMessage:a,original:c,commandName:l,commandInput:u,metadata:h,suggestion:f,...d}){e&&(i+=`\n\nVerbose:\n\n${JSON.stringify(d,null,2)}`),super(i),"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error(i).stack,super.name=this.constructor.name,this.name=this.constructor.name,this.bucket=t,this.key=r,this.thrownAt=new Date,this.code=n,this.statusCode=s,this.requestId=o,this.awsMessage=a,this.original=c,this.commandName=l,this.commandInput=u,this.metadata=h,this.suggestion=f,this.data={bucket:t,key:r,...d,verbose:e,message:i}}toJson(){return{name:this.name,message:this.message,code:this.code,statusCode:this.statusCode,requestId:this.requestId,awsMessage:this.awsMessage,bucket:this.bucket,key:this.key,thrownAt:this.thrownAt,commandName:this.commandName,commandInput:this.commandInput,metadata:this.metadata,suggestion:this.suggestion,data:this.data,original:this.original,stack:this.stack}}toString(){return`${this.name} | ${this.message}`}}class ee extends X{constructor(e,t={}){let r,i,n,s,o,a;t.original&&(o=t.original,r=o.code||o.Code||o.name,i=o.statusCode||o.$metadata&&o.$metadata.httpStatusCode,n=o.requestId||o.$metadata&&o.$metadata.requestId,s=o.message,a=o.$metadata?{...o.$metadata}:void 0),super({message:e,...t,code:r,statusCode:i,requestId:n,awsMessage:s,original:o,metadata:a})}}class te extends ee{constructor(e,t={}){super(e,t),Object.assign(this,t)}}class re extends ee{constructor(e,t={}){super(e,t),Object.assign(this,t)}}class ie extends ee{constructor({bucket:e,resourceName:t,id:r,original:i,...n}){if("string"!=typeof r)throw new Error("id must be a string");if("string"!=typeof e)throw new Error("bucket must be a string");if("string"!=typeof t)throw new Error("resourceName must be a string");super(`Resource not found: ${t}/${r} [bucket:${e}]`,{bucket:e,resourceName:t,id:r,original:i,...n})}}class ne extends ee{constructor({bucket:e,original:t,...r}){if("string"!=typeof e)throw new Error("bucket must be a string");super(`Bucket does not exists [bucket:${e}]`,{bucket:e,original:t,...r})}}class se extends ee{constructor({bucket:e,key:t,resourceName:r,id:i,original:n,...s}){if("string"!=typeof t)throw new Error("key must be a string");if("string"!=typeof e)throw new Error("bucket must be a string");if(void 0!==i&&"string"!=typeof i)throw new Error("id must be a string");super(`No such key: ${t} [bucket:${e}]`,{bucket:e,key:t,resourceName:r,id:i,original:n,...s}),this.resourceName=r,this.id=i}}class oe extends ee{constructor({bucket:e,key:t,resourceName:r,id:i,original:n,...s}){if("string"!=typeof t)throw new Error("key must be a string");if("string"!=typeof e)throw new Error("bucket must be a string");super(`Not found: ${t} [bucket:${e}]`,{bucket:e,key:t,resourceName:r,id:i,original:n,...s}),this.resourceName=r,this.id=i}}class ae extends ee{constructor({bucket:e,original:t,...r}){if("string"!=typeof e)throw new Error("bucket must be a string");super(`Missing metadata for bucket [bucket:${e}]`,{bucket:e,original:t,...r})}}class ce extends ee{constructor({bucket:e,resourceName:t,attributes:r,validation:i,message:n,original:s,...o}){if("string"!=typeof e)throw new Error("bucket must be a string");if("string"!=typeof t)throw new Error("resourceName must be a string");super(n||`Validation error: This item is not valid. Resource=${t} [bucket:${e}].\n${JSON.stringify(i,null,2)}`,{bucket:e,resourceName:t,attributes:r,validation:i,original:s,...o})}}class le extends ee{}const ue={NotFound:oe,NoSuchKey:se,UnknownError:le,NoSuchBucket:ne,MissingMetadata:ae,InvalidResourceItem:ce};function he(e,t={}){const r=e.code||e.Code||e.name,i=e.$metadata?{...e.$metadata}:void 0,n=t.commandName,s=t.commandInput;let o;return"NoSuchKey"===r||"NotFound"===r?(o="Check if the key exists in the specified bucket and if your credentials have permission.",new se({...t,original:e,metadata:i,commandName:n,commandInput:s,suggestion:o})):"NoSuchBucket"===r?(o="Check if the bucket exists and if your credentials have permission.",new ne({...t,original:e,metadata:i,commandName:n,commandInput:s,suggestion:o})):"AccessDenied"===r||403===e.statusCode||"Forbidden"===r?(o="Check your credentials and bucket policy.",new re("Access denied",{...t,original:e,metadata:i,commandName:n,commandInput:s,suggestion:o})):"ValidationError"===r||400===e.statusCode?(o="Check the request parameters and payload.",new te("Validation error",{...t,original:e,metadata:i,commandName:n,commandInput:s,suggestion:o})):"MissingMetadata"===r?(o="Check if the object metadata is present and valid.",new ae({...t,original:e,metadata:i,commandName:n,commandInput:s,suggestion:o})):(o="Check the error details and AWS documentation.",new le("Unknown error",{...t,original:e,metadata:i,commandName:n,commandInput:s,suggestion:o}))}class fe extends ee{constructor(e,t={}){super(e,{...t,suggestion:"Check the connection string format and credentials."})}}class de extends ee{constructor(e,t={}){super(e,{...t,suggestion:"Check if the crypto library is available and input is valid."})}}class pe extends ee{constructor(e,t={}){super(e,{...t,suggestion:"Check schema definition and input data."})}}class ge extends ee{constructor(e,t={}){super(e,{...t,suggestion:t.suggestion||"Check resource configuration, attributes, and operation context."}),Object.assign(this,t)}}class me extends ee{constructor(e,t={}){super(e,{...t,suggestion:t.suggestion||"Check partition definition, fields, and input values."})}}const ye="us-east-1",be="https://s3.us-east-1.amazonaws.com";class we{constructor(e){let t;const[r,i,n]=x(()=>new URL(e));if(!r)throw new fe("Invalid connection string: "+e,{original:i,input:e});t=n,this.region=ye,"s3:"===t.protocol?this.defineFromS3(t):this.defineFromCustomUri(t);for(const[e,r]of t.searchParams.entries())this[e]=r}defineFromS3(e){const[t,r,i]=R(()=>decodeURIComponent(e.hostname));if(!t)throw new fe("Invalid bucket in connection string",{original:r,input:e.hostname});this.bucket=i||"s3db";const[n,s,o]=R(()=>decodeURIComponent(e.username));if(!n)throw new fe("Invalid accessKeyId in connection string",{original:s,input:e.username});this.accessKeyId=o;const[a,c,l]=R(()=>decodeURIComponent(e.password));if(!a)throw new fe("Invalid secretAccessKey in connection string",{original:c,input:e.password});if(this.secretAccessKey=l,this.endpoint=be,["/","",null].includes(e.pathname))this.keyPrefix="";else{let[,...t]=e.pathname.split("/");this.keyPrefix=[...t||[]].join("/")}}defineFromCustomUri(e){this.forcePathStyle=!0,this.endpoint=e.origin;const[t,r,i]=R(()=>decodeURIComponent(e.username));if(!t)throw new fe("Invalid accessKeyId in connection string",{original:r,input:e.username});this.accessKeyId=i;const[n,s,o]=R(()=>decodeURIComponent(e.password));if(!n)throw new fe("Invalid secretAccessKey in connection string",{original:s,input:e.password});if(this.secretAccessKey=o,["/","",null].includes(e.pathname))this.bucket="s3db",this.keyPrefix="";else{let[,t,...r]=e.pathname.split("/");if(t){const[e,r,i]=R(()=>decodeURIComponent(t));if(!e)throw new fe("Invalid bucket in connection string",{original:r,input:t});this.bucket=i}else this.bucket="s3db";this.keyPrefix=[...r||[]].join("/")}}}class ve extends v{constructor({verbose:e=!1,id:t=null,AwsS3Client:r,connectionString:i,parallelism:n=10}){super(),this.verbose=e,this.id=t??S(),this.parallelism=n,this.config=new we(i),this.client=r||this.createClient()}createClient(){let e={region:this.config.region,endpoint:this.config.endpoint};this.config.forcePathStyle&&(e.forcePathStyle=!0),this.config.accessKeyId&&(e.credentials={accessKeyId:this.config.accessKeyId,secretAccessKey:this.config.secretAccessKey});const t=new i.S3Client(e);return t.middlewareStack.add((e,t)=>async r=>{if("DeleteObjectsCommand"===t.commandName){const e=r.request.body;if(e&&"string"==typeof e){const t=Buffer.from(await Y(e),"hex").toString("base64");r.request.headers["Content-MD5"]=t}}return e(r)},{step:"build",name:"addContentMd5ForDeleteObjects",priority:"high"}),t}async sendCommand(e){this.emit("command.request",e.constructor.name,e.input);const[t,r,i]=await x(()=>this.client.send(e));if(!t){throw he(r,{bucket:this.config.bucket,key:e.input&&e.input.Key,commandName:e.constructor.name,commandInput:e.input})}return this.emit("command.response",e.constructor.name,i,e.input),i}async putObject({key:e,metadata:t,contentType:r,body:n,contentEncoding:s,contentLength:o}){const a="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"";a&&g.join(a,e);const c={};if(t)for(const[e,r]of Object.entries(t)){c[String(e).replace(/[^a-zA-Z0-9\-_]/g,"_")]=String(r)}const l={Bucket:this.config.bucket,Key:a?g.join(a,e):e,Metadata:c,Body:n||Buffer.alloc(0)};let u,h;void 0!==r&&(l.ContentType=r),void 0!==s&&(l.ContentEncoding=s),void 0!==o&&(l.ContentLength=o);try{return u=await this.sendCommand(new i.PutObjectCommand(l)),u}catch(t){throw h=t,he(t,{bucket:this.config.bucket,key:e,commandName:"PutObjectCommand",commandInput:l})}finally{this.emit("putObject",h||u,{key:e,metadata:t,contentType:r,body:n,contentEncoding:s,contentLength:o})}}async getObject(e){const t="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"",r={Bucket:this.config.bucket,Key:t?g.join(t,e):e};let n,s;try{return n=await this.sendCommand(new i.GetObjectCommand(r)),n}catch(t){throw s=t,he(t,{bucket:this.config.bucket,key:e,commandName:"GetObjectCommand",commandInput:r})}finally{this.emit("getObject",s||n,{key:e})}}async headObject(e){const t="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"",r={Bucket:this.config.bucket,Key:t?g.join(t,e):e};let n,s;try{return n=await this.sendCommand(new i.HeadObjectCommand(r)),n}catch(t){throw s=t,he(t,{bucket:this.config.bucket,key:e,commandName:"HeadObjectCommand",commandInput:r})}finally{this.emit("headObject",s||n,{key:e})}}async copyObject({from:e,to:t}){const r={Bucket:this.config.bucket,Key:this.config.keyPrefix?g.join(this.config.keyPrefix,t):t,CopySource:g.join(this.config.bucket,this.config.keyPrefix?g.join(this.config.keyPrefix,e):e)};let n,s;try{return n=await this.sendCommand(new i.CopyObjectCommand(r)),n}catch(e){throw s=e,he(e,{bucket:this.config.bucket,key:t,commandName:"CopyObjectCommand",commandInput:r})}finally{this.emit("copyObject",s||n,{from:e,to:t})}}async exists(e){const[t,r]=await x(()=>this.headObject(e));if(t)return!0;if("NoSuchKey"===r.name||"NotFound"===r.name)return!1;throw r}async deleteObject(e){const t="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"";t&&g.join(t,e);const r={Bucket:this.config.bucket,Key:t?g.join(t,e):e};let n,s;try{return n=await this.sendCommand(new i.DeleteObjectCommand(r)),n}catch(t){throw s=t,he(t,{bucket:this.config.bucket,key:e,commandName:"DeleteObjectCommand",commandInput:r})}finally{this.emit("deleteObject",s||n,{key:e})}}async deleteObjects(r){const n="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"",s=e.chunk(r,1e3),{results:o,errors:a}=await t.PromisePool.for(s).withConcurrency(this.parallelism).process(async e=>{for(const t of e)n&&g.join(n,t),this.config.bucket,await this.exists(t);const t={Bucket:this.config.bucket,Delete:{Objects:e.map(e=>({Key:n?g.join(n,e):e}))}};let r;const[s,o,a]=await x(()=>this.sendCommand(new i.DeleteObjectsCommand(t)));if(!s)throw o;return r=a,r&&r.Errors&&r.Errors.length,r&&r.Deleted&&(r.Deleted.length,e.length),r}),c={deleted:o,notFound:a};return this.emit("deleteObjects",c,r),c}async deleteAll({prefix:e}={}){const t="string"==typeof this.config.keyPrefix?this.config.keyPrefix:"";let r,n=0;do{const s=new i.ListObjectsV2Command({Bucket:this.config.bucket,Prefix:t?g.join(t,e||""):e||"",ContinuationToken:r}),o=await this.client.send(s);if(o.Contents&&o.Contents.length>0){const t=new i.DeleteObjectsCommand({Bucket:this.config.bucket,Delete:{Objects:o.Contents.map(e=>({Key:e.Key}))}}),r=await this.client.send(t),s=r.Deleted?r.Deleted.length:0;n+=s,this.emit("deleteAll",{prefix:e,batch:s,total:n})}r=o.IsTruncated?o.NextContinuationToken:void 0}while(r);return this.emit("deleteAllComplete",{prefix:e,totalDeleted:n}),n}async moveObject({from:e,to:t}){const[r,i]=await x(async()=>{await this.copyObject({from:e,to:t}),await this.deleteObject(e)});if(!r)throw new le("Unknown error in moveObject",{bucket:this.config.bucket,from:e,to:t,original:i});return!0}async listObjects({prefix:e,maxKeys:t=1e3,continuationToken:r}={}){const n={Bucket:this.config.bucket,MaxKeys:t,ContinuationToken:r,Prefix:this.config.keyPrefix?g.join(this.config.keyPrefix,e||""):e||""},[s,o,a]=await x(()=>this.sendCommand(new i.ListObjectsV2Command(n)));if(!s)throw new le("Unknown error in listObjects",{prefix:e,bucket:this.config.bucket,original:o});return this.emit("listObjects",a,n),a}async count({prefix:e}={}){let t,r=0,i=!0;for(;i;){const n={prefix:e,continuationToken:t},s=await this.listObjects(n);r+=s.KeyCount||0,i=s.IsTruncated||!1,t=s.NextContinuationToken}return this.emit("count",r,{prefix:e}),r}async getAllKeys({prefix:e}={}){let t,r=[],i=!0;for(;i;){const n={prefix:e,continuationToken:t},s=await this.listObjects(n);s.Contents&&(r=r.concat(s.Contents.map(e=>e.Key))),i=s.IsTruncated||!1,t=s.NextContinuationToken}return this.config.keyPrefix&&(r=r.map(e=>e.replace(this.config.keyPrefix,"")).map(e=>e.startsWith("/")?e.replace("/",""):e)),this.emit("getAllKeys",r,{prefix:e}),r}async getContinuationTokenAfterOffset(e={}){const{prefix:t,offset:r=1e3}=e;if(0===r)return null;let i,n=!0,s=0;for(;n;){const e={prefix:t,maxKeys:r<1e3?r:r-s>1e3?1e3:r-s,continuationToken:i},o=await this.listObjects(e);if(o.Contents&&(s+=o.Contents.length),n=o.IsTruncated||!1,i=o.NextContinuationToken,s>=r)break}return this.emit("getContinuationTokenAfterOffset",i||null,e),i||null}async getKeysPage(e={}){const{prefix:t,offset:r=0,amount:i=100}=e;let n,s=[],o=!0;if(r>0&&(n=await this.getContinuationTokenAfterOffset({prefix:t,offset:r}),!n))return this.emit("getKeysPage",[],e),[];for(;o;){const e={prefix:t,continuationToken:n},r=await this.listObjects(e);if(r.Contents&&(s=s.concat(r.Contents.map(e=>e.Key))),o=r.IsTruncated||!1,n=r.NextContinuationToken,s.length>=i){s=s.slice(0,i);break}}return this.config.keyPrefix&&(s=s.map(e=>e.replace(this.config.keyPrefix,"")).map(e=>e.startsWith("/")?e.replace("/",""):e)),this.emit("getKeysPage",s,e),s}async moveAllObjects({prefixFrom:e,prefixTo:r}){const i=await this.getAllKeys({prefix:e}),{results:n,errors:s}=await t.PromisePool.for(i).withConcurrency(this.parallelism).process(async t=>{const i=t.replace(e,r),[n,s]=await x(async()=>{await this.moveObject({from:t,to:i})});if(!n)throw new le("Unknown error in moveAllObjects",{bucket:this.config.bucket,from:t,to:i,original:s});return i});if(this.emit("moveAllObjects",{results:n,errors:s},{prefixFrom:e,prefixTo:r}),s.length>0)throw new Error("Some objects could not be moved");return n}}async function _e(){let e;if("undefined"!=typeof process){const[t,r,i]=await x(async()=>{const{webcrypto:e}=await import("crypto");return e});if(!t)throw new de("Crypto API not available",{original:r,context:"dynamicCrypto"});e=i}else"undefined"!=typeof window&&(e=window.crypto);if(!e)throw new de("Could not load any crypto library",{context:"dynamicCrypto"});return e}async function Ae(e){const[t,r,i]=await x(_e);if(!t)throw new de("Crypto API not available",{original:r});const n=(new TextEncoder).encode(e),[s,o,a]=await x(()=>i.subtle.digest("SHA-256",n));if(!s)throw new de("SHA-256 digest failed",{original:o,input:e});return Array.from(new Uint8Array(a)).map(e=>e.toString(16).padStart(2,"0")).join("")}async function ke(e,t){const[r,i,n]=await x(_e);if(!r)throw new de("Crypto API not available",{original:i});const s=n.getRandomValues(new Uint8Array(16)),[o,a,c]=await x(()=>Ie(t,s));if(!o)throw new de("Key derivation failed",{original:a,passphrase:t,salt:s});const l=n.getRandomValues(new Uint8Array(12)),u=(new TextEncoder).encode(e),[h,f,d]=await x(()=>n.subtle.encrypt({name:"AES-GCM",iv:l},c,u));if(!h)throw new de("Encryption failed",{original:f,content:e});const p=new Uint8Array(s.length+l.length+d.byteLength);return p.set(s),p.set(l,s.length),p.set(new Uint8Array(d),s.length+l.length),function(e){if("undefined"!=typeof process)return Buffer.from(e).toString("base64");{const[t,r,i]=R(()=>String.fromCharCode.apply(null,new Uint8Array(e)));if(!t)throw new de("Failed to convert ArrayBuffer to base64 (browser)",{original:r});return window.btoa(i)}}(p)}async function Ee(e,t){const[r,i,n]=await x(_e);if(!r)throw new de("Crypto API not available",{original:i});const s=function(e){if("undefined"!=typeof process)return new Uint8Array(Buffer.from(e,"base64"));{const[t,r,i]=R(()=>window.atob(e));if(!t)throw new de("Failed to decode base64 (browser)",{original:r});const n=i.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=i.charCodeAt(e);return s}}(e),o=s.slice(0,16),a=s.slice(16,28),c=s.slice(28),[l,u,h]=await x(()=>Ie(t,o));if(!l)throw new de("Key derivation failed (decrypt)",{original:u,passphrase:t,salt:o});const[f,d,p]=await x(()=>n.subtle.decrypt({name:"AES-GCM",iv:a},h,c));if(!f)throw new de("Decryption failed",{original:d,encryptedBase64:e});return(new TextDecoder).decode(p)}async function Ie(e,t){const[r,i,n]=await x(_e);if(!r)throw new de("Crypto API not available",{original:i});const s=(new TextEncoder).encode(e),[o,a,c]=await x(()=>n.subtle.importKey("raw",s,{name:"PBKDF2"},!1,["deriveKey"]));if(!o)throw new de("importKey failed",{original:a,passphrase:e});const[l,u,h]=await x(()=>n.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},c,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]));if(!l)throw new de("deriveKey failed",{original:u,passphrase:e,salt:t});return h}function Se(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Oe,xe,Re,Ne,Be,Ce,je,De,Pe,Le,Te,Me,Ue,Fe={};function $e(){if(xe)return Oe;var e,t;xe=1;var r,i={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function n(t){throw{name:"SyntaxError",message:t,at:e,text:r}}function s(i){return i&&i!==t&&n("Expected '"+i+"' instead of '"+t+"'"),t=r.charAt(e),e+=1,t}function o(){var e,r="";for("-"===t&&(r="-",s("-"));t>="0"&&t<="9";)r+=t,s();if("."===t)for(r+=".";s()&&t>="0"&&t<="9";)r+=t;if("e"===t||"E"===t)for(r+=t,s(),"-"!==t&&"+"!==t||(r+=t,s());t>="0"&&t<="9";)r+=t,s();return e=Number(r),isFinite(e)||n("Bad number"),e}function a(){var e,r,o,a="";if('"'===t)for(;s();){if('"'===t)return s(),a;if("\\"===t)if(s(),"u"===t){for(o=0,r=0;r<4&&(e=parseInt(s(),16),isFinite(e));r+=1)o=16*o+e;a+=String.fromCharCode(o)}else{if("string"!=typeof i[t])break;a+=i[t]}else a+=t}n("Bad string")}function c(){for(;t&&t<=" ";)s()}function l(){switch(c(),t){case"{":return function(){var e,r={};if("{"===t){if(s("{"),c(),"}"===t)return s("}"),r;for(;t;){if(e=a(),c(),s(":"),Object.prototype.hasOwnProperty.call(r,e)&&n('Duplicate key "'+e+'"'),r[e]=l(),c(),"}"===t)return s("}"),r;s(","),c()}}n("Bad object")}();case"[":return function(){var e=[];if("["===t){if(s("["),c(),"]"===t)return s("]"),e;for(;t;){if(e.push(l()),c(),"]"===t)return s("]"),e;s(","),c()}}n("Bad array")}();case'"':return a();case"-":return o();default:return t>="0"&&t<="9"?o():function(){switch(t){case"t":return s("t"),s("r"),s("u"),s("e"),!0;case"f":return s("f"),s("a"),s("l"),s("s"),s("e"),!1;case"n":return s("n"),s("u"),s("l"),s("l"),null;default:n("Unexpected '"+t+"'")}}()}}return Oe=function(i,s){var o;return r=i,e=0,t=" ",o=l(),c(),t&&n("Syntax error"),"function"==typeof s?function e(t,r){var i,n,o=t[r];if(o&&"object"==typeof o)for(i in l)Object.prototype.hasOwnProperty.call(o,i)&&(void 0===(n=e(o,i))?delete o[i]:o[i]=n);return s.call(t,r,o)}({"":o},""):o},Oe}function ze(){if(Ne)return Re;Ne=1;var e,t,r,i=/[\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function s(e){return i.lastIndex=0,i.test(e)?'"'+e.replace(i,function(e){var t=n[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function o(i,n){var a,c,l,u,h,f=e,d=n[i];switch(d&&"object"==typeof d&&"function"==typeof d.toJSON&&(d=d.toJSON(i)),"function"==typeof r&&(d=r.call(n,i,d)),typeof d){case"string":return s(d);case"number":return isFinite(d)?String(d):"null";case"boolean":case"null":return String(d);case"object":if(!d)return"null";if(e+=t,h=[],"[object Array]"===Object.prototype.toString.apply(d)){for(u=d.length,a=0;a<u;a+=1)h[a]=o(a,d)||"null";return l=0===h.length?"[]":e?"[\n"+e+h.join(",\n"+e)+"\n"+f+"]":"["+h.join(",")+"]",e=f,l}if(r&&"object"==typeof r)for(u=r.length,a=0;a<u;a+=1)"string"==typeof(c=r[a])&&(l=o(c,d))&&h.push(s(c)+(e?": ":":")+l);else for(c in d)Object.prototype.hasOwnProperty.call(d,c)&&(l=o(c,d))&&h.push(s(c)+(e?": ":":")+l);return l=0===h.length?"{}":e?"{\n"+e+h.join(",\n"+e)+"\n"+f+"}":"{"+h.join(",")+"}",e=f,l}}return Re=function(i,n,s){var a;if(e="",t="","number"==typeof s)for(a=0;a<s;a+=1)t+=" ";else"string"==typeof s&&(t=s);if(r=n,n&&"function"!=typeof n&&("object"!=typeof n||"number"!=typeof n.length))throw new Error("JSON.stringify");return o("",{"":i})}}function qe(){if(Pe)return De;Pe=1;var e=Object.prototype.toString;return De=function(t){var r=e.call(t),i="[object Arguments]"===r;return i||(i="[object Array]"!==r&&null!==t&&"object"==typeof t&&"number"==typeof t.length&&t.length>=0&&"[object Function]"===e.call(t.callee)),i}}function Qe(){if(Te)return Le;var e;if(Te=1,!Object.keys){var t=Object.prototype.hasOwnProperty,r=Object.prototype.toString,i=qe(),n=Object.prototype.propertyIsEnumerable,s=!n.call({toString:null},"toString"),o=n.call(function(){},"prototype"),a=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],c=function(e){var t=e.constructor;return t&&t.prototype===e},l={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},u=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!l["$"+e]&&t.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{c(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();e=function(e){var n=null!==e&&"object"==typeof e,l="[object Function]"===r.call(e),h=i(e),f=n&&"[object String]"===r.call(e),d=[];if(!n&&!l&&!h)throw new TypeError("Object.keys called on a non-object");var p=o&&l;if(f&&e.length>0&&!t.call(e,0))for(var g=0;g<e.length;++g)d.push(String(g));if(h&&e.length>0)for(var m=0;m<e.length;++m)d.push(String(m));else for(var y in e)p&&"prototype"===y||!t.call(e,y)||d.push(String(y));if(s)for(var b=function(e){if("undefined"==typeof window||!u)return c(e);try{return c(e)}catch(e){return!1}}(e),w=0;w<a.length;++w)b&&"constructor"===a[w]||!t.call(e,a[w])||d.push(a[w]);return d}}return Le=e}function Ve(){if(Ue)return Me;Ue=1;var e=Array.prototype.slice,t=qe(),r=Object.keys,i=r?function(e){return r(e)}:Qe(),n=Object.keys;return i.shim=function(){if(Object.keys){var r=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);r||(Object.keys=function(r){return t(r)?n(e.call(r)):n(r)})}else Object.keys=i;return Object.keys||i},Me=i}var Ge,He,Je,We,Ke,Ze,Ye,Xe,et,tt,rt,it,nt,st,ot,at,ct,lt,ut,ht,ft,dt,pt,gt,mt,yt,bt,wt,vt,_t,At,kt,Et,It,St,Ot,xt,Rt,Nt,Bt,Ct,jt,Dt,Pt,Lt,Tt,Mt,Ut,Ft,$t,zt,qt,Qt,Vt,Gt,Ht,Jt,Wt,Kt,Zt,Yt,Xt,er,tr,rr,ir,nr,sr,or,ar,cr,lr,ur,hr,fr,dr,pr,gr,mr,yr,br,wr={exports:{}};function vr(){return He?Ge:(He=1,Ge=Object)}function _r(){return We?Je:(We=1,Je=Error)}function Ar(){return Ze?Ke:(Ze=1,Ke=EvalError)}function kr(){return Xe?Ye:(Xe=1,Ye=RangeError)}function Er(){return tt?et:(tt=1,et=ReferenceError)}function Ir(){return it?rt:(it=1,rt=SyntaxError)}function Sr(){return st?nt:(st=1,nt=TypeError)}function Or(){return at?ot:(at=1,ot=URIError)}function xr(){return lt?ct:(lt=1,ct=Math.abs)}function Rr(){return ht?ut:(ht=1,ut=Math.floor)}function Nr(){return dt?ft:(dt=1,ft=Math.max)}function Br(){return gt?pt:(gt=1,pt=Math.min)}function Cr(){return yt?mt:(yt=1,mt=Math.pow)}function jr(){return wt?bt:(wt=1,bt=Math.round)}function Dr(){if(kt)return At;kt=1;var e=_t?vt:(_t=1,vt=Number.isNaN||function(e){return e!=e});return At=function(t){return e(t)||0===t?t:t<0?-1:1}}function Pr(){if(Ot)return St;Ot=1;var e=It?Et:(It=1,Et=Object.getOwnPropertyDescriptor);if(e)try{e([],"length")}catch(t){e=null}return St=e}function Lr(){if(Rt)return xt;Rt=1;var e=Object.defineProperty||!1;if(e)try{e({},"a",{value:1})}catch(t){e=!1}return xt=e}function Tr(){if(jt)return Ct;jt=1;var e="undefined"!=typeof Symbol&&Symbol,t=Bt?Nt:(Bt=1,Nt=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),r=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(r))return!1;for(var i in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var n=Object.getOwnPropertySymbols(e);if(1!==n.length||n[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var s=Object.getOwnPropertyDescriptor(e,t);if(42!==s.value||!0!==s.enumerable)return!1}return!0});return Ct=function(){return"function"==typeof e&&("function"==typeof Symbol&&("symbol"==typeof e("foo")&&("symbol"==typeof Symbol("bar")&&t())))}}function Mr(){return Pt?Dt:(Pt=1,Dt="undefined"!=typeof Reflect&&Reflect.getPrototypeOf||null)}function Ur(){return Tt?Lt:(Tt=1,Lt=vr().getPrototypeOf||null)}function Fr(){if(Ut)return Mt;Ut=1;var e=Object.prototype.toString,t=Math.max,r=function(e,t){for(var r=[],i=0;i<e.length;i+=1)r[i]=e[i];for(var n=0;n<t.length;n+=1)r[n+e.length]=t[n];return r};return Mt=function(i){var n=this;if("function"!=typeof n||"[object Function]"!==e.apply(n))throw new TypeError("Function.prototype.bind called on incompatible "+n);for(var s,o=function(e,t){for(var r=[],i=t,n=0;i<e.length;i+=1,n+=1)r[n]=e[i];return r}(arguments,1),a=t(0,n.length-o.length),c=[],l=0;l<a;l++)c[l]="$"+l;if(s=Function("binder","return function ("+function(e,t){for(var r="",i=0;i<e.length;i+=1)r+=e[i],i+1<e.length&&(r+=t);return r}(c,",")+"){ return binder.apply(this,arguments); }")(function(){if(this instanceof s){var e=n.apply(this,r(o,arguments));return Object(e)===e?e:this}return n.apply(i,r(o,arguments))}),n.prototype){var u=function(){};u.prototype=n.prototype,s.prototype=new u,u.prototype=null}return s},Mt}function $r(){if($t)return Ft;$t=1;var e=Fr();return Ft=Function.prototype.bind||e}function zr(){return qt?zt:(qt=1,zt=Function.prototype.call)}function qr(){return Vt?Qt:(Vt=1,Qt=Function.prototype.apply)}function Qr(){if(Wt)return Jt;Wt=1;var e=$r(),t=qr(),r=zr(),i=Ht?Gt:(Ht=1,Gt="undefined"!=typeof Reflect&&Reflect&&Reflect.apply);return Jt=i||e.call(r,t)}function Vr(){if(Zt)return Kt;Zt=1;var e=$r(),t=Sr(),r=zr(),i=Qr();return Kt=function(n){if(n.length<1||"function"!=typeof n[0])throw new t("a function is required");return i(e,r,n)}}function Gr(){if(Xt)return Yt;Xt=1;var e,t=Vr(),r=Pr();try{e=[].__proto__===Array.prototype}catch(e){if(!e||"object"!=typeof e||!("code"in e)||"ERR_PROTO_ACCESS"!==e.code)throw e}var i=!!e&&r&&r(Object.prototype,"__proto__"),n=Object,s=n.getPrototypeOf;return Yt=i&&"function"==typeof i.get?t([i.get]):"function"==typeof s&&function(e){return s(null==e?e:n(e))}}function Hr(){if(tr)return er;tr=1;var e=Mr(),t=Ur(),r=Gr();return er=e?function(t){return e(t)}:t?function(e){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new TypeError("getProto: not an object");return t(e)}:r?function(e){return r(e)}:null}function Jr(){if(ir)return rr;ir=1;var e=Function.prototype.call,t=Object.prototype.hasOwnProperty,r=$r();return rr=r.call(e,t)}function Wr(){if(sr)return nr;var e;sr=1;var t=vr(),r=_r(),i=Ar(),n=kr(),s=Er(),o=Ir(),a=Sr(),c=Or(),l=xr(),u=Rr(),h=Nr(),f=Br(),d=Cr(),p=jr(),g=Dr(),m=Function,y=function(e){try{return m('"use strict"; return ('+e+").constructor;")()}catch(e){}},b=Pr(),w=Lr(),v=function(){throw new a},_=b?function(){try{return v}catch(e){try{return b(arguments,"callee").get}catch(e){return v}}}():v,A=Tr()(),k=Hr(),E=Ur(),I=Mr(),S=qr(),O=zr(),x={},R="undefined"!=typeof Uint8Array&&k?k(Uint8Array):e,N={__proto__:null,"%AggregateError%":"undefined"==typeof AggregateError?e:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?e:ArrayBuffer,"%ArrayIteratorPrototype%":A&&k?k([][Symbol.iterator]()):e,"%AsyncFromSyncIteratorPrototype%":e,"%AsyncFunction%":x,"%AsyncGenerator%":x,"%AsyncGeneratorFunction%":x,"%AsyncIteratorPrototype%":x,"%Atomics%":"undefined"==typeof Atomics?e:Atomics,"%BigInt%":"undefined"==typeof BigInt?e:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?e:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?e:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?e:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":r,"%eval%":eval,"%EvalError%":i,"%Float16Array%":"undefined"==typeof Float16Array?e:Float16Array,"%Float32Array%":"undefined"==typeof Float32Array?e:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?e:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?e:FinalizationRegistry,"%Function%":m,"%GeneratorFunction%":x,"%Int8Array%":"undefined"==typeof Int8Array?e:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?e:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?e:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":A&&k?k(k([][Symbol.iterator]())):e,"%JSON%":"object"==typeof JSON?JSON:e,"%Map%":"undefined"==typeof Map?e:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&A&&k?k((new Map)[Symbol.iterator]()):e,"%Math%":Math,"%Number%":Number,"%Object%":t,"%Object.getOwnPropertyDescriptor%":b,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?e:Promise,"%Proxy%":"undefined"==typeof Proxy?e:Proxy,"%RangeError%":n,"%ReferenceError%":s,"%Reflect%":"undefined"==typeof Reflect?e:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?e:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&A&&k?k((new Set)[Symbol.iterator]()):e,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?e:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":A&&k?k(""[Symbol.iterator]()):e,"%Symbol%":A?Symbol:e,"%SyntaxError%":o,"%ThrowTypeError%":_,"%TypedArray%":R,"%TypeError%":a,"%Uint8Array%":"undefined"==typeof Uint8Array?e:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?e:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?e:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?e:Uint32Array,"%URIError%":c,"%WeakMap%":"undefined"==typeof WeakMap?e:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?e:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?e:WeakSet,"%Function.prototype.call%":O,"%Function.prototype.apply%":S,"%Object.defineProperty%":w,"%Object.getPrototypeOf%":E,"%Math.abs%":l,"%Math.floor%":u,"%Math.max%":h,"%Math.min%":f,"%Math.pow%":d,"%Math.round%":p,"%Math.sign%":g,"%Reflect.getPrototypeOf%":I};if(k)try{null.error}catch(e){var B=k(k(e));N["%Error.prototype%"]=B}var C=function e(t){var r;if("%AsyncFunction%"===t)r=y("async function () {}");else if("%GeneratorFunction%"===t)r=y("function* () {}");else if("%AsyncGeneratorFunction%"===t)r=y("async function* () {}");else if("%AsyncGenerator%"===t){var i=e("%AsyncGeneratorFunction%");i&&(r=i.prototype)}else if("%AsyncIteratorPrototype%"===t){var n=e("%AsyncGenerator%");n&&k&&(r=k(n.prototype))}return N[t]=r,r},j={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},D=$r(),P=Jr(),L=D.call(O,Array.prototype.concat),T=D.call(S,Array.prototype.splice),M=D.call(O,String.prototype.replace),U=D.call(O,String.prototype.slice),F=D.call(O,RegExp.prototype.exec),$=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,z=/\\(\\)?/g,q=function(e,t){var r,i=e;if(P(j,i)&&(i="%"+(r=j[i])[0]+"%"),P(N,i)){var n=N[i];if(n===x&&(n=C(i)),void 0===n&&!t)throw new a("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:r,name:i,value:n}}throw new o("intrinsic "+e+" does not exist!")};return nr=function(e,t){if("string"!=typeof e||0===e.length)throw new a("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new a('"allowMissing" argument must be a boolean');if(null===F(/^%?[^%]*%?$/,e))throw new o("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var r=function(e){var t=U(e,0,1),r=U(e,-1);if("%"===t&&"%"!==r)throw new o("invalid intrinsic syntax, expected closing `%`");if("%"===r&&"%"!==t)throw new o("invalid intrinsic syntax, expected opening `%`");var i=[];return M(e,$,function(e,t,r,n){i[i.length]=r?M(n,z,"$1"):t||e}),i}(e),i=r.length>0?r[0]:"",n=q("%"+i+"%",t),s=n.name,c=n.value,l=!1,u=n.alias;u&&(i=u[0],T(r,L([0,1],u)));for(var h=1,f=!0;h<r.length;h+=1){var d=r[h],p=U(d,0,1),g=U(d,-1);if(('"'===p||"'"===p||"`"===p||'"'===g||"'"===g||"`"===g)&&p!==g)throw new o("property names with quotes must have matching quotes");if("constructor"!==d&&f||(l=!0),P(N,s="%"+(i+="."+d)+"%"))c=N[s];else if(null!=c){if(!(d in c)){if(!t)throw new a("base intrinsic for "+e+" exists, but the property is not available.");return}if(b&&h+1>=r.length){var m=b(c,d);c=(f=!!m)&&"get"in m&&!("originalValue"in m.get)?m.get:c[d]}else f=P(c,d),c=c[d];f&&!l&&(N[s]=c)}}return c},nr}function Kr(){if(ar)return or;ar=1;var e=Lr(),t=Ir(),r=Sr(),i=Pr();return or=function(n,s,o){if(!n||"object"!=typeof n&&"function"!=typeof n)throw new r("`obj` must be an object or a function`");if("string"!=typeof s&&"symbol"!=typeof s)throw new r("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new r("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new r("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new r("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new r("`loose`, if provided, must be a boolean");var a=arguments.length>3?arguments[3]:null,c=arguments.length>4?arguments[4]:null,l=arguments.length>5?arguments[5]:null,u=arguments.length>6&&arguments[6],h=!!i&&i(n,s);if(e)e(n,s,{configurable:null===l&&h?h.configurable:!l,enumerable:null===a&&h?h.enumerable:!a,value:o,writable:null===c&&h?h.writable:!c});else{if(!u&&(a||c||l))throw new t("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");n[s]=o}},or}function Zr(){if(lr)return cr;lr=1;var e=Lr(),t=function(){return!!e};return t.hasArrayLengthDefineBug=function(){if(!e)return null;try{return 1!==e([],"length",{value:1}).length}catch(e){return!0}},cr=t}function Yr(){if(hr)return ur;hr=1;var e=Wr(),t=Kr(),r=Zr()(),i=Pr(),n=Sr(),s=e("%Math.floor%");return ur=function(e,o){if("function"!=typeof e)throw new n("`fn` is not a function");if("number"!=typeof o||o<0||o>4294967295||s(o)!==o)throw new n("`length` must be a positive 32-bit integer");var a=arguments.length>2&&!!arguments[2],c=!0,l=!0;if("length"in e&&i){var u=i(e,"length");u&&!u.configurable&&(c=!1),u&&!u.writable&&(l=!1)}return(c||l||!a)&&(r?t(e,"length",o,!0,!0):t(e,"length",o)),e},ur}function Xr(){if(dr)return fr;dr=1;var e=$r(),t=qr(),r=Qr();return fr=function(){return r(e,t,arguments)},fr}function ei(){return pr||(pr=1,function(e){var t=Yr(),r=Lr(),i=Vr(),n=Xr();e.exports=function(e){var r=i(arguments),n=e.length-(arguments.length-1);return t(r,1+(n>0?n:0),!0)},r?r(e.exports,"apply",{value:n}):e.exports.apply=n}(wr)),wr.exports}function ti(){if(mr)return gr;mr=1;var e=Wr(),t=Vr(),r=t([e("%String.prototype.indexOf%")]);return gr=function(i,n){var s=e(i,!!n);return"function"==typeof s&&r(i,".prototype.")>-1?t([s]):s}}var ri=function(){if(br)return yr;br=1;var e=("undefined"!=typeof JSON?JSON:(Be||(Be=1,Fe.parse=$e(),Fe.stringify=ze()),Fe)).stringify,t=function(){if(je)return Ce;je=1;var e={}.toString;return Ce=Array.isArray||function(t){return"[object Array]"==e.call(t)}}(),r=Ve(),i=ei(),n=ti(),s=n("Array.prototype.join"),o=n("Array.prototype.indexOf"),a=n("Array.prototype.splice"),c=n("Array.prototype.sort"),l=function(e,t){for(var r="",i=0;i<e;i+=1)r+=t;return r},u=function(e,t,r){return r};return yr=function(n){var h=arguments.length>1?arguments[1]:void 0,f=h&&h.space||"";"number"==typeof f&&(f=l(f," "));var d=!!h&&"boolean"==typeof h.cycles&&h.cycles,p=h&&h.replacer?i(h.replacer):u;if(h&&void 0!==h.collapseEmpty&&"boolean"!=typeof h.collapseEmpty)throw new TypeError("`collapseEmpty` must be a boolean, if provided");var g=!!h&&h.collapseEmpty,m="function"==typeof h?h:h&&h.cmp,y=m&&function(e){var t=m.length>2&&function(t){return e[t]};return function(r,i){return m({key:r,value:e[r]},{key:i,value:e[i]},t?{__proto__:null,get:t}:void 0)}},b=[];return function i(n,u,h,m){var w=f?"\n"+l(m,f):"",v=f?": ":":";if(h&&h.toJSON&&"function"==typeof h.toJSON&&(h=h.toJSON()),void 0!==(h=p(n,u,h))){if("object"!=typeof h||null===h)return e(h);var _=function(e,t){return g&&0===e.length?t:("[]"===t?"[":"{")+s(e,",")+w+("[]"===t?"]":"}")};if(t(h)){for(var A=[],k=0;k<h.length;k++){var E=i(h,k,h[k],m+1)||e(null);A[A.length]=w+f+E}return _(A,"[]")}if(-1!==o(b,h)){if(d)return e("__cycle__");throw new TypeError("Converting circular structure to JSON")}b[b.length]=h;var I=c(r(h),y&&y(h));for(A=[],k=0;k<I.length;k++){var S=i(h,u=I[k],h[u],m+1);if(S){var O=e(u)+v+S;A[A.length]=w+f+O}}return a(b,o(b,h),1),_(A,"{}")}}({"":n},"",n,0)},yr}(),ii=Se(ri);async function ni(e,t,r){if(!this.passphrase)return t.push(new te("Missing configuration for secrets encryption.",{actual:e,type:"encryptionKeyMissing",suggestion:"Provide a passphrase for secret encryption."})),e;const[i,n,s]=await x(()=>ke(String(e),this.passphrase));return i?s:(t.push(new te("Problem encrypting secret.",{actual:e,type:"encryptionProblem",error:n,suggestion:"Check the passphrase and input value."})),e)}async function si(t,r,i){if(e.isString(t))return t;const[n,s,o]=R(()=>JSON.stringify(t));if(!n)throw new te("Failed to stringify JSON",{original:s,input:t});return o}class oi extends o{constructor({options:t,passphrase:r,autoEncrypt:i=!0}={}){super(e.merge({},{useNewCustomCheckerFunction:!0,messages:{encryptionKeyMissing:"Missing configuration for secrets encryption.",encryptionProblem:"Problem encrypting secret. Actual: {actual}. Error: {error}"},defaults:{string:{trim:!0},object:{strict:"remove"},number:{convert:!0}}},t)),this.passphrase=r,this.autoEncrypt=i,this.alias("secret",{type:"string",custom:this.autoEncrypt?ni:void 0,messages:{string:"The '{field}' field must be a string.",stringMin:"This secret '{field}' field length must be at least {expected} long."}}),this.alias("secretAny",{type:"any",custom:this.autoEncrypt?ni:void 0}),this.alias("secretNumber",{type:"number",custom:this.autoEncrypt?ni:void 0}),this.alias("json",{type:"any",custom:this.autoEncrypt?si:void 0})}}const ai=new Proxy(oi,{instance:null,construct(e,t){return this.instance||(this.instance=new e(...t)),this.instance}}),ci="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",li=Object.fromEntries([...ci].map((e,t)=>[e,t])),ui=e=>{if("number"!=typeof e||isNaN(e))return"undefined";if(!isFinite(e))return"undefined";if(0===e)return ci[0];if(e<0)return"-"+ui(-Math.floor(e));e=Math.floor(e);let t="";for(;e;)t=ci[e%62]+t,e=Math.floor(e/62);return t},hi=e=>{if("string"!=typeof e)return NaN;if(""===e)return 0;let t=!1;"-"===e[0]&&(t=!0,e=e.slice(1));let r=0;for(let t=0;t<e.length;t++){const i=li[e[t]];if(void 0===i)return NaN;r=62*r+i}return t?-r:r},fi=e=>{if("number"!=typeof e||isNaN(e))return"undefined";if(!isFinite(e))return"undefined";const t=e<0;e=Math.abs(e);const[r,i]=e.toString().split("."),n=ui(Number(r));return i?(t?"-":"")+n+"."+i:(t?"-":"")+n},di=e=>{if("string"!=typeof e)return NaN;let t=!1;"-"===e[0]&&(t=!0,e=e.slice(1));const[r,i]=e.split("."),n=hi(r);if(isNaN(n))return NaN;const s=i?Number(n+"."+i):n;return t?-s:s};const pi={trim:e=>null==e?e:e.trim(),encrypt:async(e,{passphrase:t})=>{if(null==e)return e;const[r,i,n]=await x(()=>ke(e,t));return r?n:e},decrypt:async(e,{passphrase:t})=>{if(null==e)return e;const[r,i,n]=await x(()=>Ee(e,t));return r?"null"===n?null:"undefined"!==n?n:void 0:e},toString:e=>null==e?e:String(e),fromArray:(e,{separator:t})=>{if(null==e||!Array.isArray(e))return e;if(0===e.length)return"";return e.map(e=>"string"==typeof e?e.replace(/\\/g,"\\\\").replace(new RegExp(`\\${t}`,"g"),`\\${t}`):String(e)).join(t)},toArray:(e,{separator:t})=>{if(Array.isArray(e))return e;if(null==e)return e;if(""===e)return[];const r=[];let i="",n=0;const s=String(e);for(;n<s.length;)"\\"===s[n]&&n+1<s.length?(i+=s[n+1],n+=2):s[n]===t?(r.push(i),i="",n++):(i+=s[n],n++);return r.push(i),r},toJSON:e=>{if(null===e)return null;if(void 0===e)return;if("string"==typeof e){const[t,r,i]=R(()=>JSON.parse(e));return e}const[t,r,i]=R(()=>JSON.stringify(e));return t?i:e},fromJSON:e=>{if(null===e)return null;if(void 0===e)return;if("string"!=typeof e)return e;if(""===e)return"";const[t,r,i]=R(()=>JSON.parse(e));return t?i:e},toNumber:t=>e.isString(t)?t.includes(".")?parseFloat(t):parseInt(t):t,toBool:e=>[!0,1,"true","1","yes","y"].includes(e),fromBool:e=>[!0,1,"true","1","yes","y"].includes(e)?"1":"0",fromBase62:e=>{if(null==e||""===e)return e;if("number"==typeof e)return e;if("string"==typeof e){const t=hi(e);return isNaN(t)?void 0:t}},toBase62:e=>{if(null==e||""===e)return e;if("number"==typeof e)return ui(e);if("string"==typeof e){const t=Number(e);return isNaN(t)?e:ui(t)}return e},fromBase62Decimal:e=>{if(null==e||""===e)return e;if("number"==typeof e)return e;if("string"==typeof e){const t=di(e);return isNaN(t)?void 0:t}},toBase62Decimal:e=>{if(null==e||""===e)return e;if("number"==typeof e)return fi(e);if("string"==typeof e){const t=Number(e);return isNaN(t)?e:fi(t)}return e},fromArrayOfNumbers:(e,{separator:t})=>{if(null==e||!Array.isArray(e))return e;if(0===e.length)return"";return e.map(e=>{if("number"==typeof e&&!isNaN(e))return ui(e);const t=Number(e);return isNaN(t)?"":ui(t)}).join(t)},toArrayOfNumbers:(e,{separator:t})=>{if(Array.isArray(e))return e.map(e=>"number"==typeof e?e:hi(e));if(null==e)return e;if(""===e)return[];const r=String(e),i=[];let n="",s=0;for(;s<r.length;)"\\"===r[s]&&s+1<r.length?(n+=r[s+1],s+=2):r[s]===t?(i.push(n),n="",s++):(n+=r[s],s++);return i.push(n),i.map(e=>{if("number"==typeof e)return e;if("string"==typeof e&&""!==e){const t=hi(e);return isNaN(t)?NaN:t}return NaN})},fromArrayOfDecimals:(e,{separator:t})=>{if(null==e||!Array.isArray(e))return e;if(0===e.length)return"";return e.map(e=>{if("number"==typeof e&&!isNaN(e))return fi(e);const t=Number(e);return isNaN(t)?"":fi(t)}).join(t)},toArrayOfDecimals:(e,{separator:t})=>{if(Array.isArray(e))return e.map(e=>"number"==typeof e?e:di(e));if(null==e)return e;if(""===e)return[];const r=String(e),i=[];let n="",s=0;for(;s<r.length;)"\\"===r[s]&&s+1<r.length?(n+=r[s+1],s+=2):r[s]===t?(i.push(n),n="",s++):(n+=r[s],s++);return i.push(n),i.map(e=>{if("number"==typeof e)return e;if("string"==typeof e&&""!==e){const t=di(e);return isNaN(t)?NaN:t}return NaN})}};class gi{constructor(t){const{map:r,name:i,attributes:n,passphrase:o,version:a=1,options:c={}}=t;this.name=i,this.version=a,this.attributes=n||{},this.passphrase=o??"secret",this.options=e.merge({},this.defaultOptions(),c),this.allNestedObjectsOptional=this.options.allNestedObjectsOptional??!1;const l=this.preprocessAttributesForValidation(this.attributes);if(this.validator=new ai({autoEncrypt:!1}).compile(e.merge({$$async:!0},l)),this.options.generateAutoHooks&&this.generateAutoHooks(),e.isEmpty(r)){const e=s.flatten(this.attributes,{safe:!0}),t=Object.keys(e).filter(e=>!e.includes("$$")),r=this.extractObjectKeys(this.attributes),i=[...new Set([...t,...r])],{mapping:n,reversedMapping:o}=function(e){const t={},r={};return e.forEach((e,i)=>{const n=ui(i);t[e]=n,r[n]=e}),{mapping:t,reversedMapping:r}}(i);this.map=n,this.reversedMap=o}else this.map=r,this.reversedMap=e.invert(r)}defaultOptions(){return{autoEncrypt:!0,autoDecrypt:!0,arraySeparator:"|",generateAutoHooks:!0,hooks:{beforeMap:{},afterMap:{},beforeUnmap:{},afterUnmap:{}}}}addHook(t,r,i){this.options.hooks[t][r]||(this.options.hooks[t][r]=[]),this.options.hooks[t][r]=e.uniq([...this.options.hooks[t][r],i])}extractObjectKeys(e,t=""){const r=[];for(const[i,n]of Object.entries(e)){if(i.startsWith("$$"))continue;const e=t?`${t}.${i}`:i;"object"!=typeof n||null===n||Array.isArray(n)||(r.push(e),"object"===n.$$type&&r.push(...this.extractObjectKeys(n,e)))}return r}generateAutoHooks(){const t=s.flatten(e.cloneDeep(this.attributes),{safe:!0});for(const[e,r]of Object.entries(t))if(r.includes("array")){if(r.includes("items:string"))this.addHook("beforeMap",e,"fromArray"),this.addHook("afterUnmap",e,"toArray");else if(r.includes("items:number")){r.includes("integer:true")||r.includes("|integer:")||r.includes("|integer")?(this.addHook("beforeMap",e,"fromArrayOfNumbers"),this.addHook("afterUnmap",e,"toArrayOfNumbers")):(this.addHook("beforeMap",e,"fromArrayOfDecimals"),this.addHook("afterUnmap",e,"toArrayOfDecimals"))}}else if(r.includes("secret"))this.options.autoEncrypt&&this.addHook("beforeMap",e,"encrypt"),this.options.autoDecrypt&&this.addHook("afterUnmap",e,"decrypt");else{if(r.includes("number")){r.includes("integer:true")||r.includes("|integer:")||r.includes("|integer")?(this.addHook("beforeMap",e,"toBase62"),this.addHook("afterUnmap",e,"fromBase62")):(this.addHook("beforeMap",e,"toBase62Decimal"),this.addHook("afterUnmap",e,"fromBase62Decimal"));continue}r.includes("boolean")?(this.addHook("beforeMap",e,"fromBool"),this.addHook("afterUnmap",e,"toBool")):(r.includes("json")||"object"===r||r.includes("object"))&&(this.addHook("beforeMap",e,"toJSON"),this.addHook("afterUnmap",e,"fromJSON"))}}static import(t){let{map:r,name:i,options:n,version:s,attributes:o}=e.isString(t)?JSON.parse(t):t;const[a,c,l]=R(()=>gi._importAttributes(o));if(!a)throw new pe("Failed to import schema attributes",{original:c,input:o});o=l;return new gi({map:r,name:i,options:n,version:s,attributes:o})}static _importAttributes(e){if("string"==typeof e){const[t,r,i]=R(()=>JSON.parse(e));if(t&&"object"==typeof i&&null!==i){const[t,r,n]=R(()=>gi._importAttributes(i));if(!t)throw new pe("Failed to parse nested schema attribute",{original:r,input:e});return n}return e}if(Array.isArray(e)){const[t,r,i]=R(()=>e.map(e=>gi._importAttributes(e)));if(!t)throw new pe("Failed to import array schema attributes",{original:r,input:e});return i}if("object"==typeof e&&null!==e){const t={};for(const[r,i]of Object.entries(e)){const[e,n,s]=R(()=>gi._importAttributes(i));if(!e)throw new pe("Failed to import object schema attribute",{original:n,key:r,input:i});t[r]=s}return t}return e}export(){return{version:this.version,name:this.name,options:this.options,attributes:this._exportAttributes(this.attributes),map:this.map}}_exportAttributes(e){if("string"==typeof e)return e;if(Array.isArray(e))return e.map(e=>this._exportAttributes(e));if("object"==typeof e&&null!==e){const t={};for(const[r,i]of Object.entries(e))t[r]=this._exportAttributes(i);return t}return e}async applyHooksActions(t,r){const i=e.cloneDeep(t);for(const[t,n]of Object.entries(this.options.hooks[r]))for(const r of n){const n=e.get(i,t);void 0!==n&&"function"==typeof pi[r]&&e.set(i,t,await pi[r](n,{passphrase:this.passphrase,separator:this.options.arraySeparator}))}return i}async validate(t,{mutateOriginal:r=!1}={}){let i=r?t:e.cloneDeep(t);return await this.validator(i)}async mapper(t){let r=e.cloneDeep(t);r=await this.applyHooksActions(r,"beforeMap");const i=s.flatten(r,{safe:!0}),n={_v:this.version+""};for(const[e,t]of Object.entries(i)){const r=this.map[e]||e,i=this.getAttributeDefinition(e);"number"==typeof t&&"string"==typeof i&&i.includes("number")?n[r]=ui(t):"string"==typeof t?"[object Object]"===t?n[r]="{}":(t.startsWith("{")||t.startsWith("["),n[r]=t):Array.isArray(t)||"object"==typeof t&&null!==t?n[r]=JSON.stringify(t):n[r]=t}return await this.applyHooksActions(n,"afterMap"),n}async unmapper(t,r){let i=e.cloneDeep(t);delete i._v,i=await this.applyHooksActions(i,"beforeUnmap");const n=r?e.invert(r):this.reversedMap,o={};for(const[e,t]of Object.entries(i)){const r=n&&n[e]?n[e]:e;let i=t;const s=this.getAttributeDefinition(r);if("string"!=typeof s||!s.includes("number")||s.includes("array")||s.includes("decimal")){if("string"==typeof t)if("[object Object]"===t)i={};else if(t.startsWith("{")||t.startsWith("[")){const[e,r,n]=R(()=>JSON.parse(t));e&&(i=n)}}else"string"==typeof i&&""!==i?i=hi(i):"number"==typeof i||(i=void 0);if(this.attributes&&"string"==typeof s&&s.includes("array"))if(Array.isArray(i));else if("string"==typeof i&&i.trim().startsWith("[")){const[e,t,r]=R(()=>JSON.parse(i));e&&Array.isArray(r)&&(i=r)}else i=pi.toArray(i,{separator:this.options.arraySeparator});if(this.options.hooks&&this.options.hooks.afterUnmap&&this.options.hooks.afterUnmap[r])for(const e of this.options.hooks.afterUnmap[r])"function"==typeof pi[e]&&(i=await pi[e](i,{passphrase:this.passphrase,separator:this.options.arraySeparator}));o[r]=i}await this.applyHooksActions(o,"afterUnmap");const a=s.unflatten(o);for(const[e,r]of Object.entries(t))e.startsWith("$")&&(a[e]=r);return a}getAttributeDefinition(e){const t=e.split(".");let r=this.attributes;for(const e of t){if(!r)return;r=r[e]}return r}preprocessAttributesForValidation(e){const t={};for(const[r,i]of Object.entries(e))if("object"!=typeof i||null===i||Array.isArray(i))t[r]=i;else{const e=i.$$type&&i.$$type.includes("required"),n=i.$$type&&i.$$type.includes("optional"),s={type:"object",properties:this.preprocessAttributesForValidation(i),strict:!1};e||(n||this.allNestedObjectsOptional)&&(s.optional=!0),t[r]=s}return t}}var mi=[],yi=[],bi="undefined"!=typeof Uint8Array?Uint8Array:Array,wi=!1;function vi(){wi=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)mi[t]=e[t],yi[e.charCodeAt(t)]=t;yi["-".charCodeAt(0)]=62,yi["_".charCodeAt(0)]=63}function _i(e){return mi[e>>18&63]+mi[e>>12&63]+mi[e>>6&63]+mi[63&e]}function Ai(e,t,r){for(var i,n=[],s=t;s<r;s+=3)i=(e[s]<<16)+(e[s+1]<<8)+e[s+2],n.push(_i(i));return n.join("")}function ki(e){var t;wi||vi();for(var r=e.length,i=r%3,n="",s=[],o=16383,a=0,c=r-i;a<c;a+=o)s.push(Ai(e,a,a+o>c?c:a+o));return 1===i?(t=e[r-1],n+=mi[t>>2],n+=mi[t<<4&63],n+="=="):2===i&&(t=(e[r-2]<<8)+e[r-1],n+=mi[t>>10],n+=mi[t>>4&63],n+=mi[t<<2&63],n+="="),s.push(n),s.join("")}function Ei(e,t,r,i,n){var s,o,a=8*n-i-1,c=(1<<a)-1,l=c>>1,u=-7,h=r?n-1:0,f=r?-1:1,d=e[t+h];for(h+=f,s=d&(1<<-u)-1,d>>=-u,u+=a;u>0;s=256*s+e[t+h],h+=f,u-=8);for(o=s&(1<<-u)-1,s>>=-u,u+=i;u>0;o=256*o+e[t+h],h+=f,u-=8);if(0===s)s=1-l;else{if(s===c)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,i),s-=l}return(d?-1:1)*o*Math.pow(2,s-i)}function Ii(e,t,r,i,n,s){var o,a,c,l=8*s-n-1,u=(1<<l)-1,h=u>>1,f=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,d=i?0:s-1,p=i?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=u):(o=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-o))<1&&(o--,c*=2),(t+=o+h>=1?f/c:f*Math.pow(2,1-h))*c>=2&&(o++,c/=2),o+h>=u?(a=0,o=u):o+h>=1?(a=(t*c-1)*Math.pow(2,n),o+=h):(a=t*Math.pow(2,h-1)*Math.pow(2,n),o=0));n>=8;e[r+d]=255&a,d+=p,a/=256,n-=8);for(o=o<<n|a,l+=n;l>0;e[r+d]=255&o,d+=p,o/=256,l-=8);e[r+d-p]|=128*g}var Si={}.toString,Oi=Array.isArray||function(e){return"[object Array]"==Si.call(e)};function xi(){return Ni.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function Ri(e,t){if(xi()<t)throw new RangeError("Invalid typed array length");return Ni.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=Ni.prototype:(null===e&&(e=new Ni(t)),e.length=t),e}function Ni(e,t,r){if(!(Ni.TYPED_ARRAY_SUPPORT||this instanceof Ni))return new Ni(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return ji(this,e)}return Bi(this,e,t,r)}function Bi(e,t,r,i){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,r,i){if(t.byteLength,r<0||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(i||0))throw new RangeError("'length' is out of bounds");t=void 0===r&&void 0===i?new Uint8Array(t):void 0===i?new Uint8Array(t,r):new Uint8Array(t,r,i);Ni.TYPED_ARRAY_SUPPORT?(e=t).__proto__=Ni.prototype:e=Di(e,t);return e}(e,t,r,i):"string"==typeof t?function(e,t,r){"string"==typeof r&&""!==r||(r="utf8");if(!Ni.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var i=0|Ti(t,r);e=Ri(e,i);var n=e.write(t,r);n!==i&&(e=e.slice(0,n));return e}(e,t,r):function(e,t){if(Li(t)){var r=0|Pi(t.length);return 0===(e=Ri(e,r)).length||t.copy(e,0,0,r),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(i=t.length)!=i?Ri(e,0):Di(e,t);if("Buffer"===t.type&&Oi(t.data))return Di(e,t.data)}var i;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function Ci(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function ji(e,t){if(Ci(t),e=Ri(e,t<0?0:0|Pi(t)),!Ni.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function Di(e,t){var r=t.length<0?0:0|Pi(t.length);e=Ri(e,r);for(var i=0;i<r;i+=1)e[i]=255&t[i];return e}function Pi(e){if(e>=xi())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+xi().toString(16)+" bytes");return 0|e}function Li(e){return!(null==e||!e._isBuffer)}function Ti(e,t){if(Li(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return hn(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return fn(e).length;default:if(i)return hn(e).length;t=(""+t).toLowerCase(),i=!0}}function Mi(e,t,r){var i=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return Xi(this,t,r);case"utf8":case"utf-8":return Wi(this,t,r);case"ascii":return Zi(this,t,r);case"latin1":case"binary":return Yi(this,t,r);case"base64":return Ji(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return en(this,t,r);default:if(i)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),i=!0}}function Ui(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function Fi(e,t,r,i,n){if(0===e.length)return-1;if("string"==typeof r?(i=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=n?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(n)return-1;r=e.length-1}else if(r<0){if(!n)return-1;r=0}if("string"==typeof t&&(t=Ni.from(t,i)),Li(t))return 0===t.length?-1:$i(e,t,r,i,n);if("number"==typeof t)return t&=255,Ni.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):$i(e,[t],r,i,n);throw new TypeError("val must be string, number or Buffer")}function $i(e,t,r,i,n){var s,o=1,a=e.length,c=t.length;if(void 0!==i&&("ucs2"===(i=String(i).toLowerCase())||"ucs-2"===i||"utf16le"===i||"utf-16le"===i)){if(e.length<2||t.length<2)return-1;o=2,a/=2,c/=2,r/=2}function l(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(n){var u=-1;for(s=r;s<a;s++)if(l(e,s)===l(t,-1===u?0:s-u)){if(-1===u&&(u=s),s-u+1===c)return u*o}else-1!==u&&(s-=s-u),u=-1}else for(r+c>a&&(r=a-c),s=r;s>=0;s--){for(var h=!0,f=0;f<c;f++)if(l(e,s+f)!==l(t,f)){h=!1;break}if(h)return s}return-1}function zi(e,t,r,i){r=Number(r)||0;var n=e.length-r;i?(i=Number(i))>n&&(i=n):i=n;var s=t.length;if(s%2!=0)throw new TypeError("Invalid hex string");i>s/2&&(i=s/2);for(var o=0;o<i;++o){var a=parseInt(t.substr(2*o,2),16);if(isNaN(a))return o;e[r+o]=a}return o}function qi(e,t,r,i){return dn(hn(t,e.length-r),e,r,i)}function Qi(e,t,r,i){return dn(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,i)}function Vi(e,t,r,i){return Qi(e,t,r,i)}function Gi(e,t,r,i){return dn(fn(t),e,r,i)}function Hi(e,t,r,i){return dn(function(e,t){for(var r,i,n,s=[],o=0;o<e.length&&!((t-=2)<0);++o)i=(r=e.charCodeAt(o))>>8,n=r%256,s.push(n),s.push(i);return s}(t,e.length-r),e,r,i)}function Ji(e,t,r){return 0===t&&r===e.length?ki(e):ki(e.slice(t,r))}function Wi(e,t,r){r=Math.min(e.length,r);for(var i=[],n=t;n<r;){var s,o,a,c,l=e[n],u=null,h=l>239?4:l>223?3:l>191?2:1;if(n+h<=r)switch(h){case 1:l<128&&(u=l);break;case 2:128==(192&(s=e[n+1]))&&(c=(31&l)<<6|63&s)>127&&(u=c);break;case 3:s=e[n+1],o=e[n+2],128==(192&s)&&128==(192&o)&&(c=(15&l)<<12|(63&s)<<6|63&o)>2047&&(c<55296||c>57343)&&(u=c);break;case 4:s=e[n+1],o=e[n+2],a=e[n+3],128==(192&s)&&128==(192&o)&&128==(192&a)&&(c=(15&l)<<18|(63&s)<<12|(63&o)<<6|63&a)>65535&&c<1114112&&(u=c)}null===u?(u=65533,h=1):u>65535&&(u-=65536,i.push(u>>>10&1023|55296),u=56320|1023&u),i.push(u),n+=h}return function(e){var t=e.length;if(t<=Ki)return String.fromCharCode.apply(String,e);var r="",i=0;for(;i<t;)r+=String.fromCharCode.apply(String,e.slice(i,i+=Ki));return r}(i)}Ni.TYPED_ARRAY_SUPPORT=void 0===B.TYPED_ARRAY_SUPPORT||B.TYPED_ARRAY_SUPPORT,xi(),Ni.poolSize=8192,Ni._augment=function(e){return e.__proto__=Ni.prototype,e},Ni.from=function(e,t,r){return Bi(null,e,t,r)},Ni.TYPED_ARRAY_SUPPORT&&(Ni.prototype.__proto__=Uint8Array.prototype,Ni.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&Ni[Symbol.species]),Ni.alloc=function(e,t,r){return function(e,t,r,i){return Ci(t),t<=0?Ri(e,t):void 0!==r?"string"==typeof i?Ri(e,t).fill(r,i):Ri(e,t).fill(r):Ri(e,t)}(null,e,t,r)},Ni.allocUnsafe=function(e){return ji(null,e)},Ni.allocUnsafeSlow=function(e){return ji(null,e)},Ni.isBuffer=function(e){return null!=e&&(!!e._isBuffer||pn(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&pn(e.slice(0,0))}(e))},Ni.compare=function(e,t){if(!Li(e)||!Li(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,i=t.length,n=0,s=Math.min(r,i);n<s;++n)if(e[n]!==t[n]){r=e[n],i=t[n];break}return r<i?-1:i<r?1:0},Ni.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Ni.concat=function(e,t){if(!Oi(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return Ni.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var i=Ni.allocUnsafe(t),n=0;for(r=0;r<e.length;++r){var s=e[r];if(!Li(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(i,n),n+=s.length}return i},Ni.byteLength=Ti,Ni.prototype._isBuffer=!0,Ni.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)Ui(this,t,t+1);return this},Ni.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)Ui(this,t,t+3),Ui(this,t+1,t+2);return this},Ni.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)Ui(this,t,t+7),Ui(this,t+1,t+6),Ui(this,t+2,t+5),Ui(this,t+3,t+4);return this},Ni.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?Wi(this,0,e):Mi.apply(this,arguments)},Ni.prototype.equals=function(e){if(!Li(e))throw new TypeError("Argument must be a Buffer");return this===e||0===Ni.compare(this,e)},Ni.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},Ni.prototype.compare=function(e,t,r,i,n){if(!Li(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===i&&(i=0),void 0===n&&(n=this.length),t<0||r>e.length||i<0||n>this.length)throw new RangeError("out of range index");if(i>=n&&t>=r)return 0;if(i>=n)return-1;if(t>=r)return 1;if(this===e)return 0;for(var s=(n>>>=0)-(i>>>=0),o=(r>>>=0)-(t>>>=0),a=Math.min(s,o),c=this.slice(i,n),l=e.slice(t,r),u=0;u<a;++u)if(c[u]!==l[u]){s=c[u],o=l[u];break}return s<o?-1:o<s?1:0},Ni.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},Ni.prototype.indexOf=function(e,t,r){return Fi(this,e,t,r,!0)},Ni.prototype.lastIndexOf=function(e,t,r){return Fi(this,e,t,r,!1)},Ni.prototype.write=function(e,t,r,i){if(void 0===t)i="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)i=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===i&&(i="utf8")):(i=r,r=void 0)}var n=this.length-t;if((void 0===r||r>n)&&(r=n),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i||(i="utf8");for(var s=!1;;)switch(i){case"hex":return zi(this,e,t,r);case"utf8":case"utf-8":return qi(this,e,t,r);case"ascii":return Qi(this,e,t,r);case"latin1":case"binary":return Vi(this,e,t,r);case"base64":return Gi(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Hi(this,e,t,r);default:if(s)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),s=!0}},Ni.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Ki=4096;function Zi(e,t,r){var i="";r=Math.min(e.length,r);for(var n=t;n<r;++n)i+=String.fromCharCode(127&e[n]);return i}function Yi(e,t,r){var i="";r=Math.min(e.length,r);for(var n=t;n<r;++n)i+=String.fromCharCode(e[n]);return i}function Xi(e,t,r){var i=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>i)&&(r=i);for(var n="",s=t;s<r;++s)n+=un(e[s]);return n}function en(e,t,r){for(var i=e.slice(t,r),n="",s=0;s<i.length;s+=2)n+=String.fromCharCode(i[s]+256*i[s+1]);return n}function tn(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function rn(e,t,r,i,n,s){if(!Li(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>n||t<s)throw new RangeError('"value" argument is out of bounds');if(r+i>e.length)throw new RangeError("Index out of range")}function nn(e,t,r,i){t<0&&(t=65535+t+1);for(var n=0,s=Math.min(e.length-r,2);n<s;++n)e[r+n]=(t&255<<8*(i?n:1-n))>>>8*(i?n:1-n)}function sn(e,t,r,i){t<0&&(t=4294967295+t+1);for(var n=0,s=Math.min(e.length-r,4);n<s;++n)e[r+n]=t>>>8*(i?n:3-n)&255}function on(e,t,r,i,n,s){if(r+i>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function an(e,t,r,i,n){return n||on(e,0,r,4),Ii(e,t,r,i,23,4),r+4}function cn(e,t,r,i,n){return n||on(e,0,r,8),Ii(e,t,r,i,52,8),r+8}Ni.prototype.slice=function(e,t){var r,i=this.length;if((e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e),Ni.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=Ni.prototype;else{var n=t-e;r=new Ni(n,void 0);for(var s=0;s<n;++s)r[s]=this[s+e]}return r},Ni.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||tn(e,t,this.length);for(var i=this[e],n=1,s=0;++s<t&&(n*=256);)i+=this[e+s]*n;return i},Ni.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||tn(e,t,this.length);for(var i=this[e+--t],n=1;t>0&&(n*=256);)i+=this[e+--t]*n;return i},Ni.prototype.readUInt8=function(e,t){return t||tn(e,1,this.length),this[e]},Ni.prototype.readUInt16LE=function(e,t){return t||tn(e,2,this.length),this[e]|this[e+1]<<8},Ni.prototype.readUInt16BE=function(e,t){return t||tn(e,2,this.length),this[e]<<8|this[e+1]},Ni.prototype.readUInt32LE=function(e,t){return t||tn(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},Ni.prototype.readUInt32BE=function(e,t){return t||tn(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},Ni.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||tn(e,t,this.length);for(var i=this[e],n=1,s=0;++s<t&&(n*=256);)i+=this[e+s]*n;return i>=(n*=128)&&(i-=Math.pow(2,8*t)),i},Ni.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||tn(e,t,this.length);for(var i=t,n=1,s=this[e+--i];i>0&&(n*=256);)s+=this[e+--i]*n;return s>=(n*=128)&&(s-=Math.pow(2,8*t)),s},Ni.prototype.readInt8=function(e,t){return t||tn(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},Ni.prototype.readInt16LE=function(e,t){t||tn(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},Ni.prototype.readInt16BE=function(e,t){t||tn(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},Ni.prototype.readInt32LE=function(e,t){return t||tn(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},Ni.prototype.readInt32BE=function(e,t){return t||tn(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},Ni.prototype.readFloatLE=function(e,t){return t||tn(e,4,this.length),Ei(this,e,!0,23,4)},Ni.prototype.readFloatBE=function(e,t){return t||tn(e,4,this.length),Ei(this,e,!1,23,4)},Ni.prototype.readDoubleLE=function(e,t){return t||tn(e,8,this.length),Ei(this,e,!0,52,8)},Ni.prototype.readDoubleBE=function(e,t){return t||tn(e,8,this.length),Ei(this,e,!1,52,8)},Ni.prototype.writeUIntLE=function(e,t,r,i){(e=+e,t|=0,r|=0,i)||rn(this,e,t,r,Math.pow(2,8*r)-1,0);var n=1,s=0;for(this[t]=255&e;++s<r&&(n*=256);)this[t+s]=e/n&255;return t+r},Ni.prototype.writeUIntBE=function(e,t,r,i){(e=+e,t|=0,r|=0,i)||rn(this,e,t,r,Math.pow(2,8*r)-1,0);var n=r-1,s=1;for(this[t+n]=255&e;--n>=0&&(s*=256);)this[t+n]=e/s&255;return t+r},Ni.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,1,255,0),Ni.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},Ni.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,2,65535,0),Ni.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):nn(this,e,t,!0),t+2},Ni.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,2,65535,0),Ni.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):nn(this,e,t,!1),t+2},Ni.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,4,4294967295,0),Ni.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):sn(this,e,t,!0),t+4},Ni.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,4,4294967295,0),Ni.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):sn(this,e,t,!1),t+4},Ni.prototype.writeIntLE=function(e,t,r,i){if(e=+e,t|=0,!i){var n=Math.pow(2,8*r-1);rn(this,e,t,r,n-1,-n)}var s=0,o=1,a=0;for(this[t]=255&e;++s<r&&(o*=256);)e<0&&0===a&&0!==this[t+s-1]&&(a=1),this[t+s]=(e/o|0)-a&255;return t+r},Ni.prototype.writeIntBE=function(e,t,r,i){if(e=+e,t|=0,!i){var n=Math.pow(2,8*r-1);rn(this,e,t,r,n-1,-n)}var s=r-1,o=1,a=0;for(this[t+s]=255&e;--s>=0&&(o*=256);)e<0&&0===a&&0!==this[t+s+1]&&(a=1),this[t+s]=(e/o|0)-a&255;return t+r},Ni.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,1,127,-128),Ni.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},Ni.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,2,32767,-32768),Ni.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):nn(this,e,t,!0),t+2},Ni.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,2,32767,-32768),Ni.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):nn(this,e,t,!1),t+2},Ni.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,4,2147483647,-2147483648),Ni.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):sn(this,e,t,!0),t+4},Ni.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||rn(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),Ni.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):sn(this,e,t,!1),t+4},Ni.prototype.writeFloatLE=function(e,t,r){return an(this,e,t,!0,r)},Ni.prototype.writeFloatBE=function(e,t,r){return an(this,e,t,!1,r)},Ni.prototype.writeDoubleLE=function(e,t,r){return cn(this,e,t,!0,r)},Ni.prototype.writeDoubleBE=function(e,t,r){return cn(this,e,t,!1,r)},Ni.prototype.copy=function(e,t,r,i){if(r||(r=0),i||0===i||(i=this.length),t>=e.length&&(t=e.length),t||(t=0),i>0&&i<r&&(i=r),i===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-t<i-r&&(i=e.length-t+r);var n,s=i-r;if(this===e&&r<t&&t<i)for(n=s-1;n>=0;--n)e[n+t]=this[n+r];else if(s<1e3||!Ni.TYPED_ARRAY_SUPPORT)for(n=0;n<s;++n)e[n+t]=this[n+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+s),t);return s},Ni.prototype.fill=function(e,t,r,i){if("string"==typeof e){if("string"==typeof t?(i=t,t=0,r=this.length):"string"==typeof r&&(i=r,r=this.length),1===e.length){var n=e.charCodeAt(0);n<256&&(e=n)}if(void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!Ni.isEncoding(i))throw new TypeError("Unknown encoding: "+i)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var s;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(s=t;s<r;++s)this[s]=e;else{var o=Li(e)?e:hn(new Ni(e,i).toString()),a=o.length;for(s=0;s<r-t;++s)this[s+t]=o[s%a]}return this};var ln=/[^+\/0-9A-Za-z-_]/g;function un(e){return e<16?"0"+e.toString(16):e.toString(16)}function hn(e,t){var r;t=t||1/0;for(var i=e.length,n=null,s=[],o=0;o<i;++o){if((r=e.charCodeAt(o))>55295&&r<57344){if(!n){if(r>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(o+1===i){(t-=3)>-1&&s.push(239,191,189);continue}n=r;continue}if(r<56320){(t-=3)>-1&&s.push(239,191,189),n=r;continue}r=65536+(n-55296<<10|r-56320)}else n&&(t-=3)>-1&&s.push(239,191,189);if(n=null,r<128){if((t-=1)<0)break;s.push(r)}else if(r<2048){if((t-=2)<0)break;s.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;s.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return s}function fn(e){return function(e){var t,r,i,n,s,o;wi||vi();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");s="="===e[a-2]?2:"="===e[a-1]?1:0,o=new bi(3*a/4-s),i=s>0?a-4:a;var c=0;for(t=0,r=0;t<i;t+=4,r+=3)n=yi[e.charCodeAt(t)]<<18|yi[e.charCodeAt(t+1)]<<12|yi[e.charCodeAt(t+2)]<<6|yi[e.charCodeAt(t+3)],o[c++]=n>>16&255,o[c++]=n>>8&255,o[c++]=255&n;return 2===s?(n=yi[e.charCodeAt(t)]<<2|yi[e.charCodeAt(t+1)]>>4,o[c++]=255&n):1===s&&(n=yi[e.charCodeAt(t)]<<10|yi[e.charCodeAt(t+1)]<<4|yi[e.charCodeAt(t+2)]>>2,o[c++]=n>>8&255,o[c++]=255&n),o}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(ln,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function dn(e,t,r,i){for(var n=0;n<i&&!(n+r>=t.length||n>=e.length);++n)t[n+r]=e[n];return n}function pn(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function gn(){throw new Error("setTimeout has not been defined")}function mn(){throw new Error("clearTimeout has not been defined")}var yn=gn,bn=mn;function wn(e){if(yn===setTimeout)return setTimeout(e,0);if((yn===gn||!yn)&&setTimeout)return yn=setTimeout,setTimeout(e,0);try{return yn(e,0)}catch(t){try{return yn.call(null,e,0)}catch(t){return yn.call(this,e,0)}}}"function"==typeof B.setTimeout&&(yn=setTimeout),"function"==typeof B.clearTimeout&&(bn=clearTimeout);var vn,_n=[],An=!1,kn=-1;function En(){An&&vn&&(An=!1,vn.length?_n=vn.concat(_n):kn=-1,_n.length&&In())}function In(){if(!An){var e=wn(En);An=!0;for(var t=_n.length;t;){for(vn=_n,_n=[];++kn<t;)vn&&vn[kn].run();kn=-1,t=_n.length}vn=null,An=!1,function(e){if(bn===clearTimeout)return clearTimeout(e);if((bn===mn||!bn)&&clearTimeout)return bn=clearTimeout,clearTimeout(e);try{return bn(e)}catch(t){try{return bn.call(null,e)}catch(t){return bn.call(this,e)}}}(e)}}function Sn(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];_n.push(new On(e,t)),1!==_n.length||An||wn(In)}function On(e,t){this.fun=e,this.array=t}On.prototype.run=function(){this.fun.apply(null,this.array)};function xn(){}var Rn=xn,Nn=xn,Bn=xn,Cn=xn,jn=xn,Dn=xn,Pn=xn;var Ln=B.performance||{},Tn=Ln.now||Ln.mozNow||Ln.msNow||Ln.oNow||Ln.webkitNow||function(){return(new Date).getTime()};var Mn=new Date;var Un,Fn={nextTick:Sn,title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:Rn,addListener:Nn,once:Bn,off:Cn,removeListener:jn,removeAllListeners:Dn,emit:Pn,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*Tn.call(Ln),r=Math.floor(t),i=Math.floor(t%1*1e9);return e&&(r-=e[0],(i-=e[1])<0&&(r--,i+=1e9)),[r,i]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-Mn)/1e3}};Un="function"==typeof Object.create?function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:function(e,t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e};var $n=/%[sdj%]/g;function zn(e){if(!es(e)){for(var t=[],r=0;r<arguments.length;r++)t.push(Gn(arguments[r]));return t.join(" ")}r=1;for(var i=arguments,n=i.length,s=String(e).replace($n,function(e){if("%%"===e)return"%";if(r>=n)return e;switch(e){case"%s":return String(i[r++]);case"%d":return Number(i[r++]);case"%j":try{return JSON.stringify(i[r++])}catch(e){return"[Circular]"}default:return e}}),o=i[r];r<n;o=i[++r])Xn(o)||!is(o)?s+=" "+o:s+=" "+Gn(o);return s}function qn(e,t){if(ts(B.process))return function(){return qn(e,t).apply(this,arguments)};if(!0===Fn.noDeprecation)return e;var r=!1;return function(){if(!r){if(Fn.throwDeprecation)throw new Error(t);Fn.traceDeprecation?console.trace(t):console.error(t),r=!0}return e.apply(this,arguments)}}var Qn,Vn={};function Gn(e,t){var r={seen:[],stylize:Jn};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),Yn(t)?r.showHidden=t:t&&function(e,t){if(!t||!is(t))return e;var r=Object.keys(t),i=r.length;for(;i--;)e[r[i]]=t[r[i]]}(r,t),ts(r.showHidden)&&(r.showHidden=!1),ts(r.depth)&&(r.depth=2),ts(r.colors)&&(r.colors=!1),ts(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=Hn),Wn(r,e,r.depth)}function Hn(e,t){var r=Gn.styles[t];return r?"["+Gn.colors[r][0]+"m"+e+"["+Gn.colors[r][1]+"m":e}function Jn(e,t){return e}function Wn(e,t,r){if(e.customInspect&&t&&os(t.inspect)&&t.inspect!==Gn&&(!t.constructor||t.constructor.prototype!==t)){var i=t.inspect(r,e);return es(i)||(i=Wn(e,i,r)),i}var n=function(e,t){if(ts(t))return e.stylize("undefined","undefined");if(es(t)){var r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(r,"string")}if(i=t,"number"==typeof i)return e.stylize(""+t,"number");var i;if(Yn(t))return e.stylize(""+t,"boolean");if(Xn(t))return e.stylize("null","null")}(e,t);if(n)return n;var s=Object.keys(t),o=function(e){var t={};return e.forEach(function(e,r){t[e]=!0}),t}(s);if(e.showHidden&&(s=Object.getOwnPropertyNames(t)),ss(t)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return Kn(t);if(0===s.length){if(os(t)){var a=t.name?": "+t.name:"";return e.stylize("[Function"+a+"]","special")}if(rs(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(ns(t))return e.stylize(Date.prototype.toString.call(t),"date");if(ss(t))return Kn(t)}var c,l,u="",h=!1,f=["{","}"];(c=t,Array.isArray(c)&&(h=!0,f=["[","]"]),os(t))&&(u=" [Function"+(t.name?": "+t.name:"")+"]");return rs(t)&&(u=" "+RegExp.prototype.toString.call(t)),ns(t)&&(u=" "+Date.prototype.toUTCString.call(t)),ss(t)&&(u=" "+Kn(t)),0!==s.length||h&&0!=t.length?r<0?rs(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),l=h?function(e,t,r,i,n){for(var s=[],o=0,a=t.length;o<a;++o)cs(t,String(o))?s.push(Zn(e,t,r,i,String(o),!0)):s.push("");return n.forEach(function(n){n.match(/^\d+$/)||s.push(Zn(e,t,r,i,n,!0))}),s}(e,t,r,o,s):s.map(function(i){return Zn(e,t,r,o,i,h)}),e.seen.pop(),function(e,t,r){var i=e.reduce(function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(i>60)return r[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+r[1];return r[0]+t+" "+e.join(", ")+" "+r[1]}(l,u,f)):f[0]+u+f[1]}function Kn(e){return"["+Error.prototype.toString.call(e)+"]"}function Zn(e,t,r,i,n,s){var o,a,c;if((c=Object.getOwnPropertyDescriptor(t,n)||{value:t[n]}).get?a=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(a=e.stylize("[Setter]","special")),cs(i,n)||(o="["+n+"]"),a||(e.seen.indexOf(c.value)<0?(a=Xn(r)?Wn(e,c.value,null):Wn(e,c.value,r-1)).indexOf("\n")>-1&&(a=s?a.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+a.split("\n").map(function(e){return"   "+e}).join("\n")):a=e.stylize("[Circular]","special")),ts(o)){if(s&&n.match(/^\d+$/))return a;(o=JSON.stringify(""+n)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+a}function Yn(e){return"boolean"==typeof e}function Xn(e){return null===e}function es(e){return"string"==typeof e}function ts(e){return void 0===e}function rs(e){return is(e)&&"[object RegExp]"===as(e)}function is(e){return"object"==typeof e&&null!==e}function ns(e){return is(e)&&"[object Date]"===as(e)}function ss(e){return is(e)&&("[object Error]"===as(e)||e instanceof Error)}function os(e){return"function"==typeof e}function as(e){return Object.prototype.toString.call(e)}function cs(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ls(){this.head=null,this.tail=null,this.length=0}Gn.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},Gn.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},ls.prototype.push=function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length},ls.prototype.unshift=function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length},ls.prototype.shift=function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}},ls.prototype.clear=function(){this.head=this.tail=null,this.length=0},ls.prototype.join=function(e){if(0===this.length)return"";for(var t=this.head,r=""+t.data;t=t.next;)r+=e+t.data;return r},ls.prototype.concat=function(e){if(0===this.length)return Ni.alloc(0);if(1===this.length)return this.head.data;for(var t=Ni.allocUnsafe(e>>>0),r=this.head,i=0;r;)r.data.copy(t,i),i+=r.data.length,r=r.next;return t};var us=Ni.isEncoding||function(e){switch(e&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function hs(e){switch(this.encoding=(e||"utf8").toLowerCase().replace(/[-_]/,""),function(e){if(e&&!us(e))throw new Error("Unknown encoding: "+e)}(e),this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2,this.detectIncompleteChar=ds;break;case"base64":this.surrogateSize=3,this.detectIncompleteChar=ps;break;default:return void(this.write=fs)}this.charBuffer=new Ni(6),this.charReceived=0,this.charLength=0}function fs(e){return e.toString(this.encoding)}function ds(e){this.charReceived=e.length%2,this.charLength=this.charReceived?2:0}function ps(e){this.charReceived=e.length%3,this.charLength=this.charReceived?3:0}hs.prototype.write=function(e){for(var t="";this.charLength;){var r=e.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:e.length;if(e.copy(this.charBuffer,this.charReceived,0,r),this.charReceived+=r,this.charReceived<this.charLength)return"";if(e=e.slice(r,e.length),!((n=(t=this.charBuffer.slice(0,this.charLength).toString(this.encoding)).charCodeAt(t.length-1))>=55296&&n<=56319)){if(this.charReceived=this.charLength=0,0===e.length)return t;break}this.charLength+=this.surrogateSize,t=""}this.detectIncompleteChar(e);var i=e.length;this.charLength&&(e.copy(this.charBuffer,0,e.length-this.charReceived,i),i-=this.charReceived);var n;i=(t+=e.toString(this.encoding,0,i)).length-1;if((n=t.charCodeAt(i))>=55296&&n<=56319){var s=this.surrogateSize;return this.charLength+=s,this.charReceived+=s,this.charBuffer.copy(this.charBuffer,s,0,s),e.copy(this.charBuffer,0,0,s),t.substring(0,i)}return t},hs.prototype.detectIncompleteChar=function(e){for(var t=e.length>=3?3:e.length;t>0;t--){var r=e[e.length-t];if(1==t&&r>>5==6){this.charLength=2;break}if(t<=2&&r>>4==14){this.charLength=3;break}if(t<=3&&r>>3==30){this.charLength=4;break}}this.charReceived=t},hs.prototype.end=function(e){var t="";if(e&&e.length&&(t=this.write(e)),this.charReceived){var r=this.charReceived,i=this.charBuffer,n=this.encoding;t+=i.slice(0,r).toString(n)}return t},ys.ReadableState=ms;var gs=function(e){if(ts(Qn)&&(Qn=Fn.env.NODE_DEBUG||""),e=e.toUpperCase(),!Vn[e])if(new RegExp("\\b"+e+"\\b","i").test(Qn)){Vn[e]=function(){var t=zn.apply(null,arguments);console.error("%s %d: %s",e,0,t)}}else Vn[e]=function(){};return Vn[e]}("stream");function ms(e,t){e=e||{},this.objectMode=!!e.objectMode,t instanceof Vs&&(this.objectMode=this.objectMode||!!e.readableObjectMode);var r=e.highWaterMark,i=this.objectMode?16:16384;this.highWaterMark=r||0===r?r:i,this.highWaterMark=~~this.highWaterMark,this.buffer=new ls,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(this.decoder=new hs(e.encoding),this.encoding=e.encoding)}function ys(e){if(!(this instanceof ys))return new ys(e);this._readableState=new ms(e,this),this.readable=!0,e&&"function"==typeof e.read&&(this._read=e.read),v.call(this)}function bs(e,t,r,i,n){var s=function(e,t){var r=null;Ni.isBuffer(t)||"string"==typeof t||null==t||e.objectMode||(r=new TypeError("Invalid non-string/buffer chunk"));return r}(t,r);if(s)e.emit("error",s);else if(null===r)t.reading=!1,function(e,t){if(t.ended)return;if(t.decoder){var r=t.decoder.end();r&&r.length&&(t.buffer.push(r),t.length+=t.objectMode?1:r.length)}t.ended=!0,_s(e)}(e,t);else if(t.objectMode||r&&r.length>0)if(t.ended&&!n){var o=new Error("stream.push() after EOF");e.emit("error",o)}else if(t.endEmitted&&n){var a=new Error("stream.unshift() after end event");e.emit("error",a)}else{var c;!t.decoder||n||i||(r=t.decoder.write(r),c=!t.objectMode&&0===r.length),n||(t.reading=!1),c||(t.flowing&&0===t.length&&!t.sync?(e.emit("data",r),e.read(0)):(t.length+=t.objectMode?1:r.length,n?t.buffer.unshift(r):t.buffer.push(r),t.needReadable&&_s(e))),function(e,t){t.readingMore||(t.readingMore=!0,Sn(ks,e,t))}(e,t)}else n||(t.reading=!1);return function(e){return!e.ended&&(e.needReadable||e.length<e.highWaterMark||0===e.length)}(t)}Un(ys,v),ys.prototype.push=function(e,t){var r=this._readableState;return r.objectMode||"string"!=typeof e||(t=t||r.defaultEncoding)!==r.encoding&&(e=Ni.from(e,t),t=""),bs(this,r,e,t,!1)},ys.prototype.unshift=function(e){return bs(this,this._readableState,e,"",!0)},ys.prototype.isPaused=function(){return!1===this._readableState.flowing},ys.prototype.setEncoding=function(e){return this._readableState.decoder=new hs(e),this._readableState.encoding=e,this};var ws=8388608;function vs(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=function(e){return e>=ws?e=ws:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function _s(e){var t=e._readableState;t.needReadable=!1,t.emittedReadable||(gs("emitReadable",t.flowing),t.emittedReadable=!0,t.sync?Sn(As,e):As(e))}function As(e){gs("emit readable"),e.emit("readable"),Ss(e)}function ks(e,t){for(var r=t.length;!t.reading&&!t.flowing&&!t.ended&&t.length<t.highWaterMark&&(gs("maybeReadMore read 0"),e.read(0),r!==t.length);)r=t.length;t.readingMore=!1}function Es(e){gs("readable nexttick read 0"),e.read(0)}function Is(e,t){t.reading||(gs("resume read 0"),e.read(0)),t.resumeScheduled=!1,t.awaitDrain=0,e.emit("resume"),Ss(e),t.flowing&&!t.reading&&e.read(0)}function Ss(e){var t=e._readableState;for(gs("flow",t.flowing);t.flowing&&null!==e.read(););}function Os(e,t){return 0===t.length?null:(t.objectMode?r=t.buffer.shift():!e||e>=t.length?(r=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.head.data:t.buffer.concat(t.length),t.buffer.clear()):r=function(e,t,r){var i;e<t.head.data.length?(i=t.head.data.slice(0,e),t.head.data=t.head.data.slice(e)):i=e===t.head.data.length?t.shift():r?function(e,t){var r=t.head,i=1,n=r.data;e-=n.length;for(;r=r.next;){var s=r.data,o=e>s.length?s.length:e;if(o===s.length?n+=s:n+=s.slice(0,e),0===(e-=o)){o===s.length?(++i,r.next?t.head=r.next:t.head=t.tail=null):(t.head=r,r.data=s.slice(o));break}++i}return t.length-=i,n}(e,t):function(e,t){var r=Ni.allocUnsafe(e),i=t.head,n=1;i.data.copy(r),e-=i.data.length;for(;i=i.next;){var s=i.data,o=e>s.length?s.length:e;if(s.copy(r,r.length-e,0,o),0===(e-=o)){o===s.length?(++n,i.next?t.head=i.next:t.head=t.tail=null):(t.head=i,i.data=s.slice(o));break}++n}return t.length-=n,r}(e,t);return i}(e,t.buffer,t.decoder),r);var r}function xs(e){var t=e._readableState;if(t.length>0)throw new Error('"endReadable()" called on non-empty stream');t.endEmitted||(t.ended=!0,Sn(Rs,t,e))}function Rs(e,t){e.endEmitted||0!==e.length||(e.endEmitted=!0,t.readable=!1,t.emit("end"))}function Ns(e,t){for(var r=0,i=e.length;r<i;r++)if(e[r]===t)return r;return-1}function Bs(){}function Cs(e,t,r){this.chunk=e,this.encoding=t,this.callback=r,this.next=null}function js(e,t){Object.defineProperty(this,"buffer",{get:qn(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.")}),e=e||{},this.objectMode=!!e.objectMode,t instanceof Vs&&(this.objectMode=this.objectMode||!!e.writableObjectMode);var r=e.highWaterMark,i=this.objectMode?16:16384;this.highWaterMark=r||0===r?r:i,this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var n=!1===e.decodeStrings;this.decodeStrings=!n,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var r=e._writableState,i=r.sync,n=r.writecb;if(function(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}(r),t)!function(e,t,r,i,n){--t.pendingcb,r?Sn(n,i):n(i);e._writableState.errorEmitted=!0,e.emit("error",i)}(e,r,i,t,n);else{var s=Ms(r);s||r.corked||r.bufferProcessing||!r.bufferedRequest||Ts(e,r),i?Sn(Ls,e,r,s,n):Ls(e,r,s,n)}}(t,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new $s(this)}function Ds(e){if(!(this instanceof Ds||this instanceof Vs))return new Ds(e);this._writableState=new js(e,this),this.writable=!0,e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev)),v.call(this)}function Ps(e,t,r,i,n,s,o){t.writelen=i,t.writecb=o,t.writing=!0,t.sync=!0,r?e._writev(n,t.onwrite):e._write(n,s,t.onwrite),t.sync=!1}function Ls(e,t,r,i){r||function(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}(e,t),t.pendingcb--,i(),Fs(e,t)}function Ts(e,t){t.bufferProcessing=!0;var r=t.bufferedRequest;if(e._writev&&r&&r.next){var i=t.bufferedRequestCount,n=new Array(i),s=t.corkedRequestsFree;s.entry=r;for(var o=0;r;)n[o]=r,r=r.next,o+=1;Ps(e,t,!0,t.length,n,"",s.finish),t.pendingcb++,t.lastBufferedRequest=null,s.next?(t.corkedRequestsFree=s.next,s.next=null):t.corkedRequestsFree=new $s(t)}else{for(;r;){var a=r.chunk,c=r.encoding,l=r.callback;if(Ps(e,t,!1,t.objectMode?1:a.length,a,c,l),r=r.next,t.writing)break}null===r&&(t.lastBufferedRequest=null)}t.bufferedRequestCount=0,t.bufferedRequest=r,t.bufferProcessing=!1}function Ms(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function Us(e,t){t.prefinished||(t.prefinished=!0,e.emit("prefinish"))}function Fs(e,t){var r=Ms(t);return r&&(0===t.pendingcb?(Us(e,t),t.finished=!0,e.emit("finish")):Us(e,t)),r}function $s(e){var t=this;this.next=null,this.entry=null,this.finish=function(r){var i=t.entry;for(t.entry=null;i;){var n=i.callback;e.pendingcb--,n(r),i=i.next}e.corkedRequestsFree?e.corkedRequestsFree.next=t:e.corkedRequestsFree=t}}ys.prototype.read=function(e){gs("read",e),e=parseInt(e,10);var t=this._readableState,r=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&(t.length>=t.highWaterMark||t.ended))return gs("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?xs(this):_s(this),null;if(0===(e=vs(e,t))&&t.ended)return 0===t.length&&xs(this),null;var i,n=t.needReadable;return gs("need readable",n),(0===t.length||t.length-e<t.highWaterMark)&&gs("length less than watermark",n=!0),t.ended||t.reading?gs("reading or ended",n=!1):n&&(gs("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=vs(r,t))),null===(i=e>0?Os(e,t):null)?(t.needReadable=!0,e=0):t.length-=e,0===t.length&&(t.ended||(t.needReadable=!0),r!==e&&t.ended&&xs(this)),null!==i&&this.emit("data",i),i},ys.prototype._read=function(e){this.emit("error",new Error("not implemented"))},ys.prototype.pipe=function(e,t){var r=this,i=this._readableState;switch(i.pipesCount){case 0:i.pipes=e;break;case 1:i.pipes=[i.pipes,e];break;default:i.pipes.push(e)}i.pipesCount+=1,gs("pipe count=%d opts=%j",i.pipesCount,t);var n=!t||!1!==t.end?o:l;function s(e){gs("onunpipe"),e===r&&l()}function o(){gs("onend"),e.end()}i.endEmitted?Sn(n):r.once("end",n),e.on("unpipe",s);var a=function(e){return function(){var t=e._readableState;gs("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&e.listeners("data").length&&(t.flowing=!0,Ss(e))}}(r);e.on("drain",a);var c=!1;function l(){gs("cleanup"),e.removeListener("close",d),e.removeListener("finish",p),e.removeListener("drain",a),e.removeListener("error",f),e.removeListener("unpipe",s),r.removeListener("end",o),r.removeListener("end",l),r.removeListener("data",h),c=!0,!i.awaitDrain||e._writableState&&!e._writableState.needDrain||a()}var u=!1;function h(t){gs("ondata"),u=!1,!1!==e.write(t)||u||((1===i.pipesCount&&i.pipes===e||i.pipesCount>1&&-1!==Ns(i.pipes,e))&&!c&&(gs("false write response, pause",r._readableState.awaitDrain),r._readableState.awaitDrain++,u=!0),r.pause())}function f(t){gs("onerror",t),g(),e.removeListener("error",f),0===function(e,t){return e.listeners(t).length}(e,"error")&&e.emit("error",t)}function d(){e.removeListener("finish",p),g()}function p(){gs("onfinish"),e.removeListener("close",d),g()}function g(){gs("unpipe"),r.unpipe(e)}return r.on("data",h),function(e,t,r){if("function"==typeof e.prependListener)return e.prependListener(t,r);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(r):e._events[t]=[r,e._events[t]]:e.on(t,r)}(e,"error",f),e.once("close",d),e.once("finish",p),e.emit("pipe",r),i.flowing||(gs("pipe resume"),r.resume()),e},ys.prototype.unpipe=function(e){var t=this._readableState;if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this)),this;if(!e){var r=t.pipes,i=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var n=0;n<i;n++)r[n].emit("unpipe",this);return this}var s=Ns(t.pipes,e);return-1===s||(t.pipes.splice(s,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this)),this},ys.prototype.on=function(e,t){var r=v.prototype.on.call(this,e,t);if("data"===e)!1!==this._readableState.flowing&&this.resume();else if("readable"===e){var i=this._readableState;i.endEmitted||i.readableListening||(i.readableListening=i.needReadable=!0,i.emittedReadable=!1,i.reading?i.length&&_s(this):Sn(Es,this))}return r},ys.prototype.addListener=ys.prototype.on,ys.prototype.resume=function(){var e=this._readableState;return e.flowing||(gs("resume"),e.flowing=!0,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,Sn(Is,e,t))}(this,e)),this},ys.prototype.pause=function(){return gs("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(gs("pause"),this._readableState.flowing=!1,this.emit("pause")),this},ys.prototype.wrap=function(e){var t=this._readableState,r=!1,i=this;for(var n in e.on("end",function(){if(gs("wrapped end"),t.decoder&&!t.ended){var e=t.decoder.end();e&&e.length&&i.push(e)}i.push(null)}),e.on("data",function(n){(gs("wrapped data"),t.decoder&&(n=t.decoder.write(n)),t.objectMode&&null==n)||(t.objectMode||n&&n.length)&&(i.push(n)||(r=!0,e.pause()))}),e)void 0===this[n]&&"function"==typeof e[n]&&(this[n]=function(t){return function(){return e[t].apply(e,arguments)}}(n));return function(e,t){for(var r=0,i=e.length;r<i;r++)t(e[r],r)}(["error","close","destroy","pause","resume"],function(t){e.on(t,i.emit.bind(i,t))}),i._read=function(t){gs("wrapped _read",t),r&&(r=!1,e.resume())},i},ys._fromList=Os,Ds.WritableState=js,Un(Ds,v),js.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},Ds.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))},Ds.prototype.write=function(e,t,r){var i=this._writableState,n=!1;return"function"==typeof t&&(r=t,t=null),Ni.isBuffer(e)?t="buffer":t||(t=i.defaultEncoding),"function"!=typeof r&&(r=Bs),i.ended?function(e,t){var r=new Error("write after end");e.emit("error",r),Sn(t,r)}(this,r):function(e,t,r,i){var n=!0,s=!1;return null===r?s=new TypeError("May not write null values to stream"):Ni.isBuffer(r)||"string"==typeof r||void 0===r||t.objectMode||(s=new TypeError("Invalid non-string/buffer chunk")),s&&(e.emit("error",s),Sn(i,s),n=!1),n}(this,i,e,r)&&(i.pendingcb++,n=function(e,t,r,i,n){r=function(e,t,r){e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=Ni.from(t,r));return t}(t,r,i),Ni.isBuffer(r)&&(i="buffer");var s=t.objectMode?1:r.length;t.length+=s;var o=t.length<t.highWaterMark;o||(t.needDrain=!0);if(t.writing||t.corked){var a=t.lastBufferedRequest;t.lastBufferedRequest=new Cs(r,i,n),a?a.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else Ps(e,t,!1,s,r,i,n);return o}(this,i,e,t,r)),n},Ds.prototype.cork=function(){this._writableState.corked++},Ds.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.finished||e.bufferProcessing||!e.bufferedRequest||Ts(this,e))},Ds.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+e);return this._writableState.defaultEncoding=e,this},Ds.prototype._write=function(e,t,r){r(new Error("not implemented"))},Ds.prototype._writev=null,Ds.prototype.end=function(e,t,r){var i=this._writableState;"function"==typeof e?(r=e,e=null,t=null):"function"==typeof t&&(r=t,t=null),null!=e&&this.write(e,t),i.corked&&(i.corked=1,this.uncork()),i.ending||i.finished||function(e,t,r){t.ending=!0,Fs(e,t),r&&(t.finished?Sn(r):e.once("finish",r));t.ended=!0,e.writable=!1}(this,i,r)},Un(Vs,ys);for(var zs=Object.keys(Ds.prototype),qs=0;qs<zs.length;qs++){var Qs=zs[qs];Vs.prototype[Qs]||(Vs.prototype[Qs]=Ds.prototype[Qs])}function Vs(e){if(!(this instanceof Vs))return new Vs(e);ys.call(this,e),Ds.call(this,e),e&&!1===e.readable&&(this.readable=!1),e&&!1===e.writable&&(this.writable=!1),this.allowHalfOpen=!0,e&&!1===e.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",Gs)}function Gs(){this.allowHalfOpen||this._writableState.ended||Sn(Hs,this)}function Hs(e){e.end()}function Js(e){this.afterTransform=function(t,r){return function(e,t,r){var i=e._transformState;i.transforming=!1;var n=i.writecb;if(!n)return e.emit("error",new Error("no writecb in Transform class"));i.writechunk=null,i.writecb=null,null!=r&&e.push(r);n(t);var s=e._readableState;s.reading=!1,(s.needReadable||s.length<s.highWaterMark)&&e._read(s.highWaterMark)}(e,t,r)},this.needTransform=!1,this.transforming=!1,this.writecb=null,this.writechunk=null,this.writeencoding=null}function Ws(e){if(!(this instanceof Ws))return new Ws(e);Vs.call(this,e),this._transformState=new Js(this);var t=this;this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.once("prefinish",function(){"function"==typeof this._flush?this._flush(function(e){Ks(t,e)}):Ks(t)})}function Ks(e,t){if(t)return e.emit("error",t);var r=e._writableState,i=e._transformState;if(r.length)throw new Error("Calling transform done when ws.length != 0");if(i.transforming)throw new Error("Calling transform done when still transforming");return e.push(null)}function Zs(e){if(!(this instanceof Zs))return new Zs(e);Ws.call(this,e)}function Ys(){v.call(this)}Un(Ws,Vs),Ws.prototype.push=function(e,t){return this._transformState.needTransform=!1,Vs.prototype.push.call(this,e,t)},Ws.prototype._transform=function(e,t,r){throw new Error("Not implemented")},Ws.prototype._write=function(e,t,r){var i=this._transformState;if(i.writecb=r,i.writechunk=e,i.writeencoding=t,!i.transforming){var n=this._readableState;(i.needTransform||n.needReadable||n.length<n.highWaterMark)&&this._read(n.highWaterMark)}},Ws.prototype._read=function(e){var t=this._transformState;null!==t.writechunk&&t.writecb&&!t.transforming?(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform)):t.needTransform=!0},Un(Zs,Ws),Zs.prototype._transform=function(e,t,r){r(null,e)},Un(Ys,v),Ys.Readable=ys,Ys.Writable=Ds,Ys.Duplex=Vs,Ys.Transform=Ws,Ys.PassThrough=Zs,Ys.Stream=Ys,Ys.prototype.pipe=function(e,t){var r=this;function i(t){e.writable&&!1===e.write(t)&&r.pause&&r.pause()}function n(){r.readable&&r.resume&&r.resume()}r.on("data",i),e.on("drain",n),e._isStdio||t&&!1===t.end||(r.on("end",o),r.on("close",a));var s=!1;function o(){s||(s=!0,e.end())}function a(){s||(s=!0,"function"==typeof e.destroy&&e.destroy())}function c(e){if(l(),0===v.listenerCount(this,"error"))throw e}function l(){r.removeListener("data",i),e.removeListener("drain",n),r.removeListener("end",o),r.removeListener("close",a),r.removeListener("error",c),e.removeListener("error",c),r.removeListener("end",l),r.removeListener("close",l),e.removeListener("close",l)}return r.on("error",c),e.on("error",c),r.on("end",l),r.on("close",l),e.on("close",l),e.emit("pipe",r),e};class Xs extends v{constructor({resource:e}){super(),this.resource=e,this.client=e.client,this.stream=new a.ReadableStream({highWaterMark:3*this.client.parallelism,start:this._start.bind(this),pull:this._pull.bind(this),cancel:this._cancel.bind(this)})}build(){return this.stream.getReader()}async _start(e){this.controller=e,this.continuationToken=null,this.closeNextIteration=!1}async _pull(e){if(this.closeNextIteration)return void e.close();const t=await this.client.listObjects({prefix:`resource=${this.resource.name}`,continuationToken:this.continuationToken}),r=t?.Contents.map(e=>e.Key).map(e=>e.replace(this.client.config.keyPrefix,"")).map(e=>e.startsWith("/")?e.replace("/",""):e).map(e=>e.replace(`resource=${this.resource.name}/id=`,""));this.continuationToken=t.NextContinuationToken,this.enqueue(r),t.IsTruncated||(this.closeNextIteration=!0)}enqueue(e){e.forEach(e=>{this.controller.enqueue(e),this.emit("id",e)})}_cancel(e){}}class eo extends Xs{enqueue(e){this.controller.enqueue(e),this.emit("page",e)}}class to extends v{constructor({resource:e,batchSize:t=10,concurrency:r=5}){if(super(),!e)throw new Error("Resource is required for ResourceReader");this.resource=e,this.client=e.client,this.batchSize=t,this.concurrency=r,this.input=new eo({resource:this.resource}),this.transform=new Ws({objectMode:!0,transform:this._transform.bind(this)}),this.input.on("data",e=>{this.transform.write(e)}),this.input.on("end",()=>{this.transform.end()}),this.input.on("error",e=>{this.emit("error",e)}),this.transform.on("data",e=>{this.emit("data",e)}),this.transform.on("end",()=>{this.emit("end")}),this.transform.on("error",e=>{this.emit("error",e)})}build(){return this}async _transform(e,r,i){const[n,s]=await x(async()=>{await t.PromisePool.for(e).withConcurrency(this.concurrency).handleError(async(e,t)=>{this.emit("error",e,t)}).process(async e=>{const t=await this.resource.get(e);return this.push(t),t})});i(s)}resume(){this.input.resume()}}class ro extends v{constructor({resource:e,batchSize:t=10,concurrency:r=5}){super(),this.resource=e,this.client=e.client,this.batchSize=t,this.concurrency=r,this.buffer=[],this.writing=!1,this.writable=new Ds({objectMode:!0,write:this._write.bind(this)}),this.writable.on("finish",()=>{this.emit("finish")}),this.writable.on("error",e=>{this.emit("error",e)})}build(){return this}write(e){return this.buffer.push(e),this._maybeWrite().catch(e=>{this.emit("error",e)}),!0}end(){this.ended=!0,this._maybeWrite().catch(e=>{this.emit("error",e)})}async _maybeWrite(){if(!this.writing&&(0!==this.buffer.length||this.ended)){for(this.writing=!0;this.buffer.length>0;){const e=this.buffer.splice(0,this.batchSize),[r,i]=await x(async()=>{await t.PromisePool.for(e).withConcurrency(this.concurrency).handleError(async(e,t)=>{this.emit("error",e,t)}).process(async e=>{const[t,r,i]=await x(async()=>await this.resource.insert(e));return t?i:(this.emit("error",r,e),null)})});r||this.emit("error",i)}this.writing=!1,this.ended&&this.writable.emit("finish")}}async _write(e,t,r){r()}}function io(e){return new Promise((t,r)=>{if(!e)return r(new Error("streamToString: stream is undefined"));const i=[];e.on("data",e=>i.push(e)),e.on("error",r),e.on("end",()=>t(Buffer.concat(i).toString("utf-8")))})}function no(e){"string"!=typeof e&&(e=String(e));let t=0;for(let r=0;r<e.length;r++){const i=e.codePointAt(r);i<=127?t+=1:i<=2047?t+=2:i<=65535?t+=3:i<=1114111&&(t+=4,i>65535&&r++)}return t}function so(e){let t=0;for(const r of Object.keys(e))t+=no(r);return t}function oo(e){return null==e?"":"boolean"==typeof e?e?"1":"0":"number"==typeof e?String(e):"string"==typeof e?e:Array.isArray(e)?0===e.length?"[]":e.map(e=>String(e)).join("|"):"object"==typeof e?JSON.stringify(e):String(e)}function ao(e){const t={};for(const[r,i]of Object.entries(e)){const e=no(oo(i));t[r]=e}return t}function co(e){const t=ao(e);return Object.values(t).reduce((e,t)=>e+t,0)+so(e)}function lo(e={}){const{version:t="1",timestamps:r=!1,id:i=""}=e,n={_v:String(t)};r&&(n.createdAt="2024-01-01T00:00:00.000Z",n.updatedAt="2024-01-01T00:00:00.000Z"),i&&(n.id=i);const s={};for(const[e,t]of Object.entries(n))s[e]=t;return co(s)}function uo(e={}){const{s3Limit:t=2048,systemConfig:r={}}=e;return t-lo(r)}const ho=2047;var fo=Object.freeze({__proto__:null,S3_METADATA_LIMIT_BYTES:ho,handleGet:async function({resource:e,metadata:t,body:r}){return{metadata:t,body:r}},handleInsert:async function({resource:e,data:t,mappedData:r,originalData:i}){const n=co(r),s=uo({s3Limit:ho,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t.id}});if(n>s)throw new Error(`S3 metadata size exceeds 2KB limit. Current size: ${n} bytes, effective limit: ${s} bytes, absolute limit: 2047 bytes`);return{mappedData:r,body:JSON.stringify(r)}},handleUpdate:async function({resource:e,id:t,data:r,mappedData:i,originalData:n}){const s=co(i),o=uo({s3Limit:ho,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t}});if(s>o)throw new Error(`S3 metadata size exceeds 2KB limit. Current size: ${s} bytes, effective limit: ${o} bytes, absolute limit: 2047 bytes`);return{mappedData:i,body:JSON.stringify(i)}},handleUpsert:async function({resource:e,id:t,data:r,mappedData:i}){const n=co(i),s=uo({s3Limit:ho,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t}});if(n>s)throw new Error(`S3 metadata size exceeds 2KB limit. Current size: ${n} bytes, effective limit: ${s} bytes, absolute limit: 2047 bytes`);return{mappedData:i,body:""}}});var po=Object.freeze({__proto__:null,handleGet:async function({resource:e,metadata:t,body:r}){return{metadata:t,body:r}},handleInsert:async function({resource:e,data:t,mappedData:r,originalData:i}){const n=co(r);return n>uo({s3Limit:ho,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t.id}})&&e.emit("exceedsLimit",{operation:"insert",totalSize:n,limit:2047,excess:n-2047,data:i||t}),{mappedData:r,body:JSON.stringify(t)}},handleUpdate:async function({resource:e,id:t,data:r,mappedData:i,originalData:n}){const s=co(i);return s>uo({s3Limit:ho,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t}})&&e.emit("exceedsLimit",{operation:"update",id:t,totalSize:s,limit:2047,excess:s-2047,data:n||r}),{mappedData:i,body:JSON.stringify(r)}},handleUpsert:async function({resource:e,id:t,data:r,mappedData:i,originalData:n}){const s=co(i);return s>uo({s3Limit:ho,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t}})&&e.emit("exceedsLimit",{operation:"upsert",id:t,totalSize:s,limit:2047,excess:s-2047,data:n||r}),{mappedData:i,body:JSON.stringify(r)}}});const go="$truncated",mo="true",yo=no(go)+no(mo);async function bo({resource:e,data:t,mappedData:r,originalData:i}){const n=uo({s3Limit:ho,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t.id}}),s=ao(r),o=Object.entries(s).sort(([,e],[,t])=>e-t),a={};let c=0,l=!1;r._v&&(a._v=r._v,c+=s._v);for(const[e,t]of o){if("_v"===e)continue;const i=r[e];if(!(c+(t+(l?0:yo))<=n)){const t=n-c-(l?0:yo);if(t>0){const r=wo(i,t);a[e]=r,l=!0,c+=no(r)}else a[e]="",l=!0;break}a[e]=i,c+=t}let u=co(a)+(l?yo:0);for(;u>n;){const e=Object.keys(a).filter(e=>"_v"!==e&&"$truncated"!==e);if(0===e.length)break;a[e[e.length-1]]="",u=co(a)+yo,l=!0}return l&&(a[go]=mo),{mappedData:a,body:JSON.stringify(r)}}function wo(e,t){if("string"==typeof e)return vo(e,t);if("object"==typeof e&&null!==e){return vo(JSON.stringify(e),t)}return vo(String(e),t)}function vo(e,t){const r=new TextEncoder;let i=r.encode(e);if(i.length<=t)return e;let n=e.length;for(;n>0;){const s=e.substring(0,n);if(i=r.encode(s),i.length<=t)return s;n--}return""}var _o=Object.freeze({__proto__:null,handleGet:async function({resource:e,metadata:t,body:r}){return{metadata:t,body:r}},handleInsert:bo,handleUpdate:async function({resource:e,id:t,data:r,mappedData:i,originalData:n}){return bo({resource:e,data:r,mappedData:i,originalData:n})},handleUpsert:async function({resource:e,id:t,data:r,mappedData:i}){return bo({resource:e,data:r,mappedData:i})}});const Ao="$overflow",ko="true",Eo=no(Ao)+no(ko);async function Io({resource:e,data:t,mappedData:r,originalData:i}){const n=uo({s3Limit:ho,systemConfig:{version:e.version,timestamps:e.config.timestamps,id:t.id}}),s=ao(r),o=Object.entries(s).sort(([,e],[,t])=>e-t),a={},c={};let l=0,u=!1;r._v&&(a._v=r._v,l+=s._v);let h=n;for(const[e,t]of o)"_v"!==e&&(!u&&l+t>n&&(h-=Eo,u=!0),!u&&l+t<=h?(a[e]=r[e],l+=t):(c[e]=r[e],u=!0));u&&(a[Ao]=ko);const f=Object.keys(c).length>0;let d=f?JSON.stringify(c):"";return f||(d="{}"),{mappedData:a,body:d}}async function So({resource:e,data:t,mappedData:r}){const i={_v:r._v||String(e.version)};i._map=JSON.stringify(e.schema.map);return{mappedData:i,body:JSON.stringify(r)}}const Oo={"user-managed":po,"enforce-limits":fo,"truncate-data":_o,"body-overflow":Object.freeze({__proto__:null,handleGet:async function({resource:e,metadata:t,body:r}){let i={};if(r&&""!==r.trim()){const[e,t,n]=R(()=>JSON.parse(r));i=e?n:{}}const n={...i,...t};return delete n.$overflow,{metadata:n,body:r}},handleInsert:Io,handleUpdate:async function({resource:e,id:t,data:r,mappedData:i,originalData:n}){return Io({resource:e,data:r,mappedData:i,originalData:n})},handleUpsert:async function({resource:e,id:t,data:r,mappedData:i}){return Io({resource:e,data:r,mappedData:i})}}),"body-only":Object.freeze({__proto__:null,handleGet:async function({resource:e,metadata:t,body:r}){let i={};if(r&&""!==r.trim()){const[e,t,n]=R(()=>JSON.parse(r));i=e?n:{}}return{metadata:{...i,...t},body:r}},handleInsert:So,handleUpdate:async function({resource:e,id:t,data:r,mappedData:i}){const n={_v:i._v||String(e.version)};return n._map=JSON.stringify(e.schema.map),{mappedData:n,body:JSON.stringify(i)}},handleUpsert:async function({resource:e,id:t,data:r,mappedData:i}){return So({resource:e,data:r,mappedData:i})}})};function xo(e){const t=Oo[e];if(!t)throw new Error(`Unknown behavior: ${e}. Available behaviors: ${Object.keys(Oo).join(", ")}`);return t}const Ro=Object.keys(Oo),No="user-managed";class Bo extends v{constructor(e={}){super(),this._instanceId=Math.random().toString(36).slice(2,8);const t=function(e){const t=[];e.name?"string"!=typeof e.name?t.push("Resource 'name' must be a string"):""===e.name.trim()&&t.push("Resource 'name' cannot be empty"):t.push("Resource 'name' is required");e.client||t.push("S3 'client' is required");e.attributes?"object"!=typeof e.attributes||Array.isArray(e.attributes)?t.push("Resource 'attributes' must be an object"):0===Object.keys(e.attributes).length&&t.push("Resource 'attributes' cannot be empty"):t.push("Resource 'attributes' are required");void 0!==e.version&&"string"!=typeof e.version&&t.push("Resource 'version' must be a string");void 0!==e.behavior&&"string"!=typeof e.behavior&&t.push("Resource 'behavior' must be a string");void 0!==e.passphrase&&"string"!=typeof e.passphrase&&t.push("Resource 'passphrase' must be a string");void 0!==e.parallelism&&("number"==typeof e.parallelism&&Number.isInteger(e.parallelism)?e.parallelism<1&&t.push("Resource 'parallelism' must be greater than 0"):t.push("Resource 'parallelism' must be an integer"));void 0===e.observers||Array.isArray(e.observers)||t.push("Resource 'observers' must be an array");const r=["cache","autoDecrypt","timestamps","paranoid","allNestedObjectsOptional"];for(const i of r)void 0!==e[i]&&"boolean"!=typeof e[i]&&t.push(`Resource '${i}' must be a boolean`);void 0!==e.idGenerator&&("function"!=typeof e.idGenerator&&"number"!=typeof e.idGenerator?t.push("Resource 'idGenerator' must be a function or a number (size)"):"number"==typeof e.idGenerator&&e.idGenerator<=0&&t.push("Resource 'idGenerator' size must be greater than 0"));void 0!==e.idSize&&("number"==typeof e.idSize&&Number.isInteger(e.idSize)?e.idSize<=0&&t.push("Resource 'idSize' must be greater than 0"):t.push("Resource 'idSize' must be an integer"));if(void 0!==e.partitions)if("object"!=typeof e.partitions||Array.isArray(e.partitions))t.push("Resource 'partitions' must be an object");else for(const[r,i]of Object.entries(e.partitions))if("object"!=typeof i||Array.isArray(i))t.push(`Partition '${r}' must be an object`);else if(i.fields)if("object"!=typeof i.fields||Array.isArray(i.fields))t.push(`Partition '${r}.fields' must be an object`);else for(const[e,n]of Object.entries(i.fields))"string"!=typeof n&&t.push(`Partition '${r}.fields.${e}' must be a string`);else t.push(`Partition '${r}' must have a 'fields' property`);if(void 0!==e.hooks)if("object"!=typeof e.hooks||Array.isArray(e.hooks))t.push("Resource 'hooks' must be an object");else{const r=["beforeInsert","afterInsert","beforeUpdate","afterUpdate","beforeDelete","afterDelete"];for(const[i,n]of Object.entries(e.hooks))if(r.includes(i))if(Array.isArray(n))for(let e=0;e<n.length;e++){const t=n[e];if("function"==typeof t);else if("string"==typeof t)continue}else t.push(`Resource 'hooks.${i}' must be an array`);else t.push(`Invalid hook event '${i}'. Valid events: ${r.join(", ")}`)}return{isValid:0===t.length,errors:t}}(e);if(!t.isValid)throw new ge(`Invalid Resource ${e.name} configuration`,{resourceName:e.name,validation:t.errors,operation:"constructor",suggestion:"Check resource config and attributes."});const{name:r,client:i,version:n="1",attributes:s={},behavior:o=No,passphrase:a="secret",parallelism:c=10,observers:l=[],cache:u=!1,autoDecrypt:h=!0,timestamps:f=!1,partitions:d={},paranoid:p=!0,allNestedObjectsOptional:g=!0,hooks:m={},idGenerator:y,idSize:b=22,versioningEnabled:w=!1}=e;if(this.name=r,this.client=i,this.version=n,this.behavior=o,this.observers=l,this.parallelism=c,this.passphrase=a??"secret",this.versioningEnabled=w,this.idGenerator=this.configureIdGenerator(y,b),this.config={cache:u,hooks:m,paranoid:p,timestamps:f,partitions:d,autoDecrypt:h,allNestedObjectsOptional:g},this.hooks={beforeInsert:[],afterInsert:[],beforeUpdate:[],afterUpdate:[],beforeDelete:[],afterDelete:[]},this.attributes=s||{},this.map=e.map,this.applyConfiguration({map:this.map}),m)for(const[e,t]of Object.entries(m))if(Array.isArray(t)&&this.hooks[e])for(const r of t)"function"==typeof r&&this.hooks[e].push(r.bind(this));this._initMiddleware()}configureIdGenerator(e,t){return"function"==typeof e?e:"number"==typeof e&&e>0?r.customAlphabet(r.urlAlphabet,e):"number"==typeof t&&t>0&&22!==t?r.customAlphabet(r.urlAlphabet,t):S}get options(){return{timestamps:this.config.timestamps,partitions:this.config.partitions||{},cache:this.config.cache,autoDecrypt:this.config.autoDecrypt,paranoid:this.config.paranoid,allNestedObjectsOptional:this.config.allNestedObjectsOptional}}export(){const e=this.schema.export();return e.behavior=this.behavior,e.timestamps=this.config.timestamps,e.partitions=this.config.partitions||{},e.paranoid=this.config.paranoid,e.allNestedObjectsOptional=this.config.allNestedObjectsOptional,e.autoDecrypt=this.config.autoDecrypt,e.cache=this.config.cache,e.hooks=this.hooks,e.map=this.map,e}applyConfiguration({map:e}={}){this.config.timestamps&&(this.attributes.createdAt||(this.attributes.createdAt="string|optional"),this.attributes.updatedAt||(this.attributes.updatedAt="string|optional"),this.config.partitions||(this.config.partitions={}),this.config.partitions.byCreatedDate||(this.config.partitions.byCreatedDate={fields:{createdAt:"date|maxlength:10"}}),this.config.partitions.byUpdatedDate||(this.config.partitions.byUpdatedDate={fields:{updatedAt:"date|maxlength:10"}})),this.setupPartitionHooks(),this.versioningEnabled&&(this.config.partitions.byVersion||(this.config.partitions.byVersion={fields:{_v:"string"}})),this.schema=new gi({name:this.name,attributes:this.attributes,passphrase:this.passphrase,version:this.version,options:{autoDecrypt:this.config.autoDecrypt,allNestedObjectsOptional:this.config.allNestedObjectsOptional},map:e||this.map}),this.validatePartitions()}updateAttributes(e){const t=this.attributes;return this.attributes=e,this.applyConfiguration({map:this.schema?.map}),{oldAttributes:t,newAttributes:e}}addHook(e,t){this.hooks[e]&&this.hooks[e].push(t.bind(this))}async executeHooks(e,t){if(!this.hooks[e])return t;let r=t;for(const t of this.hooks[e])r=await t(r);return r}setupPartitionHooks(){if(!this.config.partitions)return;const e=this.config.partitions;0!==Object.keys(e).length&&(this.hooks.afterInsert||(this.hooks.afterInsert=[]),this.hooks.afterInsert.push(async e=>(await this.createPartitionReferences(e),e)),this.hooks.afterDelete||(this.hooks.afterDelete=[]),this.hooks.afterDelete.push(async e=>(await this.deletePartitionReferences(e),e)))}async validate(t){const r={original:e.cloneDeep(t),isValid:!1,errors:[]},i=await this.schema.validate(t,{mutateOriginal:!1});return!0===i?r.isValid=!0:r.errors=i,r.data=t,r}validatePartitions(){if(!this.config.partitions)return;const e=this.config.partitions;if(0===Object.keys(e).length)return;const t=Object.keys(this.attributes||{});for(const[r,i]of Object.entries(e))if(i.fields)for(const e of Object.keys(i.fields))if(!this.fieldExistsInAttributes(e))throw new me(`Partition '${r}' uses field '${e}' which does not exist in resource attributes. Available fields: ${t.join(", ")}.`,{resourceName:this.name,partitionName:r,fieldName:e,availableFields:t,operation:"validatePartitions"})}fieldExistsInAttributes(e){if(e.startsWith("_"))return!0;if(!e.includes("."))return Object.keys(this.attributes||{}).includes(e);const t=e.split(".");let r=this.attributes||{};for(const e of t){if(!r||"object"!=typeof r||!(e in r))return!1;r=r[e]}return!0}applyPartitionRule(e,t){if(null==e)return e;let r=e;if("string"==typeof t&&t.includes("maxlength:")){const e=t.match(/maxlength:(\d+)/);if(e){const t=parseInt(e[1]);"string"==typeof r&&r.length>t&&(r=r.substring(0,t))}}if(t.includes("date"))if(r instanceof Date)r=r.toISOString().split("T")[0];else if("string"==typeof r)if(r.includes("T")&&r.includes("Z"))r=r.split("T")[0];else{const e=new Date(r);isNaN(e.getTime())||(r=e.toISOString().split("T")[0])}return r}getResourceKey(e){return p("resource="+this.name,"data",`id=${e}`)}getPartitionKey({partitionName:e,id:t,data:r}){if(!this.config.partitions||!this.config.partitions[e])throw new me(`Partition '${e}' not found`,{resourceName:this.name,partitionName:e,operation:"getPartitionKey"});const i=this.config.partitions[e],n=[],s=Object.entries(i.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,t]of s){const i=this.getNestedFieldValue(r,e),s=this.applyPartitionRule(i,t);if(null==s)return null;n.push(`${e}=${s}`)}if(0===n.length)return null;const o=t||r?.id;return o?p(`resource=${this.name}`,`partition=${e}`,...n,`id=${o}`):null}getNestedFieldValue(e,t){if(!t.includes("."))return e[t];const r=t.split(".");let i=e;for(const e of r){if(!i||"object"!=typeof i||!(e in i))return;i=i[e]}return i}calculateContentLength(e){return e?Buffer.isBuffer(e)?e.length:"string"==typeof e?Buffer.byteLength(e,"utf8"):"object"==typeof e?Buffer.byteLength(JSON.stringify(e),"utf8"):Buffer.byteLength(String(e),"utf8"):0}async insert({id:e,...t}){if(await this.exists(e))throw new Error(`Resource with id '${e}' already exists`);this.getResourceKey(e||"(auto)"),this.options.timestamps&&(t.createdAt=(new Date).toISOString(),t.updatedAt=(new Date).toISOString());const r={id:e,...this.applyDefaults(t)},i=await this.executeHooks("beforeInsert",r),n=Object.keys(i).filter(e=>!(e in r)||i[e]!==r[e]),s={};for(const e of n)s[e]=i[e];const{errors:o,isValid:a,data:c}=await this.validate(i);if(!a){const e=o&&o.length&&o[0].message?o[0].message:"Insert failed";throw new ce({bucket:this.client.config.bucket,resourceName:this.name,attributes:i,validation:o,message:e})}const{id:l,...u}=c;Object.assign(u,s);const h=l||e||this.idGenerator(),f=await this.schema.mapper(u);f._v=String(this.version);const d=xo(this.behavior),{mappedData:p,body:g}=await d.handleInsert({resource:this,data:u,mappedData:f,originalData:r}),m=p,y=this.getResourceKey(h);let b;if(g&&""!==g){const[e,t]=await x(()=>Promise.resolve(JSON.parse(g)));e&&(b="application/json")}if("body-only"===this.behavior&&(!g||""===g))throw new Error(`[Resource.insert] Tentativa de gravar objeto sem body! Dados: id=${h}, resource=${this.name}`);const[w,v,_]=await x(()=>this.client.putObject({key:y,body:g,contentType:b,metadata:m}));if(!w){const e=v&&v.message?v.message:"";if(e.includes("metadata headers exceed")||e.includes("Insert failed")){const e=co(m),t=uo({s3Limit:2047,systemConfig:{version:this.version,timestamps:this.config.timestamps,id:h}}),r=e-t;throw v.totalSize=e,v.limit=2047,v.effectiveLimit=t,v.excess=r,new ge("metadata headers exceed",{resourceName:this.name,operation:"insert",id:h,totalSize:e,effectiveLimit:t,excess:r,suggestion:"Reduce metadata size or number of fields."})}throw he(v,{bucket:this.client.config.bucket,key:y,resourceName:this.name,operation:"insert",id:h})}let A=await this.composeFullObjectFromWrite({id:h,metadata:m,body:g,behavior:this.behavior});const k=await this.executeHooks("afterInsert",A);return this.emit("insert",{...A,$before:{...r},$after:{...k}}),k}async get(t){if(e.isObject(t))throw new Error("id cannot be an object");if(e.isEmpty(t))throw new Error("id cannot be empty");const r=this.getResourceKey(t),[i,n,s]=await x(()=>this.client.getObject(r));if(!i)throw he(n,{bucket:this.client.config.bucket,key:r,resourceName:this.name,operation:"get",id:t});if(0===s.ContentLength){const e=new Error(`No such key: ${r} [bucket:${this.client.config.bucket}]`);throw e.name="NoSuchKey",he(e,{bucket:this.client.config.bucket,key:r,resourceName:this.name,operation:"get",id:t})}const o=s.Metadata?._v||this.version,a="string"==typeof o&&o.startsWith("v")?o.slice(1):o,c=await this.getSchemaForVersion(a);let l=await c.unmapper(s.Metadata);const u=xo(this.behavior);let h="";if(s.ContentLength>0){const[e,t,i]=await x(()=>this.client.getObject(r));h=e?await io(i.Body):""}const{metadata:f}=await u.handleGet({resource:this,metadata:l,body:h});let d=await this.composeFullObjectFromWrite({id:t,metadata:f,body:h,behavior:this.behavior});d._contentLength=s.ContentLength,d._lastModified=s.LastModified,d._hasContent=s.ContentLength>0,d._mimeType=s.ContentType||null,d._v=a,s.VersionId&&(d._versionId=s.VersionId),s.Expiration&&(d._expiresAt=s.Expiration),d._definitionHash=this.getDefinitionHash(),a!==this.version&&(d=await this.applyVersionMapping(d,a,this.version)),this.emit("get",d);return d}async exists(e){const t=this.getResourceKey(e),[r,i]=await x(()=>this.client.headObject(t));return r}async update(t,r){if(e.isEmpty(t))throw new Error("id cannot be empty");if(!await this.exists(t))throw new Error(`Resource with id '${t}' does not exist`);const i=await this.get(t),n=e.cloneDeep(r);let s=e.cloneDeep(i);for(const[t,r]of Object.entries(n))if(t.includes(".")){let i=s;const n=t.split(".");for(let e=0;e<n.length-1;e++)"object"==typeof i[n[e]]&&null!==i[n[e]]||(i[n[e]]={}),i=i[n[e]];i[n[n.length-1]]=e.cloneDeep(r)}else"object"!=typeof r||null===r||Array.isArray(r)?s[t]=e.cloneDeep(r):s[t]=e.merge({},s[t],r);if(this.config.timestamps){const e=(new Date).toISOString();s.updatedAt=e,s.metadata||(s.metadata={}),s.metadata.updatedAt=e}const o=await this.executeHooks("beforeUpdate",e.cloneDeep(s)),a={...i,...o,id:t},{isValid:c,errors:l,data:u}=await this.validate(e.cloneDeep(a));if(!c)throw new ce({bucket:this.client.config.bucket,resourceName:this.name,attributes:o,validation:l,message:"validation: "+(l&&l.length?JSON.stringify(l):"unknown")});await this.schema.mapper(u);const h=xo(this.behavior),f=await this.schema.mapper({...i,...o});f._v=String(this.version),await h.handleUpdate({resource:this,id:t,data:{...i,...o},mappedData:f,originalData:{...n,id:t}});const{id:d,...p}=u,g={...i,id:t},m={...p,id:t};await this.handlePartitionReferenceUpdates(g,m);const y=await this.schema.mapper(p);y._v=String(this.version);const b=xo(this.behavior),{mappedData:w,body:v}=await b.handleUpdate({resource:this,id:t,data:p,mappedData:y,originalData:{...n,id:t}}),_=w,A=this.getResourceKey(t);let k,E=v;if(""===v&&"body-overflow"!==this.behavior){const[e,t,r]=await x(()=>this.client.getObject(A));if(e&&r.ContentLength>0){const e=Buffer.from(await r.Body.transformToByteArray()),t=e.toString(),[i,n]=await x(()=>Promise.resolve(JSON.parse(t)));i||(E=e,k=r.ContentType)}}let I=k;if(E&&""!==E&&!I){const[e,t]=await x(()=>Promise.resolve(JSON.parse(E)));e&&(I="application/json")}this.versioningEnabled&&i._v!==this.version&&await this.createHistoricalVersion(t,i);const[S,O]=await x(()=>this.client.putObject({key:A,body:E,contentType:I,metadata:_}));if(!S&&O&&O.message&&O.message.includes("metadata headers exceed")){const e=co(_),r=uo({s3Limit:2047,systemConfig:{version:this.version,timestamps:this.config.timestamps,id:t}}),i=e-r;throw O.totalSize=e,O.limit=2047,O.effectiveLimit=r,O.excess=i,this.emit("exceedsLimit",{operation:"update",totalSize:e,limit:2047,effectiveLimit:r,excess:i,data:p}),new ge("metadata headers exceed",{resourceName:this.name,operation:"update",id:t,totalSize:e,effectiveLimit:r,excess:i,suggestion:"Reduce metadata size or number of fields."})}if(!S)throw he(O,{bucket:this.client.config.bucket,key:A,resourceName:this.name,operation:"update",id:t});const R=await this.composeFullObjectFromWrite({id:t,metadata:_,body:E,behavior:this.behavior}),N=await this.executeHooks("afterUpdate",R);return this.emit("update",{...R,$before:{...i},$after:{...N}}),N}async delete(t){if(e.isEmpty(t))throw new Error("id cannot be empty");let r,i=null;const[n,s,o]=await x(()=>this.get(t));n?r=o:(r={id:t},i=s),await this.executeHooks("beforeDelete",r);const a=this.getResourceKey(t),[c,l,u]=await x(()=>this.client.deleteObject(a));if(this.emit("delete",{...r,$before:{...r},$after:null}),i)throw he(i,{bucket:this.client.config.bucket,key:a,resourceName:this.name,operation:"delete",id:t});if(!c)throw he(l,{key:a,resourceName:this.name,operation:"delete",id:t});return await this.executeHooks("afterDelete",r),u}async upsert({id:e,...t}){return await this.exists(e)?this.update(e,t):this.insert({id:e,...t})}async count({partition:e=null,partitionValues:t={}}={}){let r;if(e&&Object.keys(t).length>0){const i=this.config.partitions[e];if(!i)throw new me(`Partition '${e}' not found`,{resourceName:this.name,partitionName:e,operation:"count"});const n=[],s=Object.entries(i.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,r]of s){const i=t[e];if(null!=i){const t=this.applyPartitionRule(i,r);n.push(`${e}=${t}`)}}r=n.length>0?`resource=${this.name}/partition=${e}/${n.join("/")}`:`resource=${this.name}/partition=${e}`}else r=`resource=${this.name}/data`;const i=await this.client.count({prefix:r});return this.emit("count",i),i}async insertMany(e){const{results:r}=await t.PromisePool.for(e).withConcurrency(this.parallelism).handleError(async(e,t)=>{this.emit("error",e,t),this.observers.map(r=>r.emit("error",this.name,e,t))}).process(async e=>await this.insert(e));return this.emit("insertMany",e.length),r}async deleteMany(r){const i=e.chunk(r.map(e=>this.getResourceKey(e)),1e3);r.map(e=>this.getResourceKey(e));const{results:n}=await t.PromisePool.for(i).withConcurrency(this.parallelism).handleError(async(e,t)=>{this.emit("error",e,t),this.observers.map(r=>r.emit("error",this.name,e,t))}).process(async e=>{const t=await this.client.deleteObjects(e);return e.forEach(e=>{const t=e.split("/").find(e=>e.startsWith("id=")),r=t?t.replace("id=",""):null;r&&(this.emit("deleted",r),this.observers.map(e=>e.emit("deleted",this.name,r)))}),t});return this.emit("deleteMany",r.length),n}async deleteAll(){if(!1!==this.config.paranoid)throw new ge("deleteAll() is a dangerous operation and requires paranoid: false option.",{resourceName:this.name,operation:"deleteAll",paranoid:this.config.paranoid,suggestion:"Set paranoid: false to allow deleteAll."});const e=`resource=${this.name}/data`,t=await this.client.deleteAll({prefix:e});return this.emit("deleteAll",{version:this.version,prefix:e,deletedCount:t}),{deletedCount:t,version:this.version}}async deleteAllData(){if(!1!==this.config.paranoid)throw new ge("deleteAllData() is a dangerous operation and requires paranoid: false option.",{resourceName:this.name,operation:"deleteAllData",paranoid:this.config.paranoid,suggestion:"Set paranoid: false to allow deleteAllData."});const e=`resource=${this.name}`,t=await this.client.deleteAll({prefix:e});return this.emit("deleteAllData",{resource:this.name,prefix:e,deletedCount:t}),{deletedCount:t,resource:this.name}}async listIds({partition:e=null,partitionValues:t={},limit:r,offset:i=0}={}){let n;if(e&&Object.keys(t).length>0){if(!this.config.partitions||!this.config.partitions[e])throw new me(`Partition '${e}' not found`,{resourceName:this.name,partitionName:e,operation:"listIds"});const r=this.config.partitions[e],i=[],s=Object.entries(r.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,r]of s){const n=t[e];if(null!=n){const t=this.applyPartitionRule(n,r);i.push(`${e}=${t}`)}}n=i.length>0?`resource=${this.name}/partition=${e}/${i.join("/")}`:`resource=${this.name}/partition=${e}`}else n=`resource=${this.name}/data`;const s=(await this.client.getKeysPage({prefix:n,offset:i,amount:r||1e3})).map(e=>{const t=e.split("/").find(e=>e.startsWith("id="));return t?t.replace("id=",""):null}).filter(Boolean);return this.emit("listIds",s.length),s}async list({partition:e=null,partitionValues:t={},limit:r,offset:i=0}={}){const[n,s,o]=await x(async()=>e?await this.listPartition({partition:e,partitionValues:t,limit:r,offset:i}):await this.listMain({limit:r,offset:i}));return n?o:this.handleListError(s,{partition:e,partitionValues:t})}async listMain({limit:e,offset:t=0}){const[r,i,n]=await x(()=>this.listIds({limit:e,offset:t}));if(!r)throw i;const s=await this.processListResults(n,"main");return this.emit("list",{count:s.length,errors:0}),s}async listPartition({partition:e,partitionValues:t,limit:r,offset:i=0}){if(!this.config.partitions?.[e])return this.emit("list",{partition:e,partitionValues:t,count:0,errors:0}),[];const n=this.config.partitions[e],s=this.buildPartitionPrefix(e,n,t),[o,a,c]=await x(()=>this.client.getAllKeys({prefix:s}));if(!o)throw a;const l=this.extractIdsFromKeys(c).slice(i),u=r?l.slice(0,r):l,h=await this.processPartitionResults(u,e,n,c);return this.emit("list",{partition:e,partitionValues:t,count:h.length,errors:0}),h}buildPartitionPrefix(e,t,r){const i=[],n=Object.entries(t.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,t]of n){const n=r[e];if(null!=n){const r=this.applyPartitionRule(n,t);i.push(`${e}=${r}`)}}return i.length>0?`resource=${this.name}/partition=${e}/${i.join("/")}`:`resource=${this.name}/partition=${e}`}extractIdsFromKeys(e){return e.map(e=>{const t=e.split("/").find(e=>e.startsWith("id="));return t?t.replace("id=",""):null}).filter(Boolean)}async processListResults(e,r="main"){const{results:i,errors:n}=await t.PromisePool.for(e).withConcurrency(this.parallelism).handleError(async(e,t)=>{this.emit("error",e,content),this.observers.map(t=>t.emit("error",this.name,e,content))}).process(async e=>{const[t,i,n]=await x(()=>this.get(e));return t?n:this.handleResourceError(i,e,r)});return this.emit("list",{count:i.length,errors:0}),i}async processPartitionResults(e,r,i,n){const s=Object.entries(i.fields).sort(([e],[t])=>e.localeCompare(t)),{results:o,errors:a}=await t.PromisePool.for(e).withConcurrency(this.parallelism).handleError(async(e,t)=>{this.emit("error",e,content),this.observers.map(t=>t.emit("error",this.name,e,content))}).process(async e=>{const[t,i,o]=await x(async()=>{const t=this.extractPartitionValuesFromKey(e,n,s);return await this.getFromPartition({id:e,partitionName:r,partitionValues:t})});return t?o:this.handleResourceError(i,e,"partition")});return o.filter(e=>null!==e)}extractPartitionValuesFromKey(e,t,r){const i=t.find(t=>t.includes(`id=${e}`));if(!i)throw new me(`Partition key not found for ID ${e}`,{resourceName:this.name,id:e,operation:"extractPartitionValuesFromKey"});const n=i.split("/"),s={};for(const[e]of r){const t=n.find(t=>t.startsWith(`${e}=`));if(t){const r=t.replace(`${e}=`,"");s[e]=r}}return s}handleResourceError(e,t,r){if(e.message.includes("Cipher job failed")||e.message.includes("OperationError"))return{id:t,_decryptionFailed:!0,_error:e.message,..."partition"===r&&{_partition:r}};throw e}handleListError(e,{partition:t,partitionValues:r}){return e.message.includes("Partition '")&&e.message.includes("' not found"),this.emit("list",{partition:t,partitionValues:r,count:0,errors:1}),[]}async getMany(e){const{results:r,errors:i}=await t.PromisePool.for(e).withConcurrency(this.client.parallelism).handleError(async(e,t)=>(this.emit("error",e,content),this.observers.map(t=>t.emit("error",this.name,e,content)),{id:t,_error:e.message,_decryptionFailed:e.message.includes("Cipher job failed")||e.message.includes("OperationError")})).process(async e=>{const[t,r,i]=await x(()=>this.get(e));if(t)return i;if(r.message.includes("Cipher job failed")||r.message.includes("OperationError"))return{id:e,_decryptionFailed:!0,_error:r.message};throw r});return this.emit("getMany",e.length),r}async getAll(){const[e,t,r]=await x(()=>this.listIds());if(!e)throw t;const i=[];for(const e of r){const[t,r,n]=await x(()=>this.get(e));t&&i.push(n)}return i}async page({offset:e=0,size:t=100,partition:r=null,partitionValues:i={},skipCount:n=!1}={}){const[s,o,a]=await x(async()=>{let s=null,o=null;if(!n){const[e,n,a]=await x(()=>this.count({partition:r,partitionValues:i}));e?(s=a,o=Math.ceil(s/t)):(s=null,o=null)}const a=Math.floor(e/t);let c=[];if(t<=0)c=[];else{const[n,s,o]=await x(()=>this.list({partition:r,partitionValues:i,limit:t,offset:e}));c=n?o:[]}const l={items:c,totalItems:s,page:a,pageSize:t,totalPages:o,hasMore:c.length===t&&e+t<(s||1/0),_debug:{requestedSize:t,requestedOffset:e,actualItemsReturned:c.length,skipCount:n,hasTotalItems:null!==s}};return this.emit("page",l),l});return s?a:{items:[],totalItems:null,page:Math.floor(e/t),pageSize:t,totalPages:null,_debug:{requestedSize:t,requestedOffset:e,actualItemsReturned:0,skipCount:n,hasTotalItems:!1,error:o.message}}}readable(){return new to({resource:this}).build()}writable(){return new ro({resource:this}).build()}async setContent({id:e,buffer:t,contentType:r="application/octet-stream"}){const[i,n,s]=await x(()=>this.get(e));if(!i||!s)throw new ge(`Resource with id '${e}' not found`,{resourceName:this.name,id:e,operation:"setContent"});const o={...s,_hasContent:!0,_contentLength:t.length,_mimeType:r},a=await this.schema.mapper(o),[c,l]=await x(()=>this.client.putObject({key:this.getResourceKey(e),metadata:a,body:t,contentType:r}));if(!c)throw l;return this.emit("setContent",{id:e,contentType:r,contentLength:t.length}),o}async content(e){const t=this.getResourceKey(e),[r,i,n]=await x(()=>this.client.getObject(t));if(!r){if("NoSuchKey"===i.name)return{buffer:null,contentType:null};throw i}const s=Buffer.from(await n.Body.transformToByteArray()),o=n.ContentType||null;return this.emit("content",e,s.length,o),{buffer:s,contentType:o}}async hasContent(e){const t=this.getResourceKey(e),[r,i,n]=await x(()=>this.client.headObject(t));return!!r&&n.ContentLength>0}async deleteContent(e){const t=this.getResourceKey(e),[r,i,n]=await x(()=>this.client.headObject(t));if(!r)throw i;const s=n.Metadata||{},[o,a,c]=await x(()=>this.client.putObject({key:t,body:"",metadata:s}));if(!o)throw a;return this.emit("deleteContent",e),c}getDefinitionHash(){const e={attributes:this.attributes,behavior:this.behavior},t=ii(e);return`sha256:${n.createHash("sha256").update(t).digest("hex")}`}extractVersionFromKey(e){const t=e.split("/").find(e=>e.startsWith("v="));return t?t.replace("v=",""):null}async getSchemaForVersion(e){if(e===this.version)return this.schema;const[t,r,i]=await x(()=>Promise.resolve(new gi({name:this.name,attributes:this.attributes,passphrase:this.passphrase,version:e,options:{...this.config,autoDecrypt:!0,autoEncrypt:!0}})));return t?i:this.schema}async createPartitionReferences(e){const t=this.config.partitions;if(t&&0!==Object.keys(t).length)for(const[r,i]of Object.entries(t)){const t=this.getPartitionKey({partitionName:r,id:e.id,data:e});if(t){const e={_v:String(this.version)};await this.client.putObject({key:t,metadata:e,body:"",contentType:void 0})}}}async deletePartitionReferences(e){const t=this.config.partitions;if(!t||0===Object.keys(t).length)return;const r=[];for(const[i,n]of Object.entries(t)){const t=this.getPartitionKey({partitionName:i,id:e.id,data:e});t&&r.push(t)}if(r.length>0){const[e,t]=await x(()=>this.client.deleteObjects(r))}}async query(e={},{limit:t=100,offset:r=0,partition:i=null,partitionValues:n={}}={}){if(0===Object.keys(e).length)return await this.list({partition:i,partitionValues:n,limit:t,offset:r});const s=[];let o=r;const a=Math.min(t,50);for(;s.length<t;){const t=await this.list({partition:i,partitionValues:n,limit:a,offset:o});if(0===t.length)break;const r=t.filter(t=>Object.entries(e).every(([e,r])=>t[e]===r));if(s.push(...r),o+=a,t.length<a)break}return s.slice(0,t)}async handlePartitionReferenceUpdates(e,t){const r=this.config.partitions;if(!r||0===Object.keys(r).length)return;for(const[i,n]of Object.entries(r)){const[r,s]=await x(()=>this.handlePartitionReferenceUpdate(i,n,e,t))}const i=t.id||e.id;for(const[e,n]of Object.entries(r)){const r=`resource=${this.name}/partition=${e}`;let n=[];const[s,o,a]=await x(()=>this.client.getAllKeys({prefix:r}));if(!s)continue;n=a;const c=this.getPartitionKey({partitionName:e,id:i,data:t});for(const e of n)if(e.endsWith(`/id=${i}`)&&e!==c){const[t,r]=await x(()=>this.client.deleteObject(e))}}}async handlePartitionReferenceUpdate(e,t,r,i){const n=i.id||r.id,s=this.getPartitionKey({partitionName:e,id:n,data:r}),o=this.getPartitionKey({partitionName:e,id:n,data:i});if(s!==o){if(s){const[e,t]=await x(async()=>{await this.client.deleteObject(s)})}if(o){const[e,t]=await x(async()=>{const e={_v:String(this.version)};await this.client.putObject({key:o,metadata:e,body:"",contentType:void 0})})}}else if(o){const[e,t]=await x(async()=>{const e={_v:String(this.version)};await this.client.putObject({key:o,metadata:e,body:"",contentType:void 0})})}}async updatePartitionReferences(e){const t=this.config.partitions;if(t&&0!==Object.keys(t).length)for(const[r,i]of Object.entries(t)){if(!i||!i.fields||"object"!=typeof i.fields)continue;const t=this.getPartitionKey({partitionName:r,id:e.id,data:e});if(t){const e={_v:String(this.version)},[r,i]=await x(async()=>{await this.client.putObject({key:t,metadata:e,body:"",contentType:void 0})})}}}async getFromPartition({id:e,partitionName:t,partitionValues:r={}}){if(!this.config.partitions||!this.config.partitions[t])throw new me(`Partition '${t}' not found`,{resourceName:this.name,partitionName:t,operation:"getFromPartition"});const i=this.config.partitions[t],n=[],s=Object.entries(i.fields).sort(([e],[t])=>e.localeCompare(t));for(const[e,t]of s){const i=r[e];if(null!=i){const r=this.applyPartitionRule(i,t);n.push(`${e}=${r}`)}}if(0===n.length)throw new me(`No partition values provided for partition '${t}'`,{resourceName:this.name,partitionName:t,operation:"getFromPartition"});const o=p(`resource=${this.name}`,`partition=${t}`,...n,`id=${e}`),[a,c]=await x(async()=>{await this.client.headObject(o)});if(!a)throw new ge(`Resource with id '${e}' not found in partition '${t}'`,{resourceName:this.name,id:e,partitionName:t,operation:"getFromPartition"});const l=await this.get(e);return l._partition=t,l._partitionValues=r,this.emit("getFromPartition",l),l}async createHistoricalVersion(e,t){const r=p(`resource=${this.name}`,"historical",`id=${e}`),i={...t,_v:t._v||this.version,_historicalTimestamp:(new Date).toISOString()},n=await this.schema.mapper(i),s=xo(this.behavior),{mappedData:o,body:a}=await s.handleInsert({resource:this,data:i,mappedData:n}),c={...o,_v:t._v||this.version,_historicalTimestamp:i._historicalTimestamp};let l;if(a&&""!==a){const[e,t]=await x(()=>Promise.resolve(JSON.parse(a)));e&&(l="application/json")}await this.client.putObject({key:r,metadata:c,body:a,contentType:l})}async applyVersionMapping(e,t,r){if(t===r)return e;return{...e,_v:r,_originalVersion:t,_versionMapped:!0}}async composeFullObjectFromWrite({id:e,metadata:t,body:r,behavior:i}){const n={};t&&"true"===t.$truncated&&(n.$truncated="true"),t&&"true"===t.$overflow&&(n.$overflow="true");let s={};const[o,a,c]=await x(()=>this.schema.unmapper(t));s=o?c:t;const l=e=>{if(!e||"object"!=typeof e)return e;const t={};for(const[r,i]of Object.entries(e))r.startsWith("_")||(t[r]=i);return t},u=e=>{if("object"==typeof e&&null!==e)return e;if("string"==typeof e){if("[object Object]"===e)return{};if(e.startsWith("{")||e.startsWith("[")){const[t,r,i]=R(()=>JSON.parse(e));return t?i:e}return e}return e};if("body-overflow"===i){const i=t&&"true"===t.$overflow;let n={};if(i&&r){const[e,t,i]=await x(()=>Promise.resolve(JSON.parse(r)));if(e){const[e,t,r]=await x(()=>this.schema.unmapper(i));n=e?r:{}}}const o={...s,...n,id:e};Object.keys(o).forEach(e=>{o[e]=u(o[e])});const a=l(o);return i&&(a.$overflow="true"),a}if("body-only"===i){const[i,n,s]=await x(()=>Promise.resolve(r?JSON.parse(r):{}));let o=this.schema.map;if(t&&t._map){const[e,r,i]=await x(()=>Promise.resolve("string"==typeof t._map?JSON.parse(t._map):t._map));o=e?i:this.schema.map}const[a,c,l]=await x(()=>this.schema.unmapper(s,o)),h=a?{...l,id:e}:{id:e};return Object.keys(h).forEach(e=>{h[e]=u(h[e])}),h}const h={...s,id:e};Object.keys(h).forEach(e=>{h[e]=u(h[e])});const f=l(h);return n.$truncated&&(f.$truncated=n.$truncated),n.$overflow&&(f.$overflow=n.$overflow),f}emit(e,...t){return super.emit(e,...t)}async replace(e,t){await this.delete(e),await new Promise(e=>setTimeout(e,100));const r=Date.now();for(;Date.now()-r<5e3;){if(!await this.exists(e))break;await new Promise(e=>setTimeout(e,50))}try{return await this.insert({...t,id:e})}catch(r){if(r&&r.message&&r.message.includes("already exists")){return await this.update(e,t)}throw r}}_initMiddleware(){this._middlewares=new Map,this._middlewareMethods=["get","list","listIds","getAll","count","page","insert","update","delete","deleteMany","exists","getMany"];for(const e of this._middlewareMethods)this._middlewares.set(e,[]),this[`_original_${e}`]||(this[`_original_${e}`]=this[e].bind(this),this[e]=async(...t)=>{const r={resource:this,args:t,method:e};let i=-1;const n=this._middlewares.get(e),s=async t=>{if(t<=i)throw new Error("next() called multiple times");return i=t,t<n.length?await n[t](r,()=>s(t+1)):await this[`_original_${e}`](...r.args)};return await s(0)})}useMiddleware(e,t){if(this._middlewares||this._initMiddleware(),!this._middlewares.has(e))throw new ge(`No such method for middleware: ${e}`,{operation:"useMiddleware",method:e});this._middlewares.get(e).push(t)}applyDefaults(e){const t={...e};for(const[e,r]of Object.entries(this.attributes))if(void 0===t[e]&&"string"==typeof r&&r.includes("default:")){const i=r.match(/default:([^|]+)/);if(i){let n=i[1];r.includes("boolean")?n="true"===n:r.includes("number")&&(n=Number(n)),t[e]=n}}return t}}class Co extends v{constructor(e){super(),this.version="1",this.s3dbVersion=(()=>{const[e,t,r]=x(()=>"6.2.0");return e?r:"latest"})(),this.resources={},this.savedMetadata=null,this.options=e,this.verbose=e.verbose||!1,this.parallelism=parseInt(e.parallelism+"")||10,this.plugins=e.plugins||[],this.pluginList=e.plugins||[],this.cache=e.cache,this.passphrase=e.passphrase||"secret",this.versioningEnabled=e.versioningEnabled||!1;let t=e.connectionString;if(!t&&(e.bucket||e.accessKeyId||e.secretAccessKey)){const{bucket:r,region:i,accessKeyId:n,secretAccessKey:s,endpoint:o,forcePathStyle:a}=e;if(o){const e=new URL(o);n&&(e.username=encodeURIComponent(n)),s&&(e.password=encodeURIComponent(s)),e.pathname=`/${r||"s3db"}`,a&&e.searchParams.set("forcePathStyle","true"),t=e.toString()}else if(n&&s){const e=new URLSearchParams;e.set("region",i||"us-east-1"),a&&e.set("forcePathStyle","true"),t=`s3://${encodeURIComponent(n)}:${encodeURIComponent(s)}@${r||"s3db"}?${e.toString()}`}}this.client=e.client||new ve({verbose:this.verbose,parallelism:this.parallelism,connectionString:t}),this.bucket=this.client.bucket,this.keyPrefix=this.client.keyPrefix,this._exitListenerRegistered||(this._exitListenerRegistered=!0,process.on("exit",async()=>{if(this.isConnected())try{await this.disconnect()}catch(e){}}))}async connect(){await this.startPlugins();let e=null;if(await this.client.exists("s3db.json")){const t=await this.client.getObject("s3db.json");e=JSON.parse(await io(t?.Body))}else e=this.blankMetadataStructure(),await this.uploadMetadataFile();this.savedMetadata=e;const t=this.detectDefinitionChanges(e);for(const[t,r]of Object.entries(e.resources||{})){const e=r.currentVersion||"v0",i=r.versions?.[e];i&&(this.resources[t]=new Bo({name:t,client:this.client,database:this,version:e,attributes:i.attributes,behavior:i.behavior||"user-managed",parallelism:this.parallelism,passphrase:this.passphrase,observers:[this],cache:this.cache,timestamps:void 0!==i.timestamps&&i.timestamps,partitions:r.partitions||i.partitions||{},paranoid:void 0===i.paranoid||i.paranoid,allNestedObjectsOptional:void 0===i.allNestedObjectsOptional||i.allNestedObjectsOptional,autoDecrypt:void 0===i.autoDecrypt||i.autoDecrypt,hooks:i.hooks||{},versioningEnabled:this.versioningEnabled,map:i.map}))}t.length>0&&this.emit("resourceDefinitionsChanged",{changes:t,metadata:this.savedMetadata}),this.emit("connected",new Date)}detectDefinitionChanges(e){const t=[];for(const[r,i]of Object.entries(this.resources)){const n=this.generateDefinitionHash(i.export()),s=e.resources?.[r];if(s){const e=s.currentVersion||"v0",i=s.versions?.[e],o=i?.hash;o!==n&&t.push({type:"changed",resourceName:r,currentHash:n,savedHash:o,fromVersion:e,toVersion:this.getNextVersion(s.versions)})}else t.push({type:"new",resourceName:r,currentHash:n,savedHash:null})}for(const[r,i]of Object.entries(e.resources||{}))if(!this.resources[r]){const e=i.currentVersion||"v0",n=i.versions?.[e];t.push({type:"deleted",resourceName:r,currentHash:null,savedHash:n?.hash,deletedVersion:e})}return t}generateDefinitionHash(e,t=void 0){const r={...e.attributes};e.timestamps&&(delete r.createdAt,delete r.updatedAt);const i={attributes:r,behavior:t||e.behavior||"user-managed",partitions:e.partitions||{}},s=ii(i);return`sha256:${n.createHash("sha256").update(s).digest("hex")}`}getNextVersion(e={}){const t=Object.keys(e).filter(e=>e.startsWith("v")).map(e=>parseInt(e.substring(1))).filter(e=>!isNaN(e));return`v${(t.length>0?Math.max(...t):-1)+1}`}async startPlugins(){const t=this;if(!e.isEmpty(this.pluginList)){const r=this.pluginList.map(t=>e.isFunction(t)?new t(this):t),i=r.map(async e=>{e.beforeSetup&&await e.beforeSetup(),await e.setup(t),e.afterSetup&&await e.afterSetup()});await Promise.all(i);const n=r.map(async e=>{e.beforeStart&&await e.beforeStart(),await e.start(),e.afterStart&&await e.afterStart()});await Promise.all(n)}}async usePlugin(e,t=null){const r=t||e.constructor.name.replace("Plugin","").toLowerCase();return this.plugins[r]=e,this.isConnected()&&(await e.setup(this),await e.start()),e}async uploadMetadataFile(){const e={version:this.version,s3dbVersion:this.s3dbVersion,lastUpdated:(new Date).toISOString(),resources:{}};Object.entries(this.resources).forEach(([t,r])=>{const i=r.export(),n=this.generateDefinitionHash(i),s=this.savedMetadata?.resources?.[t],o=s?.currentVersion||"v0",a=s?.versions?.[o];let c,l;a&&a.hash===n?(c=o,l=!1):(c=this.getNextVersion(s?.versions),l=!0),e.resources[t]={currentVersion:c,partitions:r.config.partitions||{},versions:{...s?.versions,[c]:{hash:n,attributes:i.attributes,behavior:i.behavior||"user-managed",timestamps:r.config.timestamps,partitions:r.config.partitions,paranoid:r.config.paranoid,allNestedObjectsOptional:r.config.allNestedObjectsOptional,autoDecrypt:r.config.autoDecrypt,cache:r.config.cache,hooks:r.config.hooks,createdAt:l?(new Date).toISOString():a?.createdAt}}},r.version!==c&&(r.version=c,r.emit("versionUpdated",{oldVersion:o,newVersion:c}))}),await this.client.putObject({key:"s3db.json",body:JSON.stringify(e,null,2),contentType:"application/json"}),this.savedMetadata=e,this.emit("metadataUploaded",e)}blankMetadataStructure(){return{version:"1",s3dbVersion:this.s3dbVersion,resources:{}}}resourceExists(e){return!!this.resources[e]}resourceExistsWithSameHash({name:e,attributes:t,behavior:r="user-managed",partitions:i={},options:n={}}){if(!this.resources[e])return{exists:!1,sameHash:!1,hash:null};const s=this.resources[e],o=this.generateDefinitionHash(s.export()),a=new Bo({name:e,attributes:t,behavior:r,partitions:i,client:this.client,version:s.version,passphrase:this.passphrase,versioningEnabled:this.versioningEnabled,...n}),c=this.generateDefinitionHash(a.export());return{exists:!0,sameHash:o===c,hash:c,existingHash:o}}async createResource({name:e,attributes:t,behavior:r="user-managed",hooks:i,...n}){if(this.resources[e]){const s=this.resources[e];if(Object.assign(s.config,{cache:this.cache,...n}),r&&(s.behavior=r),s.versioningEnabled=this.versioningEnabled,s.updateAttributes(t),i)for(const[e,t]of Object.entries(i))if(Array.isArray(t)&&s.hooks[e])for(const r of t)"function"==typeof r&&s.hooks[e].push(r.bind(s));const o=this.generateDefinitionHash(s.export(),s.behavior),a=this.savedMetadata?.resources?.[e],c=a?.currentVersion||"v0",l=a?.versions?.[c];return l&&l.hash===o||await this.uploadMetadataFile(),this.emit("s3db.resourceUpdated",e),s}const s=this.savedMetadata?.resources?.[e],o=s?.currentVersion||"v0",a=new Bo({name:e,client:this.client,version:void 0!==n.version?n.version:o,attributes:t,behavior:r,parallelism:this.parallelism,passphrase:void 0!==n.passphrase?n.passphrase:this.passphrase,observers:[this],cache:void 0!==n.cache?n.cache:this.cache,timestamps:void 0!==n.timestamps&&n.timestamps,partitions:n.partitions||{},paranoid:void 0===n.paranoid||n.paranoid,allNestedObjectsOptional:void 0===n.allNestedObjectsOptional||n.allNestedObjectsOptional,autoDecrypt:void 0===n.autoDecrypt||n.autoDecrypt,hooks:i||{},versioningEnabled:this.versioningEnabled,map:n.map,idGenerator:n.idGenerator,idSize:n.idSize});return a.database=this,this.resources[e]=a,await this.uploadMetadataFile(),this.emit("s3db.resourceCreated",e),a}resource(e){return this.resources[e]?this.resources[e]:Promise.reject(`resource ${e} does not exist`)}async listResources(){return Object.keys(this.resources).map(e=>({name:e}))}async getResource(e){if(!this.resources[e])throw new ie({bucket:this.client.config.bucket,resourceName:e,id:e});return this.resources[e]}get config(){return{version:this.version,s3dbVersion:this.s3dbVersion,bucket:this.bucket,keyPrefix:this.keyPrefix,parallelism:this.parallelism,verbose:this.verbose}}isConnected(){return!!this.savedMetadata}async disconnect(){try{if(this.pluginList&&this.pluginList.length>0){for(const e of this.pluginList)e&&"function"==typeof e.removeAllListeners&&e.removeAllListeners();const e=this.pluginList.map(async e=>{try{e&&"function"==typeof e.stop&&await e.stop()}catch(e){}});await Promise.all(e)}if(this.resources&&Object.keys(this.resources).length>0){for(const[e,t]of Object.entries(this.resources))try{t&&"function"==typeof t.removeAllListeners&&t.removeAllListeners(),t._pluginWrappers&&t._pluginWrappers.clear(),t._pluginMiddlewares&&(t._pluginMiddlewares={}),t.observers&&Array.isArray(t.observers)&&(t.observers=[])}catch(e){}Object.keys(this.resources).forEach(e=>delete this.resources[e])}this.client&&"function"==typeof this.client.removeAllListeners&&this.client.removeAllListeners(),this.removeAllListeners(),this.savedMetadata=null,this.plugins={},this.pluginList=[],this.emit("disconnected",new Date)}catch(e){}}}class jo extends Co{}class Do extends v{constructor(e={}){super(),this.config=e}async _set(e,t){}async _get(e){}async _del(e){}async _clear(e){}validateKey(e){if(null==e||"string"!=typeof e||!e)throw new Error("Invalid key")}async set(e,t){return this.validateKey(e),await this._set(e,t),this.emit("set",t),t}async get(e){this.validateKey(e);const t=await this._get(e);return this.emit("get",t),t}async del(e){this.validateKey(e);const t=await this._del(e);return this.emit("delete",t),t}async delete(e){return this.del(e)}async clear(e){const t=await this._clear(e);return this.emit("clear",t),t}}class Po extends Do{constructor(e={}){super(e),this.cache={},this.meta={},this.maxSize=e.maxSize||0,this.ttl=e.ttl||0}async _set(e,t){if(this.maxSize>0&&Object.keys(this.cache).length>=this.maxSize){const e=Object.entries(this.meta).sort((e,t)=>e[1].ts-t[1].ts)[0]?.[0];e&&(delete this.cache[e],delete this.meta[e])}return this.cache[e]=t,this.meta[e]={ts:Date.now()},t}async _get(e){if(!Object.prototype.hasOwnProperty.call(this.cache,e))return null;if(this.ttl>0){const t=Date.now(),r=this.meta[e];if(r&&t-r.ts>1e3*this.ttl)return delete this.cache[e],delete this.meta[e],null}return this.cache[e]}async _del(e){return delete this.cache[e],delete this.meta[e],!0}async _clear(e){if(!e)return this.cache={},this.meta={},!0;for(const t of Object.keys(this.cache))t.startsWith(e)&&(delete this.cache[t],delete this.meta[t]);return!0}async size(){return Object.keys(this.cache).length}async keys(){return Object.keys(this.cache)}}var Lo={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};function To(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function Mo(e,t,r,i,n){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+i),n);else for(var s=0;s<i;s++)e[n+s]=t[r+s]}var Uo=Uint8Array,Fo=Uint16Array,$o=Int32Array;function zo(e){for(var t=e.length;--t>=0;)e[t]=0}var qo=256,Qo=286,Vo=30,Go=15,Ho=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],Jo=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Wo=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Ko=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Zo=new Array(576);zo(Zo);var Yo=new Array(60);zo(Yo);var Xo=new Array(512);zo(Xo);var ea=new Array(256);zo(ea);var ta=new Array(29);zo(ta);var ra,ia,na,sa=new Array(Vo);function oa(e,t,r,i,n){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=i,this.max_length=n,this.has_stree=e&&e.length}function aa(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function ca(e){return e<256?Xo[e]:Xo[256+(e>>>7)]}function la(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function ua(e,t,r){e.bi_valid>16-r?(e.bi_buf|=t<<e.bi_valid&65535,la(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=r-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)}function ha(e,t,r){ua(e,r[2*t],r[2*t+1])}function fa(e,t){var r=0;do{r|=1&e,e>>>=1,r<<=1}while(--t>0);return r>>>1}function da(e,t,r){var i,n,s=new Array(16),o=0;for(i=1;i<=Go;i++)s[i]=o=o+r[i-1]<<1;for(n=0;n<=t;n++){var a=e[2*n+1];0!==a&&(e[2*n]=fa(s[a]++,a))}}function pa(e){var t;for(t=0;t<Qo;t++)e.dyn_ltree[2*t]=0;for(t=0;t<Vo;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function ga(e){e.bi_valid>8?la(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function ma(e,t,r,i){var n=2*t,s=2*r;return e[n]<e[s]||e[n]===e[s]&&i[t]<=i[r]}function ya(e,t,r){for(var i=e.heap[r],n=r<<1;n<=e.heap_len&&(n<e.heap_len&&ma(t,e.heap[n+1],e.heap[n],e.depth)&&n++,!ma(t,i,e.heap[n],e.depth));)e.heap[r]=e.heap[n],r=n,n<<=1;e.heap[r]=i}function ba(e,t,r){var i,n,s,o,a=0;if(0!==e.last_lit)do{i=e.pending_buf[e.d_buf+2*a]<<8|e.pending_buf[e.d_buf+2*a+1],n=e.pending_buf[e.l_buf+a],a++,0===i?ha(e,n,t):(ha(e,(s=ea[n])+qo+1,t),0!==(o=Ho[s])&&ua(e,n-=ta[s],o),ha(e,s=ca(--i),r),0!==(o=Jo[s])&&ua(e,i-=sa[s],o))}while(a<e.last_lit);ha(e,256,t)}function wa(e,t){var r,i,n,s=t.dyn_tree,o=t.stat_desc.static_tree,a=t.stat_desc.has_stree,c=t.stat_desc.elems,l=-1;for(e.heap_len=0,e.heap_max=573,r=0;r<c;r++)0!==s[2*r]?(e.heap[++e.heap_len]=l=r,e.depth[r]=0):s[2*r+1]=0;for(;e.heap_len<2;)s[2*(n=e.heap[++e.heap_len]=l<2?++l:0)]=1,e.depth[n]=0,e.opt_len--,a&&(e.static_len-=o[2*n+1]);for(t.max_code=l,r=e.heap_len>>1;r>=1;r--)ya(e,s,r);n=c;do{r=e.heap[1],e.heap[1]=e.heap[e.heap_len--],ya(e,s,1),i=e.heap[1],e.heap[--e.heap_max]=r,e.heap[--e.heap_max]=i,s[2*n]=s[2*r]+s[2*i],e.depth[n]=(e.depth[r]>=e.depth[i]?e.depth[r]:e.depth[i])+1,s[2*r+1]=s[2*i+1]=n,e.heap[1]=n++,ya(e,s,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var r,i,n,s,o,a,c=t.dyn_tree,l=t.max_code,u=t.stat_desc.static_tree,h=t.stat_desc.has_stree,f=t.stat_desc.extra_bits,d=t.stat_desc.extra_base,p=t.stat_desc.max_length,g=0;for(s=0;s<=Go;s++)e.bl_count[s]=0;for(c[2*e.heap[e.heap_max]+1]=0,r=e.heap_max+1;r<573;r++)(s=c[2*c[2*(i=e.heap[r])+1]+1]+1)>p&&(s=p,g++),c[2*i+1]=s,i>l||(e.bl_count[s]++,o=0,i>=d&&(o=f[i-d]),a=c[2*i],e.opt_len+=a*(s+o),h&&(e.static_len+=a*(u[2*i+1]+o)));if(0!==g){do{for(s=p-1;0===e.bl_count[s];)s--;e.bl_count[s]--,e.bl_count[s+1]+=2,e.bl_count[p]--,g-=2}while(g>0);for(s=p;0!==s;s--)for(i=e.bl_count[s];0!==i;)(n=e.heap[--r])>l||(c[2*n+1]!==s&&(e.opt_len+=(s-c[2*n+1])*c[2*n],c[2*n+1]=s),i--)}}(e,t),da(s,l,e.bl_count)}function va(e,t,r){var i,n,s=-1,o=t[1],a=0,c=7,l=4;for(0===o&&(c=138,l=3),t[2*(r+1)+1]=65535,i=0;i<=r;i++)n=o,o=t[2*(i+1)+1],++a<c&&n===o||(a<l?e.bl_tree[2*n]+=a:0!==n?(n!==s&&e.bl_tree[2*n]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,s=n,0===o?(c=138,l=3):n===o?(c=6,l=3):(c=7,l=4))}function _a(e,t,r){var i,n,s=-1,o=t[1],a=0,c=7,l=4;for(0===o&&(c=138,l=3),i=0;i<=r;i++)if(n=o,o=t[2*(i+1)+1],!(++a<c&&n===o)){if(a<l)do{ha(e,n,e.bl_tree)}while(0!==--a);else 0!==n?(n!==s&&(ha(e,n,e.bl_tree),a--),ha(e,16,e.bl_tree),ua(e,a-3,2)):a<=10?(ha(e,17,e.bl_tree),ua(e,a-3,3)):(ha(e,18,e.bl_tree),ua(e,a-11,7));a=0,s=n,0===o?(c=138,l=3):n===o?(c=6,l=3):(c=7,l=4)}}zo(sa);var Aa=!1;function ka(e){Aa||(!function(){var e,t,r,i,n,s=new Array(16);for(r=0,i=0;i<28;i++)for(ta[i]=r,e=0;e<1<<Ho[i];e++)ea[r++]=i;for(ea[r-1]=i,n=0,i=0;i<16;i++)for(sa[i]=n,e=0;e<1<<Jo[i];e++)Xo[n++]=i;for(n>>=7;i<Vo;i++)for(sa[i]=n<<7,e=0;e<1<<Jo[i]-7;e++)Xo[256+n++]=i;for(t=0;t<=Go;t++)s[t]=0;for(e=0;e<=143;)Zo[2*e+1]=8,e++,s[8]++;for(;e<=255;)Zo[2*e+1]=9,e++,s[9]++;for(;e<=279;)Zo[2*e+1]=7,e++,s[7]++;for(;e<=287;)Zo[2*e+1]=8,e++,s[8]++;for(da(Zo,287,s),e=0;e<Vo;e++)Yo[2*e+1]=5,Yo[2*e]=fa(e,5);ra=new oa(Zo,Ho,257,Qo,Go),ia=new oa(Yo,Jo,0,Vo,Go),na=new oa(new Array(0),Wo,0,19,7)}(),Aa=!0),e.l_desc=new aa(e.dyn_ltree,ra),e.d_desc=new aa(e.dyn_dtree,ia),e.bl_desc=new aa(e.bl_tree,na),e.bi_buf=0,e.bi_valid=0,pa(e)}function Ea(e,t,r,i){ua(e,0+(i?1:0),3),function(e,t,r){ga(e),la(e,r),la(e,~r),Mo(e.pending_buf,e.window,t,r,e.pending),e.pending+=r}(e,t,r)}function Ia(e){ua(e,2,3),ha(e,256,Zo),function(e){16===e.bi_valid?(la(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}function Sa(e,t,r,i){var n,s,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<qo;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),wa(e,e.l_desc),wa(e,e.d_desc),o=function(e){var t;for(va(e,e.dyn_ltree,e.l_desc.max_code),va(e,e.dyn_dtree,e.d_desc.max_code),wa(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*Ko[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),n=e.opt_len+3+7>>>3,(s=e.static_len+3+7>>>3)<=n&&(n=s)):n=s=r+5,r+4<=n&&-1!==t?Ea(e,t,r,i):4===e.strategy||s===n?(ua(e,2+(i?1:0),3),ba(e,Zo,Yo)):(ua(e,4+(i?1:0),3),function(e,t,r,i){var n;for(ua(e,t-257,5),ua(e,r-1,5),ua(e,i-4,4),n=0;n<i;n++)ua(e,e.bl_tree[2*Ko[n]+1],3);_a(e,e.dyn_ltree,t-1),_a(e,e.dyn_dtree,r-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),ba(e,e.dyn_ltree,e.dyn_dtree)),pa(e),i&&ga(e)}function Oa(e,t,r){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&r,e.last_lit++,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(ea[r]+qo+1)]++,e.dyn_dtree[2*ca(t)]++),e.last_lit===e.lit_bufsize-1}function xa(e,t,r,i){for(var n=65535&e,s=e>>>16&65535,o=0;0!==r;){r-=o=r>2e3?2e3:r;do{s=s+(n=n+t[i++]|0)|0}while(--o);n%=65521,s%=65521}return n|s<<16}var Ra=function(){for(var e,t=[],r=0;r<256;r++){e=r;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();function Na(e,t,r,i){var n=Ra,s=i+r;e^=-1;for(var o=i;o<s;o++)e=e>>>8^n[255&(e^t[o])];return-1^e}var Ba,Ca=-2,ja=258,Da=262,Pa=103,La=113,Ta=666;function Ma(e,t){return e.msg=Lo[t],t}function Ua(e){return(e<<1)-(e>4?9:0)}function Fa(e){for(var t=e.length;--t>=0;)e[t]=0}function $a(e){var t=e.state,r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(Mo(e.output,t.pending_buf,t.pending_out,r,e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))}function za(e,t){Sa(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,$a(e.strm)}function qa(e,t){e.pending_buf[e.pending++]=t}function Qa(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function Va(e,t,r,i){var n=e.avail_in;return n>i&&(n=i),0===n?0:(e.avail_in-=n,Mo(t,e.input,e.next_in,n,r),1===e.state.wrap?e.adler=xa(e.adler,t,n,r):2===e.state.wrap&&(e.adler=Na(e.adler,t,n,r)),e.next_in+=n,e.total_in+=n,n)}function Ga(e,t){var r,i,n=e.max_chain_length,s=e.strstart,o=e.prev_length,a=e.nice_match,c=e.strstart>e.w_size-Da?e.strstart-(e.w_size-Da):0,l=e.window,u=e.w_mask,h=e.prev,f=e.strstart+ja,d=l[s+o-1],p=l[s+o];e.prev_length>=e.good_match&&(n>>=2),a>e.lookahead&&(a=e.lookahead);do{if(l[(r=t)+o]===p&&l[r+o-1]===d&&l[r]===l[s]&&l[++r]===l[s+1]){s+=2,r++;do{}while(l[++s]===l[++r]&&l[++s]===l[++r]&&l[++s]===l[++r]&&l[++s]===l[++r]&&l[++s]===l[++r]&&l[++s]===l[++r]&&l[++s]===l[++r]&&l[++s]===l[++r]&&s<f);if(i=ja-(f-s),s=f-ja,i>o){if(e.match_start=t,o=i,i>=a)break;d=l[s+o-1],p=l[s+o]}}}while((t=h[t&u])>c&&0!==--n);return o<=e.lookahead?o:e.lookahead}function Ha(e){var t,r,i,n,s,o=e.w_size;do{if(n=e.window_size-e.lookahead-e.strstart,e.strstart>=o+(o-Da)){Mo(e.window,e.window,o,o,0),e.match_start-=o,e.strstart-=o,e.block_start-=o,t=r=e.hash_size;do{i=e.head[--t],e.head[t]=i>=o?i-o:0}while(--r);t=r=o;do{i=e.prev[--t],e.prev[t]=i>=o?i-o:0}while(--r);n+=o}if(0===e.strm.avail_in)break;if(r=Va(e.strm,e.window,e.strstart+e.lookahead,n),e.lookahead+=r,e.lookahead+e.insert>=3)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+3-1])&e.hash_mask,e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Da&&0!==e.strm.avail_in)}function Ja(e,t){for(var r,i;;){if(e.lookahead<Da){if(Ha(e),e.lookahead<Da&&0===t)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-Da&&(e.match_length=Ga(e,r)),e.match_length>=3)if(i=Oa(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!==--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else i=Oa(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(za(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(za(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(za(e,!1),0===e.strm.avail_out)?1:2}function Wa(e,t){for(var r,i,n;;){if(e.lookahead<Da){if(Ha(e),e.lookahead<Da&&0===t)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-Da&&(e.match_length=Ga(e,r),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){n=e.strstart+e.lookahead-3,i=Oa(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=n&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!==--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(za(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((i=Oa(e,0,e.window[e.strstart-1]))&&za(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=Oa(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(za(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(za(e,!1),0===e.strm.avail_out)?1:2}function Ka(e,t,r,i,n){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=i,this.func=n}function Za(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Fo(1146),this.dyn_dtree=new Fo(122),this.bl_tree=new Fo(78),Fa(this.dyn_ltree),Fa(this.dyn_dtree),Fa(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Fo(16),this.heap=new Fo(573),Fa(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Fo(573),Fa(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ya(e){var t,r=function(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:La,e.adler=2===t.wrap?0:1,t.last_flush=0,ka(t),0):Ma(e,Ca)}(e);return 0===r&&((t=e.state).window_size=2*t.w_size,Fa(t.head),t.max_lazy_match=Ba[t.level].max_lazy,t.good_match=Ba[t.level].good_length,t.nice_match=Ba[t.level].nice_length,t.max_chain_length=Ba[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),r}function Xa(e,t){var r,i,n,s;if(!e||!e.state||t>5||t<0)return e?Ma(e,Ca):Ca;if(i=e.state,!e.output||!e.input&&0!==e.avail_in||i.status===Ta&&4!==t)return Ma(e,0===e.avail_out?-5:Ca);if(i.strm=e,r=i.last_flush,i.last_flush=t,42===i.status)if(2===i.wrap)e.adler=0,qa(i,31),qa(i,139),qa(i,8),i.gzhead?(qa(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),qa(i,255&i.gzhead.time),qa(i,i.gzhead.time>>8&255),qa(i,i.gzhead.time>>16&255),qa(i,i.gzhead.time>>24&255),qa(i,9===i.level?2:i.strategy>=2||i.level<2?4:0),qa(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(qa(i,255&i.gzhead.extra.length),qa(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=Na(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69):(qa(i,0),qa(i,0),qa(i,0),qa(i,0),qa(i,0),qa(i,9===i.level?2:i.strategy>=2||i.level<2?4:0),qa(i,3),i.status=La);else{var o=8+(i.w_bits-8<<4)<<8;o|=(i.strategy>=2||i.level<2?0:i.level<6?1:6===i.level?2:3)<<6,0!==i.strstart&&(o|=32),o+=31-o%31,i.status=La,Qa(i,o),0!==i.strstart&&(Qa(i,e.adler>>>16),Qa(i,65535&e.adler)),e.adler=1}if(69===i.status)if(i.gzhead.extra){for(n=i.pending;i.gzindex<(65535&i.gzhead.extra.length)&&(i.pending!==i.pending_buf_size||(i.gzhead.hcrc&&i.pending>n&&(e.adler=Na(e.adler,i.pending_buf,i.pending-n,n)),$a(e),n=i.pending,i.pending!==i.pending_buf_size));)qa(i,255&i.gzhead.extra[i.gzindex]),i.gzindex++;i.gzhead.hcrc&&i.pending>n&&(e.adler=Na(e.adler,i.pending_buf,i.pending-n,n)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=73)}else i.status=73;if(73===i.status)if(i.gzhead.name){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(e.adler=Na(e.adler,i.pending_buf,i.pending-n,n)),$a(e),n=i.pending,i.pending===i.pending_buf_size)){s=1;break}s=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,qa(i,s)}while(0!==s);i.gzhead.hcrc&&i.pending>n&&(e.adler=Na(e.adler,i.pending_buf,i.pending-n,n)),0===s&&(i.gzindex=0,i.status=91)}else i.status=91;if(91===i.status)if(i.gzhead.comment){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(e.adler=Na(e.adler,i.pending_buf,i.pending-n,n)),$a(e),n=i.pending,i.pending===i.pending_buf_size)){s=1;break}s=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,qa(i,s)}while(0!==s);i.gzhead.hcrc&&i.pending>n&&(e.adler=Na(e.adler,i.pending_buf,i.pending-n,n)),0===s&&(i.status=Pa)}else i.status=Pa;if(i.status===Pa&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&$a(e),i.pending+2<=i.pending_buf_size&&(qa(i,255&e.adler),qa(i,e.adler>>8&255),e.adler=0,i.status=La)):i.status=La),0!==i.pending){if($a(e),0===e.avail_out)return i.last_flush=-1,0}else if(0===e.avail_in&&Ua(t)<=Ua(r)&&4!==t)return Ma(e,-5);if(i.status===Ta&&0!==e.avail_in)return Ma(e,-5);if(0!==e.avail_in||0!==i.lookahead||0!==t&&i.status!==Ta){var a=2===i.strategy?function(e,t){for(var r;;){if(0===e.lookahead&&(Ha(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,r=Oa(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(za(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(za(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(za(e,!1),0===e.strm.avail_out)?1:2}(i,t):3===i.strategy?function(e,t){for(var r,i,n,s,o=e.window;;){if(e.lookahead<=ja){if(Ha(e),e.lookahead<=ja&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(i=o[n=e.strstart-1])===o[++n]&&i===o[++n]&&i===o[++n]){s=e.strstart+ja;do{}while(i===o[++n]&&i===o[++n]&&i===o[++n]&&i===o[++n]&&i===o[++n]&&i===o[++n]&&i===o[++n]&&i===o[++n]&&n<s);e.match_length=ja-(s-n),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(r=Oa(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=Oa(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(za(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(za(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(za(e,!1),0===e.strm.avail_out)?1:2}(i,t):Ba[i.level].func(i,t);if(3!==a&&4!==a||(i.status=Ta),1===a||3===a)return 0===e.avail_out&&(i.last_flush=-1),0;if(2===a&&(1===t?Ia(i):5!==t&&(Ea(i,0,0,!1),3===t&&(Fa(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),$a(e),0===e.avail_out))return i.last_flush=-1,0}return 4!==t?0:i.wrap<=0?1:(2===i.wrap?(qa(i,255&e.adler),qa(i,e.adler>>8&255),qa(i,e.adler>>16&255),qa(i,e.adler>>24&255),qa(i,255&e.total_in),qa(i,e.total_in>>8&255),qa(i,e.total_in>>16&255),qa(i,e.total_in>>24&255)):(Qa(i,e.adler>>>16),Qa(i,65535&e.adler)),$a(e),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?0:1)}Ba=[new Ka(0,0,0,0,function(e,t){var r=65535;for(r>e.pending_buf_size-5&&(r=e.pending_buf_size-5);;){if(e.lookahead<=1){if(Ha(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var i=e.block_start+r;if((0===e.strstart||e.strstart>=i)&&(e.lookahead=e.strstart-i,e.strstart=i,za(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-Da&&(za(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(za(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(za(e,!1),e.strm.avail_out),1)}),new Ka(4,4,8,4,Ja),new Ka(4,5,16,8,Ja),new Ka(4,6,32,32,Ja),new Ka(4,4,16,16,Wa),new Ka(8,16,32,32,Wa),new Ka(8,16,128,128,Wa),new Ka(8,32,128,256,Wa),new Ka(32,128,258,1024,Wa),new Ka(32,258,258,4096,Wa)];function ec(e,t){var r,i,n,s,o,a,c,l,u,h,f,d,p,g,m,y,b,w,v,_,A,k,E,I,S;r=e.state,i=e.next_in,I=e.input,n=i+(e.avail_in-5),s=e.next_out,S=e.output,o=s-(t-e.avail_out),a=s+(e.avail_out-257),c=r.dmax,l=r.wsize,u=r.whave,h=r.wnext,f=r.window,d=r.hold,p=r.bits,g=r.lencode,m=r.distcode,y=(1<<r.lenbits)-1,b=(1<<r.distbits)-1;e:do{p<15&&(d+=I[i++]<<p,p+=8,d+=I[i++]<<p,p+=8),w=g[d&y];t:for(;;){if(d>>>=v=w>>>24,p-=v,0===(v=w>>>16&255))S[s++]=65535&w;else{if(!(16&v)){if(64&v){if(32&v){r.mode=12;break e}e.msg="invalid literal/length code",r.mode=30;break e}w=g[(65535&w)+(d&(1<<v)-1)];continue t}for(_=65535&w,(v&=15)&&(p<v&&(d+=I[i++]<<p,p+=8),_+=d&(1<<v)-1,d>>>=v,p-=v),p<15&&(d+=I[i++]<<p,p+=8,d+=I[i++]<<p,p+=8),w=m[d&b];;){if(d>>>=v=w>>>24,p-=v,16&(v=w>>>16&255)){if(A=65535&w,p<(v&=15)&&(d+=I[i++]<<p,(p+=8)<v&&(d+=I[i++]<<p,p+=8)),(A+=d&(1<<v)-1)>c){e.msg="invalid distance too far back",r.mode=30;break e}if(d>>>=v,p-=v,A>(v=s-o)){if((v=A-v)>u&&r.sane){e.msg="invalid distance too far back",r.mode=30;break e}if(k=0,E=f,0===h){if(k+=l-v,v<_){_-=v;do{S[s++]=f[k++]}while(--v);k=s-A,E=S}}else if(h<v){if(k+=l+h-v,(v-=h)<_){_-=v;do{S[s++]=f[k++]}while(--v);if(k=0,h<_){_-=v=h;do{S[s++]=f[k++]}while(--v);k=s-A,E=S}}}else if(k+=h-v,v<_){_-=v;do{S[s++]=f[k++]}while(--v);k=s-A,E=S}for(;_>2;)S[s++]=E[k++],S[s++]=E[k++],S[s++]=E[k++],_-=3;_&&(S[s++]=E[k++],_>1&&(S[s++]=E[k++]))}else{k=s-A;do{S[s++]=S[k++],S[s++]=S[k++],S[s++]=S[k++],_-=3}while(_>2);_&&(S[s++]=S[k++],_>1&&(S[s++]=S[k++]))}break}if(64&v){e.msg="invalid distance code",r.mode=30;break e}w=m[(65535&w)+(d&(1<<v)-1)]}}break}}while(i<n&&s<a);i-=_=p>>3,d&=(1<<(p-=_<<3))-1,e.next_in=i,e.next_out=s,e.avail_in=i<n?n-i+5:5-(i-n),e.avail_out=s<a?a-s+257:257-(s-a),r.hold=d,r.bits=p}var tc=15,rc=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],ic=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],nc=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],sc=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function oc(e,t,r,i,n,s,o,a){var c,l,u,h,f,d,p,g,m,y=a.bits,b=0,w=0,v=0,_=0,A=0,k=0,E=0,I=0,S=0,O=0,x=null,R=0,N=new Fo(16),B=new Fo(16),C=null,j=0;for(b=0;b<=tc;b++)N[b]=0;for(w=0;w<i;w++)N[t[r+w]]++;for(A=y,_=tc;_>=1&&0===N[_];_--);if(A>_&&(A=_),0===_)return n[s++]=20971520,n[s++]=20971520,a.bits=1,0;for(v=1;v<_&&0===N[v];v++);for(A<v&&(A=v),I=1,b=1;b<=tc;b++)if(I<<=1,(I-=N[b])<0)return-1;if(I>0&&(0===e||1!==_))return-1;for(B[1]=0,b=1;b<tc;b++)B[b+1]=B[b]+N[b];for(w=0;w<i;w++)0!==t[r+w]&&(o[B[t[r+w]]++]=w);if(0===e?(x=C=o,d=19):1===e?(x=rc,R-=257,C=ic,j-=257,d=256):(x=nc,C=sc,d=-1),O=0,w=0,b=v,f=s,k=A,E=0,u=-1,h=(S=1<<A)-1,1===e&&S>852||2===e&&S>592)return 1;for(;;){p=b-E,o[w]<d?(g=0,m=o[w]):o[w]>d?(g=C[j+o[w]],m=x[R+o[w]]):(g=96,m=0),c=1<<b-E,v=l=1<<k;do{n[f+(O>>E)+(l-=c)]=p<<24|g<<16|m}while(0!==l);for(c=1<<b-1;O&c;)c>>=1;if(0!==c?(O&=c-1,O+=c):O=0,w++,0===--N[b]){if(b===_)break;b=t[r+o[w]]}if(b>A&&(O&h)!==u){for(0===E&&(E=A),f+=v,I=1<<(k=b-E);k+E<_&&!((I-=N[k+E])<=0);)k++,I<<=1;if(S+=1<<k,1===e&&S>852||2===e&&S>592)return 1;n[u=O&h]=A<<24|k<<16|f-s}}return 0!==O&&(n[f+O]=b-E<<24|64<<16),a.bits=A,0}var ac=-2,cc=12,lc=30;function uc(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function hc(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Fo(320),this.work=new Fo(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function fc(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,function(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new $o(852),t.distcode=t.distdyn=new $o(592),t.sane=1,t.back=-1,0):ac}(e)):ac}function dc(e,t){var r,i;return e?(i=new hc,e.state=i,i.window=null,r=function(e,t){var r,i;return e&&e.state?(i=e.state,t<0?(r=0,t=-t):(r=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?ac:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=r,i.wbits=t,fc(e))):ac}(e,t),0!==r&&(e.state=null),r):ac}var pc,gc,mc=!0;function yc(e){if(mc){var t;for(pc=new $o(512),gc=new $o(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(oc(1,e.lens,0,288,pc,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;oc(2,e.lens,0,32,gc,0,e.work,{bits:5}),mc=!1}e.lencode=pc,e.lenbits=9,e.distcode=gc,e.distbits=5}function bc(e,t){var r,i,n,s,o,a,c,l,u,h,f,d,p,g,m,y,b,w,v,_,A,k,E,I,S=0,O=new Uo(4),x=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return ac;(r=e.state).mode===cc&&(r.mode=13),o=e.next_out,n=e.output,c=e.avail_out,s=e.next_in,i=e.input,a=e.avail_in,l=r.hold,u=r.bits,h=a,f=c,k=0;e:for(;;)switch(r.mode){case 1:if(0===r.wrap){r.mode=13;break}for(;u<16;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if(2&r.wrap&&35615===l){r.check=0,O[0]=255&l,O[1]=l>>>8&255,r.check=Na(r.check,O,2,0),l=0,u=0,r.mode=2;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",r.mode=lc;break}if(8!=(15&l)){e.msg="unknown compression method",r.mode=lc;break}if(u-=4,A=8+(15&(l>>>=4)),0===r.wbits)r.wbits=A;else if(A>r.wbits){e.msg="invalid window size",r.mode=lc;break}r.dmax=1<<A,e.adler=r.check=1,r.mode=512&l?10:cc,l=0,u=0;break;case 2:for(;u<16;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if(r.flags=l,8!=(255&r.flags)){e.msg="unknown compression method",r.mode=lc;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=lc;break}r.head&&(r.head.text=l>>8&1),512&r.flags&&(O[0]=255&l,O[1]=l>>>8&255,r.check=Na(r.check,O,2,0)),l=0,u=0,r.mode=3;case 3:for(;u<32;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}r.head&&(r.head.time=l),512&r.flags&&(O[0]=255&l,O[1]=l>>>8&255,O[2]=l>>>16&255,O[3]=l>>>24&255,r.check=Na(r.check,O,4,0)),l=0,u=0,r.mode=4;case 4:for(;u<16;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}r.head&&(r.head.xflags=255&l,r.head.os=l>>8),512&r.flags&&(O[0]=255&l,O[1]=l>>>8&255,r.check=Na(r.check,O,2,0)),l=0,u=0,r.mode=5;case 5:if(1024&r.flags){for(;u<16;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}r.length=l,r.head&&(r.head.extra_len=l),512&r.flags&&(O[0]=255&l,O[1]=l>>>8&255,r.check=Na(r.check,O,2,0)),l=0,u=0}else r.head&&(r.head.extra=null);r.mode=6;case 6:if(1024&r.flags&&((d=r.length)>a&&(d=a),d&&(r.head&&(A=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),Mo(r.head.extra,i,s,d,A)),512&r.flags&&(r.check=Na(r.check,i,d,s)),a-=d,s+=d,r.length-=d),r.length))break e;r.length=0,r.mode=7;case 7:if(2048&r.flags){if(0===a)break e;d=0;do{A=i[s+d++],r.head&&A&&r.length<65536&&(r.head.name+=String.fromCharCode(A))}while(A&&d<a);if(512&r.flags&&(r.check=Na(r.check,i,d,s)),a-=d,s+=d,A)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=8;case 8:if(4096&r.flags){if(0===a)break e;d=0;do{A=i[s+d++],r.head&&A&&r.length<65536&&(r.head.comment+=String.fromCharCode(A))}while(A&&d<a);if(512&r.flags&&(r.check=Na(r.check,i,d,s)),a-=d,s+=d,A)break e}else r.head&&(r.head.comment=null);r.mode=9;case 9:if(512&r.flags){for(;u<16;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if(l!==(65535&r.check)){e.msg="header crc mismatch",r.mode=lc;break}l=0,u=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=cc;break;case 10:for(;u<32;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}e.adler=r.check=uc(l),l=0,u=0,r.mode=11;case 11:if(0===r.havedict)return e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,r.hold=l,r.bits=u,2;e.adler=r.check=1,r.mode=cc;case cc:if(5===t||6===t)break e;case 13:if(r.last){l>>>=7&u,u-=7&u,r.mode=27;break}for(;u<3;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}switch(r.last=1&l,u-=1,3&(l>>>=1)){case 0:r.mode=14;break;case 1:if(yc(r),r.mode=20,6===t){l>>>=2,u-=2;break e}break;case 2:r.mode=17;break;case 3:e.msg="invalid block type",r.mode=lc}l>>>=2,u-=2;break;case 14:for(l>>>=7&u,u-=7&u;u<32;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",r.mode=lc;break}if(r.length=65535&l,l=0,u=0,r.mode=15,6===t)break e;case 15:r.mode=16;case 16:if(d=r.length){if(d>a&&(d=a),d>c&&(d=c),0===d)break e;Mo(n,i,s,d,o),a-=d,s+=d,c-=d,o+=d,r.length-=d;break}r.mode=cc;break;case 17:for(;u<14;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if(r.nlen=257+(31&l),l>>>=5,u-=5,r.ndist=1+(31&l),l>>>=5,u-=5,r.ncode=4+(15&l),l>>>=4,u-=4,r.nlen>286||r.ndist>30){e.msg="too many length or distance symbols",r.mode=lc;break}r.have=0,r.mode=18;case 18:for(;r.have<r.ncode;){for(;u<3;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}r.lens[x[r.have++]]=7&l,l>>>=3,u-=3}for(;r.have<19;)r.lens[x[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,E={bits:r.lenbits},k=oc(0,r.lens,0,19,r.lencode,0,r.work,E),r.lenbits=E.bits,k){e.msg="invalid code lengths set",r.mode=lc;break}r.have=0,r.mode=19;case 19:for(;r.have<r.nlen+r.ndist;){for(;y=(S=r.lencode[l&(1<<r.lenbits)-1])>>>16&255,b=65535&S,!((m=S>>>24)<=u);){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if(b<16)l>>>=m,u-=m,r.lens[r.have++]=b;else{if(16===b){for(I=m+2;u<I;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if(l>>>=m,u-=m,0===r.have){e.msg="invalid bit length repeat",r.mode=lc;break}A=r.lens[r.have-1],d=3+(3&l),l>>>=2,u-=2}else if(17===b){for(I=m+3;u<I;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}u-=m,A=0,d=3+(7&(l>>>=m)),l>>>=3,u-=3}else{for(I=m+7;u<I;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}u-=m,A=0,d=11+(127&(l>>>=m)),l>>>=7,u-=7}if(r.have+d>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=lc;break}for(;d--;)r.lens[r.have++]=A}}if(r.mode===lc)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=lc;break}if(r.lenbits=9,E={bits:r.lenbits},k=oc(1,r.lens,0,r.nlen,r.lencode,0,r.work,E),r.lenbits=E.bits,k){e.msg="invalid literal/lengths set",r.mode=lc;break}if(r.distbits=6,r.distcode=r.distdyn,E={bits:r.distbits},k=oc(2,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,E),r.distbits=E.bits,k){e.msg="invalid distances set",r.mode=lc;break}if(r.mode=20,6===t)break e;case 20:r.mode=21;case 21:if(a>=6&&c>=258){e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,r.hold=l,r.bits=u,ec(e,f),o=e.next_out,n=e.output,c=e.avail_out,s=e.next_in,i=e.input,a=e.avail_in,l=r.hold,u=r.bits,r.mode===cc&&(r.back=-1);break}for(r.back=0;y=(S=r.lencode[l&(1<<r.lenbits)-1])>>>16&255,b=65535&S,!((m=S>>>24)<=u);){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if(y&&!(240&y)){for(w=m,v=y,_=b;y=(S=r.lencode[_+((l&(1<<w+v)-1)>>w)])>>>16&255,b=65535&S,!(w+(m=S>>>24)<=u);){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}l>>>=w,u-=w,r.back+=w}if(l>>>=m,u-=m,r.back+=m,r.length=b,0===y){r.mode=26;break}if(32&y){r.back=-1,r.mode=cc;break}if(64&y){e.msg="invalid literal/length code",r.mode=lc;break}r.extra=15&y,r.mode=22;case 22:if(r.extra){for(I=r.extra;u<I;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}r.length+=l&(1<<r.extra)-1,l>>>=r.extra,u-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=23;case 23:for(;y=(S=r.distcode[l&(1<<r.distbits)-1])>>>16&255,b=65535&S,!((m=S>>>24)<=u);){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if(!(240&y)){for(w=m,v=y,_=b;y=(S=r.distcode[_+((l&(1<<w+v)-1)>>w)])>>>16&255,b=65535&S,!(w+(m=S>>>24)<=u);){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}l>>>=w,u-=w,r.back+=w}if(l>>>=m,u-=m,r.back+=m,64&y){e.msg="invalid distance code",r.mode=lc;break}r.offset=b,r.extra=15&y,r.mode=24;case 24:if(r.extra){for(I=r.extra;u<I;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}r.offset+=l&(1<<r.extra)-1,l>>>=r.extra,u-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=lc;break}r.mode=25;case 25:if(0===c)break e;if(d=f-c,r.offset>d){if((d=r.offset-d)>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=lc;break}d>r.wnext?(d-=r.wnext,p=r.wsize-d):p=r.wnext-d,d>r.length&&(d=r.length),g=r.window}else g=n,p=o-r.offset,d=r.length;d>c&&(d=c),c-=d,r.length-=d;do{n[o++]=g[p++]}while(--d);0===r.length&&(r.mode=21);break;case 26:if(0===c)break e;n[o++]=r.length,c--,r.mode=21;break;case 27:if(r.wrap){for(;u<32;){if(0===a)break e;a--,l|=i[s++]<<u,u+=8}if(f-=c,e.total_out+=f,r.total+=f,f&&(e.adler=r.check=r.flags?Na(r.check,n,f,o-f):xa(r.check,n,f,o-f)),f=c,(r.flags?l:uc(l))!==r.check){e.msg="incorrect data check",r.mode=lc;break}l=0,u=0}r.mode=28;case 28:if(r.wrap&&r.flags){for(;u<32;){if(0===a)break e;a--,l+=i[s++]<<u,u+=8}if(l!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=lc;break}l=0,u=0}r.mode=29;case 29:k=1;break e;case lc:k=-3;break e;case 31:return-4;default:return ac}return e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,r.hold=l,r.bits=u,(r.wsize||f!==e.avail_out&&r.mode<lc&&(r.mode<27||4!==t))&&function(e,t,r,i){var n,s=e.state;null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uo(s.wsize)),i>=s.wsize?(Mo(s.window,t,r-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):((n=s.wsize-s.wnext)>i&&(n=i),Mo(s.window,t,r-i,n,s.wnext),(i-=n)?(Mo(s.window,t,r-i,i,0),s.wnext=i,s.whave=s.wsize):(s.wnext+=n,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=n)))}(e,e.output,e.next_out,f-e.avail_out),h-=e.avail_in,f-=e.avail_out,e.total_in+=h,e.total_out+=f,r.total+=f,r.wrap&&f&&(e.adler=r.check=r.flags?Na(r.check,n,f,e.next_out-f):xa(r.check,n,f,e.next_out-f)),e.data_type=r.bits+(r.last?64:0)+(r.mode===cc?128:0)+(20===r.mode||15===r.mode?256:0),(0===h&&0===f||4===t)&&0===k&&(k=-5),k}var wc;function vc(e){if(e<1||e>7)throw new TypeError("Bad argument");this.mode=e,this.init_done=!1,this.write_in_progress=!1,this.pending_close=!1,this.windowBits=0,this.level=0,this.memLevel=0,this.strategy=0,this.dictionary=null}function _c(e,t){for(var r=0;r<e.length;r++)this[t+r]=e[r]}vc.prototype.init=function(e,t,r,i,n){var s;switch(this.windowBits=e,this.level=t,this.memLevel=r,this.strategy=i,3!==this.mode&&4!==this.mode||(this.windowBits+=16),7===this.mode&&(this.windowBits+=32),5!==this.mode&&6!==this.mode||(this.windowBits=-this.windowBits),this.strm=new To,this.mode){case 1:case 3:case 5:s=function(e,t,r,i,n,s){if(!e)return Ca;var o=1;if(-1===t&&(t=6),i<0?(o=0,i=-i):i>15&&(o=2,i-=16),n<1||n>9||8!==r||i<8||i>15||t<0||t>9||s<0||s>4)return Ma(e,Ca);8===i&&(i=9);var a=new Za;return e.state=a,a.strm=e,a.wrap=o,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=n+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uo(2*a.w_size),a.head=new Fo(a.hash_size),a.prev=new Fo(a.w_size),a.lit_bufsize=1<<n+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uo(a.pending_buf_size),a.d_buf=1*a.lit_bufsize,a.l_buf=3*a.lit_bufsize,a.level=t,a.strategy=s,a.method=r,Ya(e)}(this.strm,this.level,8,this.windowBits,this.memLevel,this.strategy);break;case 2:case 4:case 6:case 7:s=dc(this.strm,this.windowBits);break;default:throw new Error("Unknown mode "+this.mode)}0===s?(this.write_in_progress=!1,this.init_done=!0):this._error(s)},vc.prototype.params=function(){throw new Error("deflateParams Not supported")},vc.prototype._writeCheck=function(){if(!this.init_done)throw new Error("write before init");if(0===this.mode)throw new Error("already finalized");if(this.write_in_progress)throw new Error("write already in progress");if(this.pending_close)throw new Error("close is pending")},vc.prototype.write=function(e,t,r,i,n,s,o){this._writeCheck(),this.write_in_progress=!0;var a=this;return Fn.nextTick(function(){a.write_in_progress=!1;var c=a._write(e,t,r,i,n,s,o);a.callback(c[0],c[1]),a.pending_close&&a.close()}),this},vc.prototype.writeSync=function(e,t,r,i,n,s,o){return this._writeCheck(),this._write(e,t,r,i,n,s,o)},vc.prototype._write=function(e,t,r,i,n,s,o){if(this.write_in_progress=!0,0!==e&&1!==e&&2!==e&&3!==e&&4!==e&&5!==e)throw new Error("Invalid flush value");null==t&&(t=new Ni(0),i=0,r=0),n._set?n.set=n._set:n.set=_c;var a,c=this.strm;switch(c.avail_in=i,c.input=t,c.next_in=r,c.avail_out=o,c.output=n,c.next_out=s,this.mode){case 1:case 3:case 5:a=Xa(c,e);break;case 7:case 2:case 4:case 6:a=bc(c,e);break;default:throw new Error("Unknown mode "+this.mode)}return this._checkError(a,c,e)||this._error(a),this.write_in_progress=!1,[c.avail_in,c.avail_out]},vc.prototype._checkError=function(e,t,r){switch(e){case 0:case-5:if(0!==t.avail_out&&4===r)return!1;break;case 1:break;default:return!1}return!0},vc.prototype.close=function(){this.write_in_progress?this.pending_close=!0:(this.pending_close=!1,1===this.mode||3===this.mode||5===this.mode?function(e){var t;e&&e.state&&(42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&t!==Pa&&t!==La&&t!==Ta?Ma(e,Ca):(e.state=null,t===La&&Ma(e,-3)))}(this.strm):function(e){if(!e||!e.state)return ac;var t=e.state;t.window&&(t.window=null),e.state=null}(this.strm),this.mode=0)},vc.prototype.reset=function(){switch(this.mode){case 1:case 5:wc=Ya(this.strm);break;case 2:case 6:wc=fc(this.strm)}0!==wc&&this._error(wc)},vc.prototype._error=function(e){this.onerror(Lo[e]+": "+this.strm.msg,e),this.write_in_progress=!1,this.pending_close&&this.close()};var Ac=Object.freeze({__proto__:null,DEFLATE:1,DEFLATERAW:5,GUNZIP:4,GZIP:3,INFLATE:2,INFLATERAW:6,NONE:0,UNZIP:7,Z_BEST_COMPRESSION:9,Z_BEST_SPEED:1,Z_BINARY:0,Z_BLOCK:5,Z_BUF_ERROR:-5,Z_DATA_ERROR:-3,Z_DEFAULT_COMPRESSION:-1,Z_DEFAULT_STRATEGY:0,Z_DEFLATED:8,Z_ERRNO:-1,Z_FILTERED:1,Z_FINISH:4,Z_FIXED:4,Z_FULL_FLUSH:3,Z_HUFFMAN_ONLY:2,Z_NEED_DICT:2,Z_NO_COMPRESSION:0,Z_NO_FLUSH:0,Z_OK:0,Z_PARTIAL_FLUSH:1,Z_RLE:3,Z_STREAM_END:1,Z_STREAM_ERROR:-2,Z_SYNC_FLUSH:2,Z_TEXT:1,Z_TREES:6,Z_UNKNOWN:2,Zlib:vc});var kc={};Object.keys(Ac).forEach(function(e){kc[e]=Ac[e]}),kc.Z_MIN_WINDOWBITS=8,kc.Z_MAX_WINDOWBITS=15,kc.Z_DEFAULT_WINDOWBITS=15,kc.Z_MIN_CHUNK=64,kc.Z_MAX_CHUNK=1/0,kc.Z_DEFAULT_CHUNK=16384,kc.Z_MIN_MEMLEVEL=1,kc.Z_MAX_MEMLEVEL=9,kc.Z_DEFAULT_MEMLEVEL=8,kc.Z_MIN_LEVEL=-1,kc.Z_MAX_LEVEL=9,kc.Z_DEFAULT_LEVEL=kc.Z_DEFAULT_COMPRESSION;var Ec={Z_OK:kc.Z_OK,Z_STREAM_END:kc.Z_STREAM_END,Z_NEED_DICT:kc.Z_NEED_DICT,Z_ERRNO:kc.Z_ERRNO,Z_STREAM_ERROR:kc.Z_STREAM_ERROR,Z_DATA_ERROR:kc.Z_DATA_ERROR,Z_MEM_ERROR:kc.Z_MEM_ERROR,Z_BUF_ERROR:kc.Z_BUF_ERROR,Z_VERSION_ERROR:kc.Z_VERSION_ERROR};function Ic(e,t,r){var i=[],n=0;function s(){for(var t;null!==(t=e.read());)i.push(t),n+=t.length;e.once("readable",s)}function o(){var t=Ni.concat(i,n);i=[],r(null,t),e.close()}e.on("error",function(t){e.removeListener("end",o),e.removeListener("readable",s),r(t)}),e.on("end",o),e.end(t),s()}function Sc(e,t){if("string"==typeof t&&(t=new Ni(t)),!Ni.isBuffer(t))throw new TypeError("Not a string or buffer");var r=kc.Z_FINISH;return e._processChunk(t,r)}function Oc(e){if(!(this instanceof Oc))return new Oc(e);Dc.call(this,e,kc.DEFLATE)}function xc(e){if(!(this instanceof xc))return new xc(e);Dc.call(this,e,kc.INFLATE)}function Rc(e){if(!(this instanceof Rc))return new Rc(e);Dc.call(this,e,kc.GZIP)}function Nc(e){if(!(this instanceof Nc))return new Nc(e);Dc.call(this,e,kc.GUNZIP)}function Bc(e){if(!(this instanceof Bc))return new Bc(e);Dc.call(this,e,kc.DEFLATERAW)}function Cc(e){if(!(this instanceof Cc))return new Cc(e);Dc.call(this,e,kc.INFLATERAW)}function jc(e){if(!(this instanceof jc))return new jc(e);Dc.call(this,e,kc.UNZIP)}function Dc(e,t){if(this._opts=e=e||{},this._chunkSize=e.chunkSize||kc.Z_DEFAULT_CHUNK,Ws.call(this,e),e.flush&&e.flush!==kc.Z_NO_FLUSH&&e.flush!==kc.Z_PARTIAL_FLUSH&&e.flush!==kc.Z_SYNC_FLUSH&&e.flush!==kc.Z_FULL_FLUSH&&e.flush!==kc.Z_FINISH&&e.flush!==kc.Z_BLOCK)throw new Error("Invalid flush flag: "+e.flush);if(this._flushFlag=e.flush||kc.Z_NO_FLUSH,e.chunkSize&&(e.chunkSize<kc.Z_MIN_CHUNK||e.chunkSize>kc.Z_MAX_CHUNK))throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits&&(e.windowBits<kc.Z_MIN_WINDOWBITS||e.windowBits>kc.Z_MAX_WINDOWBITS))throw new Error("Invalid windowBits: "+e.windowBits);if(e.level&&(e.level<kc.Z_MIN_LEVEL||e.level>kc.Z_MAX_LEVEL))throw new Error("Invalid compression level: "+e.level);if(e.memLevel&&(e.memLevel<kc.Z_MIN_MEMLEVEL||e.memLevel>kc.Z_MAX_MEMLEVEL))throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=kc.Z_FILTERED&&e.strategy!=kc.Z_HUFFMAN_ONLY&&e.strategy!=kc.Z_RLE&&e.strategy!=kc.Z_FIXED&&e.strategy!=kc.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!Ni.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._binding=new kc.Zlib(t);var r=this;this._hadError=!1,this._binding.onerror=function(e,t){r._binding=null,r._hadError=!0;var i=new Error(e);i.errno=t,i.code=Ec[t],r.emit("error",i)};var i=kc.Z_DEFAULT_COMPRESSION;"number"==typeof e.level&&(i=e.level);var n=kc.Z_DEFAULT_STRATEGY;"number"==typeof e.strategy&&(n=e.strategy),this._binding.init(e.windowBits||kc.Z_DEFAULT_WINDOWBITS,i,e.memLevel||kc.Z_DEFAULT_MEMLEVEL,n,e.dictionary),this._buffer=new Ni(this._chunkSize),this._offset=0,this._closed=!1,this._level=i,this._strategy=n,this.once("end",this.close)}Object.keys(Ec).forEach(function(e){Ec[Ec[e]]=e}),Un(Dc,Ws),Dc.prototype.params=function(e,t,r){if(e<kc.Z_MIN_LEVEL||e>kc.Z_MAX_LEVEL)throw new RangeError("Invalid compression level: "+e);if(t!=kc.Z_FILTERED&&t!=kc.Z_HUFFMAN_ONLY&&t!=kc.Z_RLE&&t!=kc.Z_FIXED&&t!=kc.Z_DEFAULT_STRATEGY)throw new TypeError("Invalid strategy: "+t);if(this._level!==e||this._strategy!==t){var i=this;this.flush(kc.Z_SYNC_FLUSH,function(){i._binding.params(e,t),i._hadError||(i._level=e,i._strategy=t,r&&r())})}else Fn.nextTick(r)},Dc.prototype.reset=function(){return this._binding.reset()},Dc.prototype._flush=function(e){this._transform(new Ni(0),"",e)},Dc.prototype.flush=function(e,t){var r=this._writableState;if(("function"==typeof e||void 0===e&&!t)&&(t=e,e=kc.Z_FULL_FLUSH),r.ended)t&&Fn.nextTick(t);else if(r.ending)t&&this.once("end",t);else if(r.needDrain){var i=this;this.once("drain",function(){i.flush(t)})}else this._flushFlag=e,this.write(new Ni(0),"",t)},Dc.prototype.close=function(e){if(e&&Fn.nextTick(e),!this._closed){this._closed=!0,this._binding.close();var t=this;Fn.nextTick(function(){t.emit("close")})}},Dc.prototype._transform=function(e,t,r){var i,n=this._writableState,s=(n.ending||n.ended)&&(!e||n.length===e.length);if(null===!e&&!Ni.isBuffer(e))return r(new Error("invalid input"));s?i=kc.Z_FINISH:(i=this._flushFlag,e.length>=n.length&&(this._flushFlag=this._opts.flush||kc.Z_NO_FLUSH)),this._processChunk(e,i,r)},Dc.prototype._processChunk=function(e,t,r){var i=e&&e.length,n=this._chunkSize-this._offset,s=0,o=this,a="function"==typeof r;if(!a){var c,l=[],u=0;this.on("error",function(e){c=e});do{var h=this._binding.writeSync(t,e,s,i,this._buffer,this._offset,n)}while(!this._hadError&&p(h[0],h[1]));if(this._hadError)throw c;var f=Ni.concat(l,u);return this.close(),f}var d=this._binding.write(t,e,s,i,this._buffer,this._offset,n);function p(c,h){if(!o._hadError){var f=n-h;if(function(e,t){if(!e)throw new Error(t)}(f>=0,"have should not go down"),f>0){var d=o._buffer.slice(o._offset,o._offset+f);o._offset+=f,a?o.push(d):(l.push(d),u+=d.length)}if((0===h||o._offset>=o._chunkSize)&&(n=o._chunkSize,o._offset=0,o._buffer=new Ni(o._chunkSize)),0===h){if(s+=i-c,i=c,!a)return!0;var g=o._binding.write(t,e,s,i,o._buffer,o._offset,o._chunkSize);return g.callback=p,void(g.buffer=e)}if(!a)return!1;r()}}d.buffer=e,d.callback=p},Un(Oc,Dc),Un(xc,Dc),Un(Rc,Dc),Un(Nc,Dc),Un(Bc,Dc),Un(Cc,Dc),Un(jc,Dc);var Pc={codes:Ec,createDeflate:function(e){return new Oc(e)},createInflate:function(e){return new xc(e)},createDeflateRaw:function(e){return new Bc(e)},createInflateRaw:function(e){return new Cc(e)},createGzip:function(e){return new Rc(e)},createGunzip:function(e){return new Nc(e)},createUnzip:function(e){return new jc(e)},deflate:function(e,t,r){return"function"==typeof t&&(r=t,t={}),Ic(new Oc(t),e,r)},deflateSync:function(e,t){return Sc(new Oc(t),e)},gzip:function(e,t,r){return"function"==typeof t&&(r=t,t={}),Ic(new Rc(t),e,r)},gzipSync:function(e,t){return Sc(new Rc(t),e)},deflateRaw:function(e,t,r){return"function"==typeof t&&(r=t,t={}),Ic(new Bc(t),e,r)},deflateRawSync:function(e,t){return Sc(new Bc(t),e)},unzip:function(e,t,r){return"function"==typeof t&&(r=t,t={}),Ic(new jc(t),e,r)},unzipSync:function(e,t){return Sc(new jc(t),e)},inflate:function(e,t,r){return"function"==typeof t&&(r=t,t={}),Ic(new xc(t),e,r)},inflateSync:function(e,t){return Sc(new xc(t),e)},gunzip:function(e,t,r){return"function"==typeof t&&(r=t,t={}),Ic(new Nc(t),e,r)},gunzipSync:function(e,t){return Sc(new Nc(t),e)},inflateRaw:function(e,t,r){return"function"==typeof t&&(r=t,t={}),Ic(new Cc(t),e,r)},inflateRawSync:function(e,t){return Sc(new Cc(t),e)},Deflate:Oc,Inflate:xc,Gzip:Rc,Gunzip:Nc,DeflateRaw:Bc,InflateRaw:Cc,Unzip:jc,Zlib:Dc};class Lc extends Do{constructor({client:e,keyPrefix:t="cache",ttl:r=0,prefix:i}){super({client:e,keyPrefix:t,ttl:r,prefix:i}),this.client=e,this.keyPrefix=t,this.config.ttl=r,this.config.client=e,this.config.prefix=void 0!==i?i:t+(t.endsWith("/")?"":"/")}async _set(e,t){let r=JSON.stringify(t);const i=r.length;return r=Pc.gzipSync(r).toString("base64"),this.client.putObject({key:p(this.keyPrefix,e),body:r,contentEncoding:"gzip",contentType:"application/gzip",metadata:{compressor:"zlib",compressed:"true","client-id":this.client.id,"length-serialized":String(i),"length-compressed":String(r.length),"compression-gain":(r.length/i).toFixed(2)}})}async _get(e){const[t,r,i]=await x(async()=>{const{Body:t}=await this.client.getObject(p(this.keyPrefix,e));let r=await io(t);return r=Buffer.from(r,"base64"),r=Pc.unzipSync(r).toString(),JSON.parse(r)});if(t)return i;if("NoSuchKey"===r.name||"NotFound"===r.name)return null;throw r}async _del(e){return await this.client.deleteObject(p(this.keyPrefix,e)),!0}async _clear(){const e=await this.client.getAllKeys({prefix:this.keyPrefix});await this.client.deleteObjects(e)}async size(){return(await this.keys()).length}async keys(){const e=await this.client.getAllKeys({prefix:this.keyPrefix}),t=this.keyPrefix.endsWith("/")?this.keyPrefix:this.keyPrefix+"/";return e.map(e=>e.startsWith(t)?e.slice(t.length):e)}}class Tc extends v{constructor(e={}){super(),this.name=this.constructor.name,this.options=e,this.hooks=new Map}async setup(e){this.database=e,this.beforeSetup(),await this.onSetup(),this.afterSetup()}async start(){this.beforeStart(),await this.onStart(),this.afterStart()}async stop(){this.beforeStop(),await this.onStop(),this.afterStop()}async onSetup(){}async onStart(){}async onStop(){}addHook(e,t,r){this.hooks.has(e)||this.hooks.set(e,new Map);const i=this.hooks.get(e);i.has(t)||i.set(t,[]),i.get(t).push(r)}removeHook(e,t,r){const i=this.hooks.get(e);if(i&&i.has(t)){const e=i.get(t),n=e.indexOf(r);n>-1&&e.splice(n,1)}}wrapResourceMethod(e,t,r){const i=e[t];if(e._pluginWrappers||(e._pluginWrappers=new Map),e._pluginWrappers.has(t)||e._pluginWrappers.set(t,[]),e._pluginWrappers.get(t).push(r),!e[`_wrapped_${t}`]){e[`_wrapped_${t}`]=i;const r=i&&i._isMockFunction;e[t]=async function(...r){let i=await e[`_wrapped_${t}`](...r);for(const n of e._pluginWrappers.get(t))i=await n.call(this,i,r,t);return i},r&&(Object.setPrototypeOf(e[t],Object.getPrototypeOf(i)),Object.assign(e[t],i))}}addMiddleware(e,t,r){if(e._pluginMiddlewares||(e._pluginMiddlewares={}),!e._pluginMiddlewares[t]){e._pluginMiddlewares[t]=[];const r=e[t].bind(e);e[t]=async function(...i){let n=-1;const s=async(...i)=>(n++,n<e._pluginMiddlewares[t].length?await e._pluginMiddlewares[t][n].call(this,s,...i):await r(...i));return await s(...i)}}e._pluginMiddlewares[t].push(r)}getPartitionValues(e,t){if(!t.config?.partitions)return{};const r={};for(const[i,n]of Object.entries(t.config.partitions))if(n.fields){r[i]={};for(const[s,o]of Object.entries(n.fields)){const n=this.getNestedFieldValue(e,s);null!=n&&(r[i][s]=t.applyPartitionRule(n,o))}}else r[i]={};return r}getNestedFieldValue(e,t){if(!t.includes("."))return e[t]??null;const r=t.split(".");let i=e;for(const e of r){if(!i||"object"!=typeof i||!(e in i))return null;i=i[e]}return i??null}beforeSetup(){this.emit("plugin.beforeSetup",new Date)}afterSetup(){this.emit("plugin.afterSetup",new Date)}beforeStart(){this.emit("plugin.beforeStart",new Date)}afterStart(){this.emit("plugin.afterStart",new Date)}beforeStop(){this.emit("plugin.beforeStop",new Date)}afterStop(){this.emit("plugin.afterStop",new Date)}}const Mc={setup(e){},start(){},stop(){}};const Uc={async setup(e){e&&e.client&&(this.client=e.client,this.map={PutObjectCommand:"put",GetObjectCommand:"get",HeadObjectCommand:"head",DeleteObjectCommand:"delete",DeleteObjectsCommand:"delete",ListObjectsV2Command:"list"},this.costs={total:0,prices:{put:5e-6,copy:5e-6,list:5e-6,post:5e-6,get:4e-4/1e3,select:4e-4/1e3,delete:4e-4/1e3,head:4e-4/1e3},requests:{total:0,put:0,post:0,copy:0,list:0,get:0,select:0,delete:0,head:0},events:{total:0,PutObjectCommand:0,GetObjectCommand:0,HeadObjectCommand:0,DeleteObjectCommand:0,DeleteObjectsCommand:0,ListObjectsV2Command:0}},this.client.costs=JSON.parse(JSON.stringify(this.costs)))},async start(){this.client&&(this.client.on("command.response",e=>this.addRequest(e,this.map[e])),this.client.on("command.error",e=>this.addRequest(e,this.map[e])))},addRequest(e,t){t&&(this.costs.events[e]++,this.costs.events.total++,this.costs.requests.total++,this.costs.requests[t]++,this.costs.total+=this.costs.prices[t],this.client&&this.client.costs&&(this.client.costs.events[e]++,this.client.costs.events.total++,this.client.costs.requests.total++,this.client.costs.requests[t]++,this.client.costs.total+=this.client.costs.prices[t]))}};class Fc extends v{constructor(e={}){super(),this.config=e,this.name=this.constructor.name,this.enabled=!1!==e.enabled}async initialize(e){this.database=e,this.emit("initialized",{replicator:this.name})}async replicate(e,t,r,i){throw new Error(`replicate() method must be implemented by ${this.name}`)}async replicateBatch(e,t){throw new Error(`replicateBatch() method must be implemented by ${this.name}`)}async testConnection(){throw new Error(`testConnection() method must be implemented by ${this.name}`)}async getStatus(){return{name:this.name,config:this.config,connected:!1}}async cleanup(){this.emit("cleanup",{replicator:this.name})}validateConfig(){return{isValid:!0,errors:[]}}}class $c extends Fc{constructor(e={},t={}){super(e),this.projectId=e.projectId,this.datasetId=e.datasetId,this.bigqueryClient=null,this.credentials=e.credentials,this.location=e.location||"US",this.logTable=e.logTable,this.resources=this.parseResourcesConfig(t)}parseResourcesConfig(e){const t={};for(const[r,i]of Object.entries(e))"string"==typeof i?t[r]=[{table:i,actions:["insert"]}]:Array.isArray(i)?t[r]=i.map(e=>"string"==typeof e?{table:e,actions:["insert"]}:{table:e.table,actions:e.actions||["insert"]}):"object"==typeof i&&(t[r]=[{table:i.table,actions:i.actions||["insert"]}]);return t}validateConfig(){const e=[];this.projectId||e.push("projectId is required"),this.datasetId||e.push("datasetId is required"),0===Object.keys(this.resources).length&&e.push("At least one resource must be configured");for(const[t,r]of Object.entries(this.resources))for(const i of r){i.table||e.push(`Table name is required for resource '${t}'`),Array.isArray(i.actions)&&0!==i.actions.length||e.push(`Actions array is required for resource '${t}'`);const r=["insert","update","delete"],n=i.actions.filter(e=>!r.includes(e));n.length>0&&e.push(`Invalid actions for resource '${t}': ${n.join(", ")}. Valid actions: ${r.join(", ")}`)}return{isValid:0===e.length,errors:e}}async initialize(e){await super.initialize(e);const[t,r,i]=await x(()=>import("@google-cloud/bigquery"));if(!t)throw this.emit("initialization_error",{replicator:this.name,error:r.message}),r;const{BigQuery:n}=i;this.bigqueryClient=new n({projectId:this.projectId,credentials:this.credentials,location:this.location}),this.emit("initialized",{replicator:this.name,projectId:this.projectId,datasetId:this.datasetId,resources:Object.keys(this.resources)})}shouldReplicateResource(e){return this.resources.hasOwnProperty(e)}shouldReplicateAction(e,t){return!!this.resources[e]&&this.resources[e].some(e=>e.actions.includes(t))}getTablesForResource(e,t){return this.resources[e]?this.resources[e].filter(e=>e.actions.includes(t)).map(e=>e.table):[]}async replicate(e,t,r,i,n=null){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};if(!this.shouldReplicateAction(e,t))return{skipped:!0,reason:"action_not_included"};const s=this.getTablesForResource(e,t);if(0===s.length)return{skipped:!0,reason:"no_tables_for_action"};const o=[],a=[],[c,l,u]=await x(async()=>{const n=this.bigqueryClient.dataset(this.datasetId);for(const e of s){const[s,c]=await x(async()=>{const s=n.table(e);let a;if("insert"===t){const e={...r};a=await s.insert([e])}else if("update"===t){const t=Object.keys(r).filter(e=>"id"!==e),n=t.map(e=>`${e}=@${e}`).join(", "),s={id:i};t.forEach(e=>{s[e]=r[e]});const o=`UPDATE \`${this.projectId}.${this.datasetId}.${e}\` SET ${n} WHERE id=@id`,[c]=await this.bigqueryClient.createQueryJob({query:o,params:s});await c.getQueryResults(),a=[c]}else{if("delete"!==t)throw new Error(`Unsupported operation: ${t}`);{const t=`DELETE FROM \`${this.projectId}.${this.datasetId}.${e}\` WHERE id=@id`,[r]=await this.bigqueryClient.createQueryJob({query:t,params:{id:i}});await r.getQueryResults(),a=[r]}}o.push({table:e,success:!0,jobId:a[0]?.id})});s||a.push({table:e,error:c.message})}if(this.logTable){const[s,o]=await x(async()=>{const s=n.table(this.logTable);await s.insert([{resource_name:e,operation:t,record_id:i,data:JSON.stringify(r),timestamp:(new Date).toISOString(),source:"s3db-replicator"}])})}const c=0===a.length;return this.emit("replicated",{replicator:this.name,resourceName:e,operation:t,id:i,tables:s,results:o,errors:a,success:c}),{success:c,results:o,errors:a,tables:s}});return c?u:(this.emit("replicator_error",{replicator:this.name,resourceName:e,operation:t,id:i,error:l.message}),{success:!1,error:l.message})}async replicateBatch(e,t){const r=[],i=[];for(const n of t){const[t,s,o]=await x(()=>this.replicate(e,n.operation,n.data,n.id,n.beforeData));t?r.push(o):i.push({id:n.id,error:s.message})}return{success:0===i.length,results:r,errors:i}}async testConnection(){const[e,t]=await x(async()=>{this.bigqueryClient||await this.initialize();const e=this.bigqueryClient.dataset(this.datasetId);return await e.getMetadata(),!0});return!!e||(this.emit("connection_error",{replicator:this.name,error:t.message}),!1)}async cleanup(){}getStatus(){return{...super.getStatus(),projectId:this.projectId,datasetId:this.datasetId,resources:this.resources,logTable:this.logTable}}}class zc extends Fc{constructor(e={},t={}){super(e),this.connectionString=e.connectionString,this.host=e.host,this.port=e.port||5432,this.database=e.database,this.user=e.user,this.password=e.password,this.client=null,this.ssl=e.ssl,this.logTable=e.logTable,this.resources=this.parseResourcesConfig(t)}parseResourcesConfig(e){const t={};for(const[r,i]of Object.entries(e))"string"==typeof i?t[r]=[{table:i,actions:["insert"]}]:Array.isArray(i)?t[r]=i.map(e=>"string"==typeof e?{table:e,actions:["insert"]}:{table:e.table,actions:e.actions||["insert"]}):"object"==typeof i&&(t[r]=[{table:i.table,actions:i.actions||["insert"]}]);return t}validateConfig(){const e=[];this.connectionString||this.host&&this.database||e.push("Either connectionString or host+database must be provided"),0===Object.keys(this.resources).length&&e.push("At least one resource must be configured");for(const[t,r]of Object.entries(this.resources))for(const i of r){i.table||e.push(`Table name is required for resource '${t}'`),Array.isArray(i.actions)&&0!==i.actions.length||e.push(`Actions array is required for resource '${t}'`);const r=["insert","update","delete"],n=i.actions.filter(e=>!r.includes(e));n.length>0&&e.push(`Invalid actions for resource '${t}': ${n.join(", ")}. Valid actions: ${r.join(", ")}`)}return{isValid:0===e.length,errors:e}}async initialize(e){await super.initialize(e);const[t,r,i]=await x(()=>import("pg"));if(!t)throw this.emit("initialization_error",{replicator:this.name,error:r.message}),r;const{Client:n}=i,s=this.connectionString?{connectionString:this.connectionString,ssl:this.ssl}:{host:this.host,port:this.port,database:this.database,user:this.user,password:this.password,ssl:this.ssl};this.client=new n(s),await this.client.connect(),this.logTable&&await this.createLogTableIfNotExists(),this.emit("initialized",{replicator:this.name,database:this.database||"postgres",resources:Object.keys(this.resources)})}async createLogTableIfNotExists(){const e=`\n      CREATE TABLE IF NOT EXISTS ${this.logTable} (\n        id SERIAL PRIMARY KEY,\n        resource_name VARCHAR(255) NOT NULL,\n        operation VARCHAR(50) NOT NULL,\n        record_id VARCHAR(255) NOT NULL,\n        data JSONB,\n        timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n        source VARCHAR(100) DEFAULT 's3db-replicator',\n        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n      );\n      CREATE INDEX IF NOT EXISTS idx_${this.logTable}_resource_name ON ${this.logTable}(resource_name);\n      CREATE INDEX IF NOT EXISTS idx_${this.logTable}_operation ON ${this.logTable}(operation);\n      CREATE INDEX IF NOT EXISTS idx_${this.logTable}_record_id ON ${this.logTable}(record_id);\n      CREATE INDEX IF NOT EXISTS idx_${this.logTable}_timestamp ON ${this.logTable}(timestamp);\n    `;await this.client.query(e)}shouldReplicateResource(e){return this.resources.hasOwnProperty(e)}shouldReplicateAction(e,t){return!!this.resources[e]&&this.resources[e].some(e=>e.actions.includes(t))}getTablesForResource(e,t){return this.resources[e]?this.resources[e].filter(e=>e.actions.includes(t)).map(e=>e.table):[]}async replicate(e,t,r,i,n=null){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};if(!this.shouldReplicateAction(e,t))return{skipped:!0,reason:"action_not_included"};const s=this.getTablesForResource(e,t);if(0===s.length)return{skipped:!0,reason:"no_tables_for_action"};const o=[],a=[],[c,l,u]=await x(async()=>{for(const e of s){const[n,s]=await x(async()=>{let n;if("insert"===t){const t=Object.keys(r),i=t.map(e=>r[e]),s=t.map(e=>`"${e}"`).join(", "),o=t.map((e,t)=>`$${t+1}`).join(", "),a=`INSERT INTO ${e} (${s}) VALUES (${o}) ON CONFLICT (id) DO NOTHING RETURNING *`;n=await this.client.query(a,i)}else if("update"===t){const t=Object.keys(r).filter(e=>"id"!==e),s=t.map((e,t)=>`"${e}"=$${t+1}`).join(", "),o=t.map(e=>r[e]);o.push(i);const a=`UPDATE ${e} SET ${s} WHERE id=$${t.length+1} RETURNING *`;n=await this.client.query(a,o)}else{if("delete"!==t)throw new Error(`Unsupported operation: ${t}`);{const t=`DELETE FROM ${e} WHERE id=$1 RETURNING *`;n=await this.client.query(t,[i])}}o.push({table:e,success:!0,rows:n.rows,rowCount:n.rowCount})});n||a.push({table:e,error:s.message})}if(this.logTable){const[n,s]=await x(async()=>{await this.client.query(`INSERT INTO ${this.logTable} (resource_name, operation, record_id, data, timestamp, source) VALUES ($1, $2, $3, $4, $5, $6)`,[e,t,i,JSON.stringify(r),(new Date).toISOString(),"s3db-replicator"])})}const n=0===a.length;return this.emit("replicated",{replicator:this.name,resourceName:e,operation:t,id:i,tables:s,results:o,errors:a,success:n}),{success:n,results:o,errors:a,tables:s}});return c?u:(this.emit("replicator_error",{replicator:this.name,resourceName:e,operation:t,id:i,error:l.message}),{success:!1,error:l.message})}async replicateBatch(e,t){const r=[],i=[];for(const n of t){const[t,s,o]=await x(()=>this.replicate(e,n.operation,n.data,n.id,n.beforeData));t?r.push(o):i.push({id:n.id,error:s.message})}return{success:0===i.length,results:r,errors:i}}async testConnection(){const[e,t]=await x(async()=>(this.client||await this.initialize(),await this.client.query("SELECT 1"),!0));return!!e||(this.emit("connection_error",{replicator:this.name,error:t.message}),!1)}async cleanup(){this.client&&await this.client.end()}getStatus(){return{...super.getStatus(),database:this.database||"postgres",resources:this.resources,logTable:this.logTable}}}function qc(e){return"string"==typeof e?e.trim().toLowerCase():e}class Qc extends Fc{constructor(e={},t=[],r=null){super(e),this.instanceId=Math.random().toString(36).slice(2,10),this.client=r;let i=t;if(t)if(Array.isArray(t)){i={};for(const e of t)"string"==typeof e&&(i[qc(e)]=e)}else"string"==typeof t&&(i[qc(t)]=t);else i={};this.resourcesMap=this._normalizeResources(i)}_normalizeResources(e){if(!e)return{};if(Array.isArray(e)){const t={};for(const r of e)"string"==typeof r?t[qc(r)]=r:Array.isArray(r)&&"string"==typeof r[0]?t[qc(r[0])]=r:"object"==typeof r&&r.resource&&(t[qc(r.resource)]={...r});return t}if("object"==typeof e){const t={};for(const[r,i]of Object.entries(e)){const e=qc(r);"string"==typeof i?t[e]=i:Array.isArray(i)?t[e]=i.map(e=>"string"==typeof e||"function"==typeof e?e:"object"==typeof e&&e.resource?{...e}:e):"function"==typeof i?t[e]=i:"object"==typeof i&&i.resource&&(t[e]={...i})}return t}if("function"==typeof e)return e;if("string"==typeof e){return{[qc(e)]:e}}return{}}validateConfig(){const e=[];return this.client||this.connectionString||e.push("You must provide a client or a connectionString"),(!this.resources||Array.isArray(this.resources)&&0===this.resources.length||"object"==typeof this.resources&&0===Object.keys(this.resources).length)&&e.push("You must provide a resources map or array"),{isValid:0===e.length,errors:e}}async initialize(e){try{if(await super.initialize(e),this.client)this.targetDatabase=this.client;else{if(!this.connectionString)throw new Error("S3dbReplicator: No client or connectionString provided");{const e={connectionString:this.connectionString,region:this.region,bucket:this.bucket,keyPrefix:this.keyPrefix,verbose:this.config.verbose||!1};this.targetDatabase=new jo(e),await this.targetDatabase.connect()}}this.emit("connected",{replicator:this.name,target:this.connectionString||this.bucket})}catch(e){throw e}}async replicate({resource:e,operation:t,data:r,id:i}){const n=qc(e),s=this._resolveDestResource(n,r),o=this._getDestResourceObj(s),a=this._applyTransformer(n,r);let c;return"insert"===t?c=await o.insert(a):"update"===t?c=await o.update(i,a):"delete"===t&&(c=await o.delete(i)),c}_applyTransformer(e,t){const r=qc(e),i=this.resourcesMap[r];let n;return i?(Array.isArray(i)&&"function"==typeof i[1]?n=i[1](t):"function"==typeof i?n=i(t):"object"==typeof i?"function"==typeof i.transform?n=i.transform(t):"function"==typeof i.transformer&&(n=i.transformer(t)):n=t,n&&t&&t.id&&!n.id&&(n.id=t.id),!n&&t&&(n=t),n):t}_resolveDestResource(e,t){const r=qc(e),i=this.resourcesMap[r];if(!i)return e;if(Array.isArray(i)){if("string"==typeof i[0])return i[0];if("object"==typeof i[0]&&i[0].resource)return i[0].resource;if("function"==typeof i[0])return e}return"string"==typeof i?i:"function"==typeof i?e:"object"==typeof i&&i.resource?i.resource:e}_getDestResourceObj(e){if(!this.client||!this.client.resources)return null;const t=Object.keys(this.client.resources),r=qc(e),i=t.find(e=>qc(e)===r);if(!i)throw new Error(`[S3dbReplicator] Destination resource not found: ${e}. Available: ${t.join(", ")}`);return this.client.resources[i]}async replicateBatch(e,t){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};const r=[],i=[];for(const n of t){const[t,s,o]=await x(()=>this.replicate(e,n.operation,n.id,n.data,n.beforeData));t?r.push(o):i.push({id:n.id,error:s.message})}return this.emit("batch_replicated",{replicator:this.name,resourceName:e,total:t.length,successful:r.filter(e=>e.success).length,errors:i.length}),{success:0===i.length,results:r,errors:i,total:t.length}}async testConnection(){const[e,t]=await x(async()=>(this.targetDatabase||await this.initialize(this.database),await this.targetDatabase.listResources(),!0));return!!e||(this.emit("connection_error",{replicator:this.name,error:t.message}),!1)}async getStatus(){return{...await super.getStatus(),connected:!!this.targetDatabase,targetDatabase:this.connectionString||this.bucket,resources:this.resources,totalreplicators:this.listenerCount("replicated"),totalErrors:this.listenerCount("replicator_error")}}async cleanup(){this.targetDatabase&&this.targetDatabase.removeAllListeners(),await super.cleanup()}shouldReplicateResource(e,t){const r=qc(e),i=this.resourcesMap[r];if(!i)return!1;if(Array.isArray(i)){for(const e of i)if("object"==typeof e&&e.resource){if(!e.actions||!Array.isArray(e.actions))return!0;if(e.actions.includes(t))return!0}else if("string"==typeof e||"function"==typeof e)return!0;return!1}return"object"==typeof i&&i.resource?!i.actions||!Array.isArray(i.actions)||i.actions.includes(t):"string"==typeof i||"function"==typeof i}}class Vc extends Fc{constructor(e={},t=[],r=null){if(super(e),this.resources=t,this.client=r,this.queueUrl=e.queueUrl,this.queues=e.queues||{},this.defaultQueue=e.defaultQueue||e.defaultQueueUrl||e.queueUrlDefault,this.region=e.region||"us-east-1",this.sqsClient=r||null,this.messageGroupId=e.messageGroupId,this.deduplicationId=e.deduplicationId,t&&"object"==typeof t)for(const[e,r]of Object.entries(t))r.queueUrl&&(this.queues[e]=r.queueUrl)}validateConfig(){const e=[];return this.queueUrl||0!==Object.keys(this.queues).length||this.defaultQueue||this.resourceQueueMap||e.push("Either queueUrl, queues object, defaultQueue, or resourceQueueMap must be provided"),{isValid:0===e.length,errors:e}}getQueueUrlsForResource(e){if(this.resourceQueueMap&&this.resourceQueueMap[e])return this.resourceQueueMap[e];if(this.queues[e])return[this.queues[e]];if(this.queueUrl)return[this.queueUrl];if(this.defaultQueue)return[this.defaultQueue];throw new Error(`No queue URL found for resource '${e}'`)}_applyTransformer(e,t){const r=this.resources[e];let i=t;return r?("function"==typeof r.transform?i=r.transform(t):"function"==typeof r.transformer&&(i=r.transformer(t)),i||t):t}createMessage(e,t,r,i,n=null){const s={resource:e,action:t,timestamp:(new Date).toISOString(),source:"s3db-replicator"};switch(t){case"insert":case"delete":default:return{...s,data:r};case"update":return{...s,before:n,data:r}}}async initialize(e,t){if(await super.initialize(e),!this.sqsClient){const[e,r,i]=await x(()=>import("@aws-sdk/client-sqs"));if(!e)throw this.emit("initialization_error",{replicator:this.name,error:r.message}),r;const{SQSClient:n}=i;this.sqsClient=t||new n({region:this.region,credentials:this.config.credentials}),this.emit("initialized",{replicator:this.name,queueUrl:this.queueUrl,queues:this.queues,defaultQueue:this.defaultQueue})}}async replicate(e,t,r,i,n=null){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};const[s,o,a]=await x(async()=>{const{SendMessageCommand:s}=await import("@aws-sdk/client-sqs"),o=this.getQueueUrlsForResource(e),a=this._applyTransformer(e,r),c=this.createMessage(e,t,a,i,n),l=[];for(const r of o){const n=new s({QueueUrl:r,MessageBody:JSON.stringify(c),MessageGroupId:this.messageGroupId,MessageDeduplicationId:this.deduplicationId?`${e}:${t}:${i}`:void 0}),o=await this.sqsClient.send(n);l.push({queueUrl:r,messageId:o.MessageId}),this.emit("replicated",{replicator:this.name,resource:e,operation:t,id:i,queueUrl:r,messageId:o.MessageId,success:!0})}return{success:!0,results:l}});return s?a:(this.emit("replicator_error",{replicator:this.name,resource:e,operation:t,id:i,error:o.message}),{success:!1,error:o.message})}async replicateBatch(e,t){if(!this.enabled||!this.shouldReplicateResource(e))return{skipped:!0,reason:"resource_not_included"};const[r,i,n]=await x(async()=>{const{SendMessageBatchCommand:r}=await import("@aws-sdk/client-sqs"),i=this.getQueueUrlsForResource(e),n=[];for(let e=0;e<t.length;e+=10)n.push(t.slice(e,e+10));const s=[],o=[];for(const t of n){const[n,a]=await x(async()=>{const n=t.map((t,r)=>({Id:`${t.id}-${r}`,MessageBody:JSON.stringify(this.createMessage(e,t.operation,t.data,t.id,t.beforeData)),MessageGroupId:this.messageGroupId,MessageDeduplicationId:this.deduplicationId?`${e}:${t.operation}:${t.id}`:void 0})),o=new r({QueueUrl:i[0],Entries:n}),a=await this.sqsClient.send(o);s.push(a)});n||o.push({batch:t.length,error:a.message})}return this.emit("batch_replicated",{replicator:this.name,resource:e,queueUrl:i[0],total:t.length,successful:s.length,errors:o.length}),{success:0===o.length,results:s,errors:o,total:t.length,queueUrl:i[0]}});return r?n:(this.emit("batch_replicator_error",{replicator:this.name,resource:e,error:i.message}),{success:!1,error:i.message})}async testConnection(){const[e,t]=await x(async()=>{this.sqsClient||await this.initialize(this.database);const{GetQueueAttributesCommand:e}=await import("@aws-sdk/client-sqs"),t=new e({QueueUrl:this.queueUrl,AttributeNames:["QueueArn"]});return await this.sqsClient.send(t),!0});return!!e||(this.emit("connection_error",{replicator:this.name,error:t.message}),!1)}async getStatus(){return{...await super.getStatus(),connected:!!this.sqsClient,queueUrl:this.queueUrl,region:this.region,resources:this.resources,totalreplicators:this.listenerCount("replicated"),totalErrors:this.listenerCount("replicator_error")}}async cleanup(){this.sqsClient&&this.sqsClient.destroy(),await super.cleanup()}shouldReplicateResource(e){return this.resourceQueueMap&&Object.keys(this.resourceQueueMap).includes(e)||this.queues&&Object.keys(this.queues).includes(e)||this.defaultQueue||this.queueUrl||this.resources&&Object.keys(this.resources).includes(e)||!1}}const Gc={s3db:Qc,sqs:Vc,bigquery:$c,postgres:zc};function Hc(e,t={},r=[],i=null){const n=Gc[e];if(!n)throw new Error(`Unknown replicator driver: ${e}. Available drivers: ${Object.keys(Gc).join(", ")}`);return new n(t,r,i)}function Jc(e){return"string"==typeof e?e.trim().toLowerCase():e}exports.AVAILABLE_BEHAVIORS=Ro,exports.AuditPlugin=class extends Tc{constructor(e={}){super(e),this.auditResource=null,this.config={enabled:!1!==e.enabled,includeData:!1!==e.includeData,includePartitions:!1!==e.includePartitions,maxDataSize:e.maxDataSize||1e4,...e}}async onSetup(){if(!this.config.enabled)return void(this.auditResource=null);const[e,t,r]=await x(()=>this.database.createResource({name:"audits",attributes:{id:"string|required",resourceName:"string|required",operation:"string|required",recordId:"string|required",userId:"string|optional",timestamp:"string|required",oldData:"string|optional",newData:"string|optional",partition:"string|optional",partitionValues:"string|optional",metadata:"string|optional"},behavior:"body-overflow"}));this.auditResource=e?r:this.database.resources.audits||null,(e||this.auditResource)&&(this.installDatabaseProxy(),this.installEventListeners())}async onStart(){}async onStop(){}installDatabaseProxy(){if(this.database._auditProxyInstalled)return;const e=this.installEventListenersForResource.bind(this);this.database._originalCreateResource=this.database.createResource,this.database.createResource=async function(...t){const r=await this._originalCreateResource(...t);return"audits"!==r.name&&e(r),r},this.database._auditProxyInstalled=!0}installEventListeners(){for(const e of Object.values(this.database.resources))"audits"!==e.name&&this.installEventListenersForResource(e)}installEventListenersForResource(e){e.on("insert",async t=>{const r=t.id||"auto-generated",i=this.config.includePartitions?this.getPartitionValues(t,e):null,n={id:`audit-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,resourceName:e.name,operation:"insert",recordId:r,userId:this.getCurrentUserId?.()||"system",timestamp:(new Date).toISOString(),oldData:null,newData:!1===this.config.includeData?null:JSON.stringify(this.truncateData(t)),partition:this.config.includePartitions?this.getPrimaryPartition(i):null,partitionValues:this.config.includePartitions&&i&&Object.keys(i).length>0?JSON.stringify(i):null,metadata:JSON.stringify({source:"audit-plugin",version:"2.0"})};this.logAudit(n).catch(console.error)}),e.on("update",async t=>{const r=t.id;let i=t.$before;if(this.config.includeData&&!i){const[t,n,s]=await x(()=>e.get(r));t&&(i=s)}const n=this.config.includePartitions?this.getPartitionValues(t,e):null,s={id:`audit-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,resourceName:e.name,operation:"update",recordId:r,userId:this.getCurrentUserId?.()||"system",timestamp:(new Date).toISOString(),oldData:i&&!1===this.config.includeData?null:i?JSON.stringify(this.truncateData(i)):null,newData:!1===this.config.includeData?null:JSON.stringify(this.truncateData(t)),partition:this.config.includePartitions?this.getPrimaryPartition(n):null,partitionValues:this.config.includePartitions&&n&&Object.keys(n).length>0?JSON.stringify(n):null,metadata:JSON.stringify({source:"audit-plugin",version:"2.0"})};this.logAudit(s).catch(console.error)}),e.on("delete",async t=>{const r=t.id;let i=t;if(this.config.includeData&&!i){const[t,n,s]=await x(()=>e.get(r));t&&(i=s)}const n=i&&this.config.includePartitions?this.getPartitionValues(i,e):null,s={id:`audit-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,resourceName:e.name,operation:"delete",recordId:r,userId:this.getCurrentUserId?.()||"system",timestamp:(new Date).toISOString(),oldData:i&&!1===this.config.includeData?null:i?JSON.stringify(this.truncateData(i)):null,newData:null,partition:this.config.includePartitions?this.getPrimaryPartition(n):null,partitionValues:this.config.includePartitions&&n&&Object.keys(n).length>0?JSON.stringify(n):null,metadata:JSON.stringify({source:"audit-plugin",version:"2.0"})};this.logAudit(s).catch(console.error)}),e.useMiddleware("deleteMany",async(t,r)=>{const i=t.args[0],n={};if(this.config.includeData)for(const t of i){const[r,i,s]=await x(()=>e.get(t));n[t]=r?s:null}const s=await r();if(s&&s.length>0&&this.config.includeData)for(const t of i){const r=n[t],i=r&&this.config.includePartitions?this.getPartitionValues(r,e):null,s={id:`audit-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,resourceName:e.name,operation:"delete",recordId:t,userId:this.getCurrentUserId?.()||"system",timestamp:(new Date).toISOString(),oldData:!1===this.config.includeData?null:JSON.stringify(this.truncateData(r)),newData:null,partition:this.config.includePartitions?this.getPrimaryPartition(i):null,partitionValues:this.config.includePartitions&&i&&Object.keys(i).length>0?JSON.stringify(i):null,metadata:JSON.stringify({source:"audit-plugin",version:"2.0",batchOperation:!0})};this.logAudit(s).catch(console.error)}return s})}getPartitionValues(e,t){if(!e)return null;const r=t.config?.partitions||{},i={};for(const[t,n]of Object.entries(r))if(n.fields){const r={};for(const[t,i]of Object.entries(n.fields)){const i=this.getNestedFieldValue(e,t);null!=i&&(r[t]=i)}Object.keys(r).length>0&&(i[t]=r)}return i}getNestedFieldValue(e,t){if(!t.includes("."))return e[t];const r=t.split(".");let i=e;for(const e of r){if(!i||"object"!=typeof i||!(e in i))return;i=i[e]}return i}getPrimaryPartition(e){if(!e)return null;const t=Object.keys(e);return t.length>0?t[0]:null}async logAudit(e){e.id||(e.id=`audit-${Date.now()}-${Math.random().toString(36).slice(2,8)}`);return await this.auditResource.insert(e)}truncateData(e){if(!e)return e;const t={};for(const[r,i]of Object.entries(e))r.startsWith("_")||"$overflow"===r||(t[r]=i);const r=JSON.stringify(t);if(r.length<=this.config.maxDataSize)return t;let i={...t},n=JSON.stringify(i).length;const s=JSON.stringify({_truncated:!0,_originalSize:r.length,_truncatedAt:(new Date).toISOString()}).length,o=this.config.maxDataSize-s;for(const[e,t]of Object.entries(i))if("string"==typeof t&&n>o){const r=n-o,s=Math.max(0,t.length-r-3);s<t.length&&(i[e]=t.substring(0,s)+"...",n=JSON.stringify(i).length)}return{...i,_truncated:!0,_originalSize:r.length,_truncatedAt:(new Date).toISOString()}}async getAuditLogs(e={}){if(!this.auditResource)return[];const[t,r,i]=await x(async()=>{const{resourceName:t,operation:r,recordId:i,userId:n,partition:s,startDate:o,endDate:a,limit:c=100,offset:l=0}=e;let u=(await this.auditResource.getAll()).filter(e=>(!t||e.resourceName===t)&&((!r||e.operation===r)&&((!i||e.recordId===i)&&((!n||e.userId===n)&&((!s||e.partition===s)&&(!(o&&new Date(e.timestamp)<new Date(o))&&!(a&&new Date(e.timestamp)>new Date(a))))))));u.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp));return u.slice(l,l+c).map(e=>{const[t,,r]="string"==typeof e.oldData?R(()=>JSON.parse(e.oldData)):[!0,null,e.oldData],[i,,n]="string"==typeof e.newData?R(()=>JSON.parse(e.newData)):[!0,null,e.newData],[s,,o]=e.partitionValues&&"string"==typeof e.partitionValues?R(()=>JSON.parse(e.partitionValues)):[!0,null,e.partitionValues],[a,,c]=e.metadata&&"string"==typeof e.metadata?R(()=>JSON.parse(e.metadata)):[!0,null,e.metadata];return{...e,oldData:null===e.oldData||void 0===e.oldData||"null"===e.oldData?null:t?r:null,newData:null===e.newData||void 0===e.newData||"null"===e.newData?null:i?n:null,partitionValues:s?o:e.partitionValues,metadata:a?c:e.metadata}})});return t?i:[]}async getRecordHistory(e,t){return this.getAuditLogs({resourceName:e,recordId:t,limit:1e3})}async getPartitionHistory(e,t,r){return this.getAuditLogs({resourceName:e,partition:t,limit:1e3})}async getAuditStats(e={}){const{resourceName:t,startDate:r,endDate:i}=e,n=await this.getAuditLogs({resourceName:t,startDate:r,endDate:i,limit:1e4}),s={total:n.length,byOperation:{},byResource:{},byPartition:{},byUser:{},timeline:{}};for(const e of n)if(s.byOperation[e.operation]=(s.byOperation[e.operation]||0)+1,s.byResource[e.resourceName]=(s.byResource[e.resourceName]||0)+1,e.partition&&(s.byPartition[e.partition]=(s.byPartition[e.partition]||0)+1),s.byUser[e.userId]=(s.byUser[e.userId]||0)+1,e.timestamp){const t=e.timestamp.split("T")[0];s.timeline[t]=(s.timeline[t]||0)+1}return s}},exports.AuthenticationError=class extends ee{constructor(e,t={}){super(e,t),Object.assign(this,t)}},exports.BaseError=X,exports.BaseReplicator=Fc,exports.BigqueryReplicator=$c,exports.Cache=Do,exports.CachePlugin=class extends Tc{constructor(e={}){super(e),this.driver=e.driver,this.config={enabled:!1!==e.enabled,includePartitions:!1!==e.includePartitions,...e}}async setup(e){this.config.enabled&&await super.setup(e)}async onSetup(){this.config.driver?this.driver=this.config.driver:"memory"===this.config.driverType?this.driver=new Po(this.config.memoryOptions||{}):this.driver=new Lc({client:this.database.client,...this.config.s3Options||{}}),this.installDatabaseProxy(),this.installResourceHooks()}async onStart(){}async onStop(){}installDatabaseProxy(){if(this.database._cacheProxyInstalled)return;const e=this.installResourceHooks.bind(this);this.database._originalCreateResourceForCache=this.database.createResource,this.database.createResource=async function(...t){const r=await this._originalCreateResourceForCache(...t);return e(r),r},this.database._cacheProxyInstalled=!0}installResourceHooks(){for(const e of Object.values(this.database.resources))this.installResourceHooksForResource(e)}installResourceHooksForResource(e){if(!this.driver)return;Object.defineProperty(e,"cache",{value:this.driver,writable:!0,configurable:!0,enumerable:!1}),e.cacheKeyFor=async(t={})=>{const{action:r,params:i={},partition:n,partitionValues:s}=t;return this.generateCacheKey(e,r,i,n,s)};const t=["count","listIds","getMany","getAll","page","list","get"];for(const r of t)e.useMiddleware(r,async(t,i)=>{let n;if("getMany"===r)n=await e.cacheKeyFor({action:r,params:{ids:t.args[0]}});else if("page"===r){const{offset:i,size:s,partition:o,partitionValues:a}=t.args[0]||{};n=await e.cacheKeyFor({action:r,params:{offset:i,size:s},partition:o,partitionValues:a})}else if("list"===r||"listIds"===r||"count"===r){const{partition:i,partitionValues:s}=t.args[0]||{};n=await e.cacheKeyFor({action:r,partition:i,partitionValues:s})}else"getAll"===r?n=await e.cacheKeyFor({action:r}):"get"===r&&(n=await e.cacheKeyFor({action:r,params:{id:t.args[0]}}));const[s,o,a]=await x(()=>e.cache.get(n));if(s&&null!=a)return a;if(!s&&"NoSuchKey"!==o.name)throw o;const c=await i();return await e.cache.set(n,c),c});const r=["insert","update","delete","deleteMany"];for(const t of r)e.useMiddleware(t,async(r,i)=>{const n=await i();if("insert"===t)await this.clearCacheForResource(e,r.args[0]);else if("update"===t)await this.clearCacheForResource(e,{id:r.args[0],...r.args[1]});else if("delete"===t){let t={id:r.args[0]};if("function"==typeof e.get){const[i,n,s]=await x(()=>e.get(r.args[0]));i&&s&&(t=s)}await this.clearCacheForResource(e,t)}else"deleteMany"===t&&await this.clearCacheForResource(e);return n})}async clearCacheForResource(e,t){if(!e.cache)return;const r=`resource=${e.name}`;if(await e.cache.clear(r),!0===this.config.includePartitions&&e.config?.partitions&&Object.keys(e.config.partitions).length>0)if(t){const i=this.getPartitionValues(t,e);for(const[t,n]of Object.entries(i))if(n&&Object.keys(n).length>0&&Object.values(n).some(e=>null!=e)){const i=p(r,`partition=${t}`);await e.cache.clear(i)}}else for(const t of Object.keys(e.config.partitions)){const i=p(r,`partition=${t}`);await e.cache.clear(i)}}async generateCacheKey(e,t,r={},i=null,n=null){const s=[`resource=${e.name}`,`action=${t}`];if(i&&n&&Object.keys(n).length>0){s.push(`partition:${i}`);for(const[e,t]of Object.entries(n))null!=t&&s.push(`${e}:${t}`)}if(Object.keys(r).length>0){const e=await this.hashParams(r);s.push(e)}return p(...s)+".json.gz"}async hashParams(e){const t=Object.keys(e).sort().map(t=>`${t}:${e[t]}`).join("|")||"empty";return await Ae(t)}async getCacheStats(){return this.driver?{size:await this.driver.size(),keys:await this.driver.keys(),driver:this.driver.constructor.name}:null}async clearAllCache(){if(this.driver)for(const e of Object.values(this.database.resources))if(e.cache){const t=`resource=${e.name}`;await e.cache.clear(t)}}async warmCache(e,t={}){const r=this.database.resources[e];if(!r)throw new Error(`Resource '${e}' not found`);const{includePartitions:i=!0}=t;if(await r.getAll(),i&&r.config.partitions)for(const[e,t]of Object.entries(r.config.partitions))if(t.fields){const t=await r.getAll(),i=Array.isArray(t)?t:[],n=new Set;for(const t of i.slice(0,10)){const i=this.getPartitionValues(t,r);i[e]&&n.add(JSON.stringify(i[e]))}for(const t of n){const i=JSON.parse(t);await r.list({partition:e,partitionValues:i})}}}},exports.Client=ve,exports.ConnectionString=we,exports.ConnectionStringError=fe,exports.CostsPlugin=Uc,exports.CryptoError=de,exports.DEFAULT_BEHAVIOR=No,exports.Database=Co,exports.DatabaseError=class extends ee{constructor(e,t={}){super(e,t),Object.assign(this,t)}},exports.EncryptionError=class extends ee{constructor(e,t={}){super(e,t),Object.assign(this,t)}},exports.ErrorMap=ue,exports.FullTextPlugin=class extends Tc{constructor(e={}){super(),this.indexResource=null,this.config={enabled:!1!==e.enabled,minWordLength:e.minWordLength||3,maxResults:e.maxResults||100,...e},this.indexes=new Map}async setup(e){if(this.database=e,!this.config.enabled)return;const[t,r,i]=await x(()=>e.createResource({name:"fulltext_indexes",attributes:{id:"string|required",resourceName:"string|required",fieldName:"string|required",word:"string|required",recordIds:"json|required",count:"number|required",lastUpdated:"string|required"}}));this.indexResource=t?i:e.resources.fulltext_indexes,await this.loadIndexes(),this.installIndexingHooks()}async start(){}async stop(){await this.saveIndexes()}async loadIndexes(){if(!this.indexResource)return;const[e,t,r]=await x(()=>this.indexResource.getAll());if(e)for(const e of r){const t=`${e.resourceName}:${e.fieldName}:${e.word}`;this.indexes.set(t,{recordIds:e.recordIds||[],count:e.count||0})}}async saveIndexes(){if(!this.indexResource)return;const[e,t]=await x(async()=>{const e=await this.indexResource.getAll();for(const t of e)await this.indexResource.delete(t.id);for(const[e,t]of this.indexes.entries()){const[r,i,n]=e.split(":");await this.indexResource.insert({id:`index-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,resourceName:r,fieldName:i,word:n,recordIds:t.recordIds,count:t.count,lastUpdated:(new Date).toISOString()})}})}installIndexingHooks(){this.database.plugins||(this.database.plugins={}),this.database.plugins.fulltext=this;for(const e of Object.values(this.database.resources))"fulltext_indexes"!==e.name&&this.installResourceHooks(e);this.database._fulltextProxyInstalled||(this.database._previousCreateResourceForFullText=this.database.createResource,this.database.createResource=async function(...e){const t=await this._previousCreateResourceForFullText(...e);return this.plugins?.fulltext&&"fulltext_indexes"!==t.name&&this.plugins.fulltext.installResourceHooks(t),t},this.database._fulltextProxyInstalled=!0);for(const e of Object.values(this.database.resources))"fulltext_indexes"!==e.name&&this.installResourceHooks(e)}installResourceHooks(e){e._insert=e.insert,e._update=e.update,e._delete=e.delete,e._deleteMany=e.deleteMany,this.wrapResourceMethod(e,"insert",async(t,r,i)=>{const[n]=r;return this.indexRecord(e.name,t.id,n).catch(console.error),t}),this.wrapResourceMethod(e,"update",async(t,r,i)=>{const[n,s]=r;return this.removeRecordFromIndex(e.name,n).catch(console.error),this.indexRecord(e.name,n,t).catch(console.error),t}),this.wrapResourceMethod(e,"delete",async(t,r,i)=>{const[n]=r;return this.removeRecordFromIndex(e.name,n).catch(console.error),t}),this.wrapResourceMethod(e,"deleteMany",async(t,r,i)=>{const[n]=r;for(const t of n)this.removeRecordFromIndex(e.name,t).catch(console.error);return t})}async indexRecord(e,t,r){const i=this.getIndexedFields(e);if(i&&0!==i.length)for(const n of i){const i=this.getFieldValue(r,n);if(!i)continue;const s=this.tokenize(i);for(const r of s){if(r.length<this.config.minWordLength)continue;const i=`${e}:${n}:${r.toLowerCase()}`,s=this.indexes.get(i)||{recordIds:[],count:0};s.recordIds.includes(t)||(s.recordIds.push(t),s.count=s.recordIds.length),this.indexes.set(i,s)}}}async removeRecordFromIndex(e,t){for(const[r,i]of this.indexes.entries())if(r.startsWith(`${e}:`)){const e=i.recordIds.indexOf(t);e>-1&&(i.recordIds.splice(e,1),i.count=i.recordIds.length,0===i.recordIds.length?this.indexes.delete(r):this.indexes.set(r,i))}}getFieldValue(e,t){if(!t.includes("."))return e&&void 0!==e[t]?e[t]:null;const r=t.split(".");let i=e;for(const e of r){if(!i||"object"!=typeof i||!(e in i))return null;i=i[e]}return i}tokenize(e){if(!e)return[];return String(e).toLowerCase().replace(/[^\w\s\u00C0-\u017F]/g," ").split(/\s+/).filter(e=>e.length>0)}getIndexedFields(e){if(this.config.fields)return this.config.fields;return{users:["name","email"],products:["name","description"],articles:["title","content"]}[e]||[]}async search(e,t,r={}){const{fields:i=null,limit:n=this.config.maxResults,offset:s=0,exactMatch:o=!1}=r;if(!t||0===t.trim().length)return[];const a=this.tokenize(t),c=new Map,l=i||this.getIndexedFields(e);if(0===l.length)return[];for(const t of a)if(!(t.length<this.config.minWordLength))for(const r of l)if(o){const i=`${e}:${r}:${t.toLowerCase()}`,n=this.indexes.get(i);if(n)for(const e of n.recordIds){const t=c.get(e)||0;c.set(e,t+1)}}else for(const[i,n]of this.indexes.entries())if(i.startsWith(`${e}:${r}:${t.toLowerCase()}`))for(const e of n.recordIds){const t=c.get(e)||0;c.set(e,t+1)}return Array.from(c.entries()).map(([e,t])=>({recordId:e,score:t})).sort((e,t)=>t.score-e.score).slice(s,s+n)}async searchRecords(e,t,r={}){const i=await this.search(e,t,r);if(0===i.length)return[];const n=this.database.resources[e];if(!n)throw new Error(`Resource '${e}' not found`);const s=i.map(e=>e.recordId);return(await n.getMany(s)).filter(e=>e&&"object"==typeof e).map(e=>{const t=i.find(t=>t.recordId===e.id);return{...e,_searchScore:t?t.score:0}}).sort((e,t)=>t._searchScore-e._searchScore)}async rebuildIndex(e){const t=this.database.resources[e];if(!t)throw new Error(`Resource '${e}' not found`);for(const[t]of this.indexes.entries())t.startsWith(`${e}:`)&&this.indexes.delete(t);const r=await t.getAll();for(let t=0;t<r.length;t+=100){const i=r.slice(t,t+100);for(const t of i){const[r,i]=await x(()=>this.indexRecord(e,t.id,t))}}await this.saveIndexes()}async getIndexStats(){const e={totalIndexes:this.indexes.size,resources:{},totalWords:0};for(const[t,r]of this.indexes.entries()){const[i,n]=t.split(":");e.resources[i]||(e.resources[i]={fields:{},totalRecords:new Set,totalWords:0}),e.resources[i].fields[n]||(e.resources[i].fields[n]={words:0,totalOccurrences:0}),e.resources[i].fields[n].words++,e.resources[i].fields[n].totalOccurrences+=r.count,e.resources[i].totalWords++;for(const t of r.recordIds)e.resources[i].totalRecords.add(t);e.totalWords++}for(const t in e.resources)e.resources[t].totalRecords=e.resources[t].totalRecords.size;return e}async rebuildAllIndexes({timeout:e}={}){return e?Promise.race([this._rebuildAllIndexesInternal(),new Promise((t,r)=>setTimeout(()=>r(new Error("Timeout")),e))]):this._rebuildAllIndexesInternal()}async _rebuildAllIndexesInternal(){const e=Object.keys(this.database.resources).filter(e=>"fulltext_indexes"!==e);for(const t of e){const[e,r]=await x(()=>this.rebuildIndex(t))}}async clearIndex(e){for(const[t]of this.indexes.entries())t.startsWith(`${e}:`)&&this.indexes.delete(t);await this.saveIndexes()}async clearAllIndexes(){this.indexes.clear(),await this.saveIndexes()}},exports.InvalidResourceItem=ce,exports.MemoryCache=Po,exports.MetricsPlugin=class extends Tc{constructor(e={}){super(),this.config={enabled:!1!==e.enabled,collectPerformance:!1!==e.collectPerformance,collectErrors:!1!==e.collectErrors,collectUsage:!1!==e.collectUsage,retentionDays:e.retentionDays||30,flushInterval:e.flushInterval||6e4,...e},this.metrics={operations:{insert:{count:0,totalTime:0,errors:0},update:{count:0,totalTime:0,errors:0},delete:{count:0,totalTime:0,errors:0},get:{count:0,totalTime:0,errors:0},list:{count:0,totalTime:0,errors:0},count:{count:0,totalTime:0,errors:0}},resources:{},errors:[],performance:[],startTime:(new Date).toISOString()},this.flushTimer=null}async setup(e){if(this.database=e,!this.config.enabled||"test"===process.env.NODE_ENV)return;const[t,r]=await x(async()=>{const[t,r,i]=await x(()=>e.createResource({name:"metrics",attributes:{id:"string|required",type:"string|required",resourceName:"string",operation:"string",count:"number|required",totalTime:"number|required",errors:"number|required",avgTime:"number|required",timestamp:"string|required",metadata:"json"}}));this.metricsResource=t?i:e.resources.metrics;const[n,s,o]=await x(()=>e.createResource({name:"error_logs",attributes:{id:"string|required",resourceName:"string|required",operation:"string|required",error:"string|required",timestamp:"string|required",metadata:"json"}}));this.errorsResource=n?o:e.resources.error_logs;const[a,c,l]=await x(()=>e.createResource({name:"performance_logs",attributes:{id:"string|required",resourceName:"string|required",operation:"string|required",duration:"number|required",timestamp:"string|required",metadata:"json"}}));this.performanceResource=a?l:e.resources.performance_logs});t||(this.metricsResource=e.resources.metrics,this.errorsResource=e.resources.error_logs,this.performanceResource=e.resources.performance_logs),this.installMetricsHooks(),"test"!==process.env.NODE_ENV&&this.startFlushTimer()}async start(){}async stop(){this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null),"test"!==process.env.NODE_ENV&&await this.flushMetrics()}installMetricsHooks(){for(const e of Object.values(this.database.resources))["metrics","error_logs","performance_logs"].includes(e.name)||this.installResourceHooks(e);this.database._createResource=this.database.createResource,this.database.createResource=async function(...e){const t=await this._createResource(...e);return this.plugins?.metrics&&!["metrics","error_logs","performance_logs"].includes(t.name)&&this.plugins.metrics.installResourceHooks(t),t}}installResourceHooks(e){e._insert=e.insert,e._update=e.update,e._delete=e.delete,e._deleteMany=e.deleteMany,e._get=e.get,e._getMany=e.getMany,e._getAll=e.getAll,e._list=e.list,e._listIds=e.listIds,e._count=e.count,e._page=e.page,e.insert=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._insert(...t));if(this.recordOperation(e.name,"insert",Date.now()-r,!i),i||this.recordError(e.name,"insert",n),!i)throw n;return s}.bind(this),e.update=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._update(...t));if(this.recordOperation(e.name,"update",Date.now()-r,!i),i||this.recordError(e.name,"update",n),!i)throw n;return s}.bind(this),e.delete=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._delete(...t));if(this.recordOperation(e.name,"delete",Date.now()-r,!i),i||this.recordError(e.name,"delete",n),!i)throw n;return s}.bind(this),e.deleteMany=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._deleteMany(...t));if(this.recordOperation(e.name,"delete",Date.now()-r,!i),i||this.recordError(e.name,"delete",n),!i)throw n;return s}.bind(this),e.get=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._get(...t));if(this.recordOperation(e.name,"get",Date.now()-r,!i),i||this.recordError(e.name,"get",n),!i)throw n;return s}.bind(this),e.getMany=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._getMany(...t));if(this.recordOperation(e.name,"get",Date.now()-r,!i),i||this.recordError(e.name,"get",n),!i)throw n;return s}.bind(this),e.getAll=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._getAll(...t));if(this.recordOperation(e.name,"list",Date.now()-r,!i),i||this.recordError(e.name,"list",n),!i)throw n;return s}.bind(this),e.list=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._list(...t));if(this.recordOperation(e.name,"list",Date.now()-r,!i),i||this.recordError(e.name,"list",n),!i)throw n;return s}.bind(this),e.listIds=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._listIds(...t));if(this.recordOperation(e.name,"list",Date.now()-r,!i),i||this.recordError(e.name,"list",n),!i)throw n;return s}.bind(this),e.count=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._count(...t));if(this.recordOperation(e.name,"count",Date.now()-r,!i),i||this.recordError(e.name,"count",n),!i)throw n;return s}.bind(this),e.page=async function(...t){const r=Date.now(),[i,n,s]=await x(()=>e._page(...t));if(this.recordOperation(e.name,"list",Date.now()-r,!i),i||this.recordError(e.name,"list",n),!i)throw n;return s}.bind(this)}recordOperation(e,t,r,i){this.metrics.operations[t]&&(this.metrics.operations[t].count++,this.metrics.operations[t].totalTime+=r,i&&this.metrics.operations[t].errors++),this.metrics.resources[e]||(this.metrics.resources[e]={insert:{count:0,totalTime:0,errors:0},update:{count:0,totalTime:0,errors:0},delete:{count:0,totalTime:0,errors:0},get:{count:0,totalTime:0,errors:0},list:{count:0,totalTime:0,errors:0},count:{count:0,totalTime:0,errors:0}}),this.metrics.resources[e][t]&&(this.metrics.resources[e][t].count++,this.metrics.resources[e][t].totalTime+=r,i&&this.metrics.resources[e][t].errors++),this.config.collectPerformance&&this.metrics.performance.push({resourceName:e,operation:t,duration:r,timestamp:(new Date).toISOString()})}recordError(e,t,r){this.config.collectErrors&&this.metrics.errors.push({resourceName:e,operation:t,error:r.message,stack:r.stack,timestamp:(new Date).toISOString()})}startFlushTimer(){this.flushTimer&&clearInterval(this.flushTimer),this.config.flushInterval>0&&(this.flushTimer=setInterval(()=>{this.flushMetrics().catch(console.error)},this.config.flushInterval))}async flushMetrics(){if(!this.metricsResource)return;const[e,t]=await x(async()=>{const e="test"===process.env.NODE_ENV?{}:{global:"true"},t="test"===process.env.NODE_ENV?{}:{perf:"true"},r="test"===process.env.NODE_ENV?{}:{error:"true"},i="test"===process.env.NODE_ENV?{}:{resource:"true"};for(const[t,r]of Object.entries(this.metrics.operations))r.count>0&&await this.metricsResource.insert({id:`metrics-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"operation",resourceName:"global",operation:t,count:r.count,totalTime:r.totalTime,errors:r.errors,avgTime:r.count>0?r.totalTime/r.count:0,timestamp:(new Date).toISOString(),metadata:e});for(const[e,t]of Object.entries(this.metrics.resources))for(const[r,n]of Object.entries(t))n.count>0&&await this.metricsResource.insert({id:`metrics-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"operation",resourceName:e,operation:r,count:n.count,totalTime:n.totalTime,errors:n.errors,avgTime:n.count>0?n.totalTime/n.count:0,timestamp:(new Date).toISOString(),metadata:i});if(this.config.collectPerformance&&this.metrics.performance.length>0)for(const e of this.metrics.performance)await this.performanceResource.insert({id:`perf-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,resourceName:e.resourceName,operation:e.operation,duration:e.duration,timestamp:e.timestamp,metadata:t});if(this.config.collectErrors&&this.metrics.errors.length>0)for(const e of this.metrics.errors)await this.errorsResource.insert({id:`error-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,resourceName:e.resourceName,operation:e.operation,error:e.error,stack:e.stack,timestamp:e.timestamp,metadata:r});this.resetMetrics()});e||console.error("Failed to flush metrics:",t)}resetMetrics(){for(const e of Object.keys(this.metrics.operations))this.metrics.operations[e]={count:0,totalTime:0,errors:0};for(const e of Object.keys(this.metrics.resources))for(const t of Object.keys(this.metrics.resources[e]))this.metrics.resources[e][t]={count:0,totalTime:0,errors:0};this.metrics.performance=[],this.metrics.errors=[]}async getMetrics(e={}){const{type:t="operation",resourceName:r,operation:i,startDate:n,endDate:s,limit:o=100,offset:a=0}=e;if(!this.metricsResource)return[];let c=(await this.metricsResource.getAll()).filter(e=>(!t||e.type===t)&&((!r||e.resourceName===r)&&((!i||e.operation===i)&&(!(n&&new Date(e.timestamp)<new Date(n))&&!(s&&new Date(e.timestamp)>new Date(s))))));return c.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),c.slice(a,a+o)}async getErrorLogs(e={}){if(!this.errorsResource)return[];const{resourceName:t,operation:r,startDate:i,endDate:n,limit:s=100,offset:o=0}=e;let a=(await this.errorsResource.getAll()).filter(e=>(!t||e.resourceName===t)&&((!r||e.operation===r)&&(!(i&&new Date(e.timestamp)<new Date(i))&&!(n&&new Date(e.timestamp)>new Date(n)))));return a.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),a.slice(o,o+s)}async getPerformanceLogs(e={}){if(!this.performanceResource)return[];const{resourceName:t,operation:r,startDate:i,endDate:n,limit:s=100,offset:o=0}=e;let a=(await this.performanceResource.getAll()).filter(e=>(!t||e.resourceName===t)&&((!r||e.operation===r)&&(!(i&&new Date(e.timestamp)<new Date(i))&&!(n&&new Date(e.timestamp)>new Date(n)))));return a.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),a.slice(o,o+s)}async getStats(){const e=new Date,t=new Date(e.getTime()-864e5),[r,i,n]=await Promise.all([this.getMetrics({startDate:t.toISOString()}),this.getErrorLogs({startDate:t.toISOString()}),this.getPerformanceLogs({startDate:t.toISOString()})]),s={period:"24h",totalOperations:0,totalErrors:i.length,avgResponseTime:0,operationsByType:{},resources:{},uptime:{startTime:this.metrics.startTime,duration:e.getTime()-new Date(this.metrics.startTime).getTime()}};for(const e of r)if("operation"===e.type){s.totalOperations+=e.count,s.operationsByType[e.operation]||(s.operationsByType[e.operation]={count:0,errors:0,avgTime:0}),s.operationsByType[e.operation].count+=e.count,s.operationsByType[e.operation].errors+=e.errors;const t=s.operationsByType[e.operation],r=t.count,i=(t.avgTime*(r-e.count)+e.totalTime)/r;t.avgTime=i}const o=r.reduce((e,t)=>e+t.totalTime,0),a=r.reduce((e,t)=>e+t.count,0);return s.avgResponseTime=a>0?o/a:0,s}async cleanupOldData(){const e=new Date;if(e.setDate(e.getDate()-this.config.retentionDays),this.metricsResource){const t=await this.getMetrics({endDate:e.toISOString()});for(const e of t)await this.metricsResource.delete(e.id)}if(this.errorsResource){const t=await this.getErrorLogs({endDate:e.toISOString()});for(const e of t)await this.errorsResource.delete(e.id)}if(this.performanceResource){const t=await this.getPerformanceLogs({endDate:e.toISOString()});for(const e of t)await this.performanceResource.delete(e.id)}}},exports.MissingMetadata=ae,exports.NoSuchBucket=ne,exports.NoSuchKey=se,exports.NotFound=oe,exports.PartitionError=me,exports.PermissionError=re,exports.Plugin=Tc,exports.PluginObject=Mc,exports.PostgresReplicator=zc,exports.REPLICATOR_DRIVERS=Gc,exports.ReplicatorPlugin=class extends Tc{constructor(e={}){if(super(),e.verbose&&console.log("[PLUGIN][CONSTRUCTOR] ReplicatorPlugin constructor called"),e.verbose&&console.log("[PLUGIN][constructor] New ReplicatorPlugin instance created with config:",e),!e.replicators||!Array.isArray(e.replicators))throw new Error("ReplicatorPlugin: replicators array is required");for(const t of e.replicators)if(!t.driver)throw new Error("ReplicatorPlugin: each replicator must have a driver");this.config={verbose:e.verbose??!1,persistReplicatorLog:e.persistReplicatorLog??!1,replicatorLogResource:e.replicatorLogResource??"replicator_logs",replicators:e.replicators||[]},this.replicators=[],this.queue=[],this.isProcessing=!1,this.stats={totalOperations:0,totalErrors:0,lastError:null},this._installedListeners=[]}async decompressData(e){return e}filterInternalFields(e){if(!e||"object"!=typeof e)return e;const t={};for(const[r,i]of Object.entries(e))r.startsWith("_")||"$overflow"===r||"$before"===r||"$after"===r||(t[r]=i);return t}installEventListeners(e){const t=this;t.config.verbose&&console.log("[PLUGIN] installEventListeners called for:",e&&e.name,{hasDatabase:!!e.database,sameDatabase:e.database===t.database,alreadyInstalled:e._replicatorListenersInstalled,resourceObj:e,resourceObjId:e&&e.id,resourceObjType:typeof e,resourceObjIs:e&&Object.is(e,t.database.resources&&t.database.resources[e.name]),resourceObjEq:e===(t.database.resources&&t.database.resources[e.name])}),e&&e.name!==t.config.replicatorLogResource&&e.database&&e.database===t.database&&(e._replicatorListenersInstalled||(e._replicatorListenersInstalled=!0,this._installedListeners.push(e),t.config.verbose&&console.log(`[PLUGIN] installEventListeners INSTALLED for resource: ${e&&e.name}`),e.on("insert",async r=>{t.config.verbose&&console.log("[PLUGIN] Listener INSERT on",e.name,"plugin.replicators.length:",t.replicators.length,t.replicators.map(e=>({id:e.id,driver:e.driver})));try{const i=await t.getCompleteData(e,r);t.config.verbose&&console.log(`[PLUGIN] Listener INSERT completeData for ${e.name} id=${r&&r.id}:`,i),await t.processReplicatorEvent(e.name,"insert",r.id,i,null)}catch(i){t.config.verbose&&console.error(`[PLUGIN] Listener INSERT error on ${e.name} id=${r&&r.id}:`,i)}}),e.on("update",async r=>{console.log("[PLUGIN][Listener][UPDATE][START] triggered for resource:",e.name,"data:",r);const i=r&&r.$before;t.config.verbose&&console.log("[PLUGIN] Listener UPDATE on",e.name,"plugin.replicators.length:",t.replicators.length,t.replicators.map(e=>({id:e.id,driver:e.driver})),"data:",r,"beforeData:",i);try{let n;const[s,o,a]=await x(()=>e.get(r.id));n=s&&a?a:r,await t.processReplicatorEvent(e.name,"update",r.id,n,i)}catch(i){t.config.verbose&&console.error(`[PLUGIN] Listener UPDATE erro em ${e.name} id=${r&&r.id}:`,i)}}),e.on("delete",async(r,i)=>{t.config.verbose&&console.log("[PLUGIN] Listener DELETE on",e.name,"plugin.replicators.length:",t.replicators.length,t.replicators.map(e=>({id:e.id,driver:e.driver})));try{await t.processReplicatorEvent(e.name,"delete",r.id,null,i)}catch(i){t.config.verbose&&console.error(`[PLUGIN] Listener DELETE erro em ${e.name} id=${r&&r.id}:`,i)}}),t.config.verbose&&console.log(`[PLUGIN] Listeners instalados para resource: ${e&&e.name} (insert: ${e.listenerCount("insert")}, update: ${e.listenerCount("update")}, delete: ${e.listenerCount("delete")})`)))}async getCompleteData(e,t){const[r,i,n]=await x(()=>e.get(t.id));return r?n:t}async setup(e){if(console.log("[PLUGIN][SETUP] setup called"),this.config.verbose&&console.log("[PLUGIN][setup] called with database:",e&&e.name),this.database=e,this.config.persistReplicatorLog){let t=e.resources[Jc(this.config.replicatorLogResource)];t||(t=await e.createResource({name:this.config.replicatorLogResource,behavior:"truncate-data",attributes:{id:"string|required",resource:"string|required",action:"string|required",data:"object",timestamp:"number|required",createdAt:"string|required"},partitions:{byDate:{fields:{createdAt:"string|maxlength:10"}}}}),this.config.verbose&&console.log("[PLUGIN] Log resource created:",this.config.replicatorLogResource,!!t)),e.resources[Jc(this.config.replicatorLogResource)]=t,this.replicatorLog=t,this.config.verbose&&console.log("[PLUGIN] Log resource created and registered:",this.config.replicatorLogResource,!!e.resources[Jc(this.config.replicatorLogResource)]),"function"==typeof e.uploadMetadataFile&&(await e.uploadMetadataFile(),this.config.verbose&&console.log("[PLUGIN] uploadMetadataFile called. database.resources keys:",Object.keys(e.resources)))}this.config.replicators&&this.config.replicators.length>0&&0===this.replicators.length&&(await this.initializeReplicators(),console.log("[PLUGIN][SETUP] after initializeReplicators, replicators.length:",this.replicators.length),this.config.verbose&&console.log("[PLUGIN][setup] After initializeReplicators, replicators.length:",this.replicators.length,this.replicators.map(e=>({id:e.id,driver:e.driver}))));for(const t in e.resources)Jc(t)!==Jc(this.config.replicatorLogResource)&&this.installEventListeners(e.resources[t]);e.on("connected",()=>{for(const t in e.resources)Jc(t)!==Jc(this.config.replicatorLogResource)&&this.installEventListeners(e.resources[t])});const t=e.createResource.bind(e);e.createResource=async e=>{this.config.verbose&&console.log("[PLUGIN] createResource proxy called for:",e&&e.name);const r=await t(e);return r&&r.name!==this.config.replicatorLogResource&&this.installEventListeners(r),r},e.on("s3db.resourceCreated",t=>{const r=e.resources[t];r&&r.name!==this.config.replicatorLogResource&&this.installEventListeners(r)})}async initializeReplicators(){console.log("[PLUGIN][INIT] initializeReplicators called");for(const e of this.config.replicators)try{console.log("[PLUGIN][INIT] processing replicatorConfig:",e);const t=e.driver,r=e.resources,i=Hc(t,e,r,e.client);i?(this.replicators.push({id:Math.random().toString(36).slice(2),driver:t,config:e,resources:r,instance:i}),console.log("[PLUGIN][INIT] pushed replicator:",t,r)):console.log("[PLUGIN][INIT] createReplicator returned null/undefined for driver:",t)}catch(e){console.error("[PLUGIN][INIT] Error creating replicator:",e)}}async start(){}async stop(){}async processReplicatorEvent(t,r,i,n,s=null){if(this.config.verbose&&(console.log("[PLUGIN][processReplicatorEvent] replicators.length:",this.replicators.length,this.replicators.map(e=>({id:e.id,driver:e.driver}))),console.log(`[PLUGIN][processReplicatorEvent] operation: ${r}, resource: ${t}, recordId: ${i}, data:`,n,"beforeData:",s)),this.config.verbose&&console.log(`[PLUGIN] processReplicatorEvent: resource=${t} op=${r} id=${i} data=`,n),this.config.verbose&&console.log(`[PLUGIN] processReplicatorEvent: resource=${t} op=${r} replicators=${this.replicators.length}`),0===this.replicators.length)return void(this.config.verbose&&console.log("[PLUGIN] No replicators registered"));const o=this.replicators.filter(e=>{const i=e.instance.shouldReplicateResource(t,r);return this.config.verbose&&console.log(`[PLUGIN] Replicator ${e.driver} shouldReplicateResource(${t}, ${r}):`,i),i});if(this.config.verbose&&console.log(`[PLUGIN] processReplicatorEvent: applicableReplicators for resource=${t}:`,o.map(e=>e.driver)),0===o.length)return void(this.config.verbose&&console.log("[PLUGIN] No applicable replicators for resource",t));const a=this.filterInternalFields(e.isPlainObject(n)?n:{raw:n}),c=s?this.filterInternalFields(e.isPlainObject(s)?s:{raw:s}):null,l={id:`repl-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,resourceName:t,operation:r,recordId:i,data:a,beforeData:c,timestamp:(new Date).toISOString(),attempts:0},u=await this.logreplicator(l),[h,f,d]=await x(async()=>this.processreplicatorItem(l));h?(u&&await this.updatereplicatorLog(u,{status:d.success?"success":"failed",attempts:1,error:d.success?"":JSON.stringify(d.results)}),this.stats.totalOperations++,d.success?this.stats.successfulOperations++:this.stats.failedOperations++):(u&&await this.updatereplicatorLog(u,{status:"failed",attempts:1,error:f.message}),this.stats.failedOperations++)}async processreplicatorItem(e){this.config.verbose&&console.log("[PLUGIN][processreplicatorItem] called with item:",e);const t=this.replicators.filter(t=>{const r=t.instance.shouldReplicateResource(e.resourceName,e.operation);return this.config.verbose&&console.log(`[PLUGIN] processreplicatorItem: Replicator ${t.driver} shouldReplicateResource(${e.resourceName}, ${e.operation}):`,r),r});if(this.config.verbose&&console.log(`[PLUGIN] processreplicatorItem: applicableReplicators for resource=${e.resourceName}:`,t.map(e=>e.driver)),0===t.length)return this.config.verbose&&console.log("[PLUGIN] processreplicatorItem: No applicable replicators for resource",e.resourceName),{success:!0,skipped:!0,reason:"no_applicable_replicators"};const r=[];for(const i of t){let t,n,s;this.config.verbose&&console.log("[PLUGIN] processReplicatorItem",{resource:e.resourceName,operation:e.operation,data:e.data,beforeData:e.beforeData,replicator:i.instance?.constructor?.name}),i.instance&&i.instance.constructor&&"S3dbReplicator"===i.instance.constructor.name?[n,s,t]=await x(()=>i.instance.replicate({resource:e.resourceName,operation:e.operation,data:e.data,id:e.recordId,beforeData:e.beforeData})):[n,s,t]=await x(()=>i.instance.replicate(e.resourceName,e.operation,e.data,e.recordId,e.beforeData)),r.push({replicatorId:i.id,driver:i.driver,success:t&&t.success,error:t&&t.error,skipped:t&&t.skipped})}return{success:r.every(e=>e.success||e.skipped),results:r}}async logreplicator(e){const t=this.replicatorLog||this.database.resources[Jc(this.config.replicatorLogResource)];if(!t)return this.config.verbose&&console.error("[PLUGIN] replicator log resource not found!"),this.database&&(this.config.verbose&&console.warn("[PLUGIN] database.resources keys:",Object.keys(this.database.resources)),this.database.options&&this.database.options.connectionString&&this.config.verbose&&console.warn("[PLUGIN] database connectionString:",this.database.options.connectionString)),void this.emit("replicator.log.failed",{error:"replicator log resource not found",item:e});const r={id:e.id||`repl-${Date.now()}-${Math.random().toString(36).slice(2)}`,resource:e.resource||e.resourceName||"",action:e.operation||e.action||"",data:e.data||{},timestamp:"number"==typeof e.timestamp?e.timestamp:Date.now(),createdAt:e.createdAt||(new Date).toISOString().slice(0,10)};try{await t.insert(r)}catch(t){this.config.verbose&&console.error("[PLUGIN] Error writing to replicator log:",t),this.emit("replicator.log.failed",{error:t,item:e})}}async updatereplicatorLog(e,t){if(!this.replicatorLog)return;const[r,i]=await x(async()=>{await this.replicatorLog.update(e,{...t,lastAttempt:(new Date).toISOString()})});r||this.emit("replicator.updateLog.failed",{error:i.message,logId:e,updates:t})}async getreplicatorStats(){const e=await Promise.all(this.replicators.map(async e=>{const t=await e.instance.getStatus();return{id:e.id,driver:e.driver,config:e.config,status:t}}));return{replicators:e,queue:{length:this.queue.length,isProcessing:this.isProcessing},stats:this.stats,lastSync:this.stats.lastSync}}async getreplicatorLogs(e={}){if(!this.replicatorLog)return[];const{resourceName:t,operation:r,status:i,limit:n=100,offset:s=0}=e;let o={};t&&(o.resourceName=t),r&&(o.operation=r),i&&(o.status=i);return(await this.replicatorLog.list(o)).slice(s,s+n)}async retryFailedreplicators(){if(!this.replicatorLog)return{retried:0};const e=await this.replicatorLog.list({status:"failed"});let t=0;for(const r of e){const[e,i]=await x(async()=>{await this.processReplicatorEvent(r.resourceName,r.operation,r.recordId,r.data)});e?t++:this.config.verbose&&console.error("Failed to retry replicator:",i)}return{retried:t}}async syncAllData(e){const t=this.replicators.find(t=>t.id===e);if(!t)throw new Error(`Replicator not found: ${e}`);this.stats.lastSync=(new Date).toISOString();for(const r in this.database.resources)if(Jc(r)!==Jc("replicator_logs")&&t.instance.shouldReplicateResource(r)){this.emit("replicator.sync.resource",{resourceName:r,replicatorId:e});const i=this.database.resources[r],n=await i.getAll();for(const e of n)await t.instance.replicate(r,"insert",e,e.id)}this.emit("replicator.sync.completed",{replicatorId:e,stats:this.stats})}async cleanup(){if(this.config.verbose&&console.log("[PLUGIN][CLEANUP] Cleaning up ReplicatorPlugin"),this._installedListeners&&Array.isArray(this._installedListeners)){for(const e of this._installedListeners)e&&"function"==typeof e.removeAllListeners&&(e.removeAllListeners("insert"),e.removeAllListeners("update"),e.removeAllListeners("delete")),e._replicatorListenersInstalled=!1;this._installedListeners=[]}if(this.database&&"function"==typeof this.database.removeAllListeners&&this.database.removeAllListeners(),this.replicators&&Array.isArray(this.replicators)){for(const e of this.replicators)e.instance&&"function"==typeof e.instance.cleanup&&await e.instance.cleanup();this.replicators=[]}this.queue=[],this.isProcessing=!1,this.stats={totalOperations:0,totalErrors:0,lastError:null},this.config.verbose&&console.log("[PLUGIN][CLEANUP] ReplicatorPlugin cleanup complete")}},exports.Resource=Bo,exports.ResourceError=ge,exports.ResourceIdsPageReader=eo,exports.ResourceIdsReader=Xs,exports.ResourceNotFound=ie,exports.ResourceReader=to,exports.ResourceWriter=ro,exports.S3Cache=Lc,exports.S3_DEFAULT_ENDPOINT=be,exports.S3_DEFAULT_REGION=ye,exports.S3db=jo,exports.S3dbError=ee,exports.S3dbReplicator=Qc,exports.Schema=gi,exports.SchemaActions=pi,exports.SchemaError=pe,exports.SqsReplicator=Vc,exports.UnknownError=le,exports.ValidationError=te,exports.Validator=oi,exports.ValidatorManager=ai,exports.behaviors=Oo,exports.calculateAttributeNamesSize=so,exports.calculateAttributeSizes=ao,exports.calculateEffectiveLimit=uo,exports.calculateSystemOverhead=lo,exports.calculateTotalSize=co,exports.calculateUTF8Bytes=no,exports.createReplicator=Hc,exports.decode=hi,exports.decodeDecimal=di,exports.decrypt=Ee,exports.default=jo,exports.encode=ui,exports.encodeDecimal=fi,exports.encrypt=ke,exports.getBehavior=xo,exports.getSizeBreakdown=function(e){const t=ao(e),r=so(e),i=Object.values(t).reduce((e,t)=>e+t,0),n=i+r,s=Object.entries(t).sort(([,e],[,t])=>t-e).map(([e,t])=>({attribute:e,size:t,percentage:(t/n*100).toFixed(2)+"%"}));return{total:n,valueSizes:t,namesSize:r,valueTotal:i,breakdown:s,detailedBreakdown:{values:i,names:r,total:n}}},exports.idGenerator=S,exports.mapAwsError=he,exports.passwordGenerator=O,exports.sha256=Ae,exports.streamToString=io,exports.transformValue=oo,exports.tryFn=x,exports.tryFnSync=R,exports.validateReplicatorConfig=function(e,t,r=[],i=null){return Hc(e,t,r,i).validateConfig()};
